// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","@dojo/framework/shim/Map","@dojo/framework/shim/Set","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/normalizeUtils","../../../geometry/support/scaleUtils","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./SpatialQueryCache","./spatialQuerySupport","./utils","../../../tasks/support/Query"],function(e,t,r,i,n,o,u,a,s,c,l,p,f,h,y,d,m,g,x,v,S,I,Q){function b(e){return e?JSON.parse(JSON.stringify(e,["latestWkid","wkid","wkt"])):e}function F(e,t,r,i,n,o,u,a){u&&!o?i.forEachFeatureInBounds(n,function(t){e.push({attributes:t.attributes,centroid:I.getCentroid(r,t,a)})}):o&&!u?i.forEachFeatureInBounds(n,function(i){t.add(i.objectId),e.push(new R(i.attributes,I.getGeometry(r,i,0,a)))}):i.forEachFeatureInBounds(n,function(i){t.add(i.objectId),e.push(new R(i.attributes,I.getGeometry(r,i,0,a),I.getCentroid(r,i,a)))})}Object.defineProperty(t,"__esModule",{value:!0});var _=a.getLogger("esri.layers.graphics.data.QueryEngine"),R=function(){function e(e,t,r){this.attributes=e,this.geometry=t,this.centroid=r}return e}(),w={},j=new n.default,C=function(){function e(e){var t=this;this.capabilities={query:g.queryCapabilities},this.fieldsMap=new i.default,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.spatialIndex=e.spatialIndex,this.spatialIndex.setEngine(this),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new v.default),e.fields.forEach(function(e){t.fieldsMap.set(e.name.trim(),e),t.fieldsMap.set(e.name.trim().toLowerCase(),e)})}return e.prototype.destroy=function(){this.clearCache(),this.fieldsMap.clear()},Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.spatialIndex.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:b(this.spatialReference)}:null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null},e.prototype.executeQuery=function(e){var t=this;void 0===e&&(e=new Q);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).catch(function(e){if(e===w)return new x.default([],t);throw e}).then(function(e){return e.createQueryResponse(r)})},e.prototype.executeQueryForCount=function(e){var t=this;void 0===e&&(e=new Q);var r=e.clone();return r.returnGeometry=!1,r.returnCentroid=!1,r.outSpatialReference=null,this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return e.size}).catch(function(e){if(e===w)return 0;throw e})},e.prototype.executeQueryForExtent=function(e){var t=this;void 0===e&&(e=new Q);var r=e.clone(),i=r.outSpatialReference;return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(){return r.returnGeometry=!0,r.returnCentroid=!1,r.outSpatialReference=null,r}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){var r=e.size;if(!r)return{count:r,extent:null};var n={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:b(t.spatialReference)};t.spatialIndex.forEachBounds(e.items,function(e){n.xmin=Math.min(e[0],n.xmin),n.ymin=Math.min(e[1],n.ymin),n.xmax=Math.max(e[2],n.xmax),n.ymax=Math.max(e[3],n.ymax)});var o=m.project(n,e.spatialReference,i);if(o.spatialReference=b(i&&i.toJSON()||t.spatialReference),o.xmax-o.xmin==0){var u=f.getMetersPerUnitForSR(o.spatialReference);o.xmin-=u,o.xmax+=u}if(o.ymax-o.ymin==0){var u=f.getMetersPerUnitForSR(o.spatialReference);o.ymin-=u,o.ymax+=u}return{count:r,extent:o}}).catch(function(e){if(e===w)return{count:0,extent:null};throw e})},e.prototype.executeQueryForIds=function(e){var t=this;void 0===e&&(e=new Q);var r=e.clone();return r.returnGeometry=!1,r.returnCentroid=!1,r.outSpatialReference=null,this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){for(var t=e.items,r=[],i=0;i<t.length;i++)r[i]=t[i].objectId;return r}).catch(function(e){if(e===w)return[];throw e})},e.prototype.executeTileQuery=function(e,t){var r=this,i=t.returnGeometry,o=t.returnCentroid,u=t.pixelBuffer,a=new n.default,s=[],c=u*e.resolution,p=l.pad(e.bounds,c,l.create());if(F(s,a,this,this.spatialIndex,p,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}),"esriGeometryPoint"===this.geometryType||o){var f=h.getInfo(this.spatialReference);if(f){var y=f.valid,d=y[0],m=y[1];if(p[0]<d){var g=l.fromValues(m-c,p[1],m,p[3]);F(s,a,this,this.spatialIndex,g,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[m,e.bounds[3]]})}if(p[2]>m){var x=l.fromValues(d,p[1],d+c,p[3]);F(s,a,this,this.spatialIndex,x,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[d-m+e.bounds[0],e.bounds[3]]})}}}return s.sort(function(e,t){return e.attributes[r.objectIdField]-t.attributes[r.objectIdField]}),{features:s,objectIds:a}},e.prototype.executeTileQueryForIds=function(e,t){var r=t.pixelBuffer,i=r*e.resolution,n=l.pad(e.bounds,i,l.create());return this.spatialIndex.mapFeaturesInBounds(n,function(e){return e.objectId})},e.prototype.executeQueryForLatestObservations=function(e){var t=this;return this.timeInfo?this.executeQuery(e).then(function(e){return t._filterLatest(e,t.timeInfo)}):void _.error(new u("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._filterLatest=function(e,t){for(var n=t.trackIdField,o=t.startTimeField,u=t.endTimeField,a=u||o,s=new i.default,c=[],l=0,p=e.features;l<p.length;l++){var f=p[l],h=f.attributes[n],y=f.attributes[a];(!s.has(h)||s.get(h).attributes[a]<y)&&s.set(h,f)}return s.forEach(function(e){return c.push(e)}),r({},e,{features:c})},e.prototype._getAll=function(){return this._allItems||(this._allItems=new x.default(this.spatialIndex.getAllFeatures(),this)),this._allItems},e.prototype._normalizeQuery=function(e){var t=this,r=this.definitionExpression,i=e.where,n=e.geometry,o=e.outFields,u=e.orderByFields,a=e.groupByFieldsForStatistics,c=e.outStatistics;if(e.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||r&&r===i)&&(e.where=null),o)for(var l=0;l<o.length;l++)o[l]=o[l].trim();if(u)for(var l=0;l<u.length;l++)u[l]=u[l].trim();if(a)for(var l=0;l<a.length;l++)a[l]=a[l].trim();if(c)for(var l=0;l<c.length;l++)c[l].onStatisticField=c[l].onStatisticField.trim();return n?(e.outSpatialReference||(e.outSpatialReference=n.spatialReference),this._getInputGeometry(e).then(function(t){return e.geometry=t}).then(function(e){return m.checkProjectionSupport(e.spatialReference,t.spatialReference)}).then(function(){return p.normalizeCentralMeridian(e.geometry)}).then(function(e){return m.project(e[0].toJSON(),e[0].spatialReference,t.spatialReference)}).then(function(r){if(!r)throw w;return r.spatialReference=t.spatialReference,e.read({geometry:r})})):s.resolve(e)},e.prototype._executeGeometryQuery=function(e){var t=this,r=e.geometry,i=e.outSpatialReference,n=e.spatialRelationship,o=i&&!y.equals(this.spatialReference,i),u=o?JSON.stringify({geometry:r,spatialRelationship:n,outSpatialReference:i}):JSON.stringify({geometry:r,spatialRelationship:n});if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(u))return s.resolve(this._geometryQueryCache.get(u));var a=null;if(r){var c=this._searchSpatialIndex(this._getQueryBBoxes(r));if(!c.length){var l=new x.default([],this);return this.cacheSpatialQueries&&this._geometryQueryCache.set(u,l),s.resolve(l)}a="envelope-intersects"===e.spatialRelationship||"esriGeometryPoint"===this.geometryType&&S.canQueryWithRBush(r)?s.resolve(new x.default(c,this)):S.getSpatialQueryOperator(n,r,this.geometryType).then(function(e){if(e){var r=c.filter(function(r){return e(I.getGeometry(t,r))});return new x.default(r,t)}})}else a=s.resolve(this._getAll());return a.then(function(r){return o&&(e.returnGeometry||e.returnCentroid)?r.project(i).then(function(e){return t.cacheSpatialQueries&&t._geometryQueryCache.set(u,e),e}):(t.cacheSpatialQueries&&t._geometryQueryCache.set(u,r),r)})},e.prototype._getInputGeometry=function(e){var t=e.geometry,r=e.distance,i=e.units;if(null==r)return s.resolve(t);var n=t.spatialReference,u=i||f.getUnitString(n),a=n&&(n.isGeographic||n.isWebMercator),l=null;return l=a?s.resolve(t):m.checkProjectionSupport(n,o.SpatialReference.WGS84).then(function(){return c.project(t,o.SpatialReference.WGS84)}),l.then(function(e){return S.getGeodesicBufferOperator().then(function(t){return t(e,r,u)})})},e.prototype._getQueryBBoxes=function(e){if("point"===e.type)return[l.fromValues(e.x,e.y,e.x,e.y)];var t=S.canQueryWithRBush(e)?e:e.extent;switch(t.type){case"extent":return[l.fromExtent(t)];case"polygon":return t.rings.map(function(e){return l.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}},e.prototype._searchSpatialIndex=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];this.spatialIndex.forEachFeatureInBounds(n,function(e){j.has(e)||(t.push(e),j.add(e))})}return j.clear(),t},e.prototype._checkQuerySupport=function(e){return e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParameter||e.text||e.timeExtent?s.reject(new u("feature-store:unsupported-query","Unsupported query options",{query:e})):s.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),S.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),m.checkProjectionSupport(this.spatialReference,e.outSpatialReference)]).then(function(){return e})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,i=e.returnDistinctValues;if(r&&r.length>0){var n=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});d.validateFields(this.fieldsMap,n,"orderByFields contains missing fields")}if(t&&t.length>0)d.validateFields(this.fieldsMap,t,"outFields contains missing fields");else if(i)throw new u("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});d.validateWhere(this.fieldsMap,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics,i=e.having,n=r&&r.length,o=t&&t.length;if(i){if(!n||!o)return s.reject(new u("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e}));d.validateHaving(this.fieldsMap,i,t)}if(o){var a=t.map(function(e){return e.onStatisticField.trim()});d.validateFields(this.fieldsMap,a,"onStatisticFields contains missing fields"),n&&d.validateFields(this.fieldsMap,r,"groupByFieldsForStatistics contains missing fields");for(var c=0,l=t;c<l.length;c++){var p=l[c],f=p.onStatisticField,h=p.statisticType;if((!n||"count"!==h)&&d.hasInvalidFieldType(f,this.fieldsMap))return s.reject(new u("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:p,query:e}))}}},e}();t.default=C});