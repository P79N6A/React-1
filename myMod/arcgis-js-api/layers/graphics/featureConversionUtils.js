// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],function(e,r,t,n,o,a,s){function u(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function i(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function l(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function h(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function g(e,r,t){return e?r?t?y(e):d(e):t?m(e):c(e):null}function c(e){var r=e.coords;return{x:r[0],y:r[1]}}function f(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r}function d(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function v(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r}function m(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function I(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.m,r}function y(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function p(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r.coords[3]=e.m,r}function N(e,r,t,n){var o=c;n&&t?o=y:n?o=d:t&&(o=m);for(var a=0,s=r;a<s.length;a++){var u=s[a],i=u.geometry,l=u.attributes,h=i?o(i):null;e.push({attributes:l,geometry:h})}return e}function T(e,r,t,n,a){var s=f;t&&n?s=p:t?s=v:n&&(s=I);for(var u=0,i=r;u<i.length;u++){var l=i[u],h=l.geometry,g=l.attributes,c=h?s(h):void 0;e.push(new o.default(c,g,null,g[a]))}return e}function b(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=void 0;u&&(l=F(u,t,n)),e.push({attributes:i,geometry:l})}return e}function F(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=[],a=0;a<e.coords.length;a+=n){for(var s=[],u=0;u<n;u++)s.push(e.coords[a+u]);o.push(s)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function M(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],g=h.geometry,c=h.attributes,f=void 0;if(g){f=new s.default,f.lengths[0]=g.points.length;for(var d=f.coords,v=0,m=0,I=g.points;m<I.length;m++)for(var y=I[m],p=0;p<u;p++)d[v++]=y[p]}e.push(new o.default(f,c,null,c[a]))}return e}function G(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=void 0;u&&(l=E(u,t,n)),e.push({attributes:i,geometry:l})}return e}function E(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=e.coords,a=e.lengths,s=[],u=0,i=0,l=a;i<l.length;i++){for(var h=l[i],g=[],c=0;c<h;c++){for(var f=[],d=0;d<n;d++)f.push(o[u++]);g.push(f)}s.push(g)}return r?t?{paths:s,hasZ:r,hasM:t}:{paths:s,hasZ:r}:t?{paths:s,hasM:t}:{paths:s}}function w(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],g=h.geometry,c=h.attributes,f=void 0;if(g){f=new s.default;for(var d=f.lengths,v=f.coords,m=0,I=0,y=g.paths;I<y.length;I++){for(var p=y[I],N=0,T=p;N<T.length;N++)for(var b=T[N],F=0;F<u;F++)v[m++]=b[F];d.push(p.length)}}e.push(new o.default(f,c,null,c[a]))}return e}function z(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=s.centroid,h=void 0;if(u&&(h=P(u,t,n)),l){var g=c(l);e.push({attributes:i,centroid:g,geometry:h})}else e.push({attributes:i,geometry:h})}return e}function P(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=e.coords,a=e.lengths,s=[],u=0,i=0,l=a;i<l.length;i++){for(var h=l[i],g=[],c=0;c<h;c++){for(var f=[],d=0;d<n;d++)f.push(o[u++]);g.push(f)}s.push(g)}return r?t?{rings:s,hasZ:r,hasM:t}:{rings:s,hasZ:r}:t?{rings:s,hasM:t}:{rings:s}}function O(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],g=h.geometry,c=h.centroid,d=h.attributes,v=void 0;if(g){v=new s.default;for(var m=v.lengths,I=v.coords,y=0,p=0,N=g.rings;p<N.length;p++){for(var T=N[p],b=0,F=T;b<F.length;b++)for(var M=F[b],G=0;G<u;G++)I[y++]=M[G];m.push(T.length)}}c?e.push(new o.default(v,d,f(c),d[a])):e.push(new o.default(v,d,null,d[a]))}return e}function Y(e,r,t,n,o){ae[0]=e;var a=_(se,ae,r,t,n,o)[0];return ae.length=se.length=0,a}function _(e,r,n,o,a,s){if(e.length=0,!n)return void(e.length=0);switch(n){case"esriGeometryPoint":return T(e,r,o,a,s);case"esriGeometryMultipoint":return M(e,r,o,a,s);case"esriGeometryPolyline":return w(e,r,o,a,s);case"esriGeometryPolygon":return O(e,r,o,a,s);default:ee.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'")),e.length=0}return e}function x(e,r,t,n){se[0]=e,S(ae,se,r,t,n);var o=ae[0];return ae.length=se.length=0,o}function S(e,r,n,o,a){switch(e.length=0,n){case"esriGeometryPoint":return N(e,r,o,a);case"esriGeometryMultipoint":return b(e,r,o,a);case"esriGeometryPolyline":return G(e,r,o,a);case"esriGeometryPolygon":return z(e,r,o,a);default:ee.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}return e}function V(e){var r=e.objectIdFieldName,t=e.spatialReference,n=e.transform,o=e.fields,a=e.hasM,s=e.hasZ,u=e.features,i=e.geometryType,l=e.exceededTransferLimit,h=S([],u,i,s,a),g={features:h,fields:o,geometryType:i,objectIdFieldName:r,spatialReference:t};return n&&(g.transform=n),l&&(g.exceededTransferLimit=l),a&&(g.hasM=a),s&&(g.hasZ=s),g}function Z(e,r){var n=new a.default,o=e.hasM,s=e.hasZ,u=e.features,i=e.objectIdFieldName,l=e.spatialReference,h=e.geometryType,g=e.exceededTransferLimit,c=e.transform;return n.fields=e.fields,n.geometryType=h,n.objectIdFieldName=i||r,n.spatialReference=l,n.objectIdFieldName?(u&&_(n.features,u,h,s,o,n.objectIdFieldName),g&&(n.exceededTransferLimit=g),o&&(n.hasM=o),s&&(n.hasZ=s),c&&(n.transform=c),n):(ee.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function j(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var a=0,s=t;a<s.length;a++){var u=s[a];u.geometry&&U(u.geometry,u.geometry,n,o,r),u.centroid&&U(u.centroid,u.centroid,n,o,r)}return e.transform=null,e}function q(e,r){var n=r.geometryType,a=r.features,u=r.hasM,i=r.hasZ;if("esriGeometryEnvelope"===n)return ee.error(new t("optimized-features:invalid-geometry-type",'FeatureSet with geometry type "'+n+'" is not supported')),r;if(!e)return r;for(var l=0;l<a.length;l++){var h=a[l],g=new o.default(new s.default,h.attributes);A(g.geometry,h.geometry,u,i,n,e),h.centroid&&(g.centroid=new s.default,A(g.centroid,h.centroid,u,i,"esriGeometryPoint",e)),a[l]=g}return r.transform=e,r}function A(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=re[o],l=r.coords,h=r.lengths,g=t?n?4:3:n?3:2,c=t?n?oe:ne:n?ne:te;if(!h.length)return c(e.coords,l,0,0,u(a,l[0]),i(a,l[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;for(var f,d,v,m,I=0,y=0,p=y,N=0,T=h;N<T.length;N++){var b=T[N];if(!(b<s)){var F=0;y=p,v=f=u(a,l[I]),m=d=i(a,l[I+1]),c(e.coords,l,y,I,v,m),F++,I+=g,y+=g;for(var M=1;M<b;M++,I+=g)v=u(a,l[I]),m=i(a,l[I+1]),v===f&&m===d||(c(e.coords,l,y,I,v-f,m-d),y+=g,F++,f=v,d=m);F>=s&&(e.lengths.push(F),p=y)}}return e.coords.length=p,e.coords.length?e:null}function L(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=re[o],l=r.coords,h=r.lengths,g=t?n?4:3:n?3:2,c=t?n?oe:ne:n?ne:te;if(!h.length)return c(e.coords,l,0,0,u(a,l[0]),i(a,l[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;for(var f,d,v,m,I=0,y=0,p=y,N=0,T=h;N<T.length;N++){var b=T[N];if(!(b<s)){var F=0;y=p,v=f=u(a,l[I]),m=d=i(a,l[I+1]),c(e.coords,l,y,I,v,m),F++,I+=g;for(var M=!1,G=0,E=0,w=1;w<b;w++,I+=g)if(v=u(a,l[I]),m=i(a,l[I+1]),v!==f||m!==d){var z=v-f,P=m-d;M&&(0===G&&0===z||0===E&&0===P)?(G+=z,E+=P,c(e.coords,l,y,I,G,E)):(M=!0,G=z,E=P,y+=g,F++,c(e.coords,l,y,I,G,E)),f=v,d=m}M&&(y+=g,c(e.coords,l,y,I,G,E)),F>=s&&(e.lengths.push(F),p=y)}}return e.coords.length!==p&&(e.coords.length=p),e.coords.length?e:null}function k(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=re[o],u=r.coords,i=r.lengths,l=t?n?4:3:n?3:2,h=t?n?oe:ne:n?ne:te;if(!i.length)return h(e.coords,u,0,0,u[0],u[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=l,e;for(var g=0,c=0,f=i;c<f.length;c++){var d=f[c];if(d<s)g+=d*l;else{var v=e.coords.length/l;D(e.coords,u,l,a,h,g,g+d*l);var m=e.coords.length/l-v;m>=s?e.lengths.push(m):e.coords.length=v*l,g+=d*l}}return e.coords.length?e:null}function R(e,r,t,n){var o=e[r],a=e[r+1],s=e[t],u=e[t+1],i=e[n],l=e[n+1];if(s===i)return Math.abs(o-s);var h=(l-u)/(i-s),g=u-h*s;return Math.abs(h*o-a+g)/Math.sqrt(h*h+1)}function D(e,r,t,n,o,a,s){for(var u,i=a,l=s-t,h=0,g=0,c=a+t;c<s-t;c+=t)(u=R(r,c,i,l))>h&&(g=c,h=u);h>n?(D(e,r,t,n,o,a,g+t),D(e,r,t,n,o,g,s)):(o(e,r,e.length,i,r[i],r[i+1]),o(e,r,e.length,l,r[l],r[l+1]))}function C(e,r,t,n){var o=t?n?4:3:n?3:2,a=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;if(r&&r.coords)for(var l=r.coords,h=0;h<l.length;h+=o){var g=l[h],c=l[h+1];a=Math.min(a,g),u=Math.max(u,g),s=Math.min(s,c),i=Math.max(i,c)}return e[0]=a,e[1]=s,e[2]=u,e[3]=i,e}function B(e,r,t,n){for(var o=t?n?4:3:n?3:2,a=r.lengths,s=r.coords,u=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,g=0,c=0,f=a;c<f.length;c++){var d=f[c],v=s[g],m=s[g+1];u=Math.min(v,u),i=Math.min(m,i),l=Math.max(v,l),h=Math.max(m,h),g+=o;for(var I=1;I<d;I++,g+=o){var y=s[g],p=s[g+1];v+=y,m+=p,y<0&&(u=Math.min(u,v)),y>0&&(l=Math.max(l,v)),p<0?i=Math.min(i,m):p>0&&(h=Math.max(h,m))}}return e[0]=u,e[1]=i,e[2]=l,e[3]=h,e}function U(e,r,t,n,o){var a=r.coords,s=r.lengths,u=t?n?oe:ne:n?ne:te,i=t?n?4:3:n?3:2;if(!a.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!s.length)return u(e.coords,a,0,0,l(o,a[0]),h(o,a[1])),e!==r&&(e.lengths.length=0,e.coords.length=i),e;for(var g=o.scale,c=g[0],f=g[1],d=0,v=0;v<s.length;v++){var m=s[v];e.lengths[v]=m;var I=l(o,a[d]),y=h(o,a[d+1]);u(e.coords,a,d,d,I,y),d+=i;for(var p=1;p<m;p++,d+=i)I+=a[d]*c,y-=a[d+1]*f,u(e.coords,a,d,d,I,y)}return e!==r&&(e.lengths.length=s.length,e.coords.length=a.length),e}function X(e,r,t,n){if(!r||!r.lengths.length)return null;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);for(var o=e.coords,a=[],s=t?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],u=r.lengths,i=r.coords,l=t?n?4:3:n?3:2,h=0,g=0,c=u;g<c.length;g++){var f=c[g],d=Q(s,i,h,f,t,n);d&&a.push(d),h+=f*l}if(a.sort(function(e,r){var n=e[2]-r[2];return 0===n&&t&&(n=e[4]-r[4]),n}),a.length){var v=6*a[0][2];o[0]=a[0][0]/v,o[1]=a[0][1]/v,t&&(v=6*a[0][4],o[2]=0!==v?a[0][3]/v:0),(o[0]<s[0]||o[0]>s[1]||o[1]<s[2]||o[1]>s[3]||t&&(o[2]<s[4]||o[2]>s[5]))&&(o.length=0)}if(!o.length){var m=r.lengths[0]?H(i,0,u[0],t,n):null;if(!m)return null;o[0]=m[0],o[1]=m[1],t&&m.length>2&&(o[2]=m[2])}return e}function Q(e,r,t,n,o,a){for(var s=o?a?4:3:a?3:2,u=t,i=t+s,l=0,h=0,g=0,c=0,f=0,d=0,v=n-1;d<v;d++,u+=s,i+=s){var m=r[u],I=r[u+1],y=r[u+2],p=r[i],N=r[i+1],T=r[i+2],b=m*N-p*I;c+=b,l+=(m+p)*b,h+=(I+N)*b,o&&(b=m*T-p*y,g+=(y+T)*b,f+=b),m<e[0]&&(e[0]=m),m>e[1]&&(e[1]=m),I<e[2]&&(e[2]=I),I>e[3]&&(e[3]=I),o&&(y<e[4]&&(e[4]=y),y>e[5]&&(e[5]=y))}if(c>0&&(c*=-1),f>0&&(f*=-1),!c)return null;var F=[l,h,.5*c];return o&&(F[3]=g,F[4]=.5*f),F}function H(e,r,t,n,o){for(var a=n?o?4:3:o?3:2,s=r,u=r+a,i=0,l=0,h=0,g=0,c=0,f=t-1;c<f;c++,s+=a,u+=a){var d=e[s],v=e[s+1],m=e[s+2],I=e[u],y=e[u+1],p=e[u+2],N=n?K(d,v,m,I,y,p):J(d,v,I,y);if(N)if(i+=N,n){var T=$(d,v,m,I,y,p);l+=N*T[0],h+=N*T[1],g+=N*T[2]}else{var T=W(d,v,I,y);l+=N*T[0],h+=N*T[1]}}return i>0?n?[l/i,h/i,g/i]:[l/i,h/i]:t>0?n?[e[r],e[r+1],e[r+2]]:[e[r],e[r+1]]:null}function J(e,r,t,n){var o=t-e,a=n-r;return Math.sqrt(o*o+a*a)}function K(e,r,t,n,o,a){var s=n-e,u=o-r,i=a-t;return Math.sqrt(s*s+u*u+i*i)}function W(e,r,t,n){return[e+.5*(t-e),r+.5*(n-r)]}function $(e,r,t,n,o,a){return[e+.5*(n-e),r+.5*(o-r),t+.5*(a-t)]}Object.defineProperty(r,"__esModule",{value:!0});var ee=n.getLogger("esri.tasks.support.optimizedFeatureSet"),re={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},te=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a},ne=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a,e[t+2]=r[n+2]},oe=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a,e[t+2]=r[n+2],e[t+3]=r[n+3]};r.quantizeX=u,r.quantizeY=i,r.hydrateX=l,r.hydrateY=h,r.convertToPoint=g,r.convertToMultipoint=F,r.convertToPolyline=E,r.convertToPolygon=P;var ae=[],se=[];r.convertFromFeature=Y,r.convertFromFeatures=_,r.convertToFeature=x,r.convertToFeatures=S,r.convertToFeatureSet=V,r.convertFromFeatureSet=Z,r.hydrateOptimizedFeatureSet=j,r.quantizeOptimizedFeatureSet=q,r.quantizeOptimizedGeometry=A,r.quantizeOptimizedGeometryRemoveCollinear=L,r.generalizeOptimizedGeometry=k,r.getBoundsOptimizedGeometry=C,r.getQuantizedBoundsOptimizedGeometry=B,r.hydrateOptimizedGeometry=U,r.getCentroidOptimizedGeometry=X,r.lineCentroid=H,r.getLength2D=J,r.getLength3D=K,r.getMidpoint2D=W,r.getMidpoint3D=$});