// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../geometry","../../../Graphic","../../../core/Accessor","../../../core/Collection","../../../core/Error","../../../core/has","../../../core/kebabDictionary","../../../core/Loadable","../../../core/Logger","../../../core/requireUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/typescript","../../../tasks/support/FeatureSet","module"],function(e,t,r,o,n,u,s,i,a,c,l,p,d,y,h,f,v,m,g,b){function F(e){var t=e.geometry,r=e.attributes;return{geometry:t&&"mesh"!==t.type?t&&t.toJSON():null,attributes:r}}Object.defineProperty(t,"__esModule",{value:!0});var E=l({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),S=d.getLogger("esri.layers.graphics.sources.MemorySource"),R=function(t){function s(){return null!==t&&t.apply(this,arguments)||this}return r(s,t),s.prototype.load=function(){var t=this;return this.addResolvingPromise(h.open(y.getAbsMid("./support/MemorySourceWorker",e,b),{client:this,strategy:c("esri-workers-for-memory-layers")?"dedicated":"local"}).then(function(e){t._connection=e;var r=t.layer,o=r.fields,n=r.spatialReference,u=r.geometryType,s=r.objectIdField,i=r.hasM,a=r.hasZ;return e.invoke("load",{features:t.items.map(F),fields:o&&o.map(function(e){return e.toJSON()}),geometryType:E.toJSON(u),hasM:i,hasZ:a,objectIdField:s,spatialReference:n&&n.toJSON()}).then(function(e){e.featureErrors.length&&S.warn("Encountered "+e.featureErrors.length+" validation errors while loading features",e.featureErrors),t.layerDefinition=e.layerDefinition})})),this.when()},s.prototype.applyEdits=function(e){var t=this;return this.load().then(function(){return t._applyEdits(e)})},s.prototype.openPorts=function(){var e=this;return this.load().then(function(){return e._connection.openPorts()})},s.prototype.queryFeatures=function(e){return this.queryFeaturesJSON(e).then(function(e){return g.fromJSON(e)})},s.prototype.queryFeaturesJSON=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryFeatures",e?e.toJSON():null)})},s.prototype.queryFeatureCount=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryFeatureCount",e?e.toJSON():null)})},s.prototype.queryObjectIds=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryObjectIds",e?e.toJSON():null)})},s.prototype.queryExtent=function(e){var t=this;return this.load().then(function(){return t._connection.invoke("queryExtent",e?e.toJSON():null)}).then(function(e){return{count:e.count,extent:n.Extent.fromJSON(e.extent)}})},s.prototype._applyEdits=function(e){var t=this;if(!this._connection)throw new a("feature-layer-source:edit-failure","Memory source not loaded");var r=this.layer.objectIdField,o=[],n=[],u=[];if(e.addFeatures)for(var s=0,i=e.addFeatures;s<i.length;s++){var c=i[s];o.push(F(c))}if(e.deleteFeatures)for(var l=0,p=e.deleteFeatures;l<p.length;l++){var d=p[l];"objectId"in d&&null!=d.objectId?n.push(d.objectId):"attributes"in d&&null!=d.attributes[r]&&n.push(d.attributes[r])}if(e.updateFeatures)for(var y=0,h=e.updateFeatures;y<h.length;y++){var c=h[y];u.push(F(c))}return this._connection.invoke("applyEdits",{adds:o,updates:u,deletes:n}).then(function(e){var r=e.fullExtent,o=e.featureEditResults;return t.fullExtent=r,t._createEditsResult(o)})},s.prototype._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[]}},s.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},o([m.shared({Type:u,ensureType:v.ensureType(u)})],s.prototype,"itemType",void 0),o([f.property({constructOnly:!0})],s.prototype,"layer",void 0),o([f.property()],s.prototype,"layerDefinition",void 0),s=o([f.subclass("esri.layers.graphics.sources.MemorySource")],s)}(f.declared(s,i,p));t.MemorySource=R,t.default=R});