// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/has","../../../../core/promiseUtils","../../../../geometry/support/jsonUtils","../../featureConversionUtils","../../data/DefaultSpatialIndex","../../data/projectionSupport","../../data/QueryEngine","../../../support/fieldUtils","../../../../tasks/support/Query"],function(e,t,r,i,n,s,a,u,o,l,p,d,f,c){function y(e){return u.isPoint(e)?null!=e.z:!!e.hasZ}function h(e){return u.isPoint(e)?null!=e.m:!!e.hasM}function g(e,t){if(s("csp-restrictions"))return function(){return i({},e)};var r="this."+t+" = null;";for(var n in e)r+="this."+n+" = "+JSON.stringify(e[n])+";";var a=new Function(r);return function(){return new a}}Object.defineProperty(t,"__esModule",{value:!0});var m={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0}},v=function(){function e(){this.code=null,this.description=null}return e}(),b=function(){function e(e){this.error=new v,this.globalId=null,this.objectId=null,this.success=!1,this.uniqueId=null,this.error.description=e}return e}(),_=function(){function e(e){this.globalId=null,this.success=!0,this.objectId=this.uniqueId=e}return e}(),I=function(){function e(){this._queryEngine=null,this._nextObjectId=null,this._fieldsMap=new Map}return e.prototype.load=function(e){var t=this,r=e.features,s=this._inferLayerProperties(r,e.fields),u=e.fields||[],o=null!=e.hasM?e.hasM:s.hasM,c=null!=e.hasZ?e.hasZ:s.hasZ,y=e.objectIdField||s.objectIdField,h=e.spatialReference||s.spatialReference,v=e.geometryType||s.geometryType;if(!h)return a.reject(new n("feature-layer:missing-property","spatialReference not set and couldn't be inferred from the provided features"));if(!v)return a.reject(new n("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features"));if(!y)return a.reject(new n("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields"));if(y&&!s.objectIdField){var b=null;u.some(function(e){return e.name===y&&(b=e,!0)})?(b.type="esriFieldTypeOID",b.editable=!1,b.nullable=!1):u.unshift({alias:y,name:y,type:"esriFieldTypeOID",editable:!1,nullable:!1})}var _={featureErrors:[],layerDefinition:i({},m,{extent:null,geometryType:v,objectIdField:y,fields:u,hasZ:!!c,hasM:!!o})};this._queryEngine=new d.default({fields:u,geometryType:v,hasM:o,hasZ:c,objectIdField:y,spatialReference:h,spatialIndex:new l.default({geometryType:v,hasM:o,hasZ:c})});var I={};this._requiredFieldNames=[];for(var F=0,E=u;F<E.length;F++){var j=E[F];if("esriFieldTypeOID"!==j.type&&"esriFieldTypeGlobalID"!==j.type){var x=f.getFieldDefaultValue(j);j.nullable||void 0!==x?I[j.name]=x:this._requiredFieldNames.push(j.name)}this._fieldsMap.set(j.name.trim(),j),this._fieldsMap.set(j.name.trim().toLowerCase(),j)}return this._createDefaultAttributes=g(I,y),r&&r.length?(this._nextObjectId=1+r.reduce(function(e,t){var r=t.attributes&&t.attributes[y];return null==r||isNaN(r)||!isFinite(r)?e:Math.max(e,r)},0),p.checkProjectionSupport(r,h).then(function(){return t._loadInitialFeatures(_,r)})):(this._nextObjectId=1,a.resolve(_))},e.prototype.applyEdits=function(e){var t=this,r=this._queryEngine.spatialReference;return p.checkProjectionSupport(e.adds,r).then(function(){return p.checkProjectionSupport(e.updates,r)}).then(function(){return t._applyEdits(e)})},e.prototype.queryFeatures=function(e){return this._queryEngine.executeQuery(c.fromJSON(e))},e.prototype.queryFeatureCount=function(e){return this._queryEngine.executeQueryForCount(c.fromJSON(e))},e.prototype.queryObjectIds=function(e){return this._queryEngine.executeQueryForIds(c.fromJSON(e))},e.prototype.queryExtent=function(e){return this._queryEngine.executeQueryForExtent(c.fromJSON(e))},e.prototype._inferLayerProperties=function(e,t){for(var r=void 0,i=void 0,n=null,s=null,a=null,o=0,l=e;o<l.length;o++){var p=l[o],d=p.geometry;if(d&&(n||(n=u.getJsonType(d)),s||(s=d.spatialReference),null==r&&(r=y(d)),null==i&&(i=h(d)),n&&s&&null!=r&&null!=i))break}if(t&&t.length){var f=null;t.some(function(e){return f=e,"esriFieldTypeOID"===e.type||e.name&&"objectid"===e.name.toLowerCase()})&&(a=f.name)}return{geometryType:n,spatialReference:s,objectIdField:a,hasM:i,hasZ:r}},e.prototype._loadInitialFeatures=function(e,t){for(var r=this._queryEngine,i=r.geometryType,n=r.hasM,s=r.hasZ,a=r.objectIdField,l=r.spatialReference,d=r.spatialIndex,f=[],c=0,y=t;c<y.length;c++){var h=y[c];if(h.geometry&&i!==u.getJsonType(h.geometry))e.featureErrors.push(new b("Incorrect geometry type."));else{var g=this._createDefaultAttributes(),m=this._mixAttributes(g,h.attributes,!1);m?e.featureErrors.push(m):(h.attributes=g,h.geometry&&(h.geometry=p.project(h.geometry,h.geometry.spatialReference,l)),f.push(h))}}return d.addMany(o.convertFromFeatures([],f,i,s,n,a)),e.layerDefinition.extent=this._queryEngine.fullExtent,e},e.prototype._applyEdits=function(e){var t=this._queryEngine.spatialIndex,r=e.adds,i=e.updates,n=e.deletes,s={addResults:[],deleteResults:[],updateResults:[]};if(r&&r.length&&this._applyAddEdits(s,r),i&&i.length&&this._applyUpdateEdits(s,i),n&&n.length){for(var a=0,u=n;a<u.length;a++){var o=u[a];s.deleteResults.push(new _(o))}t.removeManyById(n)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:s}},e.prototype._applyAddEdits=function(e,t){for(var r=e.addResults,i=this._queryEngine,n=i.geometryType,s=i.hasM,a=i.hasZ,l=i.objectIdField,d=i.spatialReference,f=i.spatialIndex,c=[],y=0,h=t;y<h.length;y++){var g=h[y];if(g.geometry&&n!==u.getJsonType(g.geometry))r.push(new b("Incorrect geometry type."));else{var m=this._createDefaultAttributes(),v=this._mixAttributes(m,g.attributes,!0);v?r.push(v):(g.attributes=m,g.geometry&&(g.geometry=p.project(g.geometry,g.geometry.spatialReference,d)),c.push(g),r.push(new _(g.attributes[l])))}}f.addMany(o.convertFromFeatures([],c,n,a,s,l))},e.prototype._applyUpdateEdits=function(e,t){for(var r=e.updateResults,i=this._queryEngine,n=i.geometryType,s=i.hasM,a=i.hasZ,l=i.objectIdField,d=i.spatialReference,f=i.spatialIndex,c=0,y=t;c<y.length;c++){var h=y[c],g=h.attributes,m=h.geometry,v=g&&g[l];if(null!=v)if(f.hasFeature(v)){var I=o.convertToFeature(f.getFeature(v),n,a,s);if(m){if(n!==u.getJsonType(m)){r.push(new b("Incorrect geometry type."));continue}I.geometry=p.project(m,m.spatialReference,d)}if(g){var F=this._mixAttributes(I.attributes,g,!1);if(F){r.push(F);continue}}f.add(o.convertFromFeature(I,n,a,s,l)),r.push(new _(v))}else r.push(new b("Feature with object id "+v+" missing"));else r.push(new b("Identifier field "+l+" missing"))}},e.prototype._mixAttributes=function(e,t,r){for(var i in t){var n=t[i],s=this._fieldsMap.get(i);if(s){if(s.editable){var a=f.validateFieldValue(s,n);if(a)return new b(f.validationErrorToString(a,s,n));e[s.name]=t[i]}}else if((s=this._fieldsMap.get(i.toLowerCase()))&&s.editable){var a=f.validateFieldValue(s,n);if(a)return new b(f.validationErrorToString(a,s,n));e[s.name]=t[i]}}for(var u=0,o=this._requiredFieldNames;u<o.length;u++){var l=o[u];if(void 0===e[l])return new b("missing required field "+l)}var p=this._queryEngine.objectIdField;return r?e[p]=this._nextObjectId++:e[p]||(e[p]=t&&null!=t[p]?t[p]:this._nextObjectId++),null},e}();t.default=I});