// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/dom-geometry","dojo/i18n!./Popup/nls/Popup","dojo/keys","../core/Handles","../core/lang","../core/Logger","../core/watchUtils","../core/accessorSupport/decorators","./Feature","./Spinner","./Widget","./Popup/PopupViewModel","./support/widget","./support/widgetUtils"],function(e,t,o,i,n,r,a,s,l,p,u,d,c,h,g,f,_,v,b){function y(e,t){return void 0===t?k+"__"+e:k+"__"+e+"-"+t}var w={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconFeatureMenu:"esri-icon-layer-list",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconZoom:"esri-icon-zoom-in-magnifying-glass",iconDefaultAction:"esri-icon-default-action",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerTitle:"esri-popup__header-title",headerTitleButton:"esri-popup__header-title--button",content:"esri-popup__content",featureButtons:"esri-popup__feature-buttons",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",navigationButtons:"esri-popup__navigation-buttons",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",paginationText:"esri-popup__pagination-page-text",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title"},m={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},k="esri-popup",M=u.getLogger("esri.widgets.Popup");return function(e){function t(t){var o=e.call(this)||this;return o._blurContainer=!1,o._containerNode=null,o._mainContainerNode=null,o._featureMenuNode=null,o._focusContainer=!1,o._focusDockButton=!1,o._focusFeatureMenuButton=!1,o._focusFirstFeature=!1,o._handles=new l,o._displayActionTextLimit=2,o._pointerOffsetInPx=16,o._spinner=null,o.actions=null,o.alignment="auto",o.autoCloseEnabled=null,o.content=null,o.collapsed=!1,o.collapseEnabled=!0,o.dockEnabled=!1,o.featureCount=null,o.features=null,o.featureNavigationEnabled=!0,o.goToOverride=null,o.highlightEnabled=null,o.location=null,o.featureWidgets=[],o.promises=null,o.selectedFeature=null,o.selectedFeatureIndex=null,o.selectedFeatureWidget=null,o.spinnerEnabled=!0,o.title=null,o.updateLocationEnabled=null,o.view=null,o.viewModel=new _,o.visible=null,o}return o(t,e),t.prototype.postInitialize=function(){var e=this;this._addSelectedFeatureIndexHandle(),this.own(d.watch(this,"viewModel.screenLocation",function(){return e._positionContainer()}),d.watch(this,["viewModel.visible","dockEnabled"],function(){return e._toggleScreenLocationEnabled()}),d.watch(this,"viewModel.screenLocation",function(t,o){!!t!=!!o&&e.reposition()}),d.watch(this,"viewModel.features",function(t){return e._createFeatureWidgets(t)}),d.watch(this,["viewModel.view.padding","viewModel.view.size","viewModel.visible","viewModel.waitingForResult","viewModel.location","alignment"],function(){return e.reposition()}),d.watch(this,"spinnerEnabled",function(t){return e._spinnerEnabledChange(t)}),d.watch(this,"viewModel.view.size",function(t,o){return e._updateDockEnabledForViewSize(t,o)}),d.watch(this,"viewModel.view",function(t,o){return e._viewChange(t,o)}),d.watch(this,"viewModel.view.ready",function(t,o){return e._viewReadyChange(t,o)}),d.watch(this,["viewModel.waitingForResult","viewModel.location"],function(){return e._displaySpinner()}),d.watch(this,["featureWidgets","viewModel.selectedFeatureIndex"],function(){return e._updateFeatureWidget()}),d.watch(this,"selectedFeatureWidget.viewModel.title",function(t){return e._setTitleFromFeatureWidget(t)}),d.watch(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],function(){return e._setContentFromFeatureWidget()}),d.on(this,"viewModel","trigger-action",function(t){return e._zoomToAction(t)}))},t.prototype.destroy=function(){this._destroyFeatureWidgets(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"currentAlignment",{get:function(){return this._getCurrentAlignment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentDockPosition",{get:function(){return this._getCurrentDockPosition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dockOptions",{get:function(){return this._get("dockOptions")||m},set:function(e){var t=n({},m),o=this.get("viewModel.view.breakpoints"),i={};o&&(i.width=o.xsmall,i.height=o.xsmall);var r=n({},t,e),a=n({},t.breakpoint,i),s=r.breakpoint;!0===s?r.breakpoint=a:"object"==typeof s&&(r.breakpoint=n({},a,s)),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureMenuOpen",{get:function(){return!!this.viewModel.visible&&this._get("featureMenuOpen")},set:function(e){this._set("featureMenuOpen",!!e)},enumerable:!0,configurable:!0}),t.prototype.blur=function(){this.visible||M.warn("Popup cannot be blurred while visible is false"),this._blurContainer=!0,this.scheduleRender()},t.prototype.clear=function(){},t.prototype.close=function(){this.visible=!1},t.prototype.focus=function(){this.visible||M.warn("Popup cannot be focused while visible is false"),this._focusContainer=!0,this.scheduleRender()},t.prototype.next=function(){return null},t.prototype.open=function(e){this._handles.remove("selected-index");var t=!!e&&!!e.featureMenuOpen,o={featureMenuOpen:t};this.set(o),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},t.prototype.previous=function(){return null},t.prototype.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},t.prototype.triggerAction=function(e){return null},t.prototype.render=function(){var e,t,o,i,n,r,s,l=this,u=l.collapsed,d=l.collapseEnabled,c=l.dockEnabled,h=l.featureMenuOpen,g=l.featureNavigationEnabled,f=l.featureWidgets,_=l.visible,m=this.viewModel,k=m.allActions,M=m.content,x=m.featureCount,F=m.pendingPromisesCount,C=m.selectedFeatureIndex,T=m.title,O=x>1&&g,D=x>1&&h,E=d&&!D&&u,A=k&&k.length,N=O&&this._getPageText(x,C),P=this._renderContent(),L=b.isRtl(),I=this.get("selectedFeatureWidget")?this.get("selectedFeatureWidget.viewModel.waitingForContent")||this.get("selectedFeatureWidget.viewModel.content"):P,W=c?a.undock:a.dock,R=this,B=R.currentAlignment,S=R.currentDockPosition,H=F?v.tsx("div",{key:y("loading-container"),role:"presentation",class:w.loadingContainer,"aria-label":a.loading,title:a.loading},v.tsx("span",{"aria-hidden":"true",class:this.classes(w.icon,w.iconLoading,w.rotating)})):null,U=(e={},e[w.iconFeatureMenu]=!D,e[w.iconClose]=D,e),V=v.tsx("span",{"aria-hidden":"true",class:this.classes(w.icon,U)}),z=(t={},t[w.iconRightTriangleArrow]=L,t[w.paginationPreviousIconRTL]=L,t[w.iconLeftTriangleArrow]=!L,t[w.paginationPreviousIconLTR]=!L,t),j=v.tsx("span",{"aria-hidden":"true",class:this.classes(w.icon,z)}),K=v.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(w.button,w.paginationPrevious),"aria-label":a.previous,title:a.previous},j),q=(o={},o[w.iconLeftTriangleArrow]=L,o[w.paginationNextIconRTL]=L,o[w.iconRightTriangleArrow]=!L,o[w.paginationNextIconLTR]=!L,o),Z=v.tsx("span",{"aria-hidden":"true",class:this.classes(w.icon,q)}),G=v.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(w.button,w.paginationNext),"aria-label":a.next,title:a.next},Z),J=b.cssTransition("enter",w.hasFeatureUpdated),Q=this.id+"-feature-menu",X=v.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(w.button,w.featureMenuButton),"aria-haspopup":"true","aria-controls":Q,"aria-expanded":h,"aria-label":a.menu,title:a.menu},V),Y=v.tsx("div",{class:w.paginationText},N),$=O?v.tsx("div",{class:w.navigationButtons,enterAnimation:J},K,Y,G,H||X):null,ee=this._wouldDockTo(),te=(i={},i[w.iconUndock]=c,i[w.iconDock]=!c,i[w.iconDockToRight]=!c&&("top-right"===ee||"bottom-right"===ee),i[w.iconDockToLeft]=!c&&("top-left"===ee||"bottom-left"===ee),i[w.iconDockToTop]=!c&&"top-center"===ee,i[w.iconDockToBottom]=!c&&"bottom-center"===ee,i),oe=v.tsx("span",{"aria-hidden":"true",class:this.classes(te,w.icon)}),ie=this.get("dockOptions.buttonEnabled")?v.tsx("div",{role:"button","aria-label":W,title:W,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(w.button,w.buttonDock)},oe):null,ne=d&&T&&(I||A||O),re=(n={},n[w.headerTitleButton]=ne,n),ae=ne?"button":"heading",se=ne?E?a.expand:a.collapse:"",le=this.id+"-popup-title",pe=T?v.tsx("h2",{class:this.classes(w.headerTitle,re),key:T,enterAnimation:J,id:le,role:ae,"aria-label":se,title:se,bind:this,tabIndex:ne?0:-1,onclick:this._toggleCollapsed,onkeydown:this._toggleCollapsed,innerHTML:T}):null,ue=v.tsx("span",{"aria-hidden":"true",class:this.classes(w.icon,w.iconClose)}),de=v.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:w.button,"aria-label":a.close,title:a.close},ue),ce=v.tsx("header",{class:w.header},pe,v.tsx("div",{class:w.headerButtons},ie,de)),he=this.id+"-popup-content",ge=I&&!E?v.tsx("article",{key:M,enterAnimation:J,id:he,class:w.content},P):null,fe=!E&&("bottom-left"===B||"bottom-center"===B||"bottom-right"===B||"top-left"===S||"top-center"===S||"top-right"===S),_e=!E&&("top-left"===B||"top-center"===B||"top-right"===B||"bottom-left"===S||"bottom-center"===S||"bottom-right"===S),ve=D?null:v.tsx("div",{key:y("actions"),class:w.actions},this._renderActions()),be=v.tsx("section",{key:y("navigation"),class:w.navigation},$),ye=O||A?v.tsx("div",{key:y("feature-buttons"),class:w.featureButtons},ve,be):null,we=this._renderFeatureMenuNode(f,C,D,Q),me=p.substitute({total:f.length},a.selectedFeatures),ke=v.tsx("section",{key:y("menu"),class:w.featureMenu},v.tsx("h2",{class:w.featureMenuHeader},me),v.tsx("nav",{class:w.featureMenuViewport,afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},we)),Me=c?null:v.tsx("div",{key:y("pointer"),class:w.pointer,role:"presentation"},v.tsx("div",{class:this.classes(w.pointerDirection,w.shadow)})),xe=this.get("selectedFeature.layer.title"),Fe=this.get("selectedFeature.layer.id"),Ce=(r={},r[w.shadow]=c,r),Te=(s={},s[w.alignTopCenter]=_&&"top-center"===B,s[w.alignBottomCenter]=_&&"bottom-center"===B,s[w.alignTopLeft]=_&&"top-left"===B,s[w.alignBottomLeft]=_&&"bottom-left"===B,s[w.alignTopRight]=_&&"top-right"===B,s[w.alignBottomRight]="bottom-right"===B,s[w.isDocked]=_&&c,s[w.shadow]=_&&!c,s[w.isDockedTopLeft]=_&&"top-left"===S,s[w.isDockedTopCenter]=_&&"top-center"===S,s[w.isDockedTopRight]=_&&"top-right"===S,s[w.isDockedBottomLeft]=_&&"bottom-left"===S,s[w.isDockedBottomCenter]=_&&"bottom-center"===S,s[w.isDockedBottomRight]=_&&"bottom-right"===S,s[w.isFeatureMenuOpen]=_&&D,s),Oe=fe?ke:null,De=_e?ke:null,Ee=fe?ye:null,Ae=_e?ye:null,Ne=v.tsx("div",{class:this.classes(w.main,w.widget,Ce),tabIndex:-1,role:"dialog","aria-labelledby":pe?le:"","aria-describedby":ge?he:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},Ee,Oe,ce,ge,Ae,De);return v.tsx("div",{key:y("base"),class:this.classes(w.base,Te),role:"presentation","data-layer-title":xe,"data-layer-id":Fe,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},_?[Ne,Me]:null)},t.prototype._featureMenuOpenChanged=function(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0},t.prototype._setTitleFromFeatureWidget=function(e){this.selectedFeatureWidget&&(this.viewModel.title=e||"")},t.prototype._setContentFromFeatureWidget=function(){var e=this.selectedFeatureWidget;e&&(this.viewModel.content=e)},t.prototype._handleFeatureMenuKeyup=function(e){e.keyCode===s.ESCAPE&&(e.stopPropagation(),this.featureMenuOpen=!1)},t.prototype._handleFeatureMenuItemKeyup=function(e){var t=e.keyCode,o=this._featureMenuNode,i=this.get("features.length"),n=e.currentTarget,r=n["data-feature-index"];if(o){var a=o.querySelectorAll("li");if(t===s.UP_ARROW){e.stopPropagation();var l=r-1,p=(l+i)%i;return void a[p].focus()}if(t===s.DOWN_ARROW){e.stopPropagation();var u=r+1,p=(u+i)%i;return void a[p].focus()}if(t===s.HOME){e.stopPropagation();return void a[0].focus()}if(t===s.END){e.stopPropagation();return void a[a.length-1].focus()}}},t.prototype._handleMainKeyup=function(e){var t=e.keyCode;t===s.LEFT_ARROW&&(e.stopPropagation(),this.previous()),t===s.RIGHT_ARROW&&(e.stopPropagation(),this.next())},t.prototype._zoomToAction=function(e){e.action&&!e.action.disabled&&"zoom-to"===e.action.id&&this.viewModel.zoomToLocation()},t.prototype._spinnerEnabledChange=function(e){if(this._destroySpinner(),e){var t=this.get("viewModel.view");this._createSpinner(t)}},t.prototype._displaySpinner=function(){var e=this._spinner;if(e){var t=this.viewModel,o=t.location;if(t.waitingForResult)return void e.show({location:o});e.hide()}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._renderAction=function(e,t,o,i){var n,r,s=this,l=d.watch(e,["active","className","disabled","id","title","image","visible"],function(){return s.scheduleRender()});this._handles.add(l,i);var u=this.get("selectedFeature.attributes");"zoom-to"===e.id&&(e.title=a.zoom,e.className=w.iconZoom);var c=e.title,h=e.className,g=e.image,f=g||h?h:w.iconDefaultAction,_=c&&u?p.substitute(u,c):c,b=f&&u?p.substitute(u,f):f,y=g&&u?p.substitute(u,g):g,m=(n={},n[w.iconLoading]=e.active,n[w.rotating]=e.active,n[w.icon]=!!f,n[w.actionImage]=!e.active&&!!y,n);b&&(m[b]=!e.active);var k=(r={},r[w.action]="toggle"!==e.type,r[w.actionToggle]="toggle"===e.type,r[w.actionToggleOn]="toggle"===e.type&&e.value,r[w.buttonDisabled]=e.disabled,r),M=o<=this._displayActionTextLimit?v.tsx("span",{key:"text",class:w.actionText},_):null;return e.visible?v.tsx("div",{key:e,role:"button",tabIndex:0,title:_,"aria-label":_,class:this.classes(w.button,k),bind:this,"data-action-index":t,onclick:this._triggerAction,onkeydown:this._triggerAction},v.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(w.icon,m),styles:this._getIconStyles(y)}),M):null},t.prototype._renderActions=function(){var e=this;this._handles.remove("actions");var t=this.viewModel.allActions;if(t){var o=t.length;return t.map(function(t,i){return e._renderAction(t,i,o,"actions")}).toArray()}},t.prototype._addSelectedFeatureIndexHandle=function(){var e=this,t=d.watch(this,"viewModel.selectedFeatureIndex",function(t,o){return e._selectedFeatureIndexUpdated(t,o)});this._handles.add(t,"selected-index")},t.prototype._selectedFeatureIndexUpdated=function(e,t){var o=this,i=o.featureCount,n=o.featureMenuOpen;i&&n&&e!==t&&-1!==e&&(this.featureMenuOpen=!1)},t.prototype._updateFeatureWidget=function(){var e=this.featureWidgets,t=this.viewModel.selectedFeatureIndex,o=e[t]||null;o&&!o.contentEnabled&&(o.contentEnabled=!0),this._set("selectedFeatureWidget",o)},t.prototype._destroyFeatureWidgets=function(){this.featureWidgets.forEach(function(e){return e.destroy()}),this._set("featureWidgets",[])},t.prototype._createFeatureWidgets=function(e){var t=this.featureWidgets,o=t.slice(0),i=this.get("viewModel.view"),n=[];e.forEach(function(e,t){if(e){var r=null;o.some(function(t,i){return t&&t.graphic===e&&(r=t,o.splice(i,1)),!!r}),n[t]=r||new h({contentEnabled:!1,graphic:e,view:i})}}),o.forEach(function(e){return e&&e.destroy()}),this._set("featureWidgets",n)},t.prototype._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},t.prototype._isOutsideView=function(e){var t=e.popupHeight,o=e.popupWidth,i=e.screenLocation,n=e.side,r=e.view;if(isNaN(o)||isNaN(t)||!r||!i)return!1;var a=r.padding;return"right"===n&&i.x+o/2>r.width-a.right||("left"===n&&i.x-o/2<a.left||("top"===n&&i.y-t<a.top||"bottom"===n&&i.y+t>r.height-a.bottom))},t.prototype._determineCurrentAlignment=function(){function e(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}var t=this,o=t._pointerOffsetInPx,i=t._containerNode,n=t._mainContainerNode,a=t.viewModel,s=a.screenLocation,l=a.view;if(!s||!l||!i)return"top-center";if(!this._isScreenLocationWithinView(s,l))return this._get("currentAlignment")||"top-center";var p=n?window.getComputedStyle(n,null):null,u=p?e(p.getPropertyValue("max-height")):0,d=p?e(p.getPropertyValue("height")):0,c=r.getContentBox(i),h=c.w+o,g=Math.max(c.h,u,d)+o,f=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"right",view:l}),_=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"left",view:l}),v=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"top",view:l}),b=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"bottom",view:l});return _?v?"bottom-right":"top-right":f?v?"bottom-left":"top-left":v?b?"top-center":"bottom-center":"top-center"},t.prototype._getCurrentAlignment=function(){var e=this,t=e.alignment;return e.dockEnabled?null:"auto"===t?this._determineCurrentAlignment():"function"==typeof t?t.call(this):t},t.prototype._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},t.prototype._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},t.prototype._getDockPosition=function(){var e=this.get("dockOptions.position");return"auto"===e?this._determineCurrentDockPosition():"function"==typeof e?e.call(this):e},t.prototype._getCurrentDockPosition=function(){return this.dockEnabled?this._getDockPosition():null},t.prototype._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},t.prototype._renderFeatureMenuItemNode=function(e,t,o,i){var n,r=t===o,s=(n={},n[w.featureMenuSelected]=r,n),l=r?v.tsx("span",{key:y("feature-menu-selected-feature-"+o),title:a.selectedFeature,"aria-label":a.selectedFeature,class:w.iconCheckMark}):null,p=v.tsx("span",{innerHTML:e.title||a.untitled});return v.tsx("li",{role:"menuitem",tabIndex:-1,key:y("feature-menu-feature-"+o),class:this.classes(s,w.featureMenuItem),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},v.tsx("span",{class:w.featureMenuTitle},p,l))},t.prototype._renderFeatureMenuNode=function(e,t,o,i){var n=this;return e.length>1?v.tsx("ol",{class:w.featureMenuList,id:i,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},e.map(function(e,i){return n._renderFeatureMenuItemNode(e,i,t,o)})):null},t.prototype._determineCurrentDockPosition=function(){var e=this.get("viewModel.view"),t=b.isRtl()?"top-left":"top-right";if(!e)return t;var o=e.padding||{left:0,right:0,top:0,bottom:0},i=e.width-o.left-o.right,n=e.get("breakpoints");return n&&i<=n.xsmall?"bottom-center":t},t.prototype._renderContent=function(){var e=this.get("viewModel.content");return"string"==typeof e?v.tsx("div",{key:e,innerHTML:e}):v.isWidget(e)?v.tsx("div",{key:e},e.render()):e instanceof HTMLElement?v.tsx("div",{key:e,bind:e,afterCreate:this._attachToNode}):v.isWidgetBase(e)?v.tsx("div",{key:e,bind:e.domNode,afterCreate:this._attachToNode}):void 0},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._positionContainer=function(e){if(void 0===e&&(e=this._containerNode),e&&(this._containerNode=e),e){var t=this.viewModel.screenLocation,o=r.getContentBox(e),i=this._calculatePositionStyle(t,o);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)}},t.prototype._calculateFullWidth=function(e){var t=this,o=t.currentAlignment,i=t._pointerOffsetInPx;return"top-left"===o||"bottom-left"===o||"top-right"===o||"bottom-right"===o?e+i:e},t.prototype._calculateAlignmentPosition=function(e,t,o,i){var n=this,r=n.currentAlignment,a=n._pointerOffsetInPx,s=i/2,l=o.height-t,p=o.width-e,u=this.view.padding;return"bottom-center"===r?{top:t+a-u.top,left:e-s-u.left}:"top-left"===r?{bottom:l+a-u.bottom,right:p+a-u.right}:"bottom-left"===r?{top:t+a-u.top,right:p+a-u.right}:"top-right"===r?{bottom:l+a-u.bottom,left:e+a-u.left}:"bottom-right"===r?{top:t+a-u.top,left:e+a-u.left}:"top-center"===r?{bottom:l+a-u.bottom,left:e-s-u.left}:void 0},t.prototype._calculatePositionStyle=function(e,t){var o=this,i=o.dockEnabled,n=o.view;if(n){if(i)return{left:"",top:"",right:"",bottom:""};if(e&&t){var r=this._calculateFullWidth(t.w),a=this._calculateAlignmentPosition(e.x,e.y,n,r);if(a)return{top:void 0!==a.top?a.top+"px":"auto",left:void 0!==a.left?a.left+"px":"auto",bottom:void 0!==a.bottom?a.bottom+"px":"auto",right:void 0!==a.right?a.right+"px":"auto"}}}},t.prototype._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},t.prototype._viewReadyChange=function(e,t){if(e){var o=this.get("viewModel.view");return void this._wireUpView(o)}t&&(this.close(),this.clear())},t.prototype._wireUpView=function(e){if(this._destroySpinner(),e){this.spinnerEnabled&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}},t.prototype._dockingThresholdCrossed=function(e,t,o){var i=e[0],n=e[1],r=t[0],a=t[1],s=o.width,l=o.height;return i<=s&&r>s||i>s&&r<=s||n<=l&&a>l||n>l&&a<=l},t.prototype._updateDockEnabledForViewSize=function(e,t){if(e&&t){var o=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,r=[],a=[];r[0]=e[0]-i,r[1]=e[1]-n,a[0]=t[0]-i,a[1]=t[1]-n;var s=this.dockOptions,l=s.breakpoint;this._dockingThresholdCrossed(r,a,l)&&this._setDockEnabledForViewSize(s),this._setCurrentDockPosition()}},t.prototype._focusDockButtonNode=function(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())},t.prototype._mainContainerNodeUpdated=function(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0},t.prototype._featureMenuNodeUpdated=function(e){if(this._featureMenuNode=e,e&&this._focusFirstFeature){this._focusFirstFeature=!1;var t=e.querySelectorAll("li");if(t.length){t[0].focus()}}},t.prototype._focusFeatureMenuButtonNode=function(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())},t.prototype._featureMenuViewportNodeUpdated=function(e){e&&(e.scrollTop=0)},t.prototype._toggleScreenLocationEnabled=function(){var e=this,t=e.dockEnabled,o=e.visible,i=e.viewModel;if(i){var n=o&&!t;i.screenLocationEnabled=n}},t.prototype._shouldDockAtCurrentViewSize=function(e){var t=e.breakpoint,o=this.get("viewModel.view.ui"),i=o.width,n=o.height;if(isNaN(i)||isNaN(n))return!1;var r=t.hasOwnProperty("width")&&i<=t.width,a=t.hasOwnProperty("height")&&n<=t.height;return r||a},t.prototype._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},t.prototype._getPageText=function(e,t){return p.substitute({index:t+1,total:e},a.pageText)},t.prototype._destroySpinner=function(){var e=this,t=e._spinner,o=e.view;t&&(o&&o.ui.remove(this._spinner,"popup-spinner"),t.destroy(),this._spinner=null)},t.prototype._createSpinner=function(e){e&&(this._spinner=new g({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))},t.prototype._toggleCollapsed=function(){this.collapsed=!this.collapsed},t.prototype._close=function(){this.close(),this.view&&this.view.focus()},t.prototype._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()},t.prototype._toggleFeatureMenu=function(){var e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.featureMenuOpen=e},t.prototype._triggerAction=function(e){var t=e.currentTarget,o=t["data-action-index"],i=this.viewModel.allActions.getItemAt(o);i&&"toggle"===i.type&&(i.value=!i.value),this.viewModel.triggerAction(o)},t.prototype._selectFeature=function(e){var t=e.currentTarget,o=t["data-feature-index"];isNaN(o)||(this.viewModel.selectedFeatureIndex=o)},t.prototype._next=function(){this.next()},t.prototype._previous=function(){this.previous()},i([c.aliasOf("viewModel.actions"),v.renderable()],t.prototype,"actions",void 0),i([c.property()],t.prototype,"alignment",void 0),i([c.aliasOf("viewModel.autoCloseEnabled")],t.prototype,"autoCloseEnabled",void 0),i([c.aliasOf("viewModel.content"),v.renderable()],t.prototype,"content",void 0),i([c.property(),v.renderable()],t.prototype,"collapsed",void 0),i([c.property(),v.renderable()],t.prototype,"collapseEnabled",void 0),i([c.property({readOnly:!0,dependsOn:["dockEnabled","alignment"]}),v.renderable()],t.prototype,"currentAlignment",null),i([c.property({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions"]}),v.renderable()],t.prototype,"currentDockPosition",null),i([c.property(),v.renderable()],t.prototype,"dockOptions",null),i([c.property(),v.renderable()],t.prototype,"dockEnabled",void 0),i([c.aliasOf("viewModel.featureCount"),v.renderable()],t.prototype,"featureCount",void 0),i([c.property({dependsOn:["viewModel.visible"]}),v.renderable()],t.prototype,"featureMenuOpen",null),i([c.aliasOf("viewModel.features"),v.renderable()],t.prototype,"features",void 0),i([c.property(),v.renderable()],t.prototype,"featureNavigationEnabled",void 0),i([c.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),i([c.aliasOf("viewModel.highlightEnabled")],t.prototype,"highlightEnabled",void 0),i([c.aliasOf("viewModel.location"),v.renderable()],t.prototype,"location",void 0),i([c.property({readOnly:!0}),v.renderable()],t.prototype,"featureWidgets",void 0),i([c.aliasOf("viewModel.promises")],t.prototype,"promises",void 0),i([c.aliasOf("viewModel.selectedFeature"),v.renderable()],t.prototype,"selectedFeature",void 0),i([c.aliasOf("viewModel.selectedFeatureIndex"),v.renderable()],t.prototype,"selectedFeatureIndex",void 0),i([c.property({readOnly:!0}),v.renderable()],t.prototype,"selectedFeatureWidget",void 0),i([c.property()],t.prototype,"spinnerEnabled",void 0),i([c.aliasOf("viewModel.title"),v.renderable()],t.prototype,"title",void 0),i([c.aliasOf("viewModel.updateLocationEnabled")],t.prototype,"updateLocationEnabled",void 0),i([c.aliasOf("viewModel.view")],t.prototype,"view",void 0),i([c.property({type:_}),v.renderable(["viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),v.vmEvent(["triggerAction","trigger-action"])],t.prototype,"viewModel",void 0),i([c.aliasOf("viewModel.visible"),v.renderable()],t.prototype,"visible",void 0),i([c.aliasOf("viewModel.clear")],t.prototype,"clear",null),i([c.aliasOf("viewModel.next")],t.prototype,"next",null),i([c.aliasOf("viewModel.previous")],t.prototype,"previous",null),i([c.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),i([v.accessibleHandler()],t.prototype,"_toggleCollapsed",null),i([v.accessibleHandler()],t.prototype,"_close",null),i([v.accessibleHandler()],t.prototype,"_toggleDockEnabled",null),i([v.accessibleHandler()],t.prototype,"_toggleFeatureMenu",null),i([v.accessibleHandler()],t.prototype,"_triggerAction",null),i([v.accessibleHandler()],t.prototype,"_selectFeature",null),i([v.accessibleHandler()],t.prototype,"_next",null),i([v.accessibleHandler()],t.prototype,"_previous",null),t=i([c.subclass("esri.widgets.Popup")],t)}(c.declared(f))});