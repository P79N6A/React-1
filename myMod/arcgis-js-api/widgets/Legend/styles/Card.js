// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../../nls/common","dojo/i18n!../../Legend/nls/Legend","dojox/gfx","../../../core/lang","../../../core/screenUtils","../../../core/accessorSupport/decorators","../../Widget","./common","../support/styleUtils","../../support/colorUtils","../../support/widget"],function(e,t,r,a,s,i,l,o,n,c,d,h,p,y,m){var g,u={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card esri-widget",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",hidden:"esri-hidden",header:"esri-widget__heading"},v="esri-legend--card__";!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}(g||(g={}));var _=function(e){return{width:n.pt2px(e.width),height:n.pt2px(e.height)}};return function(e){function t(t){var r=e.call(this)||this;return r._hasIndicators=!1,r._selectedSectionName=null,r._sectionNames=[],r._sectionMap=new Map,r.activeLayerInfos=null,r.layout=g.Stack,r.type="card",r.view=null,r}return r(t,e),t.prototype.render=function(){var e,t=this;this._sectionNames.length=0,this._hasIndicators=this.layout===g.Auto&&this.view.container.clientWidth<=768||this.layout===g.Stack;var r=this.activeLayerInfos,a=r&&r.toArray().map(function(e){return t._renderLegendForLayer(e)}).filter(function(e){return!!e});this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;var l=this._sectionNames.length,n=this._sectionNames.map(function(e,r){var a,i=o.substitute({index:r+1,total:l},s.pagination.pageText);return m.tsx("div",{key:e,"aria-label":i,title:i,tabIndex:0,onclick:t._selectSection,onkeydown:t._selectSection,bind:t,class:t.classes(u.indicator,(a={},a[u.activated]=t._selectedSectionName===e,a)),"data-section-name":e})}),c=this._hasIndicators?m.tsx("div",{class:u.indicatorContainer,key:"carousel-navigation"},n):null,d=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):a&&a.length?a:null,h=(e={},e[u.stacked]=this._hasIndicators,e);return m.tsx("div",{class:this.classes(u.base,h)},c,d||m.tsx("div",{class:u.message},i.noLegend))},t.prototype._selectSection=function(e){var t=e.target,r=t.getAttribute("data-section-name");r&&(this._selectedSectionName=r)},t.prototype._renderLegendForLayer=function(e){var t,r=this;if(!e.ready)return null;var a=!!e.children.length,s=""+v+e.layer.uid+"-version-"+e.version;if(a){var i=e.children.map(function(e){return r._renderLegendForLayer(e)}).toArray();return this._sectionNames.push(s),m.tsx("div",{key:e.layer.uid,class:this.classes(u.service,u.groupLayer)},m.tsx("div",{class:u.serviceCaptionContainer},e.title),i)}var l=e.legendElements;if(l&&!l.length)return null;var o=l.some(function(e){return"relationship-ramp"===e.type}),n=l.map(function(t){return r._renderLegendForElement(t,e.layer,o)}).filter(function(e){return!!e});if(!n.length)return null;var c=(t={},t[u.groupLayerChild]=!!e.parent,t);return m.tsx("div",{key:e.layer.uid,class:this.classes(u.service,c)},m.tsx("div",{class:u.serviceCaptionContainer},m.tsx("div",{class:u.serviceCaptionText},e.title)),m.tsx("div",{class:u.serviceContent},n))},t.prototype._renderLegendForElement=function(e,t,r){var a=this;void 0===r&&(r=!1);var s,i="color-ramp"===e.type,l="opacity-ramp"===e.type,o="size-ramp"===e.type,n=e.title,c=null;if("string"==typeof n)c=n;else if(n){var d=p.getTitle(n,i||l);c=n.title?n.title+" ("+d+")":d}var y=""+v+t.uid+"-type-"+e.type,g=this._hasIndicators?m.tsx("div",null,m.tsx("h3",{class:this.classes(u.header,u.carouselTitle)},t.title),m.tsx("h4",{class:this.classes(u.header,u.layerCaption)},c)):c?m.tsx("h4",{class:this.classes(u.header,u.layerCaption)},c):null,_=null;if("symbol-table"===e.type){var b=e.infos.map(function(r){return a._renderLegendForElementInfo(r,t,e.legendType)}).filter(function(e){return!!e});if(b.length){var x=b[0].properties.classes&&b[0].properties.classes[u.symbolRow],w=(s={},s[u.labelContainer]=!x&&!r,s[u.relationshipLabelContainer]=r,s);_=m.tsx("div",{key:y,class:u.section},g,m.tsx("div",{class:this.classes(w)},b))}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?_=m.tsx("div",{key:y,class:u.section},g,this._renderLegendForRamp(e)):o?_=m.tsx("div",{key:y,class:u.section},g,this._renderSizeRamps(e.infos)):"relationship-ramp"===e.type&&(_=m.tsx("div",{key:y,class:this.classes(u.section,u.relationshipSection)},g,h.renderRelationshipRamp(e,this.id)));return _?(this._sectionNames.push(y),this._sectionMap.set(y,_),_):null},t.prototype._renderLegendForElementInfo=function(e,t,r){var a,s,i;if(e.type)return this._renderLegendForElement(e,t);var l=p.isImageryStretchedLegend(t,r);if(e.symbol&&e.preview){if(-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return m.tsx("div",{bind:e.preview,afterCreate:p.attachToNode});var o=(a={},a[u.symbolCell]=this._hasIndicators,a);return m.tsx("div",{class:this.classes(u.layerRow,(s={},s[u.symbolRow]=this._hasIndicators,s))},m.tsx("div",{class:this.classes(o),bind:e.preview,afterCreate:p.attachToNode}),m.tsx("div",{class:this.classes(u.imageLabel,(i={},i[u.labelCell]=this._hasIndicators,i))},p.getTitle(e.label,!1)||""))}var n=255,c=255,d=255,h=0,g=255,v=255,_=255,b=0,x=e.symbol.color&&e.symbol.color.a,w=e.symbol.outline&&e.symbol.outline.color.a;x&&(n=e.symbol.color.r,c=e.symbol.color.g,d=e.symbol.color.b,h=e.symbol.color.a),w&&(g=e.symbol.outline.color.r,v=e.symbol.outline.color.g,_=e.symbol.outline.color.b,b=e.symbol.outline.color.a);var f=y.isBright(e.symbol.color),S=f?"black":"white",L=f?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",C={background:x?"rgba("+n+", "+c+", "+d+", "+h+")":"none",color:S,textShadow:"-1px -1px 0 "+L+",\n                                              1px -1px 0 "+L+",\n                                              -1px 1px 0 "+L+",\n                                              1px 1px 0 "+L,border:w?"1px solid rgba("+g+", "+v+", "+_+", "+b+")":"none"};return m.tsx("div",{class:u.layerRow},m.tsx("div",{key:e.label,class:u.labelElement,styles:C}," ",e.label," "))}if(e.src){var k=this._renderImage(e,t,l);return m.tsx("div",{class:u.layerRow},k,m.tsx("div",{class:u.imageLabel},e.label||""))}},t.prototype._renderImage=function(e,t,r){var a,s=e.label,i=e.src,l=e.opacity,o=(a={},a[u.imageryLayerStretchedImage]=r,a[u.symbol]=!r,a),n={opacity:""+(null!=l?l:t.opacity)};return m.tsx("img",{alt:s,src:i,border:0,width:e.width,height:e.height,class:this.classes(o),styles:n})},t.prototype._renderSizeRamps=function(e){var t,r,a,s,i=document.createElement("div"),o=e[e.length-1].symbol.color,c=e[0].label,d=e[e.length-1].label,h=e[0].symbol.style&&"circle"===e[0].symbol.style;try{if(this._hasIndicators)if(s=100,h){var y=n.pt2px(e[0].symbol.size),g=n.pt2px(e[e.length-1].symbol.size),v=y/2,b=g/2;a=2*v+2;var x=s-v-b,w=Math.sqrt(Math.pow(x,2)-Math.pow(v-b,2)),f=v*w/x,S=v+f,L=v+Math.sqrt(Math.pow(v,2)-Math.pow(f,2)),C=b*f/v,k=v+C,M=s-(b-Math.sqrt(Math.pow(b,2)-Math.pow(C,2))),I=v-f,R=v-C;r=l.createSurface(i,a,s),r.createCircle({cx:v,cy:v,r:v}).setFill(o).setStroke({color:"#ddd",width:1}),r.createCircle({cx:v,cy:s-b,r:b}).setFill(o).setStroke({color:"#ddd",width:1}),r.createLine({x1:S,y1:L,x2:k,y2:M}).setStroke({color:"#ddd",width:1}),r.createLine({x1:I,y1:L,x2:R,y2:M}).setStroke({color:"#ddd",width:1})}else{var N=_(e[0].symbol),F=N.width,z=N.height,E=_(e[e.length-1].symbol),T=E.width,q=E.height,A=Math.max(F,z),j=Math.max(T,q);a=A,r=l.createSurface(i,a,s),r.createRect({x:0,y:0,height:A,width:A}).setStroke({color:"#ddd",width:1}),r.createRect({x:A/2-j/2,y:s-j,height:j,width:j}).setStroke({color:"#ddd",width:1}),r.createImage({src:e[0].symbol.url,height:A,width:A}),r.createImage({src:e[e.length-1].symbol.url,height:j,width:j,y:s-j,x:A/2-j/2}),r.createLine({x1:0,y1:A,x2:A/2-j/2,y2:s-j}).setStroke({color:"#ddd",width:1}),r.createLine({x1:a,y1:A,x2:A/2+j/2,y2:s-j}).setStroke({color:"#ddd",width:1})}else{if(a=180,h){var y=n.pt2px(e[0].symbol.size),g=n.pt2px(e[e.length-1].symbol.size),v=y/2,b=g/2;s=2*v;var x=a-v-b,w=Math.sqrt(Math.pow(x,2)-Math.pow(v-b,2)),f=v*w/x,H=v-f,O=a-(v+Math.sqrt(Math.pow(v,2)-Math.pow(f,2))),C=b*f/v,U=v-C,B=b-Math.sqrt(Math.pow(b,2)-Math.pow(C,2)),P=v+f,W=v+C;r=l.createSurface(i,a,s),r.createCircle({cx:a-v,cy:v,r:v}).setFill(o).setStroke({color:"#ddd",width:1}),r.createCircle({cx:b,cy:v,r:b}).setFill(o).setStroke({color:"#ddd",width:1}),r.createLine({x1:O,y1:H,x2:B,y2:U}).setStroke({color:"#ddd",width:1}),r.createLine({x1:O,y1:P,x2:B,y2:W}).setStroke({color:"#ddd",width:1})}else{var Z=_(e[0].symbol),F=Z.width,z=Z.height,D=_(e[e.length-1].symbol),T=D.width,q=D.height,A=Math.max(F,z),j=Math.max(T,q);s=A,r=l.createSurface(i,a,s),r.createRect({x:0,y:A/2-j/2,height:j,width:j}).setStroke({color:"#ddd",width:1}),r.createRect({x:a-A,y:0,height:A,width:A}).setStroke({color:"#ddd",width:1}),r.createImage({src:e[e.length-1].symbol.url,height:j,width:j,y:A/2-j/2}),r.createImage({src:e[0].symbol.url,height:A,width:A,x:a-A}),r.createLine({x1:j,y1:A/2-j/2,x2:a-A,y2:0}).setStroke({color:"#ddd",width:1}),r.createLine({x1:j,y1:A/2+j/2,x2:a-A,y2:A}).setStroke({color:"#ddd",width:1})}var G=c;c=d,d=G}}catch(e){r.clear(),r.destroy()}return r?m.tsx("div",{class:this.classes(u.layerRow,(t={},t[u.sizeRampRow]=this._hasIndicators,t))},m.tsx("div",{class:u.rampLabel},c),m.tsx("div",{class:u.sizeRampContainer},m.tsx("div",{bind:i,afterCreate:p.attachToNode})),m.tsx("div",{class:u.rampLabel},d)):null},t.prototype._renderLegendForRamp=function(e){var t=e.infos,r="heatmap-ramp"===e.type,a=t.length-1,s=a>2&&!r?25*a:100,o=s+20,n=document.createElement("div");n.style.width=o+"px";var c=l.createSurface(n,o,25),d=t.slice(0).reverse();try{d.forEach(function(e,t){e.offset=r?e.ratio:t/a}),r||c.createPath("M0 12.5 L10 0 L10 25 Z").setFill(d[0].color).setStroke(null),c.createRect({x:10,y:0,width:s,height:25}).setFill({type:"linear",x1:10,y1:0,x2:s+10,y2:0,colors:d}).setStroke(null),r||c.createPath("M"+(s+10)+" 0 L"+o+" 12.5 L"+(s+10)+" 25 Z").setFill(d[d.length-1].color).setStroke(null)}catch(e){c.clear(),c.destroy()}if(!c)return null;var h=d.filter(function(e,t){return!!e.label&&0!==t&&t!==d.length-1}).map(function(e){return m.tsx("div",{class:u.intervalSeparatorsContainer},m.tsx("div",{class:u.intervalSeparator},"|"),m.tsx("div",{class:u.rampLabel},e.label))}),y=t[t.length-1].label,g=t[0].label;return m.tsx("div",{class:u.layerRow},m.tsx("div",{class:u.rampLabel},r?i[y]:y),m.tsx("div",{class:u.symbolContainer},m.tsx("div",{bind:n,afterCreate:p.attachToNode}),h),m.tsx("div",{class:u.rampLabel},r?i[g]:g))},a([m.renderable(),c.property()],t.prototype,"activeLayerInfos",void 0),a([c.property()],t.prototype,"layout",void 0),a([c.property({readOnly:!0})],t.prototype,"type",void 0),a([c.property()],t.prototype,"view",void 0),a([m.accessibleHandler()],t.prototype,"_selectSection",null),t=a([c.subclass("esri.widgets.Legend.styles.Card")],t)}(c.declared(d))});