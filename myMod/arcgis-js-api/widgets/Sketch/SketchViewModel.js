// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Graphic","../../core/Accessor","../../core/Evented","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/2d/draw/support/Box","../../views/2d/draw/support/GraphicMover","../../views/2d/draw/support/Reshape","./support/sketchUtils"],function(e,t,i,r,n,o,a,c,s,p,l,h,y,u,v,m,d,f,_,g){var w=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),r([l.property()],t.prototype,"reset",void 0),t=r([l.subclass()],t)}(l.declared(a,c)),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=null,t}return i(t,e),r([l.property()],t.prototype,"type",void 0),r([l.property()],t.prototype,"canUndo",void 0),r([l.property()],t.prototype,"canRedo",void 0),r([l.property()],t.prototype,"complete",void 0),r([l.property()],t.prototype,"cancel",void 0),r([l.property()],t.prototype,"undo",void 0),r([l.property()],t.prototype,"redo",void 0),t=r([l.subclass()],t)}(l.declared(a,c)),G={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape"},E=function(){function e(e){this.tool=e,this.type="create-init"}return e}(),x=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create-start"}return e}(),b=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create"}return e}(),C=function(){function e(e){this.tool=e,this.type="create-cancel"}return e}(),P=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create-complete"}return e}(),k=function(){function e(e){this.geometry=e,this.type="update-init"}return e}(),R=function(){function e(e){this.geometry=e,this.type="update"}return e}(),K=function(){function e(e){this.geometry=e,this.type="update-cancel"}return e}(),L=function(){function e(e){this.geometry=e,this.type="update-complete"}return e}(),M=function(){function e(){this.type="reset"}return e}(),O=function(){function e(e,t){this.geometry=e,this.angle=t,this.type="rotate-start"}return e}(),H=function(){function e(e,t){this.geometry=e,this.angle=t,this.type="rotate"}return e}(),T=function(){function e(e,t){this.geometry=e,this.angle=t,this.type="rotate-complete"}return e}(),U=function(){function e(e,t,i){this.geometry=e,this.xScale=t,this.yScale=i,this.type="scale-start"}return e}(),A=function(){function e(e,t,i){this.geometry=e,this.xScale=t,this.yScale=i,this.type="scale"}return e}(),V=function(){function e(e,t,i){this.geometry=e,this.xScale=t,this.yScale=i,this.type="scale-complete"}return e}(),z=function(){function e(e,t,i){this.geometry=e,this.dx=t,this.dy=i,this.type="move-start"}return e}(),F=function(){function e(e,t,i){this.geometry=e,this.dx=t,this.dy=i,this.type="move"}return e}(),I=function(){function e(e,t,i){this.geometry=e,this.dx=t,this.dy=i,this.type="move-complete"}return e}(),j=function(){function e(e){this.geometry=e,this.type="reshape-start"}return e}(),q=function(){function e(e){this.geometry=e,this.type="reshape"}return e}(),B=function(){function e(e){this.geometry=e,this.type="reshape-complete"}return e}(),D=function(){function e(e){this.geometry=e,this.type="undo"}return e}(),N=function(){function e(e){this.geometry=e,this.type="redo"}return e}();return function(e){function t(t){var i=e.call(this,t)||this;return i._activeLineGraphic=null,i._centerGraphic=null,i._centerSymbol=new v({type:"simple-marker",style:"circle",size:3,color:[255,255,255],outline:{color:[100,100,100]}}),i._defaultGraphicsLayer=null,i._defaultSegmentOffset=48,i._handles=new s,i._lineGraphic=null,i._operationHandle=null,i._targetGraphic=null,i._vertexGraphics=[],i.activeFillSymbol=new y({type:"simple-fill",style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),i.activeLineSymbol=new u({type:"simple-line",color:[12,207,255,1],width:2,style:"dash"}),i.activePointSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),i.draw=null,i.graphic=null,i.hoverVertexSymbol=new v({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.layer=null,i.pointSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),i.polygonSymbol=new y({type:"simple-fill",color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),i.polylineSymbol=new u({type:"simple-line",color:[130,130,130],width:2}),i.selectedVertexSymbol=new v({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),i.updatePointSymbol=new v({type:"simple-marker",size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),i.updatePolygonSymbol=new y({type:"simple-fill",color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),i.updatePolylineSymbol=new u({type:"simple-line",color:[12,207,255],width:2}),i.vertexSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.view=null,i}return i(t,e),t.prototype.initialize=function(){var e=this;this._handles.add([p.whenOnce(this,"view.ready",function(){e._set("draw",new m({view:e.view}))}),p.when(this,"layer",function(){e._defaultGraphicsLayer&&(e.view&&e.view.map.remove(e._defaultGraphicsLayer),e._defaultGraphicsLayer.destroy(),e._defaultGraphicsLayer=null)}),p.whenNot(this,"layer",function(t){e._defaultGraphicsLayer=new h({listMode:"hide"}),e.view&&e.view.map.add(e._defaultGraphicsLayer)}),p.pausable(this,"layer",function(t,i){i&&(e._clearGraphics(i),i.remove(e.graphic)),e.reset()})])},t.prototype.destroy=function(){this.reset(),this._handles.removeAll(),this._handles=null,this._defaultGraphicsLayer&&(this.view&&this.view.map.remove(this._defaultGraphicsLayer),this._defaultGraphicsLayer.destroy(),this._defaultGraphicsLayer=null),this.draw&&this.draw.destroy(),this._set("draw",null),this._set("view",null),this.emit("destroy")},Object.defineProperty(t.prototype,"_layer",{get:function(){return this.layer||this._defaultGraphicsLayer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.get("view.ready"),t=this._operationHandle;return e&&t?"create"===t.type?"creating":"updating":e?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete(),this.draw.reset()},t.prototype.create=function(e,t){var i=this;this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null;var r;switch(e){case"point":r=this._createPointOperation(t);break;case"polygon":r=this._createPolygonOperation(t);break;case"polyline":r=this._createPolylineOperation(t);break;case"multipoint":r=this._createMultipointOperation(t);break;case"rectangle":r=this._createRectangleOperation(t);break;case"circle":r=this._createCircleOperation(t);break;case"ellipse":r=this._createEllipseOperation(t);break;case"triangle":r=this._createTriangleOperation(t)}if(r)return r.on("complete",function(){r===i._operationHandle&&(i._operationHandle=null,i._emitCreateCompleteEvent(e))}),r.on("cancel",function(){r===i._operationHandle&&(i._operationHandle=null,i._emitCreateCancelEvent(e))}),this._operationHandle=r,this._emitCreateInitEvent(e),r},t.prototype.reset=function(){this._clearGraphics(),this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,this.graphic&&(this._layer&&this._layer.remove(this.graphic),this._set("graphic",null)),this.view.container.style.cursor="default",this.draw.reset(),this._emitResetEvent()},t.prototype.update=function(e,t){var i=this;if(this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,!this._layer||!e||!e.geometry)return null;var r;switch(e.geometry.type){case"point":r=this._updatePointOperation(e,t);break;case"polyline":case"polygon":r=this._updateOperation(e,t)}return r?(r.on("complete",function(){r===i._operationHandle&&(i._operationHandle=null,i._emitUpdateCompleteEvent())}),r.on("cancel",function(){r===i._operationHandle&&(i._operationHandle=null,i._emitUpdateCancelEvent())}),this._operationHandle=r,this._emitUpdateInitEvent(),r):null},t.prototype.undo=function(){this._operationHandle&&this._operationHandle.canUndo()&&this._operationHandle.undo()},t.prototype.redo=function(){this._operationHandle&&this._operationHandle.canRedo()&&this._operationHandle.redo()},t.prototype._createPointOperation=function(e){var t=this,i=this.draw.create("point",e),r=null,a=[i.on("cursor-update",function(e){r=t._displayCrosshairCursor()}),i.on("draw-complete",function(e){t._layer.remove(t.graphic);var i=e.coordinates,r=i[0],a=i[1];t._set("graphic",new o(new n.Point({x:r,y:a,spatialReference:t.view.spatialReference}),t.pointSymbol)),c&&c.complete()})],c=new S({type:"create",complete:function(){t._layer.remove(t.graphic),r&&r.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("complete")},cancel:function(){t._layer.remove(t.graphic),r&&r.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("cancel")}});return c},t.prototype._createPolygonOperation=function(e){var t=this,i="polygon",r=this.draw.create(i,e),a=new n.Point,c=null,s=null,p=!1,l=[r.on("vertex-add",function(e){var r=e.vertices;s=e,p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,!1),1===r.length?t._emitCreateStartEvent(i):t._emitCreateEvent(i)}),r.on("vertex-remove",function(e){var r=e.vertices;s=e,p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,!1),t._emitCreateEvent(i)}),r.on("vertex-update",function(e){var r=e.vertices;s=e,p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,!1),t._emitCreateEvent(i)}),r.on("cursor-update",function(e){var i=e.vertices,r=e.native;s=e,t.view.toMap(r.x,r.y,a),p&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!0)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new o(g.createPolygon([e.vertices],t.view),t.polygonSymbol)),h&&h.complete()}),r.on("undo",function(e){var i=e.vertices,r=s&&"cursor-update"===s.type;if(!i.length)return void t._clearGraphics();p&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,r)}),r.on("redo",function(e){var i=e.vertices,r=s&&"cursor-update"===s.type;p&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,r)}),this.view.on("key-down",function(e){var i=r.vertices.slice(0),n=s&&"cursor-update"===s.type;e.key!==G.constraintKey||p?e.key===G.undoKey&&h&&h.canUndo()?(e.stopPropagation(),h.undo()):e.key===G.redoKey&&h&&h.canRedo()?(e.stopPropagation(),h.redo()):e.key===G.cancelKey&&h&&h.cancel():(p=!0,n&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,n))}),this.view.on("key-up",function(e){var i=r.vertices.slice(0),n=s&&"cursor-update"===s.type;e.key===G.constraintKey&&(p=!1,i.pop(),i.push([a.x,a.y]),t._showPolygonGraphic(i,n))}),this.view.on("pointer-down",function(e){t.view.hitTest(e).then(function(i){var r=i.results;if(r.length&&r[0].graphic){var n=r[0].graphic;0===t._vertexGraphics.indexOf(n)&&e.stopPropagation()}})}),this.view.on("click",function(e){t.view.hitTest(e).then(function(i){var n=i.results;if(n.length&&n[0].graphic){var o=n[0].graphic;0===t._vertexGraphics.indexOf(o)&&t._vertexGraphics.length>2&&(e.stopPropagation(),s&&"cursor-update"===s.type&&r.vertices.pop(),r.complete())}})}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){c=t._displayCrosshairCursor()})})],h=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("cancel")},undo:function(){r&&r.undo(),t._emitUndoEvent()},redo:function(){r&&r.redo(),t._emitRedoEvent()},canUndo:function(){return r&&r.canUndo()},canRedo:function(){return r&&r.canRedo()}});return h},t.prototype._createPolylineOperation=function(e){var t=this,i="polyline",r=this.draw.create(i,e),a=new n.Point,c=null,s=null,p=!1,l=[r.on("vertex-add",function(e){var r=e.vertices;c=e,p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,!1),1===r.length?t._emitCreateStartEvent(i):t._emitCreateEvent(i)}),r.on("vertex-remove",function(e){var r=e.vertices;c=e,p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,!1),t._emitCreateEvent(i)}),r.on("vertex-update",function(e){var r=e.vertices;c=e,p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,!1),t._emitCreateEvent(i)}),r.on("cursor-update",function(e){var i=e.vertices,r=e.native;c=e,t.view.toMap(r.x,r.y,a),p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!0)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new o(g.createPolyline([e.vertices],t.view),t.polylineSymbol)),h&&h.complete()}),r.on("undo",function(e){var i=e.vertices,r=c&&"cursor-update"===c.type;if(!i.length)return void t._clearGraphics();p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,r)}),r.on("redo",function(e){var i=e.vertices,r=c&&"cursor-update"===c.type;p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,r)}),this.view.on("key-down",function(e){var i=r.vertices.slice(0),n=c&&"cursor-update"===c.type;e.key!==G.constraintKey||p?e.key===G.undoKey&&h&&h.canUndo()?(e.stopPropagation(),h.undo()):e.key===G.redoKey&&h&&h.canRedo()?(e.stopPropagation(),h.redo()):e.key===G.cancelKey&&h&&h.cancel():(p=!0,n&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,n))}),this.view.on("key-up",function(e){var i=r.vertices.slice(0),n=c&&"cursor-update"===c.type;e.key===G.constraintKey&&(p=!1,i.pop(),i.push([a.x,a.y]),t._showPolylineGraphic(i,n))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){s=t._displayCrosshairCursor()})})],h=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),s&&s.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),s&&s.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("cancel")},undo:function(){r&&r.undo(),t._emitUndoEvent()},redo:function(){r&&r.redo(),t._emitRedoEvent()},canUndo:function(){return r&&r.canUndo()},canRedo:function(){return r&&r.canRedo()}});return h},t.prototype._createRectangleOperation=function(e){var t=this,i="rectangle",r=this.draw.create(i,e),n=null,a=!1,c=!1,s=[r.on("vertex-add",function(e){var r=e.vertices;t._showRectangleGraphic(r,c,a),1===r.length?t._emitCreateStartEvent(i):t._emitCreateEvent(i)}),r.on("cursor-update",function(e){t._showRectangleGraphic(e.vertices,c,a)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic);var i=e.vertices.slice(0);if(1===i.length){a=!1,c=!1;var r=t.view.toScreen(i[0][0],i[0][1],null),n=t.view.toMap(r.x-t._defaultSegmentOffset,r.y+t._defaultSegmentOffset),s=t.view.toMap(r.x+t._defaultSegmentOffset,r.y-t._defaultSegmentOffset);i=[[n.x,n.y],[s.x,s.y]]}var l=a?g.createSquare(i,t.view,c):g.createRectangle(i,t.view,c);t._set("graphic",new o(l,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?e.key!==G.centerKey||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showRectangleGraphic(r.vertices,c,a)):(a=!0,t._showRectangleGraphic(r.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showRectangleGraphic(r.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showRectangleGraphic(r.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){n=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),n&&n.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),n&&n.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")},undo:function(){},redo:function(){},canUndo:function(){return!1},canRedo:function(){return!1}});return p},t.prototype._createMultipointOperation=function(e){var t=this,i="multipoint",r=this.draw.create(i,e),n=null,a=[r.on("vertex-add",function(e){var r=e.vertices;t._showMultipointGraphic(r),1===r.length?t._emitCreateStartEvent(i):t._emitCreateEvent(i)}),r.on("vertex-remove",function(e){t._showMultipointGraphic(e.vertices),t._emitCreateEvent(i)}),r.on("vertex-update",function(e){t._showMultipointGraphic(e.vertices),t._emitCreateEvent(i)}),r.on("cursor-update",function(e){t._showMultipointGraphic(e.vertices)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new o(g.createMultipoint(e.vertices,t.view),t.pointSymbol)),c&&c.complete()}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){n=t._displayCrosshairCursor()})}),this.view.on("key-down",function(e){e.key===G.cancelKey&&c&&c.cancel()})],c=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),n&&n.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),n&&n.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("cancel")},undo:function(){r&&r.undo(),t._emitUndoEvent()},redo:function(){r&&r.undo(),t._emitUndoEvent()},canUndo:function(){return!1},canRedo:function(){return!1}});return c},t.prototype._createCircleOperation=function(e){var t=this,i=this.draw.create("circle",e),r=null,a=!1,c=!1,s=[i.on("vertex-add",function(e){var i=e.vertices;t._showCircleGraphic(i,c,a),1===i.length?t._emitCreateStartEvent("circle"):t._emitCreateEvent("circle")}),i.on("cursor-update",function(e){t._showCircleGraphic(e.vertices,c,a)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){a=!1,c=!0;var s=t.view.toScreen(r[0][0],r[0][1],null),l=new n.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});r.push(i.getCoordsFromScreenPoint(l))}var h=a?g.createEllipse(r,t.view,c):g.createCircle(r,t.view,c);t._set("graphic",new o(h,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?e.key!==G.centerKey||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showCircleGraphic(i.vertices,c,a)):(a=!0,t._showCircleGraphic(i.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showCircleGraphic(i.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showCircleGraphic(i.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")},undo:function(){},redo:function(){},canUndo:function(){return!1},canRedo:function(){return!1}});return p},t.prototype._createEllipseOperation=function(e){var t=this,i=this.draw.create("ellipse",e),r=null,a=!1,c=!1,s=[i.on("vertex-add",function(e){var i=e.vertices;t._showEllipseGraphic(e.vertices,c,a),1===i.length?t._emitCreateStartEvent("ellipse"):t._emitCreateEvent("ellipse")}),i.on("cursor-update",function(e){t._showEllipseGraphic(e.vertices,c,a)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){a=!0,c=!0;var s=t.view.toScreen(r[0][0],r[0][1],null),l=new n.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});r.push(i.getCoordsFromScreenPoint(l))}var h=a?g.createCircle(r,t.view,c):g.createEllipse(r,t.view,c);t._set("graphic",new o(h,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?"Alt"!==e.key||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showEllipseGraphic(i.vertices,c,a)):(a=!0,t._showEllipseGraphic(i.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showEllipseGraphic(i.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showEllipseGraphic(i.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")},undo:function(){},redo:function(){},canUndo:function(){return!1},canRedo:function(){return!1}});return p},t.prototype._createTriangleOperation=function(e){var t=this,i="triangle",r=this.draw.create(i,e),a=null,c=!1,s=!1,p=[r.on("vertex-add",function(e){var r=e.vertices;t._showTriangleGraphic(e.vertices,s,c),1===r.length?t._emitCreateStartEvent(i):t._emitCreateEvent(i)}),r.on("cursor-update",function(e){t._showTriangleGraphic(e.vertices,s,c)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic);var i=e.vertices.slice(0);if(1===i.length){c=!0,s=!0;var a=t.view.toScreen(i[0][0],i[0][1],null),p=new n.ScreenPoint({x:a.x+t._defaultSegmentOffset,y:a.y});i.push(r.getCoordsFromScreenPoint(p))}t._set("graphic",new o(g.createTriangle(i,t.view,s,c),t.polygonSymbol)),l&&l.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||c?e.key!==G.centerKey||s?e.key===G.cancelKey&&l&&l.cancel():(s=!0,t._showTriangleGraphic(r.vertices,s,c)):(c=!0,t._showTriangleGraphic(r.vertices,s,c))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(c=!1,t._showTriangleGraphic(r.vertices,s,c)):e.key===G.centerKey&&(s=!1,t._showTriangleGraphic(r.vertices,s,c))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){a=t._displayCrosshairCursor()})})],l=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),a&&a.reset(),p.forEach(function(e){return e.remove()}),t.draw.reset(),l.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),a&&a.reset(),p.forEach(function(e){return e.remove()}),t.draw.reset(),l.emit("cancel")},undo:function(){},redo:function(){},canUndo:function(){return!1},canRedo:function(){return!1}});return l},t.prototype._updatePointOperation=function(e,t){var i=this,r=[],n=[],a=null,c=new o(e.geometry,this.updatePointSymbol);this._layer.add(c),this._set("graphic",c.clone());var s=new f({graphics:[c],view:this.view,callbacks:{onGraphicMoveStart:function(e){n=[],r.push({geometry:i.graphic.geometry}),i._emitMoveStartEvent(e.dx,e.dy)},onGraphicMove:function(e){i._set("graphic",e.graphic),i._emitMoveEvent(e.dx,e.dy)},onGraphicMoveStop:function(e){i._set("graphic",e.graphic),i._emitMoveCompleteEvent(e.dx,e.dy)},onGraphicPointerOver:function(e){a=i._displayPointerCursor()},onGraphicPointerOut:function(e){a&&a.reset(),a=null}}}),p=[this.view.on("click",function(t){i.view.hitTest(t).then(function(t){var i=t.results;i.length&&i[0].graphic&&i[0].graphic===c||(c.geometry!==e.geometry?l&&l.complete():l&&l.cancel())})}),this.view.on("key-down",function(t){t.key===G.undoKey?l&&l.undo():t.key===G.redoKey?l&&l.redo():t.key===G.cancelKey&&(i.graphic.geometry!==e.geometry?l&&l.complete():l&&l.cancel())})],l=new S({type:"update",complete:function(){s.destroy(),i._layer.remove(c),p.forEach(function(e){return e.remove()}),a&&a.reset(),r=[],n=[],i.draw.reset(),i.graphic.geometry=c.geometry,l.emit("complete")},cancel:function(){s.destroy(),i._layer.remove(c),p.forEach(function(e){return e.remove()}),a&&a.reset(),r=[],n=[],i.draw.reset(),i.graphic.geometry=c.geometry,l.emit("cancel")},undo:function(){if(l.canUndo()){var e=r.pop();n.push({geometry:i.graphic.geometry}),i.graphic.geometry=e.geometry,i._emitUndoEvent()}},redo:function(){if(l.canRedo()){var e=n.pop();r.push({geometry:i.graphic.geometry}),i.graphic.geometry=e.geometry,i._emitRedoEvent()}},canUndo:function(){return r.length>0},canRedo:function(){return n.length>0}});return l},t.prototype._updateOperation=function(e,t){var i=this,r="polygon"===e.geometry.type?this.updatePolygonSymbol:this.updatePolylineSymbol,n=[],a=[];this._set("graphic",new o(e.geometry,r)),this._layer.add(this.graphic);var c=new d({graphic:this.graphic,layer:this._layer,view:this.view,callbacks:{onMoveStart:function(e){a=[],n.push({geometry:i.graphic.geometry}),i._emitMoveStartEvent(e.dx,e.dy)},onMove:function(e){i._set("graphic",e.graphic),i._emitMoveEvent(e.dx,e.dy)},onMoveStop:function(e){i._set("graphic",e.graphic),i._emitMoveCompleteEvent(e.dx,e.dy)},onScaleStart:function(e){a=[],n.push({geometry:i.graphic.geometry}),i._emitScaleStartEvent(e.xScale,e.yScale)},onScale:function(e){i._set("graphic",e.graphic),i._emitScaleEvent(e.xScale,e.yScale)},onScaleStop:function(e){i._set("graphic",e.graphic),i._emitScaleCompleteEvent(e.xScale,e.yScale)},onRotateStart:function(e){a=[],n.push({geometry:i.graphic.geometry}),i._emitRotateStartEvent(e.angle)},onRotate:function(e){i._set("graphic",e.graphic),i._emitRotateEvent(e.angle)},onRotateStop:function(e){i._set("graphic",e.graphic),i._emitRotateCompleteEvent(e.angle)}}}),s=new _({graphic:null,layer:this._layer,view:this.view,callbacks:{onReshapeStart:function(e){a=[],n.push({geometry:i.graphic.geometry}),i._emitReshapeStartEvent()},onReshape:function(e){i._set("graphic",e.graphic),i._emitReshapeEvent()},onReshapeStop:function(e){i._set("graphic",e.graphic),i._emitReshapeCompleteEvent()},onMoveStart:function(e){a=[],n.push({geometry:i.graphic.geometry}),i._emitMoveStartEvent(e.dx,e.dy)},onMove:function(e){i._set("graphic",e.graphic),i._emitMoveEvent(e.dx,e.dy)},onMoveStop:function(e){i._set("graphic",e.graphic),i._emitMoveCompleteEvent(e.dx,e.dy)},onVertexAdd:function(e){i._set("graphic",e.graphic),a=[],n.push({geometry:e.oldGraphic.geometry}),i._emitUpdateEvent()},onVertexRemove:function(e){i._set("graphic",e.graphic),a=[],n.push({geometry:e.oldGraphic.geometry}),i._emitUpdateEvent()}}}),p=c,l=[this.view.on("click",function(t){i.view.hitTest(t).then(function(t){t.results.some(function(e){if(e.graphic&&p.graphics.indexOf(e.graphic)>-1)return p.graphic=null,p instanceof d?p=s:p instanceof _&&(p=c),p.graphic=i.graphic,!0})||h&&(i.graphic.geometry!==e.geometry?h.complete():h.cancel())})}),this.view.on("key-down",function(t){t.key===G.undoKey?h&&h.undo():t.key===G.redoKey?h&&h.redo():t.key===G.cancelKey&&h?i.graphic.geometry!==e.geometry?h.complete():h.cancel():t.key===G.constraintKey&&c&&!t.repeat&&c.set("uniformScaling",!0)}),this.view.on("key-up",function(e){e.key===G.constraintKey&&c&&c.set("uniformScaling",!1)})],h=new S({type:"update",complete:function(){if(c&&c.destroy(),s&&s.destroy(),i._layer.remove(i.graphic),i.graphic.symbol=e.symbol,l.forEach(function(e){return e.remove()}),n=[],a=[],"polygon"===e.geometry.type){var t=g.createPolygon(i.graphic.geometry.rings,i.view);i.graphic.geometry=t}h.emit("complete")},cancel:function(){c&&c.destroy(),s&&s.destroy(),i._layer.remove(i.graphic),i.graphic.symbol=e.symbol,l.forEach(function(e){return e.remove()}),n=[],a=[],h.emit("cancel")},undo:function(){if(h.canUndo()){var e=n.pop();a.push({geometry:i.graphic.geometry}),i.graphic.geometry=e.geometry,p.refresh(),i._emitUndoEvent()}},redo:function(){if(h.canRedo()){var e=a.pop();n.push({geometry:i.graphic.geometry}),i.graphic.geometry=e.geometry,p.refresh(),i._emitRedoEvent()}},canUndo:function(){return n.length>0},canRedo:function(){return a.length>0}});return h},t.prototype._showPolygonGraphic=function(e,t){var i=this;if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1],s=new o(new n.Point(a,c,this.view.spatialReference),this.activePointSymbol);return t||(this._vertexGraphics.push(s),this._layer.add(s)),void this._set("graphic",s)}var p,l;if(2===e.length?(p=g.createPolyline([e],this.view),l=this.polylineSymbol):(p=g.createPolygon([e],this.view),l=this.polygonSymbol,this._targetGraphic=new o(p,this.activeFillSymbol),this._layer.add(this._targetGraphic)),this._set("graphic",new o(p,l)),t){var h=e.map(function(e){return Array.apply([],e)}),y=h.pop(),u=[h[h.length-1],y];this._lineGraphic=new o(g.createPolyline([h],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),this._activeLineGraphic=new o(g.createPolyline(u,this.view),this.activeLineSymbol),this._layer.add(this._activeLineGraphic),h.forEach(function(e,t){var r=t===h.length-1?i.activePointSymbol:i.pointSymbol,a=new o({geometry:new n.Point({x:e[0],y:e[1],spatialReference:i.view.spatialReference}),symbol:r});i._vertexGraphics.push(a),i._layer.add(a)})}else this._lineGraphic=new o(g.createPolyline([e],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),e.forEach(function(t,r){var a=r===e.length-1?i.activePointSymbol:i.pointSymbol,c=new o({geometry:new n.Point({x:t[0],y:t[1],spatialReference:i.view.spatialReference}),symbol:a});i._vertexGraphics.push(c),i._layer.add(c)})},t.prototype._showPolylineGraphic=function(e,t){var i=this;if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1];return void this._set("graphic",new o(new n.Point(a,c,this.view.spatialReference),this.pointSymbol))}if(this._set("graphic",new o(g.createPolyline([e],this.view),this.polylineSymbol)),t){var s=e.map(function(e){return Array.apply([],e)}),p=s.pop(),l=[s[s.length-1],p];this._lineGraphic=new o(g.createPolyline(s,this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),this._activeLineGraphic=new o(g.createPolyline(l,this.view),this.activeLineSymbol),this._layer.add(this._activeLineGraphic),s.forEach(function(e,t){var r=t===s.length-1?i.activePointSymbol:i.pointSymbol,a=new o({geometry:new n.Point({x:e[0],y:e[1],spatialReference:i.view.spatialReference}),symbol:r});i._vertexGraphics.push(a),i._layer.add(a)})}else this._lineGraphic=new o(g.createPolyline([e],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),e.forEach(function(t,r){var a=r===e.length-1?i.activePointSymbol:i.pointSymbol,c=new o({geometry:new n.Point({x:t[0],y:t[1],spatialReference:i.view.spatialReference}),symbol:a});i._vertexGraphics.push(c),i._layer.add(c)})},t.prototype._showRectangleGraphic=function(e,t,i){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1];return void this._set("graphic",new o(new n.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=i?g.createSquare(e,this.view,t):g.createRectangle(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new o(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._showMultipointGraphic=function(e){this._layer.remove(this.graphic),this._set("graphic",new o(g.createMultipoint(e,this.view),this.pointSymbol)),this._layer.add(this.graphic)},t.prototype._showCircleGraphic=function(e,t,i){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1];return void this._set("graphic",new o(new n.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=i?g.createEllipse(e,this.view,t):g.createCircle(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new o(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._showEllipseGraphic=function(e,t,i){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1];return void this._set("graphic",new o(new n.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=i?g.createCircle(e,this.view,t):g.createEllipse(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new o(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._showTriangleGraphic=function(e,t,i){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var r=e[0],a=r[0],c=r[1]
;return void this._set("graphic",new o(new n.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=g.createTriangle(e,this.view,t,i);this._toggleCenterGraphic(s),this._set("graphic",new o(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._toggleCenterGraphic=function(e){this._layer&&this._layer.remove(this._centerGraphic),this._centerGraphic=null,e&&e.extent&&e.extent.center&&(this._centerGraphic=new o(e.extent.center,this._centerSymbol),this._layer&&this._layer.add(this._centerGraphic))},t.prototype._clearGraphics=function(e){var t=e||this._layer;this._toggleCenterGraphic(),t&&(t.remove(this._targetGraphic),t.remove(this._lineGraphic),t.remove(this._activeLineGraphic),t.removeMany(this._vertexGraphics)),this._targetGraphic=null,this._lineGraphic=null,this._activeLineGraphic=null,this._vertexGraphics=[]},t.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),i=e[e.length-1],r=this.view.toScreen(t[0],t[1],null),n=this.view.toScreen(i[0],i[1],null),o=Math.abs(r.x-n.x),a=Math.abs(r.y-n.y),c=this.view.toMap(o>a?r.x:n.x,o>a?n.y:r.y);e.push([c.x,c.y])}},t.prototype._displayCrosshairCursor=function(){return"crosshair"!==this.view.container.style.cursor&&(this.view.container.style.cursor="crosshair"),this._getResetCursorHandle()},t.prototype._displayPointerCursor=function(){return"pointer"!==this.view.container.style.cursor&&(this.view.container.style.cursor="pointer"),this._getResetCursorHandle()},t.prototype._getResetCursorHandle=function(){var e=this;return new w({reset:function(){"default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default")}})},t.prototype._emitCreateStartEvent=function(e){this.emit("create-start",new x(e,this.graphic.geometry))},t.prototype._emitCreateEvent=function(e){this.emit("create",new b(e,this.graphic.geometry))},t.prototype._emitCreateCompleteEvent=function(e){this.emit("create-complete",new P(e,this.graphic.geometry.clone()))},t.prototype._emitCreateCancelEvent=function(e){this.emit("create-cancel",new C(e))},t.prototype._emitCreateInitEvent=function(e){this.emit("create-init",new E(e))},t.prototype._emitUpdateCompleteEvent=function(){this.emit("update-complete",new L(this.graphic.geometry))},t.prototype._emitUpdateEvent=function(){this.emit("update",new R(this.graphic.geometry))},t.prototype._emitUpdateInitEvent=function(){this.emit("update-init",new k(this.graphic.geometry))},t.prototype._emitUpdateCancelEvent=function(){this.emit("update-cancel",new K(this.graphic.geometry))},t.prototype._emitResetEvent=function(){this.emit("reset",new M)},t.prototype._emitReshapeStartEvent=function(){this.emit("reshape-start",new j(this.graphic.geometry))},t.prototype._emitReshapeEvent=function(){this.emit("reshape",new q(this.graphic.geometry))},t.prototype._emitReshapeCompleteEvent=function(){this.emit("reshape-complete",new B(this.graphic.geometry))},t.prototype._emitMoveStartEvent=function(e,t){this.emit("move-start",new z(this.graphic.geometry,e,t))},t.prototype._emitMoveEvent=function(e,t){this.emit("move",new F(this.graphic.geometry,e,t))},t.prototype._emitMoveCompleteEvent=function(e,t){this.emit("move-complete",new I(this.graphic.geometry,e,t))},t.prototype._emitScaleStartEvent=function(e,t){this.emit("scale-start",new U(this.graphic.geometry,e,t))},t.prototype._emitScaleEvent=function(e,t){this.emit("scale",new A(this.graphic.geometry,e,t))},t.prototype._emitScaleCompleteEvent=function(e,t){this.emit("scale-complete",new V(this.graphic.geometry,e,t))},t.prototype._emitRotateStartEvent=function(e){this.emit("rotate-start",new O(this.graphic.geometry,e))},t.prototype._emitRotateEvent=function(e){this.emit("rotate",new H(this.graphic.geometry,e))},t.prototype._emitRotateCompleteEvent=function(e){this.emit("rotate-complete",new T(this.graphic.geometry,e))},t.prototype._emitUndoEvent=function(){this.emit("undo",new D(this.graphic.geometry))},t.prototype._emitRedoEvent=function(){this.emit("redo",new N(this.graphic.geometry))},r([l.property()],t.prototype,"_defaultGraphicsLayer",void 0),r([l.property({dependsOn:["layer","_defaultGraphicsLayer"]})],t.prototype,"_layer",null),r([l.property()],t.prototype,"_operationHandle",void 0),r([l.property()],t.prototype,"activeFillSymbol",void 0),r([l.property()],t.prototype,"activeLineSymbol",void 0),r([l.property()],t.prototype,"activePointSymbol",void 0),r([l.property({readOnly:!0})],t.prototype,"draw",void 0),r([l.property({readOnly:!0})],t.prototype,"graphic",void 0),r([l.property()],t.prototype,"hoverVertexSymbol",void 0),r([l.property()],t.prototype,"layer",void 0),r([l.property()],t.prototype,"pointSymbol",void 0),r([l.property()],t.prototype,"polygonSymbol",void 0),r([l.property()],t.prototype,"polylineSymbol",void 0),r([l.property()],t.prototype,"selectedVertexSymbol",void 0),r([l.property({dependsOn:["view.ready","_operationHandle"],readOnly:!0})],t.prototype,"state",null),r([l.property()],t.prototype,"view",void 0),t=r([l.subclass("esri.widgets.Sketch.SketchViewModel")],t)}(l.declared(a,c))});