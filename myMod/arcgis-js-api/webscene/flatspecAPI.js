// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../Basemap","../Ground","../WebScene","../core/JSONSupport","../core/MultiOriginJSONSupport","../core/accessorSupport/ensureType","../core/accessorSupport/extensions/serializableProperty/type","../layers/GroupLayer","../layers/mixins/OperationalLayer"],function(e,t,n,r,a,s,u,i,o,p,c,l,y){function h(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=new D,[4,N({typeName:"json",type:e},t)];case 1:return n.sent(),r=t.flatProperties,r.sort(function(e,t){return e.path.localeCompare(t.path)}),[2,r]}})})}function f(e){return r(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return t=new D({classPaths:{},cacheEnabled:!1}),[4,N({typeName:"json",type:e},t)];case 1:return n.sent(),[2,t.classPaths]}})})}function d(e,t){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:switch(r=e.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,g(e,t)];case 2:return n.sent(),[3,12];case 3:return[4,w(e,t)];case 4:return n.sent(),[3,12];case 5:return[4,N(e,t)];case 6:return n.sent(),[3,12];case 7:return[4,m(e,t)];case 8:return n.sent(),[3,12];case 9:return[4,b(e,t)];case 10:return n.sent(),[3,12];case 11:n.label=12;case 12:return[2]}})})}function m(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){return t.addProperty({path:t.pathString,type:k(e)}),[2]})})}function v(e){var t=e.slice();return t.sort(),t}function b(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){return t.addProperty({path:t.pathString,type:k(e),enum:v(e.values).map(function(e){return""+e}).join("|")}),[2]})})}function g(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return t.pushPath(t.popPath()+"[]"),[4,d(e.elementType,t)];case 1:return n.sent(),[2]}})})}function P(e){return q[e]||e}function w(e,t){return r(this,void 0,void 0,function(){var r,a,s,u,i,o;return n(this,function(n){switch(n.label){case 0:r=t.pathString,a=t.popPath(),s=[],u=0,i=e.types,n.label=1;case 1:return u<i.length?(o=i[u],"native"!==o.type.typeName?[3,2]:(s.push(o.type),[3,4])):[3,5];case 2:return t.pushPath(a+"<"+P(o.value)+">"),[4,d(o.type,t)];case 3:n.sent(),t.popPath(),n.label=4;case 4:return u++,[3,1];case 5:return s.length&&t.addProperty({type:s.map(k).join("|"),path:r}),t.pushPath(a),[2]}})})}function S(e,t,i){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return e.type!==u||"layers"!==t?[3,2]:[4,T("web-scene/operational-layers")];case 1:return[2,n.sent()];case 2:return e.type!==a||"baseLayers"!==t?[3,4]:[4,T("web-scene/basemap")];case 3:return[2,n.sent()];case 4:return e.type!==s||"layers"!==t?[3,6]:[4,T("web-scene/ground")];case 5:return[2,n.sent()];case 6:return e.type!==l||"layers"!==t?[3,8]:[4,T("web-scene/operational-layers",function(e){return e!==l})];case 7:return[2,n.sent()];case 8:return[2,x(i)]}})})}function N(e,t){return r(this,void 0,void 0,function(){var r,a,s,u,i,o,p,c,l,y,h,f,d,m,v,b,g,P,w,N;return n(this,function(n){switch(n.label){case 0:if(r=e.type.__accessorMetadata__,a=e.type.prototype.declaredClass.replace(/\./g,"/"),s=r&&r.properties,a&&t.classPaths&&(t.classPaths[t.pathString]=a),!s)return t.addProperty({path:t.pathString,type:"unknown"}),[2];if(u=t.seen.get(e.type)){for(i=0,o=u;i<o.length;i++)p=o[i],t.pushPath(p.path),t.addProperty({path:t.pathString,type:p.type}),t.popPath();return[2]}c=t.flatProperties.length,l=t.pathString,y=[];for(h in s)y.push(h);f=0,n.label=1;case 1:return f<y.length?(d=y[f],m=s[d],(v=L(m))&&v.enabled?(b=v.target,"string"!=typeof b&&null!=b?[3,4]:[4,S(e,d,m)]):[3,6]):[3,7];case 2:return g=n.sent(),g?[4,j(g,"string"==typeof b?b:d,t)]:[3,6];case 3:return n.sent(),[3,6];case 4:return[4,C(b,t)];case 5:n.sent(),n.label=6;case 6:return f++,[3,1];case 7:if(t.flatProperties.length===c)return t.addProperty({path:t.pathString,type:"unknown"}),[2];for(P=[],w=c;w<t.flatProperties.length;w++)N=t.flatProperties[w],P.push({path:N.path.slice(l.length+1),type:N.type});return t.addSeen(e.type,P),[2]}})})}function j(e,t,a){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return a.pushPath(t),[4,d(e,a)];case 1:return n.sent(),a.popPath(),[2]}})})}function C(e,t){return r(this,void 0,void 0,function(){var r,a,s;return n(this,function(n){for(r in e)a=e[r],s=void 0,s=a.types?O(a.types):B(a.type),j(s,r,t);return[2]})})}function T(e,t){return r(this,void 0,void 0,function(){var r,a,s,u,i,o,p,c;return n(this,function(n){switch(n.label){case 0:r=y.supportedTypes[e],a={typeName:"union",key:"layerType",types:[]},s=[];for(u in r)s.push(u);i=0,n.label=1;case 1:return i<s.length?(o=s[i],[4,y.typeModuleMap[o]()]):[3,4];case 2:if(!(p=n.sent()))return[3,3];if(t&&!t(p))return[3,3];a.types.push({type:{typeName:"json",type:p},value:o}),n.label=3;case 3:return i++,[3,1];case 4:return 0===a.types.length?[2,null]:(c={typeName:"array",elementType:1===a.types.length?a.types[0].type:a},[2,c])}})})}function k(e){switch(e.typeName){case"array":return k(e.elementType)+"[]";case"union":return""+e.types.map(function(e){return k(e.type)}).join(" | ");case"native":switch(e.type){case Number:return"number";case p.Integer:return"integer";case String:return"string";case Boolean:return"boolean";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string"}}function M(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:B(t)};if(t.typeMap){var n=[];for(var r in t.typeMap){var a=t.typeMap[r];n.push({type:B(a),value:A(a)?null:r})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:n}}}}function x(e){return e.types?O(e.types):_(e)}function O(e){if(Array.isArray(e))return{typeName:"array",elementType:O(e[0])};var t=[];for(var n in e.typeMap){var r=e.typeMap[n];t.push({type:B(r),value:A(r)?null:n})}return 1===t.length?t[0].type:{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function _(e){return B(e.json&&e.json.type||e.type)}function B(e){return e?Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:{typeName:"array",elementType:B(e[0])}:c.isCollection(e)?M(e):A(e)?{typeName:"native",type:e}:R(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function R(e){var t=e._meta&&e._meta.bases;return!!t&&(-1!==t.indexOf(i)||-1!==t.indexOf(o))}function A(e){return e===String||e===Boolean||e===Number||e===p.Integer}function L(e){if(!e.json)return null;var t=e.json.origins,n=e.json.write,r=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return r||a||n||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=h,t.collectClassPaths=f;var q={"unique-value":"uniqueValue","class-breaks":"classBreaks","point-3d":"PointSymbol3D","line-3d":"LineSymbol3D","mesh-3d":"MeshSymbol3D","polygon-3d":"PolygonSymbol3D","label-3d":"LabelSymbol3D","web-style":"styleSymbolReference",text:"Text",object:"Object",icon:"Icon",fill:"Fill",extrude:"Extrude",line:"Line",path:"Path","point-cloud-class-breaks":"pointCloudClassBreaksRenderer","point-cloud-rgb":"pointCloudRGBRenderer","point-cloud-stretch":"pointCloudStretchRenderer","point-cloud-unique-value":"pointCloudUniqueValueRenderer","fixed-size":"pointCloudFixedSizeAlgorithm",splat:"pointCloudSplatAlgorithm",bitfield:"pointCloudBitfieldFilter",return:"pointCloudReturnFilter",value:"pointCloudValueFilter"},D=function(){function e(e){this.flatProperties=[],this.path=[],this.seen=new Map,e&&e.classPaths&&(this.classPaths=e.classPaths),this.cacheEnabled=!(!e||!e.cacheEnabled)}return e.prototype.addProperty=function(e){this.flatProperties.push(e)},e.prototype.addSeen=function(e,t){this.cacheEnabled&&this.seen.set(e,t)},e.prototype.pushPath=function(e){this.path.push(e)},e.prototype.popPath=function(){return this.path.pop()},Object.defineProperty(e.prototype,"pathString",{get:function(){return this.path.join(".")},enumerable:!0,configurable:!0}),e}()});