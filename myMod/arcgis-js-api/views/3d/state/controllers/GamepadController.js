// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/runtimeUtils","../../camera/constraintUtils","../../lib/gl-matrix","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/viewUtils","../../../3d/support/earthUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../support/mathUtils","../../webgl-engine/lib/Camera","../../../navigation/gamepadUtils"],function(t,e,a,i,r,n,o,s,c,l,d,p,v,m,u,h){function f(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,n.mat4d.identity(t.pan.matrix),t.rotate.enabled=!1,n.mat4d.identity(t.rotate.matrix)}Object.defineProperty(e,"__esModule",{value:!0});var y=function(t){function e(e,a){var i=t.call(this)||this;return i.view=e,i.device=a,i.transformation={translation:[0,0,0],heading:0,tilt:0},i.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new u,interactionFactor:0,interactionDirection:null,tiltMode:1},i}return a(e,t),e.prototype.handleEvent=function(t){var e=h.extractTransformation(t,this.view.navigation.gamepad,this.transformation);if("end"===t.action||h.isZeroTransformation(e))return void this.finishController()},e.prototype.onControllerStart=function(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,t.prototype.onControllerStart.call(this,e)},e.prototype.updateFilteredSurfaceElevation=function(t){var e=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(e-this.filteredSurfaceElevation)*t},e.prototype.stepController=function(e,a){this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(a),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,k),this.applyPan(k.pan),this.applyRotate(k.rotate),this.applyZoom(k.zoom),this.applyAscend(k.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,r.applyAll(this.view,this.currentCamera,this.constraintOptions),t.prototype.stepController.call(this,e,a)},e.prototype.applyRotate=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.up,o=e.eye;n.vec3d.subtract(a,o),n.mat4d.multiplyVec3(t.matrix,a),n.vec3d.add(a,o),n.mat4d.multiplyVec3(t.matrix,i),e.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,r.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyPan=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.eye,o=e.up;n.mat4d.multiplyVec3(t.matrix,i),n.mat4d.multiplyVec3(t.matrix,a);this.view.state.isGlobal&&n.mat4d.multiplyVec3(t.matrix,o),e.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,r.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyZoom=function(t){if(t){var e=this.currentCamera,a=e.eye,i=e.viewForward;n.vec3d.add(a,n.vec3d.scale(i,t,F)),this.currentCamera.markViewDirty(),this.constraintOptions.interactionDirection=n.vec3d.negate(n.vec3d.set(i,G)),this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,r.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.applyAscend=function(t){if(t){var e=this.currentCamera,a=e.center,i=e.eye;this.view.renderCoordsHelper.worldUpAtPosition(i,A),this.constraintOptions.interactionDirection=n.vec3d.set(A,G);if(this.view.state.isGlobal){var o=n.vec3d.length(i),s=(o+t)/o;n.vec3d.scale(i,s),n.vec3d.scale(a,s)}else{var c=n.vec3d.scale(A,t,M);n.vec3d.add(i,c),n.vec3d.add(a,c)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,r.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,r.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.calculateControlTransformation=function(t,e,a){f(a);var r=this.computeVelocities(t);switch(this.view.viewingMode){case"local":this.calculateControlTransformationLocal(r,e,a);break;case"global":this.calculateControlTransformationGlobal(r,e,a);break;default:i.neverReached(this.view.viewingMode)}},e.prototype.updateCameraCenter=function(){var t=this.currentCamera,e=t.eye,a=t.viewForward,i=t.center,r=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.centerOnManifoldSilhouetteFallback(this.view.renderCoordsHelper,e,a,r,i),this.currentCamera.markViewDirty()},e.prototype.calculateControlTransformationLocal=function(t,e,a){var r=e.viewRight,s=e.viewForward,c=this.transformation,d=this.view.navigation.gamepad;n.vec3d.set3(s[0],s[1],0,x),n.vec3d.normalize(x);var p=c.translation[0]*t.pan;switch(0!==p&&(n.vec3d.scale(r,p,D),n.mat4d.translate(a.pan.matrix,D),a.pan.enabled=!0),n.vec3d.set3(0,0,0,F),d.mode){case"pan":var v=-c.translation[1]*t.pan;0!==v&&(n.vec3d.scale(x,v,F),n.mat4d.translate(a.pan.matrix,F),a.pan.enabled=!0);break;case"zoom":a.zoom=-c.translation[1]*t.zoom;break;default:i.neverReached(d.mode)}var u=c.translation[2]*t.ascend;a.ascend=u;var h=-c.heading*t.rotate;0!==h&&(n.mat4d.rotate(a.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,A)),a.rotate.enabled=!0);var f=c.tilt*t.rotate,y=l.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),w=m.clamp(y+f,o.TiltDefault.min,o.TiltDefault.max)-y;w&&(n.mat4d.rotate(a.rotate.matrix,w,r),a.rotate.enabled=!0)},e.prototype.calculateControlTransformationGlobal=function(t,e,a){var i=e.eye,r=e.viewRight,o=this.transformation,s=this.view.navigation.gamepad;n.vec3d.cross(r,i,x),n.vec3d.normalize(x),n.vec3d.negate(x);var c=o.translation[0]*t.pan;switch(0!==c&&(n.mat4d.rotate(a.pan.matrix,c,x),a.pan.enabled=!0),s.mode){case"pan":var l=o.translation[1]*t.pan;0!==l&&(n.mat4d.rotate(a.pan.matrix,l,r),a.pan.enabled=!0);break;case"zoom":a.zoom=-o.translation[1]*t.zoom}var d=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,p=o.translation[2]*t.ascend;a.ascend=p;var v=-o.heading*t.rotate;0!==v&&(n.mat4d.rotate(a.rotate.matrix,v,i),a.rotate.enabled=!0);var m=o.tilt*t.rotate,u=this.clampTiltDeltaGlobalToValidRange(m,e.eye,e.viewForward,d);0!==u&&(n.mat4d.rotate(a.rotate.matrix,u,r),a.rotate.enabled=!0)},e.prototype.clampTiltDeltaGlobalToValidRange=function(t,e,a,i){var r=c.onSurfaceTiltToEyeTiltGlobal(o.TiltDefault.min,e,i),s=0,p=0;if(this.view.renderCoordsHelper.intersectManifold(e,a,i,M)){var v=l.viewAngle(this.view.renderCoordsHelper,M,e);s=c.onSurfaceTiltToEyeTiltGlobal(v,e,i),p=c.onSurfaceTiltToEyeTiltGlobal(o.TiltDefault.max,e,i)}else{c.closestPointOnCenteredSphereSilhouette(i+d.earthRadius,e,a,M);var v=m.acos(-n.vec3d.dot(a,n.vec3d.normalize(M)));s=c.offSurfaceTiltToEyeTiltGlobal(v,e,i),p=c.offSurfaceTiltToEyeTiltGlobal(o.TiltDefault.max,e,i)}return m.clamp(s+t,r,p)-s},e.prototype.pointEquivalentAboveSurface=function(t,e,a){var i=this.view.renderCoordsHelper,r=i.getAltitude(t),o=Math.abs(r-e),s=e+o;return n.vec3d.set(t,a),i.setAltitude(s,a),s},e.prototype.clampedDistanceToSurface=function(t,e){var a=this.view.renderCoordsHelper,i=this.view.state.camera,r=p.headingTiltToDirectionUp(this.view,e,0,C,R).direction;c.centerOnManifoldSilhouetteFallback(a,e,r,t,V);var o=n.vec3d.dist(e,V);c.centerOnManifoldSilhouetteFallback(a,e,n.vec3d.direction(i.center,e,V),t,z);var s=n.vec3d.dist(e,z);return Math.min(o,s)},e.prototype.computeHeadingRotateRadius=function(t){var e=this.view,a=e.renderCoordsHelper,i=e.state,r=i.camera,o=i.isGlobal;if(c.centerOnManifoldSilhouetteFallback(a,r.eye,r.viewForward,this.filteredSurfaceElevation,M),o){var s=n.vec3d.subtract(t,M,V),l=n.vec3d.length(s);n.vec3d.scale(s,1/l,s);var d=n.vec3d.normalize(t,z),p=m.acos(n.vec3d.dot(d,s));return l*Math.sin(Math.min(b,p))}return n.vec3d.set(t,V),a.setAltitude(this.filteredSurfaceElevation,V),n.vec3d.dist(M,V)},e.prototype.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:g},e.prototype.computeVelocities=function(t){var e=this.filteredSurfaceElevation,a=e+d.earthRadius,i=this.view.state,r=i.camera,n=i.isGlobal,o=this.pointEquivalentAboveSurface(r.eye,e,E),s=this.clampedDistanceToSurface(e,E),c=r.width/2,l=T*r.width,p=T*r.width,v=s*Math.tan(.5*r.fovX)/c,u=v/a,h=v/this.computeHeadingRotateRadius(E),f=n?u:v,y=f*l*t,w=o-e;return{pan:y,ascend:Math.max(this.minimumAscendVelocity()*t,Math.pow(2,l*t/c)*w-w),zoom:Math.pow(2,l*t/c)*s-s,rotate:m.clamp(h*p,O,S)*t}},e.activatesFor=function(t,e){var a=h.extractTransformation(e,t.navigation.gamepad,w);return!("end"===e.action||h.isZeroTransformation(a))},e}(s.InteractiveController);e.GamepadController=y;var w={translation:[0,0,0],heading:0,tilt:0},C=80,b=m.deg2rad(C),T=.75,g=5,O=m.deg2rad(30),S=m.deg2rad(80),x=n.vec3d.create(),A=n.vec3d.create(),D=n.vec3d.create(),F=n.vec3d.create(),M=n.vec3d.create(),V=n.vec3d.create(),z=n.vec3d.create(),E=n.vec3d.create(),k={zoom:0,ascend:0,pan:{enabled:!1,matrix:n.mat4d.create()},rotate:{enabled:!1,matrix:n.mat4d.create()}},G=n.vec3d.create(),R=v.createDirectionUp()});