// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/lang","../../../core/PooledArray"],function(t,e,i,s){var r=new s,n=function(){function t(t,e,i){this._namespace=t,this._storage=e,this._priority=0,this._removeFunc=!1,this._hit=0,this._miss=0,r.push(this),this._namespace+=":",i&&(this._storage.registerRemoveFunc(this._namespace,i),this._removeFunc=!0)}return Object.defineProperty(t.prototype,"priority",{get:function(){return this._priority},set:function(t){isNaN(t)||(this._priority=Math.max(0,t))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"namespace",{get:function(){return this._namespace.slice(0,-1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hitRate",{get:function(){return this._hit/(this._hit+this._miss)},enumerable:!0,configurable:!0}),t.prototype.resetHitRate=function(){this._hit=this._miss=0},t.prototype.destroy=function(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),r.removeUnordered(this)},t.prototype.put=function(t,e,i){this._storage.put(this._namespace+t,e,i,this._priority)},t.prototype.pop=function(t){var e=this._storage.pop(this._namespace+t);return void 0===e?++this._miss:++this._hit,e},t.prototype.clear=function(){this._storage.clear(this._namespace)},t.prototype.clearAll=function(){this._storage.clearAll()},t.prototype.getSize=function(){return this._storage.getSize()},t.prototype.getMaxSize=function(){return this._storage.maxSize},t.prototype.getStats=function(){return this._storage.getStats()},t.prototype.resetStats=function(){this._storage.resetStats()},t}();return function(t){var e=function(){function t(){this._db=new Map,this._size=0,this._age=0,this._hit=0,this._miss=0,this._maxSize=10485760,this._removeFuncs=[]}return t.prototype.registerRemoveFunc=function(t,e){this._removeFuncs.push([t,e])},t.prototype.deregisterRemoveFunc=function(t){this._removeFuncs=this._removeFuncs.filter(function(e){return e[0]!==t})},Object.defineProperty(t.prototype,"maxSize",{get:function(){return this._maxSize},set:function(t){this._maxSize=Math.max(t,0),this._size>this._maxSize&&this._removeEntries()},enumerable:!0,configurable:!0}),t.prototype.put=function(t,e,i,s){if(i>this._maxSize){if(this._db.has(t)){var r=this._db.get(t);this._size-=r.size,this._db.delete(t)}return void this._notifyRemoved(t,e)}if(!i||i<0)return void console.warn("Refusing to cache entry with invalid size "+i);if(this._db.has(t)){var r=this._db.get(t);this._notifyRemoved(t,r.entry),this._size+=i-r.size,r.entry=e,r.lastUsed=this._age+s,r.size=i}else this._db.set(t,{entry:e,size:i,lastUsed:this._age+s}),this._size+=i;++this._age,this._size>this._maxSize&&this._removeEntries()},t.prototype.pop=function(t){if(this._db.has(t)){var e=this._db.get(t);return this._size-=e.size,this._db.delete(t),++this._hit,e.entry}++this._miss},t.prototype.getSize=function(){return this._size},t.prototype.getStats=function(){var t=this,e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},s={},n=this._age,o=this._age;this._db.forEach(function(t,e){n=Math.min(n,t.lastUsed),o=Math.max(o,t.lastUsed),r.forEach(function(r){var n=r.namespace;if(i.startsWith(e,n)){var o=s[n]||0;return s[n]=o+t.size,!1}})}),e.Entries+=" / "+n+" - "+o;var h={};r.forEach(function(t){var e=t.namespace;if(!isNaN(t.hitRate)&&t.hitRate>0){var i=s[e]||0;s[e]=i,h[e]=Math.round(100*t.hitRate)+"%"}else h[e]="0%"});var a=Object.keys(s);return a.forEach(function(e){return s[e]=s[e]/t._size*100}),a.sort(function(t,e){return s[e]-s[t]}),a.forEach(function(t){return e[t]=Math.round(s[t])+"% / "+h[t]}),e},t.prototype.resetStats=function(){this._hit=this._miss=0,r.forEach(function(t){return t.resetHitRate()})},t.prototype.clear=function(t){var e=this;this._db.forEach(function(s,r){i.startsWith(r,t)&&(e._size-=s.size,e._db.delete(r),e._notifyRemoved(r,s.entry))})},t.prototype.clearAll=function(){var t=this;this._db.forEach(function(e,i){t._notifyRemoved(i,e.entry)}),this._size=0,this._db.clear()},t.prototype._getHitRate=function(){return this._hit/(this._hit+this._miss)},t.prototype._notifyRemoved=function(t,e){this._removeFuncs.forEach(function(s){i.startsWith(t,s[0])&&s[1](e)})},t.prototype._removeEntries=function(){var t=[];this._db.forEach(function(e,i){t.push([e.lastUsed,i])}),t.sort(function(t,e){return t[0]-e[0]});for(var e=0,i=t;e<i.length;e++){var s=i[e],r=s[1],n=this._db.get(r);if(this._size-=n.size,this._db.delete(r),this._notifyRemoved(r,n.entry),this._size<=.9*this.maxSize)return}},t}();t.Storage=e}(n||(n={})),n});