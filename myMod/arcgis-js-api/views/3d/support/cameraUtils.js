// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../Camera","../../../config","../../../core/Logger","../../../core/promiseUtils","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","../lib/gl-matrix","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./mathUtils","./projectionUtils","../webgl-engine/lib/Camera"],function(e,t,r,n,a,i,o,c,l,u,s,v,f,d,m,p,g,h,T){function M(e){return e.spatialReference||l.WGS84}function y(e){return"global"===e.viewingMode?m:d}function x(e,t,r,n,a){return y(e).headingTiltToDirectionUp(t,r,n,a)}function S(e,t){var r=e.renderSpatialReference,n=y(e).headingTiltToDirectionUp,a=f.vec3d.create();if(!h.pointToVector(t.position,a,r))return null;var i=n(a,t.heading,t.tilt);f.vec3d.add(i.direction,a);var o=v.cameraOnContentAlongViewDirection(e,a,i.direction,i.up);return o.fov=g.deg2rad(t.fov),o}function C(e,t,r){var a=e.renderSpatialReference,i=f.vec3d.set(t.viewForward,ne),o=P(e,t.eye,i,t.up,ae),u=M(e);return h.vectorToVector(t.eye,a,te,u)||(u=l.WGS84,h.vectorToVector(t.eye,a,te,u)),r?(r.position.x=te[0],r.position.y=te[1],r.position.z=te[2],r.position.spatialReference=u,r.heading=o.heading,r.tilt=o.tilt,r.fov=g.rad2deg(t.fov),r):new n(new c(te,u),o.heading,o.tilt,g.rad2deg(t.fov))}function w(e,t,r){var n=e.state.camera,i=n.fovX,o=n.width/2;return"global"===e.viewingMode&&null!=r&&(t*=Math.cos(g.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters,o/(a.screenDPI*B/t)/Math.tan(i/2)}function R(e,t,r){var n=e.state.camera,i=n.fovX,o=t*Math.tan(i/2),c=n.width/2,l=c/o,u=a.screenDPI*B,s=u/l;return"global"===e.viewingMode&&(s/=Math.cos(g.deg2rad(r))),s*=e.renderCoordsHelper.unitInMeters}function b(e,t,r,n,a,i){return D(e,t,w(e,r,t.latitude),n,a,i)}function D(e,t,r,n,a,i){if(X(i)){var c=o.createResolver();return H(e,n.heading,n.tilt,t,r,a,c),void c.promise.then(function(t){return i.resolve(G(e,t,n.fov))})}var l={center:[],eye:[],up:[],tilt:0,heading:0};return H(e,n.heading,n.tilt,t,r,a,l),G(e,l,n.fov,i)}function P(e,t,r,n,a){return y(e).directionToHeadingTilt(t,r,n,a)}function U(e,t,r){return e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,ie,e.spatialReference)&&e.basemapTerrain.getElevation(ie)>ie.z-1}function z(e,t,r){return e.renderCoordsHelper.fromRenderCoords(t,ie,e.spatialReference)?e.elevationProvider.queryElevation(ie).then(function(e){return e>ie.z-10}):o.resolve(!1)}function E(e,t){var r=f.vec3d.create();if(t&&t instanceof c){if(h.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain)return e.elevationProvider.queryElevation(t).then(function(t){return null!=t&&e.renderCoordsHelper.setAltitude(t,r),r})}else t?f.vec3d.set(t,r):f.vec3d.set(e.state.camera.center,r);return o.resolve(r)}function A(e,t){var r=f.vec3d.create();if(t&&t instanceof c){if(h.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=e.elevationProvider.getElevation(t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?f.vec3d.set(t,r):f.vec3d.set(e.state.camera.center,r);return r}function H(e,t,r,n,a,i,o){var l=n&&n instanceof c?n:null;if(X(o))return void E(e,n).then(function(n){O(e,t,r,l,n,a,i,o)});var u=A(e,n);return O(e,t,r,l,u,a,i,o)}function O(e,t,r,n,a,i,o,c){if(!n){var l=e.renderSpatialReference,u=M(e);n=h.vectorToPoint(a,l,u)}i=Math.max(i,e.state.constraints.minimumPoiDistance);var s=L(e,t,r,a,i,o),v=y(e).eyeForCenterWithHeadingTilt,f=v(a,i,s.heading,s.tilt);if(o===_.ADJUST&&"global"===e.viewingMode&&r>0){var d=function(){var l=W(e,a,i,J(e,i,r,a));return o=r-l<1?_.LOCKED:_.ADJUST,O(e,t,l,n,a,i,o,c)};if(U(e,f.eye,f.tilt))return d();if(X(c))return void z(e,f.eye,f.tilt).then(function(e){if(e)return d();c.resolve({eye:f.eye,up:f.up,center:a,heading:f.heading,tilt:f.tilt})})}var m={center:[],eye:[],up:[],tilt:0,heading:0};return c&&!X(c)&&(m=c),m.eye=f.eye,m.up=f.up,m.center=a,m.heading=f.heading,m.tilt=f.tilt,X(c)&&c.resolve(m),m}function V(e,t,r,n,a,i){var u,v=0;null!=t.zmax&&null!=t.zmin&&(u=(t.zmax+t.zmin)/2,v=t.zmax-t.zmin);var f,d,m;if("global"===e.viewingMode){var g=l.WebMercator,h=t.spatialReference||g,T=new c(t.xmin,t.ymin,h),y=new c(t.xmax,t.ymax,h);if(T=s.project(T,g),y=s.project(y,g),null===T||null===y)return void(X(i)&&i.reject());f=new c(oe.center(T.x,y.x),(y.y+T.y)/2,g),null!=u&&(f.z=u);var x=p.getGreatCircleSpanAt(f,T,y);d=x.lon,m=x.lat,oe.diff(T.x,y.x)>oe.range/2&&(d+=p.halfEarthCircumference),d=Math.min(d,p.halfEarthCircumference),m=Math.min(m,p.halfEarthCircumference)}else{var S=M(e);s.canProject(t,S)&&(t=s.project(t,S)),d=t.xmax-t.xmin,m=t.ymax-t.ymin,f=new c({x:t.xmin+.5*d,y:t.ymin+.5*m,z:u,spatialReference:S})}var C=e.state.camera,w=1/Math.tan(C.fovX/2),R=1/Math.tan(C.fovY/2),b=1/Math.tan(C.fov/2),D=Math.max(.5*d*w,.5*m*R,.5*v*b)/Q;if(X(i)){var P=o.createResolver();return H(e,r,n,f,D,a,P),void P.promise.then(function(t){return i.resolve(G(e,t,e.camera.fov))})}var U={center:[],eye:[],up:[],tilt:0,heading:0};return H(e,r,n,f,D,a,U),G(e,U,e.camera.fov,i)}function j(e,t,r,n,a){t||(r||(r=e.state.camera),t=C(e,r,a));var i,o,c=e.renderSpatialReference;if(r)i=h.vectorToPoint(r.center,c,M(e)),o=r.distance;else{if(!(i=e.toMap(e.screenCenter)))return null;o=p.computeCarthesianDistance(t.position,i)}r||(r=e.state.camera);var l=Math.tan(r.fovX/2),u=Math.tan(r.fovY/2),s=2*o*l*Q,v=2*o*u*Q;return"global"===e.viewingMode?m.toExtent(e,i,s,v,n):d.toExtent(e,i,s,v,n)}function I(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>$)return!0;var a=e.renderSpatialReference,i=M(e),o=h.vectorToPoint(t,a,i),c=h.vectorToPoint(e.state.camera.center,a,i),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>ee}function L(e,t,r,n,a,i){var o=0;return i===_.ADJUST&&I(e,n,a)?(t=0,o=F(e,a,r,n)):o=q(e,n,a,r),o=e.state.constraints.clampTilt(a,o),r=W(e,n,a,o),{heading:t,tilt:r}}function F(e,t,r,n){var a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);var i=a.min*(1-ce)+a.max*ce,o=q(e,n,t,r);return Math.min(o,i)}function J(e,t,r,n){var a=e.state.constraints.tilt(t),i=q(e,n,t,r);return i=Math.min(i,.5*Math.PI),a.min*(1-ce)+i*ce}function W(e,t,r,n){return y(e).lookAtTiltToEyeTilt(t,r,n)}function q(e,t,r,n){return y(e).eyeTiltToLookAtTilt(t,r,n)}function G(e,t,r,a){var i=e.renderSpatialReference,o=M(e),c=h.vectorToPoint(t.eye,i,o);return c?a?(a.position=c,a.heading=t.heading,a.tilt=t.tilt,a.fov=r,a):new n(c,t.heading,t.tilt,r):null}function X(e){return e&&e.resolve&&e.reject}function K(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.levelAtScale(t):void N.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function k(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.scaleAtLevel(t):void N.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Y(e,t){return e.spatialReference?u.getResolutionForScale(t,e.spatialReference):void 0}function Z(e,t,r){var n=e.renderSpatialReference;t||(t=e.state.camera);var a,i,o=l.WGS84;return t instanceof T?(h.vectorToVector(t.center,n,re,o),a=re[1],i=t.distance):(a=t.position.latitude,h.pointToVector(t.position,te,n),h.pointToVector(r,re,n),i=f.vec3d.dist(te,re)),R(e,i,a)}Object.defineProperty(t,"__esModule",{value:!0});var _,N=i.getLogger("esri.views.3d.support.cameraUtils"),B=39.37,Q=1,$=8,ee=5,te=f.vec3d.create(),re=f.vec3d.create(),ne=f.vec3d.create(),ae={heading:0,tilt:0},ie=new c,oe=new g.Cyclical(-20037508.342788905,20037508.342788905);!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(_=t.OrientationMode||(t.OrientationMode={})),t.headingTiltToDirectionUp=x,t.externalToInternal=S,t.internalToExternal=C,t.scaleToDistance=w,t.distanceToScale=R,t.fromCenterScale=b,t.fromCenterDistance=D,t.directionToHeadingTilt=P,t.getObserverForPointAtDistance=H,t.fromExtent=V,t.toExtent=j;var ce=.7;t.observerToCamera=G,t.scaleToZoom=K,t.zoomToScale=k,t.scaleToResolution=Y,t.computeScale=Z});