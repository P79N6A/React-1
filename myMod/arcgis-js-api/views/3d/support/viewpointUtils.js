// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/Error","../../../core/promiseUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","../lib/gl-matrix","./cameraUtils","./intersectionUtils","./mathUtils","./projectionUtils"],function(e,t,n,r,a,i,o,c,l,s,u,m,f,p,v,d,g){function h(e){return 360-d.cyclicalDeg.normalize(e)}function x(e){return d.cyclicalDeg.normalize(360-e)}function y(e,t){return e&&(null==t?e.reject():e.resolve(t)),t}function R(e,t,n,a){if(!t)return y(a);var i=e.spatialReference||r.SpatialReference.WGS84;if(t.camera){var o=t.get("camera.position.spatialReference");if(!u.canProject(o,i))return y(a);var c=t.camera.clone();return o.equals(i)||(c.position=u.project(c.position,i)),y(a,c)}var l=t.get("targetGeometry.spatialReference");if(l&&!u.canProject(l,i))return y(a);var s=p.internalToExternal(e,e.state.camera),m=p.OrientationMode.ADJUST;if(null!=t.rotation&&(s.heading=h(t.rotation),m=p.OrientationMode.LOCKED),null!=n&&(s.tilt=n),"point"===t.targetGeometry.type){var f=t.targetGeometry,v=void 0,d=t.targetGeometry.clone();return v=null!=t.scale?p.scaleToDistance(e,t.scale,f.latitude):e.state.camera.distance,p.fromCenterDistance(e,d,v,s,m,a)}var g=t.targetGeometry.extent;return p.fromExtent(e,g,s.heading,s.tilt,m,a)}function w(e,t,r){return r||(r=new i({camera:new n})),p.internalToExternal(e,t,r.camera),M(e,t,r)}function T(e,t,n){return n||(n=new i),n.camera=t.clone(),M(e,null,n)}function b(e,t){var a=k(e,t);if(!a)return c.reject(new o("viewpointutils-create:no-target","Missing target for creating viewpoint"));var u=new i({camera:new n({fov:e.camera.fov})}),m=null!=a.scale||null!=a.zoom;if(a.target instanceof i)return D(e,a.target,a,u).then(function(e){return L(e)});if(a.target instanceof n)return c.resolve(L(C(e,a,a.target,u)));if(a.target instanceof r.Extent){var f=a.target.xmin===a.target.xmax||a.target.ymin===a.target.ymax;return m||f?B(e,a,a.target.center,u).then(function(e){return L(e)}):F(e,a,a.target,u).then(function(e){return L(e)})}var p={boundingBox:l.empty(),hasZ:!1,screenSpaceObjects:[]},v=m?G(e,a):void 0;return z(e,a.target,v,p).then(function(){if(isFinite(p.boundingBox[0])){l.center(p.boundingBox,I),Q.x=I[0],Q.y=I[1],Q.z=I[2],Q.spatialReference=e.spatialReference;var t=void 0;if(isFinite(Q.z)&&p.hasZ?t=l.isPoint(p.boundingBox):(Q.z=void 0,t=s.isPoint(l.toRect(p.boundingBox,N))),m||t)return B(e,a,Q,u);var n=_(e,p.screenSpaceObjects);return Z(e,a,Q,p.boundingBox,n,u)}return a.position?P(e,a,u):V(e,a,u)}).then(function(e){return L(e)})}function S(e,t){var n=t.scale;return null==n&&null!=t.zoom&&(n=p.zoomToScale(e,t.zoom)),n}function G(e,t){return p.scaleToResolution(e,S(e,t))}function E(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=h(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function M(e,t,n){var a=e.spatialReference||r.SpatialReference.WGS84;return t=t||p.externalToInternal(e,n.camera),n.targetGeometry=g.vectorToPoint(t.center,e.renderSpatialReference,a),n.scale=p.computeScale(e,t),n.rotation=x(n.camera.heading),n}function O(e,t,n){if(t){if(!u.canProject(t.spatialReference,e.spatialReference))throw new o("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var r=[];if(!t.hasZ&&e.basemapTerrain){var a=void 0;switch(t.type){case"point":a=t;break;case"multipoint":case"polyline":case"mesh":a=t.extent.center;break;case"extent":a=t.center;break;case"polygon":a=t.centroid}a&&u.canProject(a,e.basemapTerrain.spatialReference)?I[2]=e.basemapTerrain.getElevation(a)||0:I[2]=0}(0,$[t.type])(t,function(e){r.push(e[0],e[1],e[2])},I);var i=r.length/3;if(0!==i){var c=new Array(r.length);if(g.bufferToBuffer(r,t.spatialReference,0,c,e.spatialReference,0,i)){t.hasZ&&(n.hasZ=!0);for(var s=0;s<c.length;s+=3)t.hasZ?(I[0]=c[s+0],I[1]=c[s+1],I[2]=c[s+2]):(I[0]=c[s+0],I[1]=c[s+1]),l.expand(n.boundingBox,I)}}}}function A(e,t,n,r){return e.whenViewForGraphic(t).then(function(e){if(e&&e.whenGraphicBounds)return e.whenGraphicBounds(t,{minDemResolution:n})}).then(function(e){var t=e.boundingBox;l.expand(r.boundingBox,t),e.screenSpaceObjects&&e.screenSpaceObjects.forEach(function(e){r.screenSpaceObjects.push(e)}),isFinite(t[2])&&(r.hasZ=!0)}).catch(function(){O(e,t.geometry,r)})}function z(e,t,n,i){if(Array.isArray(t)&&2===t.length){var o=t[0],l=t[1];if("number"==typeof o&&"number"==typeof l)return Q.x=o,Q.y=l,Q.z=void 0,Q.spatialReference=r.SpatialReference.WGS84,O(e,Q,i),c.resolve()}if(t&&"function"==typeof t.map)return c.eachAlways(t.map(function(t){return z(e,t,n,i)}));if(t instanceof r.BaseGeometry)try{O(e,t,i)}catch(e){return c.reject(e)}else if(t instanceof a)return A(e,t,n,i);return c.resolve()}function D(e,t,n,r){if(t.camera)return c.resolve(C(e,n,t.camera,r));r.scale=t.scale,r.rotation=t.rotation,r.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,r.camera=null,null!=n.heading?r.rotation=x(n.heading):null!=n.rotation&&(r.rotation=n.rotation);var a=S(e,n);null!=a&&(r.scale=a);var i=c.createResolver();return R(e,r,n.tilt,i),i.promise.then(function(e){return r.camera=e,r})}function C(e,t,n,r){r.camera=n.clone(),r.camera.fov=e.camera.fov;var a=e.spatialReference,i=r.camera.position.spatialReference;return u.canProject(i,a)?(i.equals(a)||(r.camera.position=u.project(r.camera.position,a)),M(e,null,r)):null}function j(e,t,n,a,i){var o=e.renderSpatialReference;return g.pointToVector(n.position,W,o),g.pointToVector(t,Y,o),i.targetGeometry=new r.Point(t),i.camera.position=new r.Point(n.position),f.vec3d.subtract(Y,W,H),p.directionToHeadingTilt(e,W,H,a.up,i.camera),i.scale=p.distanceToScale(e,f.vec3d.dist(W,Y),i.targetGeometry.latitude),i.rotation=x(i.camera.heading),i}function B(e,t,n,r){if(!n)return c.reject();r.targetGeometry=n.clone();var a=m.cameraOnContentAlongViewDirection(e);if(t.position)return c.resolve(j(e,r.targetGeometry,t,a,r));if(t.zoomFactor){var i=a.distance/t.zoomFactor,o=f.vec3d.scale(a.viewForward,-i,I);f.vec3d.add(a.center,o,a.eye),a.markViewDirty(),r.scale=p.distanceToScale(e,i,n.latitude)}p.internalToExternal(e,a,r.camera);var l=E(r.camera,t)?p.OrientationMode.LOCKED:p.OrientationMode.ADJUST;if(!t.zoomFactor){r.scale=S(e,t),null==r.scale&&(g.pointToVector(n,I,e.renderSpatialReference),v.frustumPoint(a.frustumPlanes,I)?r.scale=p.distanceToScale(e,f.vec3d.dist(a.eye,I),n.latitude):r.scale=p.computeScale(e,a));var s=c.createResolver();return p.fromCenterScale(e,r.targetGeometry,r.scale,r.camera,l,s),s.promise.then(function(e){return r.camera=e,r})}return c.resolve(r)}function P(e,t,n){var a=m.cameraOnContentAlongViewDirection(e);return f.vec3d.set(a.viewForward,H),p.directionToHeadingTilt(e,a.eye,H,a.up,X),n.camera.position=new r.Point(t.position),n.camera.heading=null!=t.heading?t.heading:X.heading,n.camera.tilt=null!=t.tilt?t.tilt:X.tilt,M(e,null,n)}function V(e,t,n){var r=m.cameraOnContentAlongViewDirection(e);return B(e,t,g.vectorToPoint(r.center,e.renderSpatialReference,Q,e.spatialReference),n)}function F(e,t,n,r){r.targetGeometry=n.clone();var a=m.cameraOnContentAlongViewDirection(e);p.internalToExternal(e,a,r.camera);var i=E(r.camera,t)?p.OrientationMode.LOCKED:p.OrientationMode.ADJUST,o=c.createResolver();return p.fromExtent(e,n,r.camera.heading,r.camera.tilt,i,o),o.promise.then(function(e){return r.camera=e,r})}function U(e,t,n,r,a){var i=0;n.hasZ?i=n.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(n)),f.vec3d.set3(n.x,n.y,i,I),g.computeLinearTransformation(e.spatialReference,I,q,e.renderSpatialReference),f.mat4d.toMat3(q,J),f.mat3d.transpose(J),l.empty(K);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var s=o[c],u=r[s[2]];isFinite(u)||(u=i),f.vec3d.set3(r[s[0]],r[s[1]],u,I),g.vectorToVector(I,e.spatialReference,I,e.renderSpatialReference),l.expand(K,f.mat3d.multiplyVec3(J,I))}var m=l.width(K),p=l.height(K),v=l.depth(K),d=1/Math.tan(t.fovX/2),h=1/Math.tan(t.fovY/2),x=Math.sqrt(m*m+v*v),y=.5*x*Math.max(h,d)+.5*p,R=.5*p*h+.5*Math.max(m,v);return Math.max(y,R)/a}function Z(e,t,n,r,a,i){i.targetGeometry=n.clone();var o=m.cameraOnContentAlongViewDirection(e),l=U(e,o,n,r,a);p.internalToExternal(e,o,i.camera);var s=E(i.camera,t)?p.OrientationMode.LOCKED:p.OrientationMode.ADJUST;i.scale=p.distanceToScale(e,l,i.targetGeometry.latitude);var u=c.createResolver();return p.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,s,u),u.promise.then(function(e){return i.camera=e,i})}function k(e,t){if(!t||!e.spatialReference)return null;var n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(var r in t)n[r]=t[r];t.center&&!n.target&&(n.target=t.center)}return n}function L(e){return e&&(e.rotation=x(e.camera.heading)),e}function _(e,n){var r=t.DEFAULT_FRAME_COVERAGE;if(!n.length)return r;for(var a=Number.NEGATIVE_INFINITY,i=0;i<n.length;i++){var o=n[i].screenSpaceBoundingRect;a=Math.max(a,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}return r-a/Math.min(e.width,e.height)*2}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=h,t.headingToRotation=x,t.toCamera=R,t.fromInternalCamera=w,t.fromCamera=T,t.create=b;var I=f.vec3d.create(),q=f.mat4d.create(),J=f.mat3d.create(),K=l.create(),N=s.create(),H=f.vec3d.create(),W=f.vec3d.create(),Y=f.vec3d.create(),X={heading:0,tilt:0},Q=new r.Point,$={point:function(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},polygon:function(e,t,n){for(var r=e.hasZ,a=0;a<e.rings.length;a++)for(var i=e.rings[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},polyline:function(e,t,n){for(var r=e.hasZ,a=0;a<e.paths.length;a++)for(var i=e.paths[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},multipoint:function(e,t,n){for(var r=e.points,a=e.hasZ,i=0;i<r.length;i++)n[0]=r[i][0],n[1]=r[i][1],a&&(n[2]=r[i][2]),t(n)},extent:function(e,t,n){e.hasZ?(t(f.vec3d.set3(e.xmin,e.ymin,e.zmin,n)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmin,n)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmin,n)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmin,n)),t(f.vec3d.set3(e.xmin,e.ymin,e.zmax,n)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmax,n)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmax,n)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmax,n))):(t(f.vec3d.set3(e.xmin,e.ymin,n[2],n)),t(f.vec3d.set3(e.xmax,e.ymin,n[2],n)),t(f.vec3d.set3(e.xmin,e.ymax,n[2],n)),t(f.vec3d.set3(e.xmax,e.ymax,n[2],n)))},mesh:function(e,t,n){var r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(var a=0;a<r.length;a+=3)t(f.vec3d.set3(r[a+0],r[a+1],r[a+2],n))}}});