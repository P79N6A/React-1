// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/has","../../../../core/Logger","../../../../core/promiseUtils","../../lib/gl-matrix","../lib/DrapedRenderer","../lib/GLMaterialRep","../lib/GLTextureRep","../lib/ProgramRepository","../lib/tracer","../lighting/Lightsources","./Model","./Viewport","../../../support/screenshotUtils","../../../webgl/context-util","../../../webgl/FramebufferObject","../../../webgl/RenderingContext"],function(e,t,r,i,n,s,o,a,h,p,d,c,u,l,_,g,f,v,m){var R=n.getLogger("esri.views.3d.webgl-engine.parts.View"),b=function(){function e(e,t,r,i){var n=this;this._backgroundColor=o.vec4d.createFrom(1,1,1,1),this._lightDirection=o.vec3d.createFrom(0,1,0),this._didRender=!1,this._needsRender=!0,this._idleSuspend=!0,this._shouldRender=!1,this._supersampleScreenshots=!0,this._screenshotQueue=[],this._container=e,this._stage=t,this._initializeContext(i),this._programRepository=new d(this._rctx),this._programRepository.globalOptions.viewingMode=i.viewingMode;var s=function(){return n._viewport.getCamera().viewport};this._textureRep=new p(t.getAll(l.ContentType.TEXTURE),this._programRepository,s,this._rctx),this._materialRep=new h(this._textureRep,this._programRepository),this._viewport=new _(this._stage,this._programRepository,this._materialRep,this._textureRep,this._rctx),this._initializeViewportCamera(),this._drapedRenderer=new a(this._rctx,this._canvas,this._programRepository,this._materialRep,this._textureRep,r),this._initializeFrameTask()}return Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return this._viewport.isLoadingResources},enumerable:!0,configurable:!0}),e.prototype._initializeFrameTask=function(){var e=this;this._frameTask={preRender:function(){if(c.begin(),e._stage.processDirty(),e.needsRender()){e._shouldRender=!0;e._viewport.getCamera().setGLViewport(e._rctx),e._rctx.setClearColor.apply(e._rctx,e._backgroundColor),e._rctx.clear(16640)}else e._shouldRender=!1},render:function(){e._shouldRender&&(e._didRender=!0,y.lightDirection=e._lightDirection,e._viewport.render(y))},postRender:function(){c.end()},update:function(){e.resetNeedsRender(),e._performScreenshots()}}},e.prototype._initializeViewportCamera=function(){var e=this._container.getBoundingClientRect(),t=this._viewport.getCamera();t.viewport[2]=e.width,t.viewport[3]=e.height,this._viewport.setCamera(t)},e.prototype._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil},r=f.createContextOrErrorHTML(this._canvas,t,e.renderContext);this._gl=c.instrumentContext(r);var n={disabledExtensions:e.deactivatedWebGLExtensions||{}};this._rctx=new m(this._gl,n),!e.alpha&&this._rctx.contextAttributes.alpha&&R.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas),null!=e.supersampleScreenshots&&(this._supersampleScreenshots=e.supersampleScreenshots)},e.prototype.dispose=function(){this._viewport.dispose(),this._viewport=null,this._drapedRenderer.dispose(),this._drapedRenderer=null,this._programRepository.dispose(),this._programRepository=null,this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._container=null,this._canvas=null,this._gl=null,this._frameTask=null},e.prototype.getCombinedStats=function(){return this._viewport.getCombinedStats()},e.prototype.setNeedsRender=function(){this._didRender=!1,this._needsRender=!0},e.prototype.resetNeedsRender=function(){this._didRender&&(this._needsRender=!1,this._didRender=!1),this._viewport.resetNeedsRender(),this._textureRep.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||!this._idleSuspend||this._viewport.needsRender()||this._textureRep.needsRender()},e.prototype.getFrameTask=function(){return this._frameTask},e.prototype.setLighting=function(e){o.vec3d.set3(0,0,0,this._lightDirection);for(var t=0,r=e.lights;t<r.length;t++){var i=r[t];if(i instanceof u.MainLight){o.vec3d.negate(i.direction,this._lightDirection);break}}this._viewport.setLighting(e),this._needsRender=!0},e.prototype.getEdgeView=function(){return this._viewport.getEdgeView()},e.prototype.getMainLightDirection=function(){return this._lightDirection},e.prototype.getViewParams=function(e){var t={};return e&&!e.backgroundColor||(t.backgroundColor=this._backgroundColor),t},e.prototype.setViewParams=function(e){this._needsRender=!0,e.backgroundColor&&(this._backgroundColor=e.backgroundColor)},e.prototype.setRenderParams=function(e){this._needsRender=!0,void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._viewport.setRenderParams(e)},e.prototype.getRenderParams=function(){var e=this._viewport.getRenderParams();return e.anisotropicFiltering=this._textureRep.getMaxAnisotropy(),e.idleSuspend=this._idleSuspend,e},e.prototype.getIdleSuspend=function(){return this._idleSuspend},Object.defineProperty(e.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return"s3tc"===e?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===e&&!!this._rctx.capabilities.shaderTextureLOD},e.prototype.modify=function(e,t,r,i){this._viewport.modify(e,t,r,i)},e.prototype.setCamera=function(e){this._viewport.setCamera(e)},e.prototype.getCamera=function(){return this._viewport.getCamera()},e.prototype.getCanvas=function(){return this._canvas},e.prototype.getDrapedTextureRenderer=function(){return this._drapedRenderer},e.prototype.takeScreenshot=function(e){var t=this,r=s.createResolver(function(){t._screenshotQueue=t._screenshotQueue.filter(function(e){return e.resolver!==r})});return this._screenshotQueue.push({settings:e,resolver:r}),this._needsRender=!0,r.promise},e.prototype.getFramebufferTexture=function(e){return this._viewport.getFramebufferTexture(e)},Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._viewport.renderPlugins},enumerable:!0,configurable:!0}),e.prototype._screenshotSuperSampleSettings=function(e){if(!this._supersampleScreenshots)return e;var t=e.framebufferWidth,i=e.framebufferHeight,n=e.pixelRatio,s=e.region,o=Math.min(C,w/Math.max(t,i));return o<x?e:r({},e,{framebufferWidth:Math.round(t*o),framebufferHeight:Math.round(i*o),pixelRatio:n*o,resample:{region:{x:Math.round(s.x*o),y:Math.round(s.y*o),width:Math.round(s.width*o),height:Math.round(s.height*o)},width:t,height:i}})},e.prototype._readbackScreenshot=function(e){var t=e.framebufferWidth,r=e.framebufferHeight,i=e.region,n=e.resample;if(n){var s=g.createEmptyImageData(t,r,this._ensureScreenshotEncodeCanvas());this._gl.readPixels(0,0,t,r,6408,5121,new Uint8Array(s.data.buffer));var o=g.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return g.resampleHermite(s,o,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}var s=g.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return this._gl.readPixels(i.x,r-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(s.data.buffer)),s},e.prototype._renderScreenshot=function(e){var t=null,r=this._viewport.getCamera(),i=this._screenshotSuperSampleSettings(e),n=i.framebufferWidth,s=i.framebufferHeight,o=!1;if(n!==r.fullWidth||s!==r.fullHeight){var a=r.copy();a.fullWidth=n,a.fullHeight=s;var h=r.fovX-a.fovX,p=r.fovY-a.fovY;h<0&&h<p?a.fovX=r.fovX:p<0&&p<h&&(a.fovY=r.fovY),this._drapedRenderer.forceUpdate&&this._drapedRenderer.forceUpdate(a),o=!0,t=new v(this._rctx,{width:a.fullWidth,height:a.fullHeight,colorTarget:0,depthStencilTarget:3}),this._rctx.bindFramebuffer(t),a.setGLViewport(this._rctx),this._rctx.setClearColor.apply(this._rctx,this._backgroundColor),this._rctx.clear(16640),this._viewport.render({lightDirection:this._lightDirection,fbo:t,camera:a,pixelRatio:i.pixelRatio})}var d=this._readbackScreenshot(i);return t&&t.dispose(),this._rctx.bindFramebuffer(null),o&&this._drapedRenderer.forceUpdate&&this._drapedRenderer.forceUpdate(r),d},e.prototype._performScreenshots=function(){if(0!==this._screenshotQueue.length){for(var e=0,t=this._screenshotQueue;e<t.length;e++){var r=t[e],i=r.settings;if(this._gl){var n=this._ensureScreenshotEncodeCanvas(),s=this._renderScreenshot(i),o=g.encodeResult(s,i,n,{flipY:!0,premultipliedAlpha:!0});r.resolver(o)}else r.resolver.reject()}this._screenshotQueue=[]}},e.prototype._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},e}(),y={lightDirection:o.vec3d.create(),camera:null,fbo:null,pixelRatio:1},w=2048,x=1.5,C=8;return b});