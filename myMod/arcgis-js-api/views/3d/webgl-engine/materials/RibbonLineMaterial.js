// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../lib/gl-matrix","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","./internal/MaterialUtil","../shaders/RibbonLinePrograms"],function(t,e,r,n,a,i,s,o,p,l,c,d,f,m){var u=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),h=function(t){function e(e,r){var n=t.call(this,r)||this;return n.params=f.copyParameters(e,y),"miter"!==n.params.join&&(n.params.miterLimit=0),n.numVertsAtJoin="wall"===n.params.type?2:4,n.numVertsAtCap=2,n.canBeMerged="screen"===n.params.type&&null==n.params.stippleLength,n.bufferWriter="wall"===n.params.type?new A:new P(n.canBeMerged),n}return r(e,t),e.prototype.setColor=function(t){this.params.color=t,this.notifyDirty("matChanged")},e.prototype.getColor=function(){return this.params.color},e.prototype.dispose=function(){},e.prototype.getParams=function(){return this.params},e.prototype.getParameterValues=function(){var t=f.copyParameters(this.params);return t.miterLimit="miter"===t.join?t.miterLimit:0,t},e.prototype.setParameterValues=function(t){for(var e in t)d.assert("type"!==e,"RibbonLineMaterial: type cannot be changed after creation"),d.assert("stippleLength"!==e||null!=t[e]==(null!=this.params[e]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[e]=t[e];"miter"!==this.params.join&&(this.params.miterLimit=0),this.notifyDirty("matChanged")},e.prototype.intersect=function(t,e,r,n,s,p,l,c){if(n.isSelection&&!o.isAllHidden(e.componentVisibilities,t.data.componentOffsets)){if(!d.isTranslationMatrix(r))return void u.error("intersection assumes a translation-only matrix");var f=t.data,m=f.getVertexAttr()[d.VertexAttrConstants.POSITION].data,h=f.getVertexAttr()[d.VertexAttrConstants.SIZE],v=h&&h.data[0],g=n.camera,y=n.point,b=v+this.params.width,P=b/2+4;a.vec3d.set3(y[0]-P,y[1]+P,0,T[0]),a.vec3d.set3(y[0]+P,y[1]+P,0,T[1]),a.vec3d.set3(y[0]+P,y[1]-P,0,T[2]),a.vec3d.set3(y[0]-P,y[1]-P,0,T[3]);for(var L=0;L<4;L++)g.unprojectPoint(T[L],D[L]);i.plane.fromPoints(g.eye,D[0],D[1],B),i.plane.fromPoints(g.eye,D[1],D[2],N),i.plane.fromPoints(g.eye,D[2],D[3],j),i.plane.fromPoints(g.eye,D[3],D[0],F);for(var A=Number.MAX_VALUE,L=0;L<m.length-5;L+=3)if(C[0]=m[L]+r[12],C[1]=m[L+1]+r[13],C[2]=m[L+2]+r[14],O[0]=m[L+3]+r[12],O[1]=m[L+4]+r[13],O[2]=m[L+5]+r[14],!(i.plane.distance(B,C)<0&&i.plane.distance(B,O)<0||i.plane.distance(N,C)<0&&i.plane.distance(N,O)<0||i.plane.distance(j,C)<0&&i.plane.distance(j,O)<0||i.plane.distance(F,C)<0&&i.plane.distance(F,O)<0)){if(g.projectPoint(C,I),g.projectPoint(O,E),I[2]<0&&E[2]>0){a.vec3d.subtract(C,O,w);var V=g.frustumPlanes,x=-i.plane.distance(V[4],C),W=x/a.vec3d.dot(w,V[4]);a.vec3d.scale(w,W,w),a.vec3d.add(C,w,C),g.projectPoint(C,I)}else if(I[2]>0&&E[2]<0){a.vec3d.subtract(O,C,w);var V=g.frustumPlanes,x=-i.plane.distance(V[4],O),W=x/a.vec3d.dot(w,V[4]);a.vec3d.scale(w,W,w),a.vec3d.add(O,w,O),g.projectPoint(O,E)}else if(I[2]<0&&E[2]<0)continue;var J=d.pointLineSegmentDistanceSquared2D(I,E,y);J<A&&(A=J,a.vec3d.set(C,U),a.vec3d.set(O,M))}var q=n.p0,X=n.p1;if(A<P*P){var Z=d.lineLineDistanceSquared3D(U,M,q,X,R),_=Number.MAX_VALUE;if(Z.success){a.vec3d.subtract(Z.pa,q,S);var z=a.vec3d.length(S);a.vec3d.scale(S,1/z),_=z/a.vec3d.dist(q,X)}l(_,S)}}},e.prototype.getGLMaterials=function(){return{color:v,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:g}},e.prototype.getAllTextureIds=function(){return[]},e}(l),v=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.updateParameters(),n}return r(e,t),e.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},e.prototype.beginSlot=function(t){return t===c.TRANSPARENT_MATERIAL},e.prototype.getProgram=function(){return this.program},e.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.colorPass,{screenScale:"screen"===this.params.type,wall:"wall"===this.params.type,stipple:null!=this.params.stippleLength,slice:this.params.slicePlaneEnabled})},e.prototype.bind=function(t,e){var r=this,n=r.program,a=r.params;if(t.bindProgram(n),n.setUniform4fv("eColor",a.color),n.setUniform1f("miterLimit",a.miterLimit),n.setUniform1f("nearPlane",e.nearFar[0]),"screen"===a.type?(n.setUniform2fv("screenSize",[e.viewport[2],e.viewport[3]]),n.setUniform1f("extLineWidth",a.width*e.pixelRatio)):n.setUniform1f("extLineWidth",a.width),null!=a.stippleLength){var i=a.stippleLength?1/(2*a.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",i)}a.polygonOffset&&(t.setPolygonOffsetFillEnabled(!0),t.setPolygonOffset(0,-4)),t.setFaceCullingEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(770,771,1,771),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(a.color[3]>=1)},e.prototype.release=function(t){this.params.polygonOffset&&t.setPolygonOffsetFillEnabled(!1),t.setBlendingEnabled(!1),t.setDepthWriteEnabled(!0)},e.prototype.bindView=function(t,e){var r=this.program,n=this.params;f.bindView(e.origin,e.view,r),n.slicePlaneEnabled&&f.bindSlicePlane(e.origin,e.slicePlane,r)},e.prototype.bindInstance=function(t,e){this.program.setUniformMatrix4fv("model",e.transformation)},e.prototype.getDrawMode=function(t){return 5},e}(p),g=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.updateParameters(),n}return r(e,t),e.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},e.prototype.beginSlot=function(t){return t===c.OPAQUE_MATERIAL},e.prototype.getProgram=function(){return this.program},e.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.highlightPass,{screenScale:"screen"===this.params.type,wall:"wall"===this.params.type,stipple:null!=this.params.stippleLength,slice:this.params.slicePlaneEnabled})},e.prototype.bind=function(t,e){var r=this,n=r.program,a=r.params;if(t.bindProgram(n),n.setUniform4fv("eColor",a.color),n.setUniform1f("miterLimit",a.miterLimit),n.setUniform1f("nearPlane",e.nearFar[0]),"screen"===a.type?(n.setUniform2fv("screenSize",[e.viewport[2],e.viewport[3]]),n.setUniform1f("extLineWidth",a.width*e.pixelRatio)):n.setUniform1f("extLineWidth",a.width),null!=a.stippleLength){var i=a.stippleLength?1/(2*a.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",i)}a.polygonOffset&&(t.setPolygonOffsetFillEnabled(!0),t.setPolygonOffset(0,-4)),t.setFaceCullingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(a.color[3]>=1)},e.prototype.release=function(t){this.params.polygonOffset&&t.setPolygonOffsetFillEnabled(!1),t.setDepthWriteEnabled(!0)},e.prototype.bindView=function(t,e){var r=this.program,n=this.params;f.bindView(e.origin,e.view,r),n.slicePlaneEnabled&&f.bindSlicePlane(e.origin,e.slicePlane,r)},e.prototype.bindInstance=function(t,e){this.program.setUniformMatrix4fv("model",e.transformation)},e.prototype.getDrawMode=function(t){return 5},e}(p),y={color:[1,1,1,1],width:0,type:"screen",join:"miter",miterLimit:5,polygonOffset:!1,stippleLength:null,slicePlaneEnabled:!1},b=s.newLayout().vec3f(d.VertexAttrConstants.POSITION).vec2f(d.VertexAttrConstants.UV0).vec3f(d.VertexAttrConstants.AUXPOS1).vec3f(d.VertexAttrConstants.AUXPOS2).vec4f(d.VertexAttrConstants.COLOR).f32(d.VertexAttrConstants.SIZE),P=function(){function t(t){this.canBeMerged=t,this.vertexBufferLayout=b,this.numVertsAtJoin=4,this.numVertsAtCap=2}return t.prototype.allocate=function(t){return b.createBuffer(t)},t.prototype.elementCount=function(t){var e=t.indices[d.VertexAttrConstants.POSITION].length/2+1,r=(e-2)*this.numVertsAtJoin+2*this.numVertsAtCap;return this.canBeMerged&&(r+=2),r},t.prototype.write=function(t,e,r,n,a){var i=e.vertexAttr[d.VertexAttrConstants.POSITION].data,s=e.indices&&e.indices[d.VertexAttrConstants.POSITION];s&&s.length!==2*(i.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var o=e.vertexAttr[d.VertexAttrConstants.COLOR]?e.vertexAttr[d.VertexAttrConstants.COLOR].data:V,p=e.vertexAttr[d.VertexAttrConstants.SIZE]?e.vertexAttr[d.VertexAttrConstants.SIZE].data:x,l=i.length/3,c=t.transformation,f=n.position.typedBuffer,m=0,u=this.vertexBufferLayout.stride/4,h=a*u,v=h;this.canBeMerged&&(h+=u);var g=i[0],y=i[1],b=i[2];if(c){var P=g,L=y,A=b;g=c[0]*P+c[4]*L+c[8]*A+c[12],y=c[1]*P+c[5]*L+c[9]*A+c[13],b=c[2]*P+c[6]*L+c[10]*A+c[14]}var C=i[3],O=i[4],w=i[5];if(c){var P=C,L=O,A=w;C=c[0]*P+c[4]*L+c[8]*A+c[12],O=c[1]*P+c[5]*L+c[9]*A+c[13],w=c[2]*P+c[6]*L+c[10]*A+c[14]}for(var S=g,I=y,E=b,U=0;U<l;U++){var M=3*U;if(U<l-1&&(C=i[M+3],O=i[M+4],w=i[M+5],c)){var P=C,L=O,A=w;C=c[0]*P+c[4]*L+c[8]*A+c[12],O=c[1]*P+c[5]*L+c[9]*A+c[13],w=c[2]*P+c[6]*L+c[10]*A+c[14]}m+=Math.sqrt((S-g)*(S-g)+(I-y)*(I-y)+(E-b)*(E-b)),f[h++]=S,f[h++]=I,f[h++]=E,f[h++]=m,f[h++]=0===U?-1.2:-1,f[h++]=g,f[h++]=y,f[h++]=b,f[h++]=C,f[h++]=O,f[h++]=w,f[h++]=o[0],f[h++]=o[1],f[h++]=o[2],f[h++]=o[3],f[h++]=p[0],f[h++]=S,f[h++]=I,f[h++]=E,f[h++]=m,f[h++]=0===U?1.2:1,f[h++]=g,f[h++]=y,f[h++]=b,f[h++]=C,f[h++]=O,f[h++]=w,f[h++]=o[0],f[h++]=o[1],f[h++]=o[2],f[h++]=o[3],f[h++]=p[0],U>0&&U<l-1&&(f[h++]=S,f[h++]=I,f[h++]=E,f[h++]=m,f[h++]=-1.2,f[h++]=g,f[h++]=y,f[h++]=b,f[h++]=C,f[h++]=O,f[h++]=w,f[h++]=o[0],f[h++]=o[1],f[h++]=o[2],f[h++]=o[3],f[h++]=p[0],f[h++]=S,f[h++]=I,f[h++]=E,f[h++]=m,f[h++]=1.2,f[h++]=g,f[h++]=y,f[h++]=b,f[h++]=C,f[h++]=O,f[h++]=w,f[h++]=o[0],f[h++]=o[1],f[h++]=o[2],f[h++]=o[3],f[h++]=p[0]),g=S,y=I,b=E,S=C,I=O,E=w}if(this.canBeMerged){for(var U=v;U<v+u;U++)f[U]=f[U+u];for(var R=h-u,U=0;U<u;U++)f[h++]=f[R++]}},t}(),L=s.newLayout().vec3f(d.VertexAttrConstants.POSITION).vec2f(d.VertexAttrConstants.UV0),A=function(){function t(){this.vertexBufferLayout=L,this.numVertsAtJoin=2,this.numVertsAtCap=2,this.tmpCurrent=a.vec3d.create(),this.tmpLast=a.vec3d.create()}return t.prototype.allocate=function(t){return b.createBuffer(t)},t.prototype.elementCount=function(t){return(t.indices[d.VertexAttrConstants.POSITION].length/2+1-2)*this.numVertsAtJoin+2*this.numVertsAtCap},t.prototype.write=function(t,e,r,n,i){var s=e.vertexAttr[d.VertexAttrConstants.POSITION].data,o=e.indices&&e.indices[d.VertexAttrConstants.POSITION];o&&o.length!==2*(s.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var p=s.length/3,l=t.transformation,c=0,f=this.tmpCurrent,m=this.tmpLast;a.vec3d.set3(s[0],s[1],s[2],f);for(var u=i,h=0;h<p;h++){var v=3*h;a.vec3d.set(f,m),a.vec3d.set3(s[v],s[v+1],s[v+2],f),l&&a.mat4d.multiplyVec3(l,f,f),c+=a.vec3d.dist2(m,f),n.position.setVec(u,f),n.uv0.set(u,0,c),n.uv0.set(u,1,-1),++u,n.position.setVec(u,f),n.uv0.set(u,0,c),n.uv0.set(u,1,1),++u}},t}(),V=[255,255,255,255],x=[0,0,0,0],C=a.vec3d.create(),O=a.vec3d.create(),w=a.vec3d.create(),S=a.vec3d.create(),I=a.vec3d.create(),E=a.vec3d.create(),U=a.vec3d.create(),M=a.vec3d.create(),R={success:!1,dist2:0,pa:a.vec3d.create(),pb:a.vec3d.create()},T=[a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create()],D=[a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create()],B=i.plane.create(),N=i.plane.create(),j=i.plane.create(),F=i.plane.create();return h});