// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../geometry/support/aaBoundingBox","../../../lib/gl-matrix","../../../support/mathUtils","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],function(e,n,t,r,i,a,o,c,s){function f(e,n,t,r,i,o,c){s.assert("triangle"===e.data.primitiveType);var f=n&&n.componentVisibilities,d=r.tolerance;e.componentCount>1?v(e,f,i,o,d,c):f&&!a.getVisibility(f,0)||l(e.boundingInfo,i,o,d,c)}function l(e,n,r,i,a){var o=m(n,r,N);if(t.setMin(E,e.getBBMin()),t.setMax(E,e.getBBMax()),g(E,n,o,i)){var c=e.getPrimitiveIndices(),s=e.getIndices(),f=e.getPosition(),v=c?c.length:s.length/3;if(v>G){var u=e.getChildren();if(void 0!==u){for(var p=0;p<8;++p)void 0!==u[p]&&l(u[p],n,r,i,a);return}}d(n,r,0,v,s,f,c,a)}}function v(e,n,r,i,o,c){var s=m(r,i,N),f=e.boundingInfo;if(t.setMin(E,f.getBBMin()),t.setMax(E,f.getBBMax()),g(E,r,s,o))for(var l=e.data,v=e.componentCount,u=l.getIndices(C.POSITION),p=l.getAttribute(C.POSITION),h=l.componentOffsets,b=0;b<v;b++)if(!n||a.getVisibility(n,b)){var M=e.getComponentAABB(b,E);if(g(M,r,s,o)){var x=h[b]/3,P=h[b+1]/3;d(r,i,x,P,u,p,void 0,c)}}}function d(e,n,t,r,i,a,o,c){for(var s=a.data,f=a.offsetIdx,l=a.strideIdx,v=e[0],d=e[1],m=e[2],g=n[0],p=n[1],h=n[2],b=g-v,M=p-d,x=h-m,P=t;P<r;P++){var S=o?o[P]:P,O=f+l*i[3*S],y=f+l*i[3*S+1],L=f+l*i[3*S+2],U=s[O],B=s[O+1],I=s[O+2],A=s[y],w=s[y+1],W=s[y+2],T=s[L],V=s[L+1],D=s[L+2],E=A-U,C=w-B,N=W-I,Y=T-U,j=V-B,H=D-I,R=M*H-j*x,_=x*Y-H*b,k=b*j-Y*M,G=E*R+C*_+N*k,F=v-U,J=d-B,K=m-I,Q=J*N-C*K,X=K*E-N*F,Z=F*C-E*J;if(G>z){var $=F*R+J*_+K*k;if($<0||$>G)continue;var ee=b*Q+M*X+x*Z;if(ee<0||$+ee>G)continue}else{if(!(G<-z))continue;var $=F*R+J*_+K*k;if($>0||$<G)continue;var ee=b*Q+M*X+x*Z;if(ee>0||$+ee<G)continue}var ne=(Y*Q+j*X+H*Z)/G;if(ne>=0){c(ne,u(E,C,N,Y,j,H,q),S)}}}function u(e,n,t,i,a,o,c){return r.vec3d.set3(e,n,t,Y),r.vec3d.set3(i,a,o,j),r.vec3d.normalize(r.vec3d.cross(Y,j,c))}function m(e,n,t){return r.vec3d.set3(1/(n[0]-e[0]),1/(n[1]-e[1]),1/(n[2]-e[2]),t)}function g(e,n,t,r){var i=(e[0]-r-n[0])*t[0],a=(e[3]+r-n[0])*t[0],o=Math.min(i,a),c=Math.max(i,a),s=(e[1]-r-n[1])*t[1],f=(e[4]+r-n[1])*t[1];if(o=Math.max(o,Math.min(s,f)),c=Math.min(c,Math.max(s,f)),o>c)return!1;var l=(e[2]-r-n[2])*t[2],v=(e[5]+r-n[2])*t[2];return o=Math.max(o,Math.min(l,v)),c=Math.min(c,Math.max(l,v)),o<=c}function p(e,n,t){return r.vec4d.set4(e[0]-n[0],e[1]-n[1],e[2]-n[2],1,t)}function h(e,n,t,i){return r.mat4d.translate(t,n,D),t=D,r.mat4d.multiplyVec4(t,e,i)}function b(e,n,t,i){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3],r.mat4d.multiplyVec4(n,i)}function M(e,n){return r.vec4d.scale(e,1/Math.abs(e[3]),n)}function x(e,n,t,r,i){return c.scale(e,r,t,i)}function P(e,n,t,r,a){var o=t.screenLength||0;a&&(o=x(o,e,n,r,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return i.clamp(c*n,t.minWorldLength||0,null!=t.maxWorldLength?t.maxWorldLength:1/0)}function S(e,n,t){if(void 0!==e)return n.aquire(e,t)}function O(e,n){void 0!==e&&n.release(e)}function y(e,n,t){r.mat4d.translate(n,e,H),t.setUniform3fv("localOrigin",e),t.setUniformMatrix4fv("view",H)}function L(e,n,t){t.setUniform3f("camPos",n[3]-e[0],n[7]-e[1],n[11]-e[2])}function U(e,n){o.encodeDoubleArraySplit(e,R,_,3),n.setUniform3fv("viewOriginHi",R),n.setUniform3fv("viewOriginLo",_)}function B(e,n,t){r.vec3d.subtract(n.origin,e,k),t.setUniform3fv("slicePlaneOrigin",k),t.setUniform3fv("slicePlaneBasis1",n.basis1),t.setUniform3fv("slicePlaneBasis2",n.basis2)}function I(e,n,t){if(e){var r=A(e,n.fovY,n.viewport[3]),i=n.pixelRatio||1;t.setUniform4f("verticalOffset",r.screenLength*i,r.perDistance,r.minWorldLength,r.maxWorldLength)}}function A(e,n,t,r){return void 0===r&&(r=F),r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*n)/(.5*t),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}function w(e,n,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var i=e.parameters,a=n.pixelRatio||1,o=e.paddingPixelsOverride;t.setUniform4f(r,i.divisor,i.offset,i.minPixelSize*a,o)}}function W(e,n){var t=n?W(n):{};for(var r in e){var i=e[r];i&&i.forEach&&(i=V(i)),null==i&&r in t||(t[r]=i)}return t}function T(e,n){var t=!1;for(var r in n){var i=n[r];void 0!==i&&(t=!0,Array.isArray(i)?e[r]=i.slice():e[r]=i)}return t}function V(e){var n=[];return e.forEach(function(e){return n.push(e)}),n}Object.defineProperty(n,"__esModule",{value:!0});var D=r.mat4d.create(),E=t.create(),C=s.VertexAttrConstants;n.IDENTITY=r.mat4d.identity(),n.intersectTriangleGeometry=f;var N=r.vec3d.create(),z=Math.pow(2,-52),q=r.vec3d.create();n.intersectTriangles=d;var Y=r.vec3d.create(),j=r.vec3d.create();n.computeNormal=u,n.intersectAabbInvDir=g,n.transformToWorld=p,n.transformToView=h,n.transformToProjection=b,n.transformToNDC=M,n.applyScreenSizePerspectiveScale=x,n.verticalOffsetAtDistance=P,n.aquireIfNotUndefined=S,n.releaseIfNotUndefined=O;var H=r.mat4.create();n.bindView=y,n.bindCamPos=L;var R=r.vec3d.create(),_=r.vec3d.create();n.bindViewOriginDouble=U;var k=r.vec3d.create();n.bindSlicePlane=B,n.bindVerticalOffset=I,n.bindScreenSizePerspective=w,n.copyParameters=W,n.updateParameters=T;!function(e){function n(e,n){for(var t=[],r=0;r<2;r++)for(var a=0;a<2;a++){var o=i({shadowMappingEnabled:1===r,ssaoEnabled:1===a}),c=i({shadowMappingEnabled:1===r,ssaoEnabled:1===a&&e.receiveSSAO});t[o]=t[c]||n({receiveShadows:1===r,receiveSSAO:1===a&&e.receiveSSAO})}return{programs:t.filter(function(e){return null!=e}),byParameter:t}}function t(e,n){return e.byParameter[i(n)]}function r(e){return e.programs}function i(e){return(e.shadowMappingEnabled?1:0)|(e.ssaoEnabled?2:0)}e.create=n,e.lookup=t,e.programs=r}(n.BindParametersMap||(n.BindParametersMap={})),n.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var G=1e3,F={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});