// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/has","../../lib/gl-matrix","./Object3D","./PerformanceTimer"],function(t,e,r,i,s,n){var a=i.vec3d.create(),o=i.vec3d.create(),m=i.vec3d.create(),h=r("dojo-debug-messages"),l=function(){function t(t){this.minResult=new c,this.maxResult=new c,this._normalDir=null,this._transform=i.mat4d.create(),this._transformInverse=new u({value:this._transform},i.mat4d.inverse,i.mat4d.create),this._transformInverseTranspose=new u(this._transformInverse,i.mat4d.transpose,i.mat4d.create),this._transformTranspose=new u({value:this._transform},i.mat4d.transpose,i.mat4d.create),this._transformInverseRotation=new u({value:this._transform},i.mat4d.toInverseMat3,i.mat3d.create),this.enableHUDSelection=!0,this.enableTerrain=!0,this.enableInvisibleTerrain=!1,this.enableBackfacesTerrain=!0,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.viewingMode=t||"global",h&&(this._timer=new n(1))}return t.prototype.init=function(t,e,r,s,n,a,o,l){var c=this;if(e&&r&&i.vec3d.subtract(r,e,m),this.minResult.init(e,r),this.maxResult.init(e,r),this._numObjectsTested=0,this.point=s,this.camera=n,this.isSelection=o,this.p0=e,this.p1=r,this.hudResults=[],null==a&&(a=1e-5),this.tolerance=a,t){var u=function(t){c.intersectObject(t,l)};h&&this._timer.start();for(var f=0,d=t;f<d.length;f++){var p=d[f],v=p.getSpatialQueryAccelerator?p.getSpatialQueryAccelerator():void 0;if(v)v.forEachAlongRay(this.p0,m,u),o&&v.forEachDegenerateObject(u);else for(var y=p.getObjects(),g=0,b=y;g<b.length;g++){var _=b[g];u(_)}}h&&(this._timer.stop(),this.performanceInfo.queryDuration=this._timer.getLast(),this.performanceInfo.numObjectsTested=this._numObjectsTested)}},Object.defineProperty(t.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),t.prototype.getDirection=function(){return this._normalDir||(this._normalDir=i.vec3d.create(),i.vec3d.normalize(m,this._normalDir)),this._normalDir},t.prototype.intersectObject=function(t,e){var r=this;this._numObjectsTested++;for(var s,n=t.id,m=t.getGeometryRecords(),h=t.objectTransformation,l=0;l<m.length;l++){var u=m[l],f=u.geometry,d=u.materials,p=u.instanceParameters;p.hidden||(s=f.id,i.mat4d.set(h,this._transform),i.mat4d.multiply(this._transform,u.getShaderTransformation()),this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate(),i.mat4d.multiplyVec3(this.transformInverse,this.p0,a),i.mat4d.multiplyVec3(this.transformInverse,this.p1,o),d[0].intersect(f,p,this._transform,this,a,o,function(i,a,o,m,h,l){if(i>=0){if(null!=e&&!e(r.p0,r.p1,i))return;if(h){var u=new c;u.init(r.p0,r.p1),u.set(t,n,i,a,m,l,s,o),r.hudResults.push(u)}else(null==r.minResult.priority||m>=r.minResult.priority)&&(null==r.minResult.dist||i<r.minResult.dist)&&r.minResult.set(t,n,i,a,m,null,s,o),(null==r.maxResult.priority||m>=r.maxResult.priority)&&(null==r.maxResult.dist||i>r.maxResult.dist)&&r.maxResult.set(t,n,i,a,m,null,s,o)}},u.customTransformation),this.minResult.geometryId===s&&i.mat4d.set(this._transform,this.minResult.transformation),this.maxResult.geometryId===s&&i.mat4d.set(this._transform,this.maxResult.transformation))}},t.DEFAULT_TOLERANCE=1e-5,t}(),c=function(){function t(t,e){this.transformation=i.mat4d.identity(),this.normal=i.vec3d.create(),this.init(t,e)}return t.prototype.getIntersectionPoint=function(t){return null!=this.dist&&(i.vec3d.lerp(this.p0,this.p1,this.dist,t),!0)},t.prototype.getTransformedNormal=function(t){return i.vec3d.set(this.normal,f),f[3]=0,i.mat4d.multiplyVec4(this.transformation,f),i.vec3d.set(f,t),i.vec3d.normalize(t),t},t.prototype.set=function(t,e,r,n,a,o,m,h){t instanceof s&&(t={type:"stage",obj:t}),this.dist=r,i.vec3d.set(n,this.normal),this.target=t,this.name=e,this.priority=a,this.center=o?i.vec3d.create(o):null,this.geometryId=m,this.triangleNr=h},t.prototype.copyFrom=function(t){this.p0=t.p0,this.p1=t.p1,this.dist=t.dist,this.target=t.target,this.name=t.name,this.priority=t.priority,this.center=t.center?i.vec3d.create(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,i.vec3d.set(t.normal,this.normal)},t.prototype.setIntersector=function(t){this.intersector=t},t.prototype.init=function(t,e){this.dist=void 0,this.target=void 0,this.name=void 0,this.priority=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",this.p0=t,this.p1=e},t}(),u=function(){function t(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}return t.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(t.prototype,"value",{get:function(){return this.dirty&&(this.update(this.original.value,this.transform),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),t}(),f=i.vec4d.create();return l});