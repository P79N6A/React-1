// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../lib/gl-matrix","./ComponentUtils","./GeometryRecord","./HighlightUtils","./IdGen","./ModelContentType","./Util"],function(t,e,i,o,r,n,a,s,c){var m=c.assert,h=i.mat4d.identity(),d=function(){function t(e){void 0===e&&(e={}),this._bvObjectSpace=new l,this._bvWorldSpace=new l,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._allComponentsHiddenDirty=!0,this.id=t._idGen.gen(e.idHint),this.name=e.name,this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.objectTransformation=i.mat4d.identity(),this._initializeGeometryRecords(e.geometries,e.materials,e.transformations,e.origins)}return t.prototype._initializeGeometryRecords=function(t,e,o,n){if(!Array.isArray(t))return this.geometryRecords=[],void(this.geometries=[]);m(e.length===t.length,"Object3D: materials don't match geometries"),m(o.length===t.length,"Object3D: transformations don't match geometries"),this.geometryRecords=new Array(t.length),this.geometries=t.slice();for(var a=0;a<t.length;a++){m(Array.isArray(e[a]),"Object3D: materials parameter must be array of array");var s={};this.geometryRecords[a]=new r(t[a],e[a].slice(),i.mat4d.create(o[a]),s,n&&n[a])}this._hasVolatileTransformation=!1},Object.defineProperty(t.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(t){m(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t},enumerable:!0,configurable:!0}),t.prototype.getParentLayer=function(){return this.parentLayer},t.prototype.addParentLayer=function(t){this.parentLayer=t},t.prototype.removeParentLayer=function(t){this.parentLayer=null},t.prototype.getNumGeometryRecords=function(){return this.geometryRecords.length},t.prototype.getFirstGeometryIndex=function(t){var e=this.geometries.indexOf(t);return m(e>-1,"Object3D.getFirstGeometryIndex: geometry not found"),e},t.prototype.findGeometryRecords=function(t){for(var e=[],i=0;i<this.geometries.length;i++)this.geometries[i]===t&&e.push(this.geometryRecords[i]);return e},t.prototype.getGeometryRecord=function(t){return m(t>=0&&t<this.geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this.geometryRecords[t]},t.prototype.getGeometryRecords=function(){return this.geometryRecords},t.prototype.addGeometry=function(t,e,o,n,a,s){void 0===o&&(o=h),m(Array.isArray(e),"Object3D.addGeometry: materials must be array"),this.geometries.push(t);var c=new r(t,e.slice(),i.mat4d.create(o),n||{},a,s);return this.geometryRecords.push(c),this._hasVolatileTransformation=this.geometryRecords.some(function(t){return!!t.customTransformation}),this._notifyDirty("objGeometryAdded",c),this._invalidateBoundingVolume(),this._allComponentsHiddenDirty=!0,c},t.prototype.hasGeometry=function(t){return this.geometries.indexOf(t)>-1},t.prototype.removeGeometry=function(t){var e=this.geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=this.geometryRecords.some(function(t){return!!t.customTransformation}),this.geometries.splice(t,1),this._notifyDirty("objGeometryRemoved",e),this._invalidateBoundingVolume(),this._allComponentsHiddenDirty=!0,e},t.prototype.removeAllGeometries=function(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)},t.prototype.geometryVertexAttrsUpdated=function(t){this._notifyDirty("vertexAttrsUpdated",this.geometryRecords[t]),this._invalidateBoundingVolume()},t.prototype.areAllComponentsHidden=function(){if(this._allComponentsHiddenDirty){this._allComponentsHiddenDirty=!1,this._allComponentsHidden=!0;for(var t=0,e=this.geometryRecords;t<e.length;t++){var i=e[t],r=i.instanceParameters.componentVisibilities,n=i.geometry.data.componentOffsets;if(!o.isAllHidden(r,n)){this._allComponentsHidden=!1;break}}}return this._allComponentsHidden},t.prototype.areAllComponentsVisible=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var i=e[t],r=i.instanceParameters.componentVisibilities,n=i.geometry.data.componentOffsets;if(!o.isAllVisible(r,n))return!1}return!0},t.prototype.hasComponents=function(){for(var t=!1,e=0;e<this.geometries.length;e++){var i=this.geometries[e];if(t=o.hasComponents(i.data.componentOffsets))break}return t},t.prototype.setComponentVisibility=function(t,e,i){var r=t.geometry,n=t.instanceParameters.componentVisibilities,a=r.data.componentOffsets,s=o.updateVisibility(n,a,e,i);t.instanceParameters.componentVisibilities=s,this._notifyDirty("visibilityChanged",t),this._allComponentsHiddenDirty=!0},t.prototype.setHidden=function(t,e){t.instanceParameters.hidden=!!e,this._notifyDirty("visibilityChanged",t)},t.prototype.isHidden=function(t){return!!t.instanceParameters.hidden},t.prototype.getComponentVisibility=function(t,e){var i=t.instanceParameters.componentVisibilities;return o.getVisibility(i,e)},t.prototype.hideAllComponents=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var i=e[t],r=i.instanceParameters.componentVisibilities,n=o.hideAllComponents(r);i.instanceParameters.componentVisibilities=n}this._notifyDirty("visibilityChanged"),this._allComponentsHiddenDirty=!0},t.prototype.unhideAllComponents=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var i=e[t],r=i.instanceParameters.componentVisibilities,n=o.unhideAllComponents(r);i.instanceParameters.componentVisibilities=n}this._notifyDirty("visibilityChanged"),this._allComponentsHiddenDirty=!0},t.prototype._setComponentHighlight=function(t,e,i,r){var n=t.instanceParameters.componentHighlights,a=o.addHighlight(n,e,i,r);t.instanceParameters.componentHighlights=a},t.prototype.setComponentHighlight=function(t,e,i){var o=n.generateHighlightId();return this._setComponentHighlight(t,e,i,o),this._notifyDirty("componentHighlightChanged"),o},t.prototype.highlightAllComponents=function(t){for(var e=n.generateHighlightId(),i=0,o=this.geometryRecords;i<o.length;i++){var r=o[i];this._setComponentHighlight(r,null,t,e)}return this._notifyDirty("componentHighlightChanged"),e},t.prototype.removeHighlights=function(t){for(var e=0,i=this.geometryRecords;e<i.length;e++){var r=i[e],n=r.instanceParameters,a=n.componentHighlights,s=o.removeHighlight(a,t);n.componentHighlights=s}this._notifyDirty("componentHighlightChanged")},t.prototype.getComponentFromTriangleNr=function(t,e){m(t>=0&&t<this.geometryRecords.length,"Object3d.getComponentFromTriangleNr: index out of range");var i=this.geometryRecords[t],r=i.geometry.data.componentOffsets;return o.componentFind(r,3*e)},t.prototype.setGeometryTransformation=function(t,e){m(t>=0&&t<this.geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");var o=this.geometryRecords[t],n=new r(o.geometry,o.materials,i.mat4d.create(e),o.instanceParameters);this.geometryRecords[t]=n,this._notifyDirty("objGeometryReplaced",[o,n]),this._invalidateBoundingVolume()},t.prototype.getObjectTransformation=function(){return i.mat4d.create(this.objectTransformation)},t.prototype.setObjectTransformation=function(t){i.mat4d.set(t,this.objectTransformation),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")},t.prototype.getCombinedStaticTransformation=function(t,e){return e=e||i.mat4d.create(),i.mat4d.multiply(this.objectTransformation,t.getStaticTransformation(),e),e},t.prototype.getCombinedShaderTransformation=function(t,e){return e=e||i.mat4d.create(),i.mat4d.multiply(this.objectTransformation,t.getShaderTransformation(),e),e},t.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation},t.prototype.getCastShadow=function(){return this.castShadow},t.prototype.setCastShadow=function(t){this.castShadow=t},t.prototype.getMetadata=function(){return this.metadata},t.prototype.getName=function(){return this.name},t.prototype.getBBMin=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},t.prototype.getBBMax=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},t.prototype.getCenter=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.center:this._bvWorldSpace.center},t.prototype.getBSRadius=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius},t.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var t=0;t<this.geometryRecords.length;++t){var e=this.geometries[t],o=this.geometryRecords[t],r=e.boundingInfo;this._calculateTransformedBoundingVolume(r,this._bvObjectSpace,o.getShaderTransformation()),this._calculateTransformedBoundingVolume(r,this._bvWorldSpace,this.getCombinedShaderTransformation(o))}i.vec3d.lerp(this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5,this._bvObjectSpace.center),i.vec3d.lerp(this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5,this._bvWorldSpace.center);for(var n=i.vec3d.create(),a=i.vec3d.create(),s=i.mat4d.maxScale(this.objectTransformation),t=0;t<this.geometryRecords.length;++t){var e=this.geometries[t],c=this.geometryRecords[t].getShaderTransformation(),m=i.mat4d.maxScale(c),r=e.boundingInfo;i.mat4d.multiplyVec3(c,r.getCenter(),n);var h=i.vec3d.dist(n,this._bvObjectSpace.center),d=r.getBSRadius()*m;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,h+d),i.mat4d.multiplyVec3(this.objectTransformation,n,a);var l=i.vec3d.dist(a,this._bvWorldSpace.center),p=d*s;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,l+p)}this._bvDirty=!1}},t.prototype._calculateTransformedBoundingVolume=function(t,e,o){var r=t.getBBMin(),n=t.getBBMax(),a=i.vec3d.create(r),s=i.vec3d.create(n);i.mat4d.multiplyVec3(o,a),i.mat4d.multiplyVec3(o,s);for(var c=0;c<3;++c)e.bbMin[c]=Math.min(e.bbMin[c],a[c],s[c]),e.bbMax[c]=Math.max(e.bbMax[c],a[c],s[c]);for(var c=0;c<3;++c){i.vec3d.set(r,a),i.vec3d.set(n,s),a[c]=n[c],s[c]=r[c],i.mat4d.multiplyVec3(o,a),i.mat4d.multiplyVec3(o,s);for(var m=0;m<3;++m)e.bbMin[m]=Math.min(e.bbMin[m],a[m],s[m]),e.bbMax[m]=Math.max(e.bbMax[m],a[m],s[m])}},t.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})},t.prototype._notifyDirty=function(t,e,i,o){if(this._parentLayer){i=i||s.OBJECT;var r=o||this;this._parentLayer.notifyDirty(t,e,i,r)}},t._idGen=new a,t}(),l=function(){function t(){this.bbMin=i.vec3d.create(),this.bbMax=i.vec3d.create(),this.center=i.vec3d.create(),this.bsRadius=0}return t.prototype.init=function(){i.vec3d.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.bbMin),i.vec3d.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.bbMax),i.vec3d.set3(0,0,0,this.center),this.bsRadius=0},t.prototype.getCenter=function(){return this.center},t.prototype.getBSRadius=function(){return this.bsRadius},t}();return d});