// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../lib/gl-matrix","../../support/mathUtils","./Camera","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./glUtil3D","./Util","../shaders/MiscPrograms","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,a,r,s,c,i,d,o,n,h,v,u,p,l){function f(e,t,r,s,c,i,d,n){a.vec2d.set2(0,0,I);for(var h=0;h<4;++h)a.vec2d.add(I,e[h],I);a.vec2d.scale(I,.25),a.vec2d.set2(0,0,L);for(var h=4;h<8;++h)a.vec2d.add(L,e[h],L);a.vec2d.scale(L,.25),a.vec2d.lerp(e[4],e[5],.5,W[0]),a.vec2d.lerp(e[5],e[6],.5,W[1]),a.vec2d.lerp(e[6],e[7],.5,W[2]),a.vec2d.lerp(e[7],e[4],.5,W[3]);for(var v=0,u=a.vec2d.dist2(W[0],I),h=1;h<4;++h){var p=a.vec2d.dist2(W[h],I);p<u&&(u=p,v=h)}a.vec2d.subtract(W[v],e[v+4],G);var l=G[0];G[0]=-G[1],G[1]=l,a.vec2d.subtract(L,I,Q),a.vec2d.lerp(G,Q,r),a.vec2d.normalize(G);var f,m;f=m=a.vec2d.dot(a.vec2d.subtract(e[0],I,k),G);for(var h=1;h<8;++h){var x=a.vec2d.dot(a.vec2d.subtract(e[h],I,k),G);x<f?f=x:x>m&&(m=x)}a.vec2d.set(I,s),a.vec2d.scale(G,f-t,k),a.vec2d.add(s,k,s);for(var b=-1,y=1,g=0,M=0,h=0;h<8;++h){a.vec2d.subtract(e[h],s,z),a.vec2d.normalize(z);var T=G[0]*z[1]-G[1]*z[0];T>0?T>b&&(b=T,g=h):T<y&&(y=T,M=h)}o.verify(b>0,"leftArea"),o.verify(y<0,"rightArea"),a.vec2d.scale(G,f,q),a.vec2d.add(q,I,q),a.vec2d.scale(G,m,H),a.vec2d.add(H,I,H),X[0]=-G[1],X[1]=G[0];var w=o.rayRay2D(s,e[M],H,a.vec2d.add(H,X,k),1,c),D=o.rayRay2D(s,e[g],H,k,1,i),R=o.rayRay2D(s,e[g],q,a.vec2d.add(q,X,k),1,d),C=o.rayRay2D(s,e[M],q,k,1,n);o.verify(w,"rayRay"),o.verify(D,"rayRay"),o.verify(R,"rayRay"),o.verify(C,"rayRay")}function m(e,t){return 3*t+e}function x(e,t){return a.vec3d.set3(e[t],e[t+3],e[t+6],Y),Y}function b(e,t,r,s,c){a.vec2d.scale(a.vec2d.subtract(r,s,J),.5),K[0]=J[0],K[1]=J[1],K[2]=0,K[3]=J[1],K[4]=-J[0],K[5]=0,K[6]=J[0]*J[0]+J[1]*J[1],K[7]=J[0]*J[1]-J[1]*J[0],K[8]=1,K[m(0,2)]=-a.vec2d.dot(x(K,0),e),K[m(1,2)]=-a.vec2d.dot(x(K,1),e);var i=a.vec2d.dot(x(K,0),r)+K[m(0,2)],d=a.vec2d.dot(x(K,1),r)+K[m(1,2)],o=a.vec2d.dot(x(K,0),s)+K[m(0,2)],n=a.vec2d.dot(x(K,1),s)+K[m(1,2)];i=-(i+o)/(d+n),K[m(0,0)]+=K[m(1,0)]*i,K[m(0,1)]+=K[m(1,1)]*i,K[m(0,2)]+=K[m(1,2)]*i,i=1/(a.vec2d.dot(x(K,0),r)+K[m(0,2)]),d=1/(a.vec2d.dot(x(K,1),r)+K[m(1,2)]),K[m(0,0)]*=i,K[m(0,1)]*=i,K[m(0,2)]*=i,K[m(1,0)]*=d,K[m(1,1)]*=d,K[m(1,2)]*=d,K[m(2,0)]=K[m(1,0)],K[m(2,1)]=K[m(1,1)],K[m(2,2)]=K[m(1,2)],K[m(1,2)]+=1,i=a.vec2d.dot(x(K,1),t)+K[m(1,2)],d=a.vec2d.dot(x(K,2),t)+K[m(2,2)],o=a.vec2d.dot(x(K,1),r)+K[m(1,2)],n=a.vec2d.dot(x(K,2),r)+K[m(2,2)],i=-.5*(i/d+o/n),K[m(1,0)]+=K[m(2,0)]*i,K[m(1,1)]+=K[m(2,1)]*i,K[m(1,2)]+=K[m(2,2)]*i,i=a.vec2d.dot(x(K,1),t)+K[m(1,2)],d=a.vec2d.dot(x(K,2),t)+K[m(2,2)],o=-d/i,K[m(1,0)]*=o,K[m(1,1)]*=o,K[m(1,2)]*=o,c[0]=K[0],c[1]=K[1],c[2]=0,c[3]=K[2],c[4]=K[3],c[5]=K[4],c[6]=0,c[7]=K[5],c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=K[6],c[13]=K[7],c[14]=0,c[15]=K[8]}for(var y=function(){function e(){this.camera=new s,this.lightMat=a.mat4d.create()}return e}(),g=function(){function e(e,t){this.doShadowMapMipmapsWork=!1,this.textureRes=4096,this.numCascades=1,this.maxNumCascades=2,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.programRep=e,this.rctx=t,this.emptyTexture=d.createEmptyTexture(t);for(var a=0;a<4;++a)this.cascades.push(new y)}return e.prototype.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null},Object.defineProperty(e.prototype,"textureResolution",{get:function(){return this.textureRes},set:function(e){this.textureRes=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=r.clamp(Math.floor(e),1,4)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return!!this.depthTexture},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),e.prototype.getDepthTexture=function(){return this.depthTexture},e.prototype.getCascades=function(){for(var e=0;e<this.numCascades;++e)_[e]=this.cascades[e];return _.length=this.numCascades,_},e.prototype.prepare=function(e,t,r,s){o.assert(this.enabled),a.mat4d.multiply(e.projectionMatrix,e.viewMatrix,T);var c=s.near,i=s.far;c<2&&(c=2),i<2&&(i=2),c>=i&&(c=2,i=4),this.numCascades=Math.min(1+Math.floor(o.logWithBase(i/c,4)),this.maxNumCascades);for(var d=Math.pow(i/c,1/this.numCascades),n=0;n<this.numCascades+1;++n)this.cascadeDistances[n]=c*Math.pow(d,n);a.mat4d.inverse(T,w),a.mat4d.lookAt([0,0,0],[-t[0],-t[1],-t[2]],[0,1,0],B);for(var h=e.viewMatrix,v=e.projectionMatrix,n=0;n<this.numCascades;++n){var u=this.cascades[n],p=-this.cascadeDistances[n],l=-this.cascadeDistances[n+1],m=(v[10]*p+v[14])/Math.abs(v[11]*p+v[15]),x=(v[10]*l+v[14])/Math.abs(v[11]*l+v[15]);o.assert(m<x);for(var y=0;y<8;++y){var g=y%4==0||y%4==3?-1:1,C=y%4==0||y%4==1?-1:1,_=y<4?m:x;a.vec4d.set4(g,C,_,1,D),a.mat4d.multiplyVec4(w,D,R[y]);for(var N=0;N<3;++N)R[y][N]/=R[y][3]}a.vec3d.negate(R[0],F),a.mat4d.translate(B,F,M),u.camera.viewMatrix=M;for(var y=0;y<8;++y)a.mat4d.multiplyVec3(u.camera.viewMatrix,R[y]);a.vec3d.set(R[0],A),a.vec3d.set(R[0],O);for(var y=1;y<8;++y)for(var N=0;N<3;++N)A[N]=Math.min(A[N],R[y][N]),O[N]=Math.max(O[N],R[y][N]);A[2]-=200,O[2]+=200,u.camera.near=-O[2],u.camera.far=-A[2];c=1/R[0][3],i=1/R[4][3],o.assert(c<i);var S=c+Math.sqrt(c*i),I=Math.sin(Math.acos(h[2]*t[0]+h[6]*t[1]+h[10]*t[2]));S/=I,f(R,S,I,U,E,j,P,V),b(U,E,P,V,u.camera.projectionMatrix),u.camera.projectionMatrix[10]=2/(A[2]-O[2]),u.camera.projectionMatrix[14]=-(A[2]+O[2])/(A[2]-O[2]),a.mat4d.multiply(u.camera.projectionMatrix,u.camera.viewMatrix,u.lightMat);var L=this.textureRes/2;u.camera.viewport[0]=n%2==0?0:L,u.camera.viewport[1]=0===Math.floor(n/2)?0:L,u.camera.viewport[2]=L,u.camera.viewport[3]=L}this.lastOrigin=null,this.cascadeDistances[this.numCascades]=100*i;var W=this.rctx,G=W.gl;W.bindFramebuffer(this.fbo),W.bindTexture(null,7),W.setClearColor(1,1,1,1),W.clear(G.COLOR_BUFFER_BIT|G.DEPTH_BUFFER_BIT),W.setBlendingEnabled(!1)},e.prototype.finish=function(e){o.assert(this.enabled),this.rctx.bindFramebuffer(e),this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()},e.prototype.bind=function(e){var t=this.rctx,a=this.enabled;t.bindTexture(a?this.depthTexture:this.emptyTexture,7),t.bindProgram(e),e.setUniform1i("depthTex",7),e.setUniform1f("depthHalfPixelSz",a?.5/this.textureRes:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])},e.prototype.bindAll=function(e){for(var t=e.getProgramsUsingUniform("shadowMapDistance"),a=0;a<t.length;a++)this.bind(t[a])},e.prototype.bindView=function(e,t){if(this.enabled){var r=this.lastOrigin;if(!(r&&r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2])){this.lastOrigin=this.lastOrigin||a.vec3d.create(),a.vec3d.set(t,this.lastOrigin);for(var s=0;s<this.numCascades;++s){a.mat4d.translate(this.cascades[s].lightMat,t,N);for(var c=0;c<16;++c)S[16*s+c]=N[c]}}e.setUniformMatrix4fv("shadowMapMatrix",S)}},e.prototype.drawDebugQuad=function(e){o.assert(this.enabled);var t=this.rctx,a=t.gl;if(!this.debugQuadVAO){var r=new Float32Array([0,0,0,0,256,0,1,0,0,256,0,1,256,256,1,1]);this.debugQuadVAO=new l(t,c.Default3D,{geometry:i.Pos2Tex},{geometry:h.createVertex(t,a.STATIC_DRAW,r)})}var s=this.programRep.getProgram(n.showDepth),d=this.debugQuadVAO;t.setDepthTestEnabled(!1),t.bindProgram(s),s.setUniformMatrix4fv("proj",e),s.setUniform1i("depthTex",0),t.bindTexture(this.depthTexture,0),t.bindVAO(d),p.assertCompatibleVertexAttributeLocations(d,s),t.drawArrays(a.TRIANGLE_STRIP,0,p.vertexCount(d,"geometry")),t.setDepthTestEnabled(!0)},e.prototype.enable=function(){if(!this.enabled){var e=this.rctx.gl,t={target:e.TEXTURE_2D,pixelFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,wrapMode:e.CLAMP_TO_EDGE,samplingMode:e.NEAREST,flipped:!0,width:this.textureRes,height:this.textureRes};this.depthTexture=new u(this.rctx,t),this.fbo=v.createWithAttachments(this.rctx,this.depthTexture,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes})}},e.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.fbo=null,this.depthTexture=null)},e}(),M=a.mat4d.create(),T=a.mat4d.create(),w=a.mat4d.create(),D=a.vec4d.create(),R=[],C=0;C<8;++C)R.push(a.vec4d.create());var A=a.vec3d.create(),O=a.vec3d.create(),U=a.vec2d.create(),E=a.vec2d.create(),j=a.vec2d.create(),P=a.vec2d.create(),V=a.vec2d.create(),B=a.mat4d.create(),F=a.vec3d.create(),_=[],N=a.mat4d.create(),S=new Float32Array(64),I=a.vec2d.create(),L=a.vec2d.create(),W=[a.vec2d.create(),a.vec2d.create(),a.vec2d.create(),a.vec2d.create()],G=a.vec2d.create(),Q=a.vec2d.create(),k=a.vec2d.create(),z=a.vec2d.create(),q=a.vec2d.create(),H=a.vec2d.create(),X=a.vec2d.create(),Y=a.vec3d.create(),J=a.vec2d.create(),K=a.mat3d.create();return g});