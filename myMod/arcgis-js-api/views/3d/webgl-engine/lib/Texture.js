// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/Logger","../../lib/gl-matrix","../../support/imageUtils","../../support/mathUtils","../../support/buffer/typedArrayUtil","./DDSUtil","./DefaultVertexBufferLayouts","./glUtil3D","./IdGen","./Util","../shaders/MiscPrograms","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],function(e,t,i,a,r,s,n,p,h,o,d,m,l,u,f,g){function w(e,t,i,a,n,p,h){h=!1!==h,r.requestImage(t).then(function(t){if(m.assert(t.width>=1&&t.height>=1),i.samplingMode=h?9987:9729,i.hasMipmap=h,!(h||33071!==i.wrapMode)||s.isPowerOfTwo(t.width)&&s.isPowerOfTwo(t.height)){i.width=t.width,i.height=t.height;var r=new f(e,i,t);e.bindTexture(r),p(r)}else{var r=c(e,t,i,a,n);e.bindTexture(r),p(r)}}).catch(function(e){var i=t.length>200?t.slice(0,100)+"..."+t.slice(t.length-100):t;x.error("Failed to load image from uri",i,e),p(null)})}function c(e,t,i,r,n){var p=s.nextHighestPowerOfTwo(t.width),d=s.nextHighestPowerOfTwo(t.height);m.assert(p!==t.width||d!==t.height),i.width=p,i.height=d;var w=new f(e,i),c=u.createWithAttachments(e,w,{colorTarget:0,depthStencilTarget:0}),x=new f(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!!i.flipped,maxAnisotropy:8,preMultiplyAlpha:i.preMultiplyAlpha},t);if(e.bindFramebuffer(c),void 0===n){var y=e.getViewport();n=[y.x,y.y,y.width,y.height]}e.setViewport(0,0,p,d);var T=r.getProgram(l.texOnly),v=a.mat4d.identity();e.bindProgram(T),T.setUniformMatrix4fv("model",v),T.setUniformMatrix4fv("view",v),T.setUniformMatrix4fv("proj",v),T.setUniform4f("color",1,1,1,1),T.setUniform1i("tex",0);var b=o.createQuadVAO(e,h.Pos3Tex);return e.bindTexture(x,0),e.bindVAO(b),e.setDepthTestEnabled(!1),e.setBlendingEnabled(!1),e.drawArrays(5,0,g.vertexCount(b,"geometry")),e.setDepthTestEnabled(!0),e.bindFramebuffer(null),e.setViewport(n[0],n[1],n[2],n[3]),b.dispose(!0),x.dispose(),e.bindFramebuffer(null),c.detachColorTexture(),c.dispose(),i.hasMipmap&&w.generateMipmap(),w}var x=i.getLogger("esri.views.3d.webgl-engine.lib.Texture");return function(){function e(t,i,a){this.data=t,this.id=e.idGen.gen(i),this.unloadFunc=void 0,this.params=a||{},this.params.wrapClamp=this.params.wrapClamp||!1,this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.estimatedTexMemRequired=e.estimateTexMemRequired(this.data,this.params)}return e.estimateTexMemRequired=function(e,t){return null==e?0:n.isArrayBuffer(e)||n.isUint8Array(e)?e.byteLength:e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement?(t.mipmap?4/3:1)*e.width*e.height*4:(t.mipmap?4/3:1)*t.width*t.height*4||0},e.prototype.getEstimatedTexMemRequired=function(){return this.estimatedTexMemRequired},e.prototype.dispose=function(){this.data=void 0},e.prototype.deferredLoading=function(){return"string"==typeof this.data},e.prototype.getWidth=function(){return this.params.width},e.prototype.getHeight=function(){return this.params.height},e.prototype.initializeThroughUpload=function(t,i,a,r,h){var o=this.data;if(i.flipped=!this.params.noUnpackFlip,i.samplingMode=this.params.mipmap?9987:9729,i.hasMipmap=this.params.mipmap,i.wrapMode=this.params.wrapClamp?33071:10497,i.preMultiplyAlpha=this.params.preMultiplyAlpha,"string"==typeof o)w(t,o,i,a,r,h,this.params.mipmap);else if(o instanceof Image||o instanceof ImageData||o instanceof HTMLCanvasElement){this.params.width=o.width,this.params.height=o.height;var d=this.params.mipmap||!this.params.wrapClamp;if(!d||s.isPowerOfTwo(o.width)&&s.isPowerOfTwo(o.height)){i.width=o.width,i.height=o.height;var l=new f(t,i,o);t.bindTexture(l),h(l)}else{var l=c(t,o,i,a,r);t.bindTexture(l),h(l)}}else if(n.isArrayBuffer(o)&&this.params.encoding===e.DDS_ENCODING){var l=p.createDDSTexture(t,i,o,this.params.mipmap);t.bindTexture(l),h(l)}else if(n.isUint8Array(o)&&this.params.encoding===e.DDS_ENCODING){var l=p.createDDSTexture(t,i,o.buffer,this.params.mipmap);t.bindTexture(l),h(l)}else if(n.isUint8Array(o)){m.assert(this.params.width>0&&this.params.height>0),i.pixelFormat=1===this.params.components?6409:6408,i.width=this.params.width,i.height=this.params.height;var l=new f(t,i,o);t.bindTexture(l),h(l)}else{if(null!==o)throw console.warn("Unsupported image data"),new Error("Unsupported image data");var l=new f(t,i,null);t.bindTexture(l),h(l)}this.data=void 0},e.prototype.setUnloadFunc=function(e){this.unloadFunc=e},e.prototype.unload=function(){void 0!==this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=void 0)},e.createEmpty=function(t){return void 0===t&&(t="emptyTexture"),new e(new Uint8Array([0,0,0,0]),t,{width:1,height:1,wrapClamp:!0})},e.idGen=new d,e.DDS_ENCODING="image/vnd-ms.dds",e}()});