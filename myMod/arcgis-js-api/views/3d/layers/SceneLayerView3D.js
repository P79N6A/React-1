// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","dojo/errors/CancelError","../../../Color","../../../Graphic","../../../core/arrayUtils","../../../core/Collection","../../../core/has","../../../core/iteratorUtils","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/requireUtils","../../../core/scheduling","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../geometry/support/aaBoundingBox","../../../geometry/support/scaleUtils","../../../layers/IntegratedMeshLayer","../../../layers/graphics/controllers/I3SOnDemandController","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","../../../tasks/support/Query","./LayerView3D","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/edgeUtils","./support/layerViewUpdatingProperties","./support/symbolColorUtils","../lib/gl-matrix","../support/mathUtils","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../support/buffer/typedArrayUtil","../webgl-engine/Stage","../webgl-engine/lib/Geometry","../webgl-engine/lib/Layer","../webgl-engine/lib/Object3D","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Texture","../webgl-engine/lib/Util","../webgl-engine/lib/TextureBackedBuffer/BufferManager","../webgl-engine/materials/DefaultMaterial","module"],function(e,t,r,n,i,a,o,s,l,d,u,c,h,p,g,f,y,m,_,b,v,x,I,E,C,w,M,O,S,D,T,j,A,V,F,R,G,P,B,L,U,N,k,q,H,K,z,Q,J,W,X,Y,Z,$,ee,te,re){function ne(e,t,r,n,i){var a,o=!1;t.encoding===R.DDS_ENCODING_STRING?a=Z.DDS_ENCODING:o=!(k.isPowerOfTwo(e.width)&&k.isPowerOfTwo(e.height));var s=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),l=s||t.atlas,d=(l?n:r)&&!o;return{mipmap:d,wrapClamp:l||!t.wrap,disableAnisotropy:l&&d&&i,encoding:a,noUnpackFlip:!0}}function ie(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.i3sTexId===t)return i.data}return null}function ae(e){return z.isArrayBuffer(e.data)}function oe(e,t){for(var r=1024,n=0,i=e;n<i.length;n++){var a=i[n];r+=a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0),r+=a.positionData.data.byteLength+a.positionData.indices.byteLength}for(var o=0,s=t;o<s.length;o++){var l=s[o];z.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function se(e,t){return(0|e)+(0|t)|0}var le=Q.ModelContentType,de=g.getLogger("esri.views.3d.layers.SceneLayerView3D"),ue=[1,1,1,1],ce=[.8,.8,.8],he=[.5,.5,.5],pe=function(){function e(){}return e}(),ge=10,fe=function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._queryEngine=null,e._highlights=new j(e),e._elevationProvider=null,e._worker=new D,e._workerThread=null,e._texId2Meta=new Map,e._nodeId2Meta=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new G.IDBCache("esri-scenelayer-cache","geometries",ge),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e.alwaysLoadEverythingModeEnabled=!1,e._cacheKeySuffix=null,e._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return r(s,t),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererNeedsTextures",{get:function(){return R.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=I.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=M.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),s.prototype._enableSecretAlwayLoadMode=function(){this.layer.store.lodModel&&"always-load"===this.layer.store.lodModel&&(this.alwaysLoadEverythingModeEnabled=!0)},Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!c("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(b.open(y.getAbsMid("./SceneLayerWorker",e,re),{client:this}).then(function(e){t.destroyed?e.close():t._workerThread=e}),R.checkSceneLayerValid(this.layer),R.checkSceneLayerCompatibleWithView(this.layer,this.view),this._controller=new C({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh=this.layer instanceof E,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.view.getEdgeView()),this._memCache=this.view.resourceController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new A({layerView:this,stageLayer:this._stageLayer}),this.handles.add([_.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),_.init(this.layer,"renderer",function(e){return t._rendererChange(e)}),_.init(this.layer,"objectIdFilter",function(){return t._filterChange()}),_.init(this.layer,"rangeInfos",function(e){return t._rangeInfosChanged(e)}),_.init(this,"_controller.parsedDefinitionExpression",function(){return t._filterChange()}),_.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),_.watch(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),_.watch(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),_.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){t._reloadAll(),t._memCache.clear()}),_.init(this,"suspended",function(e){return t._suspendedChange(e)})],"sceneLayerHandles"),this._idbCache.init().catch(function(e){de.warn("Failed to initialize IndexedDB cache: "+e)}),this._cacheKeySuffix=R.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._componentColorManager=this._hasSymbolColors?new ee.BufferManager(this._stage.view.renderingContext):null,this._enableSecretAlwayLoadMode()},s.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._texId2Meta=null,this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},s.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)},s.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e.id)},s.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},s.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0},s.prototype._suspendedChange=function(e){if(e)this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider);else{var t=this._isIntegratedMesh?"im":"scene";this.view.elevationProvider.register(t,this._elevationProvider)}},s.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),textures:this._texId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},s.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;this._whiteTexture=new Z(t,"white",{width:8,height:8}),e.add(le.TEXTURE,this._whiteTexture);var n=this.layer.id,i=new W(n,{},n);this._stageLayer=i,e.add(le.LAYER,i),this._stage.addToViewContent([i.id])},s.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;e.remove(le.TEXTURE,this._whiteTexture.id),this._removeAllNodeDataFromStage(),$.assert(0===this._nodeId2Meta.size),$.assert(0===this._texId2Meta.size),e.remove(le.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e.id);if(t)return t.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e.id);if(t)return t.attributeData},s.prototype.setAttributeData=function(e,t,r){var n=this._nodeId2Meta.get(e.id);n&&(n.loadedAttributes=t,n.attributeData=r,n.cachedRendererVersion=this._getInvalidRendererVersion(),this._updateEngineObject(e,n))},s.prototype.getLoadedNodeIDs=function(){return d.keysOfMap(this._nodeId2Meta)},s.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var n=this.fullOpacity,i=1-k.clamp($.fallbackIfUndefined(t.transparency,0),0,1);return{opacity:i,layerOpacity:n,transparent:i<1||n<1||e&&p.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r}},s.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},s.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},s.prototype._getMaterialParameters=function(e,t,r,n){var i;if(null!=e){var a=this._texId2Meta.get(t);i=a&&a.engineTex?a.engineTex.id:this._whiteTexture.id}var o=r.params,s=$.fallbackIfUndefined(o.diffuse,ce);"standard"!==r.type&&de.warn("Unknown material type '"+r.type+"', must be 'standard'");var l=this._isIntegratedMesh,d={ambient:s,diffuse:s,specular:$.fallbackIfUndefined(o.specular,he),atlasRegions:o.vertexRegions,textureId:i,vertexColors:this._hasVertexColors,componentIndices:this._hasSymbolColors,componentColorBuffer:this._hasSymbolColors&&n?n.textureBuffer:null,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(o),cullFace:this._calcEngineMaterialCullFaceParams(o),writeStencil:l,receiveSSAO:!l,groundNormalShading:l,compressedNormals:!l,slicePlaneEnabled:this.slicePlaneEnabled};if(!l){var u=this._calcEngineMaterialTransparencyParams(e,o);p.mixin(d,u)}return d},s.prototype._createEngineMaterial=function(e,t,r,n,i,a,o){var s=null==t?null:this._getI3STexEncoding(t),l=this._getMaterialParameters(t,r,n,o),d=new te(l,i);if(d.metadata={i3sMatId:i,i3sTexId:r,i3sTex:t,i3sMatParams:n.params},null!=t){var u=this._texId2Meta.get(r);u?u.usedByEngineMats.push(d):(u={id:r,usedByEngineMats:[d],images:t.images,encoding:s,atlas:!0===t.atlas,wrap:"none"!==t.wrap[0]||"none"!==t.wrap[1]},this._texId2Meta.set(r,u));var c=ie(a,r);if(null!=c&&null==u.engineTex){var h=ne(c,u,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);u.engineTex=new Z(c,u.id,h),this._stage.add(le.TEXTURE,u.engineTex),e.memory+=this.memEstimateTextureAdded(u.engineTex)}if(null!=u.engineTex)for(var p=u.engineTex.id,g=0,f=u.usedByEngineMats;g<f.length;g++){var y=f[g];y.setParameterValues({textureId:p})}}return d},s.prototype._getI3STexEncoding=function(e){var t=R.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures);return t>-1?e.encoding[t]:e.encoding},s.prototype._getVertexBufferLayout=function(e,t){var r=e.params.materialID,n=t.materialDefinitions[r];$.assert(void 0!==n,"geometry wants unknown material "+r);var i,a=e.params.textureID||"none";"none"!==a&&(null!=t.textureDefinitions&&null!=t.textureDefinitions[a]||de.warn("textureDefinitions missing in shared resource"),i=t.textureDefinitions[a]);var o=this._getMaterialParameters(i,a,n);return K.glLayout(te.getVertexBufferLayout(o))},s.prototype._createEngineMat=function(e,t,r,n,i){var a=t.params.materialID,o=r.materialDefinitions[a];$.assert(void 0!==o,"geometry wants unknown material "+a);var s,l=t.params.textureID||"none";return"none"!==l&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[l]||de.warn("textureDefinitions missing in shared resource"),s=r.textureDefinitions[l]),this._createEngineMaterial(e,s,l,o,a,n,i)},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=P.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return h.everyMap(this._nodeId2Meta,function(e,n){var i=e.featureIds.indexOf(t);return-1===i||(r={node:e.node,index:i},!1)}),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.id);if(!r)return[];for(var n=[],i=this._getObjectIdField(),a=0,o=t;a<o.length;a++){var s=o[a],l=P.attributeLookup(s.attributes,i),d=r.featureIds.indexOf(l);-1!==d&&n.push(d)}return n},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return f.reject();var r=this._nodeId2Meta.get(t.node.id).engineObject,n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(H.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var i=x.empty();return x.expandWithBuffer(i,n,0,8),f.resolve({boundingBox:i,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return R.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(e){return e[0]})},s.prototype.getGraphicFromStageObject=function(e,t){if(this.layer instanceof E)return f.reject();var r=this._getMetadata(e),n=e.getComponentFromTriangleNr(0,t);if(null!=n&&null!=r.featureIds&&n<r.featureIds.length){var i=this._createGraphic(n,r);return f.resolve(i)}return f.reject()},s.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.i3sNode)},s.prototype._getCacheKey=function(e){return e.baseUrl+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=se(this._cancelCount,1)},s.prototype._handleCancelled=function(e){if(se(this._cancelCount,-e)>0)throw new o},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.id))},s.prototype.loadCachedNodeData=function(e,t){var r=this,n=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(i){if(null==i)return null;if(r._handleCancelled(n),i.nodeVersion!==e.version)return r._idbCache.remove(r._getCacheKey(e)),null;e.obb||(e.obb=q.clone(i.nodeObb),r._controller.updateVisibility(e.id));var a=function(e){if(null==e.data)return!0;var t=i.sharedResource.textureDefinitions[e.i3sTexId],n=r._getI3STexEncoding(t);return e.encoding!==n};return r.rendererNeedsTextures&&i.textureData.some(a)?t(i.allGeometryData,i.sharedResource).then(function(t){return i.textureData=t,t.every(ae)&&r._idbCache.put(r._getCacheKey(e),i).catch(function(t){t&&"indexedb:not-initialized"===t.name||de.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(n),i}):i}):f.resolve(null)},s.prototype.addNodeData=function(e,t){var r=this;return this._transformBundle(e,t).then(function(t){return r._controller.reschedule(e.id,t)}).then(function(n){e.obb||(e.obb=n.obb,r._controller.updateVisibility(e.id));var i={allGeometryData:t.allGeometryData,transformedGeometries:n.transformedGeometries,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:oe(n.transformedGeometries,t.textureData)};if(r._cachingEnabled()){var a=i.textureData.map(function(e){return ae(e)?e:{i3sTexId:e.i3sTexId,encoding:e.encoding,data:null}});r._idbCache.put(r._getCacheKey(e),{allGeometryData:i.allGeometryData,transformedGeometries:i.transformedGeometries,textureData:a,sharedResource:i.sharedResource,nodeVersion:i.nodeVersion,nodeObb:i.nodeObb,byteSize:i.byteSize}).catch(function(t){return de.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return r.addCachedNodeData(e,i,t.attributeDataInfo)})},s.prototype._transformBundle=function(e,t){for(var r=this,n=[],i=[t.geometryBuffer],a=0,o=t.allGeometryData;a<o.length;a++)for(var s=o[a].geometries,l=0,d=s;l<d.length;l++){var u=d[l];n.push(this._getVertexBufferLayout(u,t.sharedResource))}var c={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData,layouts:n,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",c,i):this._controller.reschedule(e.id,c).then(function(e){return r._worker.transform(e)})},s.prototype.addCachedGPUData=function(e,t,r){return this.alwaysLoadEverythingModeEnabled||this._controller.isGeometryVisible(e)?(t.attributeData=r?r.attributeData:null,t.loadedAttributes=r?r.loadedAttributes:null,this._nodeId2Meta.set(e.id,t),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1),this._updateEngineObject(e,t),this._highlights.objectCreated(t.engineObject),f.resolve()):(this._memCache.put(this._getMemCacheKey(e.id),t,e.memory),f.resolve())},s.prototype.addCachedNodeData=function(e,t,r){var n=this;if(this._nodeId2Meta.has(e.id))return this._addOrUpdateEdgeRendering(this._nodeId2Meta.get(e.id)),this._applyFilters(e),f.resolve();if(this.suspended||!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(e))return f.resolve();var i=t.allGeometryData,a=t.transformedGeometries,o=t.textureData,s=t.sharedResource;if(0===i.length)return f.resolve();if(1!==i.length&&console.warn("Node with",i.length,"geometries is unsupported"),!this.rendererNeedsTextures)for(var l=0,d=o;l<d.length;l++){var u=d[l];u.data=null}var c={};c[le.OBJECT]={},c[le.GEOMETRY]={},c[le.MATERIAL]={};var h=0,p=!1;e.memory=0;var g=i[0],y=g.componentOffsets,m=g.geometries,_=g.featureIds,b=null,v=null;if(this._hasSymbolColors){b=this._componentColorManager.getBuffer(_.length),v=new Uint16Array(_.length);for(var x=0;x<_.length;x++)v[x]=b.aquireIndex()}for(var I,E=e.id+"|"+_[0],C=[],w=[],M=[],O=[],S=0,D=m;S<D.length;S++){var T=D[S],j=this._createEngineMat(e,T,s,o,b),A=a[h++];I=A.corMatrices.globalTrafo,p=p||A.hasColors;var F=new Y(new Float32Array(A.interleavedVertexData),A.layout,A.positionData,y||Y.DefaultOffsets,A.indices||Y.DefaultIndices,!0);this._hasSymbolColors&&this._setComponentIndices(F,v);var R=null!=T.transformation?N.mat4d.create(T.transformation):N.mat4d.identity(),G=C.length,P=E+(G>0?"_"+G:""),B=new J(F,P);C.push(B),M.push(R),O.push([j]),w.push(V.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference)),e.memory+=this.memEstimateGeometryAdded(B.data),c[le.MATERIAL][j.id]=j,c[le.GEOMETRY][B.id]=B}var L={i3sNode:e.id,layerUid:this.layer.uid},U=new X({idHint:e.id,name:E,geometries:C,materials:O,transformations:M,origins:w,castShadow:!0,metadata:L});U.setObjectTransformation(I),c[le.OBJECT][U.id]=U;var k=new pe;return k.node=e,k.engineObject=U,k.featureIds=_,k.attributeData=r?r.attributeData:null,k.loadedAttributes=r?r.loadedAttributes:null,k.componentColorBuffer=b,k.componentIndices=v,k.cachedRendererVersion=this._getInvalidRendererVersion(),k.cachedSymbolInfos=[],!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors||(this._hasColors=p),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors"),f.create(function(t){n._addOrUpdateEdgeRendering(k).then(function(){if(n._nodeId2Meta.has(e.id))return n._edgeView&&n._edgeView.removeObject(k.engineObject),t();var r=n._stageLayer,i=n._stage,a=c[le.OBJECT];for(var o in a)a.hasOwnProperty(o)&&r.addObject(a[o]);for(var s in c)if(c.hasOwnProperty(s)){var l=c[s];for(var d in l)l.hasOwnProperty(d)&&null==i.get(s,d)&&i.add(s,l[d])}if(n._nodeId2Meta.set(e.id,k),n.suspended)return n._removeNodeStageData(e.id),t();n._setObjectSymbology(k),n._applyFilters(e),n._highlights.objectCreated(U),n.visibleGeometryChanged(U),t()})})},s.prototype._clippingAreaChanged=function(){var e=this,t=x.create();H.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._nodeId2Meta.forEach(function(t){return e._applyFilters(t.node)}),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){var e=this;this._updateFilters(),this._nodeId2Meta.forEach(function(t){return e._applyFilters(t.node)})},s.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),n="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,i){return e._objectIdFilter(r,n,i)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var i=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,i,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},s.prototype._sqlFilter=function(e,t,r,n){var i={},a=new l(null,null,i);a.layer=this.layer,a.sourceLayer=this.layer;for(var o=this.layer.objectIdField,s=0,d=0,u=this._nodeId2Meta.get(e.id),c=u.featureIds,h=u.attributeData,p=r.every(function(e){return null!=h[e]||e===o}),g=0;g<c.length&&s<n.length;g++)if(n[s]===c[g]){var f=!0;if(p){i[o]=c[g];for(var y=0,m=r;y<m.length;y++){var _=m[y];_!==o&&(i[_]=R.getCachedAttributeValue(h[_],g))}f=this._evaluateClause(t,a)}f&&(n[d]=n[s],d++),s++}n.length=d},s.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&de.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&de.error("Further errors are ignored"),!1}},s.prototype._objectIdFilter=function(e,t,r){for(var n=0,i=0;n<r.length;){d.binaryIndexOf(e,r[n])>=0===t&&(r[i]=r[n],i++),n++}r.length=i},s.prototype._boundingboxFilter=function(e,t,r){var n=[0,0,0,0];H.mbsToMbs(e.mbs,this._controller.crsIndex,n,this.view.renderSpatialReference);var i=null!=t?R.intersectBoundingBoxWithMbs(t,n):2;if(2!==i){if(0===i)return void(r.length=0);var a=0,o=0,s=this._nodeId2Meta.get(e.id),l=s.featureIds,d=s.engineObject.getObjectTransformation(),u=s.engineObject.getGeometryRecords()[0].getShaderTransformation();if(N.mat4d.multiply(d,u),0===d[1]&&0===d[2]&&0===d[3]&&0===d[4]&&0===d[6]&&0===d[7]&&0===d[8]&&0===d[9]&&0===d[11]&&1===d[15]){var c=me;c[0]=(t[0]-d[12])/d[0],c[1]=(t[1]-d[13])/d[5],c[2]=(t[2]-d[14])/d[10],c[3]=(t[3]-d[12])/d[0],c[4]=(t[4]-d[13])/d[5],c[5]=(t[5]-d[14])/d[10];for(var h=s.engineObject.getGeometryRecords()[0].geometry,p=h.componentCount,g=0;g<p&&a<r.length;g++)if(r[a]===l[g]){var f=h.getComponentAABB(g,_e);x.intersects(c,f)&&(r[o]=r[a],o++),a++}r.length=o}}},s.prototype._addOrUpdateEdgeRendering=function(e){return i(this,void 0,void 0,function(){var t,r,n,i,o,s;return a(this,function(a){switch(a.label){case 0:return this._edgeView?(t=e.engineObject,r=this._edgeView.hasObject(t),n=this._extractObjectEdgeMaterials(e),i=n.hasEdges,o=n.perFeatureEdgeMaterials,i?(s=!t.isHidden(t.geometryRecords[0]),r?(this._edgeView.updateAllComponentMaterials(t,o),this._edgeView.updateObjectVisibility(t,s),[3,3]):[3,1]):[3,4]):[2];case 1:return s?[4,this._edgeView.addObject(t,o)]:[3,3];case 2:a.sent(),a.label=3;case 3:return[3,5];case 4:r&&this._edgeView.removeObject(t),a.label=5;case 5:return[2]}})})},s.prototype._applyFilters=function(e){var t=this._nodeId2Meta.get(e.id);t&&(this._applyFiltersToObjects(e,t),this._updateEdgeRendering(t))},s.prototype._applyFiltersToObjects=function(e,t){var r=t.engineObject;if(r.unhideAllComponents(),0!==this._filters.length){for(var n=t.featureIds,i=n.slice(),a=0,o=this._filters;a<o.length;a++){(0,o[a])(e,i)}if(i.length!==n.length)for(var s=0,l=r.getGeometryRecords()[0],d=0;d<n.length;d++){var u=n[d];s>=i.length||i[s]!==u?r.setComponentVisibility(l,d,!1):s++}}},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,n){return t._removeNodeStageData(n,e)})},s.prototype.removeNodeData=function(e){var t=this;e.forEach(function(e){return t._removeNodeStageData(e.id)})},s.prototype._removeNodeStageData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._nodeId2Meta.get(e);if(r){var n=r.engineObject;n.setHidden(n.geometryRecords[0],!0),this.visibleGeometryChanged(n),this._addOrUpdateEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(n),this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory)}},s.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,n=e.engineObject;this._edgeView&&this._edgeView.removeObject(n),r.removeObject(n);for(var i=0,a=n.getGeometryRecords();i<a.length;i++){var o=a[i];this.memEstimateGeometryRemoved(o.geometry.data),t.remove(le.GEOMETRY,o.geometry.id);for(var s=0,l=o.materials;s<l.length;s++){var d=l[s];this._removeMaterial(d,t)}}if(e.componentIndices){for(var u=0;u<e.componentIndices.length;u++)e.componentColorBuffer.releaseIndex(e.componentIndices[u]);this._componentColorManager.garbageCollect()}t.remove(le.OBJECT,n.id)},s.prototype._removeMaterial=function(e,t){t.remove(le.MATERIAL,e.id);var r=e.metadata.i3sTexId;if(r){var n=this._texId2Meta.get(r);if(n){var i=n.usedByEngineMats;if(d.removeUnordered(i,e)||de.error("Missing reference from material to texture"),0===i.length){var a=n.engineTex;a&&a!==this._whiteTexture&&(this.memEstimateTextureRemoved(a),t.remove(le.TEXTURE,n.engineTex.id)),this._texId2Meta.delete(r)}}}},s.prototype.setPolygonOffset=function(e,t){var r=this._nodeId2Meta.get(e.id);if(r)for(var n=0,i=r.engineObject.getGeometryRecords();n<i.length;n++)for(var a=i[n],o=0,s=a.materials;o<s.length;o++){var l=s[o];l.setParameterValues({polygonOffset:t})}},s.prototype._getInvalidRendererVersion=function(){return se(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){if(this._currentRenderer=e,this._rendererVersion=se(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e&&e.requiredFields&&(this._rendererFields=R.findFieldsCaseInsensitive(e.requiredFields,this.layer.fields)),e&&e.visualVariables)for(var t=0,r=e.visualVariables;t<r.length;t++){var n=r[t];"color"===n.type?this._colorVariable=n:"opacity"===n.type?this._opacityVariable=n:de.warn("Unsupported visual variable type for 3D Object Scene Services: "+n.type)}if(e&&(e.colorInfo||e.sizeInfo)&&de.warn("renderer.colorInfo and renderer.sizeInfo are not supported for 3D Object Scene Services. Use visualVariables instead."),e)for(var i=0,a=e.getSymbols();i<a.length;i++){var o=a[i];"mesh-3d"!==o.type&&de.error("Symbols of type '"+o.type+"' are not supported for 3D Object Scene Services.")}this.view.resourceController.setMemoryDirty()},s.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},s.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},n=this._tmpAttributeOnlyGraphic;n.attributes=r;for(var i=this._currentRenderer,a=null!=e.featureIds?this.layer.objectIdField:null,o=null!=e.attributeData?this._rendererFields:null,s=0;s<t;s++){if(null!=a&&(r[a]=e.featureIds[s]),null!=o)for(var l=0,d=o;l<d.length;l++){var u=d[l];e.attributeData[u]&&(r[u]=R.getCachedAttributeValue(e.attributeData[u],s))}var c=i&&i.getSymbol(n),h=null;c instanceof w&&(this._symbolInfos.has(c.id)||this._symbolInfos.set(c.id,R.getSymbolInfo(c)),h=this._symbolInfos.get(c.id)),e.cachedSymbolInfos[s]=h,null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));var p=null,g=null;if(this._colorVariable){var f=i.getColor(n,{colorInfo:this._colorVariable,color:ve});f&&(p=be,p[0]=f.r/255,p[1]=f.g/255,p[2]=f.b/255,this._opacityVariable||null===f.a||(g=f.a))}if(this._opacityVariable&&(g=i.getOpacity(n,{opacityInfo:this._opacityVariable})),h&&h.material){var y=h.material;p=null==p||null==g?T.overrideColor(p,g,y.color,y.alpha,ue,be):T.overrideColor(p,g,null,null,ue,be),U.encodeSymbolColor(p,y.colorMixMode,e.cachedSymbolColors,4*s)}else U.encodeSymbolColor(null,null,e.cachedSymbolColors,4*s)}}},s.prototype._extractObjectEdgeMaterials=function(e){for(var t=[],r=e.engineObject,n=e.featureIds?e.featureIds.length:1,i=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),a={opacity:this.fullOpacity,slicePlaneEnabled:this.slicePlaneEnabled},o=!1,s=null,l=null,d=this._getSymbolInfos(e),u=0;u<n;u++){var c=d[u]
;r.getComponentVisibility(r.getGeometryRecords()[0],u)&&c?(l!==c&&(l=c,(s=B.createMaterialFromEdges(this._edgeView,c.edges,a))&&(o=!0)),t.push(null!=s?s:i)):t.push(i)}return{hasEdges:o,perFeatureEdgeMaterials:t}},s.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){for(var t=e.featureIds?e.featureIds.length:1,r=!1,n=this._getSymbolColors(e),i=e.componentColorBuffer.textureBuffer,a=0;a<t;a++){var o=4*a,s=e.componentIndices[a];i.setData(s,0,n[o],n[o+1],n[o+2],n[o+3]),U.isOpaqueSymbolColor(n,o)||(r=!0)}this._updateObjectOpacity(e.engineObject,r)}},s.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute($.VertexAttrConstants.COMPONENTINDEX),n=r.data,i=r.offsetIdx,a=r.strideIdx,o=e.getIndices($.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],u=l;u<d;u++){var c=i+o[u]*a;n[c]=t[s]}},s.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&de.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},s.prototype._updateObjectOpacity=function(e,t){for(var r=0,n=e.getGeometryRecords();r<n.length;r++)for(var i=n[r],a=0,o=i.materials;a<o.length;a++){var s=o[a],l=s.metadata;void 0!==t&&(l.symbolIsTransparent=t);var d=s.getParams(),u=this._calcEngineMaterialTransparencyParams(l.i3sTex,l.i3sMatParams,l.symbolIsTransparent);d.transparent===u.transparent&&d.layerOpacity===u.layerOpacity||s.setParameterValues(u)}},s.prototype._updateEngineObject=function(e,t){this._setObjectSymbology(t),this._addOrUpdateEdgeRendering(t),this._applyFilters(e),this.visibleGeometryChanged(t.engineObject)},s.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._nodeId2Meta.forEach(function(e){for(var n=0,i=e.engineObject.getGeometryRecords();n<i.length;n++)for(var a=i[n],o=0,s=a.materials;o<s.length;o++){var l=s[o];l.setParameterValues(r)}t._updateEdgeRendering(e)})},s.prototype._updateEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e)},s.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},s.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},s.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},s.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},s.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},s.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new F(this.layer,{forAll:function(r,n){var i=function(n,i,a){t.id=n,t.index=i,t.meta=a,e._boundingBoxCornerPoints(i,a.engineObject,t.bbCorners),r(t)};e._forAllFeatures(i,n)},createGraphic:function(t){return e._createGraphic(t.index,t.meta)},requestFields:function(t,r,n){var i=function(){var n=e._getGraphicIndices(t,r);return{node:t,indices:n}};return R.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),n,i,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},s.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=x.empty(),n=new Float64Array(24);return{add:function(i){H.bufferToBuffer(i.bbCorners,e,0,n,t,0,8)&&x.expandWithBuffer(r,n,0,8)},getExtent:function(){return x.toExtent(r,t)}}},s.prototype._forAllFeatures=function(e,t,r){var n=this;this._nodeId2Meta.forEach(function(i,a){n._forAllFeaturesOfNode(i,e,r),t&&t(i.node)})},s.prototype._forAllFeaturesOfNode=function(e,t,r){for(var n=e.featureIds,i=e.engineObject.getGeometryRecords()[0],a=0;a<n.length;a++)if(r||e.engineObject.getComponentVisibility(i,a)){var o=n[a];t(o,a,e,i)}},s.prototype._createGraphic=function(e,t){var r={};if(null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]),null!=t.attributeData)for(var n=0,i=Object.keys(t.attributeData);n<i.length;n++){var a=i[n];r[a]=R.getCachedAttributeValue(t.attributeData[a],e)}var o=new l(null,null,r);return o.layer=this.layer,o.sourceLayer=this.layer,o},s.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,me),i=0;i<8;++i)ye[0]=1&i?n[0]:n[3],ye[1]=2&i?n[1]:n[4],ye[2]=4&i?n[2]:n[5],N.mat4d.multiplyVec3(t.objectTransformation,ye),r[3*i]=ye[0],r[3*i+1]=ye[1],r[3*i+2]=ye[2];return r},s.prototype.highlight=function(e,t){var r=this,n=this._highlights;if(e instanceof O){var i=n.acquireSet(t),a=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return n.setFeatureIds(a,e)}),o}if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var s=e,d=s.map(function(e){return P.attributeLookup(e.attributes,r._getObjectIdField())}),c=n.acquireSet(t),h=c.set,o=c.handle;return n.setFeatureIds(h,d),o}if("number"==typeof e[0]){var d=e,p=n.acquireSet(t),h=p.set,o=p.handle;return n.setFeatureIds(h,d),o}}return{remove:function(){}}},s.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=m.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},n([v.property()],s.prototype,"layer",void 0),n([v.property()],s.prototype,"_controller",void 0),n([v.property({dependsOn:["_controller.updating"]})],s.prototype,"updating",void 0),n([v.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),n([v.property(L.updatingPercentage)],s.prototype,"updatingPercentage",void 0),n([v.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],s.prototype,"updatingPercentageValue",void 0),n([v.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),n([v.property({readOnly:!0,dependsOn:["layer.renderer"]})],s.prototype,"rendererNeedsTextures",null),n([v.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),n([v.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),n([v.property()],s.prototype,"alwaysLoadEverythingModeEnabled",void 0),n([v.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),n([v.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),s=n([v.subclass("esri.views.3d.layers.SceneLayerView3D")],s)}(v.declared(S)),ye=N.vec3d.create(),me=x.create(),_e=x.create(),be=[0,0,0,0],ve=new s([0,0,0,0]);return fe});