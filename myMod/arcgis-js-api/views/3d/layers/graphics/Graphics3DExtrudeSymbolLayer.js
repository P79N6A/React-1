// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/earcut/earcut","../../../../geometry/Point","../../../../geometry/Polygon","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../lib/gl-matrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,d,h,g,u,v,y,f,m){function _(e,t,r,a,n,i,o,s,l,c,p,d,h,g){var u=r.length/3,v=0;p+=2*a.count,E(e,t,a.index,a.count,r,0,u,n,i,o,s,l,c,p,d,h,g),l+=2*a.count,p+=2*u,p-=2*a.count+2*u,b(n,i,s,o,v,a.pathLengths[0],a.count,l,c,p,d),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],v+=a.pathLengths[0];for(var y=1;y<a.pathLengths.length;++y)b(n,i,s,o,v,a.pathLengths[y],a.count,l,c,p,d),l+=4*a.pathLengths[y],p+=2*a.pathLengths[y],v+=a.pathLengths[y]}function E(e,t,r,a,n,i,o,s,l,c,p,h,g,u,v,y,f){d.vec3d.set(y,C);for(var m=v>0?1:-1,_=3*r,E=h,x=3*E,b=h+a,S=3*b,A=0;A<a;++A)f&&(C[0]=e[_+0],C[1]=e[_+1],C[2]=e[_+2],d.vec3d.normalize(C)),s[x+0]=e[_+0],s[x+1]=e[_+1],s[x+2]=e[_+2],l[x+0]=t[_+0],l[x+1]=t[_+1],l[x+2]=t[_+2],c[x+0]=-m*C[0],c[x+1]=-m*C[1],c[x+2]=-m*C[2],p[E]=0,s[S+0]=e[_+0]+v*C[0],s[S+1]=e[_+1]+v*C[1],s[S+2]=e[_+2]+v*C[2],l[S+0]=t[_+0],l[S+1]=t[_+1],l[S+2]=t[_+2],c[S+0]=m*C[0],c[S+1]=m*C[1],c[S+2]=m*C[2],p[b]=v,x+=3,S+=3,_+=3,E+=1,b+=1;_=3*i,x=3*u,S=3*(u+o);x=3*(u+o),S=3*u;var w=O,P=L;v<0&&(w=L,P=O);for(var A=0;A<o;++A)g[x+0]=n[_+w[0]],g[x+1]=n[_+w[1]],g[x+2]=n[_+w[2]],g[S+0]=n[_+P[0]]+a,g[S+1]=n[_+P[1]]+a,g[S+2]=n[_+P[2]]+a,x+=3,S+=3,_+=3}function x(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function b(e,t,r,a,n,i,o,s,l,c,p){var d=n,h=n+1,g=n+o,u=n+o+1,v=s,y=s+1,f=s+2*i,m=s+2*i+1;p<0&&(d=n+o+1,u=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(h=n,u=n+o):(h=n,d=n+o)),S(e,d,h,g,M),x(e,t,a,r,M,v,d),x(e,t,a,r,M,y,h),x(e,t,a,r,M,f,g),x(e,t,a,r,M,m,u),l[c++]=v,l[c++]=f,l[c++]=m,l[c++]=v,l[c++]=m,l[c++]=y,d++,h++,g++,u++,v+=2,y+=2,f+=2,m+=2}function S(e,t,r,a,n){t*=3,r*=3,a*=3,d.vec3d.set3(e[t++],e[t++],e[t++],R),d.vec3d.set3(e[r++],e[r++],e[r++],T),d.vec3d.set3(e[a++],e[a++],e[a++],V),d.vec3d.subtract(T,R,G),d.vec3d.subtract(V,R,I),d.vec3d.cross(I,G,n),d.vec3d.normalize(n,n)}function A(e,t,r,a){var n=a.setAltitude;P.spatialReference=r.spatialReference;for(var i=e.getGeometryRecords(),o=i.length,l="absolute-height"!==t.mode,c=0,p=0;p<o;p++){var d=i[p].geometry,h=i[p].transformation;j[0]=h[12],j[1]=h[13],j[2]=h[14],d.invalidateBoundingInfo();for(var g=d.data.getVertexAttr(),u=g[f.VertexAttrConstants.POSITION].data,v=g[f.VertexAttrConstants.SIZE].data,y=g.mapPos.data,m=u.length/3,_=0,E=0,x=!1,b=0,S=0;S<m;S++){P.x=y[E],P.y=y[E+1],P.z=y[E+2],U[0]=u[_],U[1]=u[_+1],U[2]=u[_+2];var A=s.computeElevation(r,P,t,a,l?D:null);l&&(b+=D.terrainElevation),w[0]=u[_]+j[0],w[1]=u[_+1]+j[1],w[2]=u[_+2]+j[2],n(A+v[_/3],w),u[_]=w[0]-j[0],u[_+1]=w[1]-j[1],u[_+2]=w[2]-j[2];var C=.01/a.unitInMeters;(Math.abs(U[0]-u[_])>C||Math.abs(U[1]-u[_+1])>C||Math.abs(U[2]-u[_+2])>C)&&(x=!0),E+=3,_+=3}x&&e.geometryVertexAttrsUpdated(p),c+=b/m}return c/o}var w=d.vec3d.create(),C=d.vec3d.create(),O=[0,2,1],L=[0,1,2],P=new n,D={verticalDistanceToGround:0,terrainElevation:0},z=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._edgeStageObjects=new Set,t}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=c.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=d.vec3d.create(r),n=r[3],i={diffuse:a,ambient:a,opacity:n,transparent:n<1||this._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new m(i,t+"_3dlinemat"),this._context.stage.add(g.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(g.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,a=r.geometry;if("polygon"!==a.type&&"extent"!==a.type)return this._logWarning("unsupported geometry type for extrude symbol: "+a.type),null;if(!this._validateGeometry(a))return null;var n="polygon"===a.type||"extent"===a.type?"rings":"paths",i="graphic"+r.uid,o=this._getVertexOpacityAndColor(t,Float32Array,255),s=this.getGraphicElevationContext(r);return this._createAs3DShape(r,n,t,o,s,i,r.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=a<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:a,transparent:n}),this._edgeStageObjects.size>0){var i=this._context.stage.view.getEdgeView(),o=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){i.updateAllComponentOpacities(e,[o])})}return!0}if("elevationInfo"===e){this._updateElevationContext();for(var l in t){var c=t[l],p=r(c);if(p){var d=c.graphic,h=this.getGraphicElevationContext(d);p.needsElevationUpdates=s.needsElevationUpdates3D(h.mode),p.elevationContext.set(h)}}return!0}return!1},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?s.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,n,l,c,g){var v=this,f=e.geometry;"extent"===f.type&&(f=i.fromExtent(f));var m=f[t],E=[],x=[],b=[],S=d.vec3d.create(),w=new Array(6),C=this._context.renderSpatialReference===h.SphericalECEFSpatialReference,O=this._getExtrusionSize(r),L=d.vec3d.create();C||this._context.renderCoordsHelper.worldUpAtPosition(null,L);var P=s.getGeometryVertexData3D(m,f.hasZ,f.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,l);if(this._logGeometryCreationWarnings(P,m,t,"ExtrudeSymbol3DLayer"),m.length>0){for(var D=P.geometryData.polygons,z=P.eleVertexData,M=P.vertexData,R=M.length/3,T=new Float64Array(3*R*6),V=new Float64Array(3*R*6),G=new Float64Array(3*R*6),I=new Float64Array(1*R*6),U=0,j=this,F=0;F<D.length;++F)!function(e){var t=D[e],r=t.count,i=t.index;if(j._context.clippingExtent&&(s.computeBoundingBox(z,i,r,w),s.boundingBoxClipped(w,j._context.clippingExtent)))return"continue";var o=new Float64Array(z.buffer,3*i*T.BYTES_PER_ELEMENT,3*r),l=t.holeIndices.map(function(e){return e-i}),p=a(o,l,3);if(p.length>0){s.chooseOrigin(M,i,r,S);var h=3*r*2+2*p.length,g=new Uint32Array(h),v=6*r,y=new Float64Array(T.buffer,3*U*T.BYTES_PER_ELEMENT,3*v),f=new Float64Array(V.buffer,3*U*V.BYTES_PER_ELEMENT,3*v),m=new Float64Array(G.buffer,3*U*G.BYTES_PER_ELEMENT,3*v),A=new Float64Array(I.buffer,1*U*I.BYTES_PER_ELEMENT,1*v);_(M,z,p,t,y,m,f,A,0,g,0,O,L,C),s.subtractCoordinates(y,0,v,S),U+=6*r;var P=j._createExtrudeGeometry(g,{positions:y,elevation:m,normals:f,heights:A},n),R=new u(P,c+"path"+e);R.singleUse=!0,E.push(R),x.push([j._material]);var F=d.mat4d.identity();d.mat4d.translate(F,S,F),b.push(F)}}(F);if(E.length>0){var N=new y({geometries:E,materials:x,transformations:b,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:g},idHint:c}),B=function(e){var t=v._context.stage.view.getEdgeView();if(t){t.removeObject(e),v._edgeStageObjects.delete(e);var r={opacity:v._getLayerOpacity(),slicePlaneEnabled:v._context.slicePlaneEnabled},a=p.createMaterial(t,v.symbol,r);a&&(v._edgeStageObjects.add(e),t.addObject(e,[a]))}};B(N);var H=function(e,t,r,a){var n=A(e.stageObject,t,r,a);return B(N),n},Y=new o(this,N,E,null,null,H,l);return Y.alignedTerrainElevation=P.terrainElevation,Y.needsElevationUpdates=s.needsElevationUpdates3D(l.mode),Y}return null}return null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[f.VertexAttrConstants.POSITION]=n,s[f.VertexAttrConstants.NORMAL]=n,s[f.VertexAttrConstants.COLOR]=i,l[f.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[f.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[f.VertexAttrConstants.COLOR]={size:4,data:r},l[f.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new v(l,s)},t}(l),M=d.vec3d.create(),R=d.vec3d.create(),T=d.vec3d.create(),V=d.vec3d.create(),G=d.vec3d.create(),I=d.vec3d.create(),U=d.vec3d.create(),j=d.vec3d.create();return z});