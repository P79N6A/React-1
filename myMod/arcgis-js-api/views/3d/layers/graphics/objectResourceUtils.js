// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","dojo/errors/CancelError","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/Version","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/loader","../../lib/gl-matrix","../../support/imageUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,n,a,i,s,o,u,l,c,p,f,d,m,g,v,h,x,y,b,w,U,M,T){function A(e,t){return void 0===t&&(t={}),a(this,void 0,void 0,function(){var r,a;return n(this,function(n){switch(n.label){case 0:return c.endsWith(e,".gltf")||c.endsWith(e,".glb")?(r=new v.DefaultLoadingContext(t.streamDataSupplier),[4,h.load(r,e)]):[3,2];case 1:return[2,n.sent()];case 2:return[4,j(e,t)];case 3:return a=n.sent(),[4,D(a,t)];case 4:return[2,n.sent()]}})})}function C(e,t){return a(this,void 0,void 0,function(){var r,i,s,u,l,c=this;return n(this,function(p){switch(p.label){case 0:return r=d.removeFile(e),[4,j(e,t)];case 1:return i=p.sent(),i.lods?[4,f.all(i.lods.map(function(e){return e.href?j(d.makeAbsolute(e.href,r)):i}))]:[3,4];case 2:return s=p.sent(),u=I,[4,o.map(s,function(e){return a(c,void 0,void 0,function(){return n(this,function(r){switch(r.label){case 0:return[4,D(e,t)];case 1:return[2,r.sent()]}})})})];case 3:return[2,u.apply(void 0,[p.sent(),i])];case 4:return l=I,[4,D(i,t)];case 5:return[2,l.apply(void 0,[[p.sent()],i])]}})})}function I(e,t){return t.lods&&t.lods.length===e.length&&e.forEach(function(e,r){e.lodMetrics=t.lods[r].metrics}),e}function j(e,t){t=t||{};var r=t.streamDataSupplier;if(r){var n=r.request(e,"json");return f.create(function(e,t){n.then(function(t,r){e(r)},function(e){t(e instanceof i?e:E(e))})},function(){r.cancelRequest(n)})}var a=s(e);return f.create(function(e,t){a.then(function(t){e(t.data)},function(e){t(e instanceof i?e:E(e))})},function(){a.cancel()})}function E(e){return new u("","Request for object resource failed: "+e)}function P(e){for(var t=e.stageResources[b.ModelContentType.GEOMETRY],r=g.empty(),n=[0,0,0],a=[0,0,0],i=0;i<t.length;i++){var s=t[i],o=s.boundingInfo;x.vec3d.set(o.getBBMin(),n),x.vec3d.set(o.getBBMax(),a);for(var u=0;u<3;++u)r[u]=Math.min(r[u],n[u]),r[u+3]=Math.max(r[u+3],a[u])}return r}function B(e){var t=e.params,r=t.topology,n=!0;switch(t.vertexAttributes||(k.warn("Geometry must specify vertex attributes"),n=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var a=t.faces;if(a){if(t.vertexAttributes)for(var i in t.vertexAttributes){var s=a[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(k.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),n=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(k.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),n=!1)):(k.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),n=!1)}}else k.warn("Indexed geometries must specify faces"),n=!1;break;default:k.warn("Unsupported topology '"+r+"'"),n=!1}e.params.material||(k.warn("Geometry requires material"),n=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(k.warn("Geometries with externally defined attributes are not yet supported"),n=!1)}return n}function D(e,t){return a(this,void 0,void 0,function(){var r,a,i,s,o,u,p,f,d,g,v,h,x,y,b,M,A,C,I,j,E,P,D,k,G,F,L,V,H,_,z,W,Y;return n(this,function(n){switch(n.label){case 0:return r=[],a=[],i=[],s=[],o=[],u=m.Version.parse(e.version||"1.0","wosr"),q.validate(u),p="meshsymbol_"+e.model.name,f=e.textureDefinitions,[4,O(p,f,t)];case 1:d=n.sent();for(g in d)o.push(d[g].engineTexObj);for(v=e.model.geometries,h=e.materialDefinitions,x=0,y=0;y<v.length;y++)if(b=v[y],B(b)){M=R(b),A=b.params.vertexAttributes,C={};for(I in A)j=A[I],E=j.values,C[I]={data:E,size:j.valuesPerElement};if(i.push([]),P={},"PerAttributeArray"===b.params.topology){D=C.position.data.length/C.position.size,k=S(D);for(G in C)P[G]=k}else{F=b.params.faces;for(L in F)P[L]=new Uint32Array(F[L].values)}V=M.texture?d[M.texture]:null,H=s[M.material]?s[M.material][M.texture]:null,H||(_=M.material.substring(M.material.lastIndexOf("/")+1),z=h[_].params,1===z.transparency&&(z.transparency=0),W={ambient:z.diffuse,diffuse:z.diffuse,specular:[0,0,0],opacity:1-(z.transparency||0),transparent:z.transparency>0,textureId:V?V.engineTexObj.id:void 0,textureInitTransparent:!0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:z.externalColorMixMode||"tint"},l("enable-feature:jkieboom/alpha-channel-usage")&&(!V||"transparency"!==V.alphaChannelUsage&&"maskAndTransparency"!==V.alphaChannelUsage||(W.transparent=!0)),t&&t.materialParamsMixin&&c.mixin(W,t.materialParamsMixin),H=new T(W,p),s[M.material]||(s[M.material]={}),s[M.material][M.texture]=H,a.push(H)),i[y].push(H),Y=new w(new U(C,P),p),x+=P.position?P.position.length:0,r.push(Y)}return[2,{stageResources:{textures:o,materials:a,geometries:r},materialsByComponent:i,pivotOffset:e.model.pivotOffset,numberOfVertices:x}]}})})}function O(e,t,r){return a(this,void 0,void 0,function(){var a,i,s,o,u,c,p,d;return n(this,function(n){switch(n.label){case 0:a=[],i=function(n){var i=t[n],s=i.images[0].data;if(!s)return k.warn("Externally referenced texture data is not yet supported"),"continue";var o=i.encoding+";base64,"+s,u="/textureDefinitions/"+n,c={noUnpackFlip:!0,wrapClamp:!1};l("enable-feature:jkieboom/alpha-channel-usage")&&(c.wrapClamp=!0);var p=r&&r.disablePreloadTextures?f.resolve(o):y.requestImage(o);a.push(p.then(function(t){return{refId:u,engineTexObj:new M(t,e,c),alphaChannelUsage:"rgba"===i.channels?i.alphaChannelUsage||"transparency":"none"}}))};for(s in t)i(s);return[4,f.all(a)];case 1:for(o=n.sent(),u={},c=0,p=o;c<p.length;c++)d=p[c],u[d.refId]=d;return[2,u]}})})}function R(e){var t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}function S(e){for(var t=new Uint32Array(e),r=0;r<e;r++)t[r]=r;return t}Object.defineProperty(t,"__esModule",{value:!0});var k=p.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),q=new m.Version(1,2,"wosr");t.fetch=A,t.fetchLod=C,t.computeBoundingBox=P,t.createStageResources=D,t.createTextureResources=O});