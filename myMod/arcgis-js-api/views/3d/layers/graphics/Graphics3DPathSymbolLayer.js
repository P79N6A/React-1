// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../geometry/Point","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../lib/gl-matrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,a,n,o,s,l,p,c,h,d,g,y,u){function v(e,t,r,i){for(var a=e.stageObject,o=a.getGeometryRecords(),s=o.length,l="absolute-height"!==t.mode,p=0,c=0;c<s;c++){var h=o[c].geometry,d=[o[c].transformation[12],o[c].transformation[13],o[c].transformation[14]],g=h.data.getVertexAttr(),y=g[_.POSITION].data,u=g.zOffset.data,v=g.mapPos.data,f=v.length/3;m(y.length/3==f*D+2,"unexpected tube geometry");var E=0,C=0;b.spatialReference=r.spatialReference;for(var P=0,A=0;A<f;A++){b.x=v[3*A],b.y=v[3*A+1],b.z=v[3*A+2];var G=n.computeElevation(r,b,t,i,l?S:null);l&&(P+=S.terrainElevation);var z=D;0!==A&&A!==f-1||z++;for(var w=0;w<z;w++)x[0]=y[E]+d[0],x[1]=y[E+1]+d[1],x[2]=y[E+2]+d[2],i.setAltitude(G+u[C],x),y[E]=x[0]-d[0],y[E+1]=x[1]-d[1],y[E+2]=x[2]-d[2],E+=3,C+=1;h.invalidateBoundingInfo()}a.geometryVertexAttrsUpdated(c),p+=P/f}return p/s}var m=y.assert,f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=s.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),i=l.vec3d.create(r),a=r[3],n={diffuse:i,ambient:i,opacity:a,transparent:a<1||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new u(n,t+"_3dlinemat"),this._context.stage.add(c.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(c.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,i=this.getGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,a,i,r,t.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var i=this._getMaterialOpacity(),a=i<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:i,transparent:a}),!0}if("elevationInfo"===e){this._updateElevationContext();for(var o in t){var s=t[o],l=r(s);if(l){var p=s.graphic,c=this.getGraphicElevationContext(p);l.needsElevationUpdates=n.needsElevationUpdates3D(c.mode),l.elevationContext.set(c)}}return!0}return!1},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype._getPathSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?n.getSingleSizeDriver(e.size):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,i,o){var s=e.geometry,c=s.paths,y=[],u=[],m=[],f=l.vec3d.create(),_=this._context.renderSpatialReference,x=_===p.SphericalECEFSpatialReference,b=new Array(6),S=this._getPathSize(t),E=n.getGeometryVertexData3D(c,s.hasZ,s.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(E,c,"paths","PathSymbol3DLayer"),c.length>0){for(var C=E.geometryData.outlines,P=E.eleVertexData,A=E.vertexData,G=0;G<C.length;++G){var z=C[G];if(!(z.count<=1)){var w=z.index,O=z.count;if(!this._context.clippingExtent||(n.computeBoundingBox(P,w,O,b),!n.boundingBoxClipped(b,this._context.clippingExtent))){n.chooseOrigin(A,w,O,f),n.subtractCoordinates(A,w,O,f);var U=new Float64Array(P.buffer,3*w*P.BYTES_PER_ELEMENT,3*O),I=n.flatArrayToArrayOfArrays(A,w,O),R=d.createTubeGeometry(I,.5*S,D,x,f);if(R.getVertexAttr().mapPos={size:3,data:U,offsetIdx:0,strideIdx:3},this._material.getParams().vertexColors){var T=this._getVertexOpacityAndColor(t);R=d.addVertexColors(R,T)}var V=new h(R,i+"path"+G);V.singleUse=!0,y.push(V),u.push([this._material]);var M=l.mat4d.identity();l.mat4d.translate(M,f,M),m.push(M)}}}if(y.length>0){var j=new g({geometries:y,materials:u,transformations:m,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:o},idHint:i}),L=v,B=new a(this,j,y,null,null,L,r);return B.alignedTerrainElevation=E.terrainElevation,B.needsElevationUpdates=n.needsElevationUpdates3D(r.mode),B}}return null},t}(o),_=y.VertexAttrConstants,x=l.vec3d.create(),b=new i,S={verticalDistanceToGround:0,terrainElevation:0},D=10;return f});