// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","dojo/promise/all","../../../../Color","../../../../core/Accessor","../../../../core/Handles","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/LabelClass","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DWebStyleSymbol","./labelPlacement","../../support/debugFlags","../../webgl-engine/Stage","../../webgl-engine/lib/Layer","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextTexture","../../webgl-engine/lib/TextTextureAtlas"],function(e,t,a,l,i,s,r,o,n,c,h,b,p,u,d,f,y,g,C,x,v,m){function T(e){return e instanceof d?e.graphics3DSymbol:e}Object.defineProperty(t,"__esModule",{value:!0});var D=function(e){function t(t){var a=e.call(this)||this;return a.labelStageLayer=null,a.labels={},a.labelsToAdd={},a.labelsToRemove={},a.labelingContexts=[],a.idHint="__labeler",a.dirty=!1,a}a(t,e),r=t,t.prototype.setup=function(){var e=this;this.handles||(this.handles=new o,this.handles.add([this.view.watch("state.camera",function(){return e.setDirty()})])),this.labelStageLayer||(this.labelStageLayer=new C(this.idHint,{isPickable:!1},this.idHint+"_labels"),this.view._stage.add(g.ModelContentType.LAYER,this.labelStageLayer),this.view._stage.addToViewContent([this.labelStageLayer.id]),this.textTextureAtlas=new m(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new x(this.view._stage),this.calloutMaterialCollection=new x(this.view._stage)),this.handles.add(this.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return e.needsIdleUpdate()},idleFrame:function(t){return e.idleUpdate(t)}}))},t.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.labelStageLayer&&(this.view._stage.removeFromViewContent([this.labelStageLayer.id]),this.view._stage.remove(g.ModelContentType.LAYER,this.labelStageLayer.id),this.labelStageLayer=null,this.textTextureAtlas.dispose(),this.textTextureAtlas=null,this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null,this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null),this.labelingContexts=[],this.labels={},this.labelsToAdd={},this.labelsToRemove={}},t.prototype.isActiveLabelingContext=function(e){return e.active&&this.labelsEnabled(e)},t.prototype.activateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]=a,a.graphics3DGraphic.setVisibilityFlag(0,!0,1)}e.active=!0},t.prototype.deactivateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];a.graphics3DGraphic.setVisibilityFlag(0,!1,1),a.rendered&&(this.labelsToRemove[t]=e.labels[t]),delete this.labels[t],delete this.labelsToAdd[t]}e.active=!1},t.prototype.addLabelTextureToAtlas=function(e){for(var t=0,a=0;a<e.graphics3DGraphic._labelGraphics.length;a++){var l=e.graphics3DGraphic._labelGraphics[a];if(l._labelClass){var i=e.textTextures[t];t++,i&&this.textTextureAtlas.addTextTexture(i,l.stageObject)}}e.rendered=!0},t.prototype.removeLabelTextureFromAtlas=function(e){for(var t=0;t<e.graphics3DGraphic._labelGraphics.length;t++)e.textTextures[t]&&this.textTextureAtlas.removeTextTexture(e.textTextures[t],e.graphics3DGraphic._labelGraphics[t].stageObject);e.rendered=!1},t.prototype.needsIdleUpdate=function(){return this.isDirty},t.prototype.idleUpdate=function(e){if(this.view.ready){for(var t=!!e,a=!1,l=0,i=this.labelingContexts;l<i.length;l++){var s=i[l];if(this.isActiveLabelingContext(s)){if(!this.hasValidLabelClassContext(s)){if(this.hasInvalidLabelClassContext(s)){this.deactivateLabelingContext(s);continue}if(this.createLabelClassContext(s),this.hasPendingLabelClassContext(s)){a=!0;continue}if(!this.hasValidLabelClassContext(s))continue}for(var r in s.labelsToInitialize){if(t&&e.done())return;var o=s.labelsToInitialize[r];!o.hasGraphics3DResources&&this.createGraphics3DResources(o)&&(this.labels[r]=o,t&&this.view.deconflictor.setDirty()),o.hasGraphics3DResources&&!o.hasTextTextureResources&&o.visible&&this.createTextTextureResources(o),(o.visible&&o.hasTextTextureResources||!o.visible&&o.hasGraphics3DResources)&&delete s.labelsToInitialize[r]}}}for(var r in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[r]),delete this.labelsToRemove[r];for(var r in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[r]),delete this.labelsToAdd[r];a||(this.dirty=!1)}},t.prototype.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()},t.prototype.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},t.prototype.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},t.prototype.createLabelClassContext=function(e){return e.labelClassPromise?e.labelClassPromise:(e.labelClassPromise=e.layer.when(function(){e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();var t=e.graphics3DCore,a=t.layer.labelingInfo&&t.layer.labelingInfo.filter(function(e){return!!e.symbol});if(!a||0===a.length)return null;var l=new Array(a.length),s=a.map(function(e,a){var i=e.symbol,s=T(t.getOrCreateGraphics3DSymbol(i)),r=null;return p.isCalloutSupport(i)&&i.hasVisibleCallout()&&(r=u.make(i,t.symbolCreationContext)),l[a]={labelClass:e,graphics3DSymbol:s,graphics3DCalloutSymbolLayer:r,options:e.getOptions()},s});return i(s).then(function(){return l})}).then(function(t){t&&(e.labelClassContexts=t)}).catch(function(){e.labelClassContexts=null}),e.labelClassPromise)},t.prototype.destroyLabelClassContext=function(e){e.labelClassContexts=[],e.labelClassPromise=null},t.prototype.createLabelText=function(e,t,a,l){if(!b.evaluateWhere(t.where,e.attributes))return null;var i=t.getLabelExpression();return i.expression?b.buildLabelText(i.expression,e,l.fields,a):null},t.prototype.createTextSymbolGraphic=function(e,t,a,l,i){var s={text:e,centerOffset:a.centerOffset,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,anchor:a.anchor,needsOffsetAdjustment:a.needsOffsetAdjustment,centerOffsetUnits:a.centerOffsetUnits,verticalOffset:a.verticalOffset,debugDrawBorder:y.LABELS_SHOW_BORDER};return r.tmpGraphicCreationContext.graphic=t,r.tmpGraphicCreationContext.renderingInfo=null,r.tmpGraphicCreationContext.layer=l,i.createGraphics3DGraphic(r.tmpGraphicCreationContext,s,this.hudMaterialCollection,this.textTextureAtlas)},t.prototype.createLineCalloutGraphic=function(e,t,a,l,i){return r.tmpGraphicCreationContext.graphic=e,r.tmpGraphicCreationContext.renderingInfo={symbol:t,needsOffsetAdjustment:l.needsOffsetAdjustment,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this.calloutMaterialCollection},r.tmpGraphicCreationContext.layer=i,a.createGraphics3DGraphic(r.tmpGraphicCreationContext)},t.prototype.createGraphics3DResources=function(e){var t=e.labelingContext,a=!1,l=e.graphics3DGraphic,i=l.graphic,s=t.labelClassContexts,r=t.layer,o=this.labelsEnabled(t);if(s&&0!==s.length&&l._graphics[0]){for(var n=0,c=s;n<c.length;n++){var h=c[n],b=h.labelClass,p=h.options,u=this.createLabelText(i,b,p,r);if(u){var d=null;h.graphics3DSymbol&&h.graphics3DSymbol.symbol&&"label-3d"===h.graphics3DSymbol.symbol.type&&(d=h.graphics3DSymbol.symbol);var y=h.graphics3DSymbol.childGraphics3DSymbols[0],g=f.get({graphics3DGraphic:l,labelSymbol:d,labelClass:h.labelClass});if(y&&g.isValid){var C=this.createTextSymbolGraphic(u,i,g,r,y);if(!C)return!1;if(C._labelClass=b,l.addLabelGraphic(C,this.labelStageLayer,this.view._stage),t.spatialIndex&&t.spatialIndex.add(l),l.setVisibilityFlag(0,o,1),l.setVisibilityFlag(1,void 0,1),l.setVisibilityFlag(2,!1,1),a=!0,h.graphics3DCalloutSymbolLayer&&g.hasLabelVerticalOffset){var x=this.createLineCalloutGraphic(i,d,h.graphics3DCalloutSymbolLayer,g,r);x&&(h.calloutSymbolLayerIndex=l._labelGraphics.length,l.addLabelGraphic(x,this.labelStageLayer,this.view._stage))}break}}}return t.scaleVisibility&&a&&t.scaleVisibility.updateGraphicLabelScaleVisibility(l),e.hasGraphics3DResources=!0,!0}},t.prototype.destroyGraphics3DResources=function(e){e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},t.prototype.createTextTextureResources=function(e){var t=e.labelingContext,a=e.graphics3DGraphic,l=t.labelClassContexts,i=t.layer,r=a.graphic;if(l&&0!==l.length&&a._graphics[0]){for(var o=0,n=l;o<n.length;o++){var h=n[o],b=h.labelClass,p=h.options,u=this.createLabelText(r,b,p,i)||r.symbol&&r.symbol.text;if(u&&!(u.length<1)){var d=h.graphics3DSymbol.childGraphics3DSymbols[0],f=d.symbol,y=f.material?s.toUnitRGBA(f.material.color):L,g=f.halo&&f.halo.color&&f.halo.size>0,C=g?s.toUnitRGBA(f.halo.color):L,x=g?c.pt2px(f.halo.size):0,m=c.pt2px(f.size)||12,T=i.id+"_label_"+r.uid,D=new v(u,{size:m,color:y,font:{family:f.font&&f.font.family?f.font.family:"sans-serif",weight:f.font&&f.font.weight?f.font.weight:"normal",style:f.font&&f.font.style?f.font.style:"normal"},halo:{size:x,color:C}},T);e.textTextures.push(D)}}e.hasTextTextureResources=!0}},t.prototype.destroyTextTextureResources=function(e){e.textTextures=[],e.hasTextTextureResources=!1},t.prototype.addGraphic=function(e,t){var a={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextures:[]},l=t.graphic.uid;e.labels[l]=a,this.isActiveLabelingContext(e)&&this.hasValidLabelClassContext(e)&&this.createGraphics3DResources(a)?this.labels[l]=a:e.labelsToInitialize[l]=a;var i=e.graphics3DCore.asyncUpdates;this.setDirty(i),this.view.deconflictor.setDirty({async:i})},t.prototype.removeGraphic=function(e,t){var a=t.graphic.uid,l=e.labels[a];if(l){this.labels[a]&&(this.removeLabelTextureFromAtlas(l),delete this.labels[a],delete this.labelsToAdd[a],delete this.labelsToRemove[a]),l.hasTextTextureResources&&this.destroyTextTextureResources(l),l.hasGraphics3DResources&&this.destroyGraphics3DResources(l),delete e.labels[a],delete e.labelsToInitialize[a];var i=e.graphics3DCore.asyncUpdates;this.setDirty(i),this.view.deconflictor.setDirty({async:i})}},t.prototype.labelsEnabled=function(e){return!0===e.layer.labelsVisible&&null!=e.layer.labelingInfo&&e.layer.labelingInfo.length>0},t.prototype.elevationInfoChange=function(e){for(var t=0,a=e.labelClassContexts;t<a.length;t++){var l=a[t];!function(t){if(t.graphics3DSymbol.layerPropertyChanged("elevationInfo",{}),t.graphics3DCalloutSymbolLayer){var a={},l=function(e){return e._labelGraphics[t.calloutSymbolLayerIndex]};for(var i in e.labels){var s=e.labels[i],r=s.graphics3DGraphic;a[r.graphic.uid]=r}t.graphics3DCalloutSymbolLayer.layerPropertyChanged("elevationInfo",a,l)}}(l)}},t.prototype.visibilityInfoChange=function(e){var t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e);var a=e.graphics3DCore.asyncUpdates;this.setDirty(a),this.view.deconflictor.setDirty({async:a})},t.prototype.resetLabels=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]&&(this.removeLabelTextureFromAtlas(a),delete this.labels[t],delete this.labelsToAdd[t],delete this.labelsToRemove[t]),a.hasTextTextureResources&&this.destroyTextTextureResources(a),a.hasGraphics3DResources&&this.destroyGraphics3DResources(a),a.visible=!1,a.rendered=!1,e.labelsToInitialize[t]=a}this.destroyLabelClassContext(e),this.labelStageLayer.invalidateSpatialQueryAccelerator();var l=e.graphics3DCore.asyncUpdates;this.setDirty(l),this.view.deconflictor.setDirty({async:l})},t.prototype.findLabelingContext=function(e){for(var t=0;t<this.labelingContexts.length;t++)if(this.labelingContexts[t].graphics3DCore===e)return this.labelingContexts[t];return null},t.prototype.addGraphicsOwner=function(e,t,a){var l=this;if(!this.findLabelingContext(e)){var i={graphics3DCore:e,layer:e.layer,scaleVisibility:t,spatialIndex:a,active:e.layer.labelsVisible,labelClassPromise:null,labelClassContexts:[],labels:{},labelsToInitialize:{}};return this.labelingContexts.push(i),this.setDirty(),{addGraphic:function(e){return l.addGraphic(i,e)},removeGraphic:function(e){return l.removeGraphic(i,e)},layerLabelsEnabled:function(){return l.labelsEnabled(i)},labelingInfoChange:function(e){if(e){for(var t=0,a=e;t<a.length;t++){var s=a[t],r=i.labels[s];r&&(l.removeGraphic(i,r.graphics3DGraphic),l.addGraphic(i,r.graphics3DGraphic))}return n.create(function(e){return!0})}return l.visibilityInfoChange(i),l.resetLabels(i),l.createLabelClassContext(i)},elevationInfoChange:function(){l.elevationInfoChange(i)},visibilityInfoChange:function(){l.visibilityInfoChange(i)},clear:function(){l.resetLabels(i)}}}},t.prototype.removeGraphicsOwner=function(e){var t=this.findLabelingContext(e);if(t){var a=this.labelingContexts.indexOf(t);this.labelingContexts.splice(a,1);for(var l in t.labels)this.removeGraphic(t,t.labels[l].graphics3DGraphic);this.setDirty()}},t.prototype.setLabelGraphicVisibility=function(e,t){var a=e.graphic.uid,l=this.labels[a];if(l){t&&!l.rendered?(this.labelsToAdd[a]=l,l.hasTextTextureResources||(l.labelingContext.labelsToInitialize[a]=l)):!t&&l.rendered&&(this.labelsToRemove[a]=l),l.visible=t;var i=l.labelingContext.graphics3DCore.asyncUpdates;this.setDirty(i)}},Object.defineProperty(t.prototype,"labelStageLayerId",{get:function(){return this.labelStageLayer.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this.dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(e){void 0===e&&(e=!0),this.dirty=!0,e||this.idleUpdate()},Object.defineProperty(t.prototype,"updating",{get:function(){return this.labelingContexts.some(function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()})},enumerable:!0,configurable:!0});var r;return t.tmpGraphicCreationContext={graphic:null,renderingInfo:null,layer:null},l([h.property({constructOnly:!0})],t.prototype,"view",void 0),l([h.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=r=l([h.subclass()],t)}(h.declared(r));t.Labeler=D;var L=[0,0,0,1]});