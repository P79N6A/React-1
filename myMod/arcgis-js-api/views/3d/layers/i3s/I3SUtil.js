// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../request","../../../../core/Error","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../geometry/SpatialReference","../../../../geometry/support/webMercatorUtils","../../../../tasks/QueryTask","../../../../tasks/support/Query","./I3SBinaryReader","../../support/projectionUtils","../../support/buffer/typedArrayUtil"],function(e,r,t,n,a,i,o,u,l,s,f,c,d){function h(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function p(e,t){if(Array.isArray(e)){if(t){var n=e.indexOf(r.DDS_ENCODING_STRING);if(n>-1)return n}for(var a=0;a<e.length;a++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[a])>-1)return a;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1}function v(e,r,t,n,a,i){if(null!=t){var o=t.mbs;if(r!==n&&(o=W,c.mbsToMbs(t.mbs,n,o,r)),0!==y(e,o)&&(i(t),t.children))for(var u=0;u<t.children.length;++u){var l=a[t.children[u].id];v(e,r,l,n,a,i)}}}function g(e,r,t,n){if(void 0===n&&(n=Number.POSITIVE_INFINITY),r<=0)return void e.clear();var a=new Map,i=Number.POSITIVE_INFINITY;e.forEach(function(o,u){var l=t(o);if(u<r)return i=Math.min(i,l),void a.set(o.id,l);if(!(l<=i||l>=n)){a.set(o.id,l),i=a.get(e.front().id);for(var s=i,f=0,c=1;c<r;++c){var d=e.data[c],h=a.get(d.id);h<i&&(f=c,s=i,i=h)}e.data[f]=o,i=s}}),e.length=Math.min(e.length,r),e.sort(function(e,r){return a.get(r.id)-a.get(e.id)})}function y(e,r){var t=r[0],n=r[1],a=r[2],i=r[3],o=0;if(t<e[0]){var u=e[0]-t;o+=u*u}if(n<e[1]){var u=e[1]-n;o+=u*u}if(a<e[2]){var u=e[2]-a;o+=u*u}if(t>e[3]){var u=t-e[3];o+=u*u}if(n>e[4]){var u=n-e[4];o+=u*u}if(a>e[5]){var u=a-e[5];o+=u*u}if(o>i*i)return 0;if(o>0)return 1;var l=1/0;return t-e[0]<l&&(l=t-e[0]),n-e[1]<l&&(l=n-e[1]),a-e[2]<l&&(l=a-e[2]),e[3]-t<l&&(l=e[3]-t),e[4]-n<l&&(l=e[4]-n),e[5]-a<l&&(l=e[5]-a),l>i?2:1}function m(e,r,t){for(var n=[],a=t&&t.missingFields,i=t&&t.originalFields,o=0,u=e;o<u.length;o++){for(var l=u[o],s=l.toLowerCase(),f=!1,c=0,d=r;c<d.length;c++){var h=d[c];if(s===h.name.toLowerCase()){n.push(h.name),f=!0,i&&i.push(l);break}}!f&&a&&a.push(l)}return n}function b(e,r,t,i,o,u){var l=!0===(u&&u.populateObjectId),s=u.ignoreUnavailableFields?void 0:[],f=1===i.length&&"*"===i[0];!f&&l&&(i=w(i,t));var c=f?i:m(i,e.fields,{missingFields:s});if(s&&0!==s.length)return a.reject(new n("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:s}));if(0===r.length)return a.resolve(r);var d=e.associatedLayer,h=e.attributeStorageInfo,p=f?e.fields.map(function(e){return e.name}):c;if(d)return I(d,r,t,p);var v=S(p,r[0]);if(0===v.length)return a.resolve(r);if(h){var g=o();return null==g?a.reject(new n("scenelayer:feature-not-loaded","Tried to query attributes for unloaded features")):x(h,g.node,g.indices,v,u).then(function(e){for(var t=0;t<r.length;t++){for(var n=0,a=p;n<a.length;n++){var i=a[n];i in e[t]||(e[t][i]=r[t].attributes[i])}r[t].attributes=e[t]}return r})}return a.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))}function w(e,r){return e.filter(function(e){return e.toLowerCase()!==r.toLowerCase()}).concat([r])}function I(e,r,t,n){r.sort(function(e,r){return e.attributes[t]-r.attributes[t]});var a=r.map(function(e){return e.attributes[t]}),i=[],o=m(n,e.fields,{originalFields:i});return R(e,a,o).then(function(e){for(var t=0;t<r.length;t++){var n=r[t],a=e[t];n.attributes={};for(var u=0;u<i.length;u++)n.attributes[i[u]]=a[o[u]]}return r})}function S(e,r){for(var t=[],n=0,a=e;n<a.length;n++){var i=a[n];i in r.attributes||t.push(i)}return t}function R(e,r,t){if(null!=e.maxRecordCount&&r.length>e.maxRecordCount){var i=T(r,e.maxRecordCount);return a.all(i.map(function(r){return R(e,r,t)})).then(A)}var o=new s({objectIds:r,outFields:t,orderByFields:[e.objectIdField]});return new l(e.parsedUrl.path).execute(o).then(function(e){return e&&e.features&&e.features.length===r.length?e.features.map(function(e){return e.attributes}):a.reject(new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function x(e,r,o,u,l){for(var s=[],c=0;c<r.attributeData.length;c++){var d=r.attributeData[c],h=e[c];if(h&&-1!==u.indexOf(h.name)){var p=i.makeAbsolute(d.href,r.baseUrl);s.push({url:p,storageInfo:h})}}return a.eachAlways(s.map(function(e){return t(e.url,{responseType:"array-buffer"}).then(function(r){return f.readBinaryAttribute(e.storageInfo,r.data)})})).then(function(e){var r=[];if(!l.ignoreUnavailableFields&&e.some(function(e){return null==e.value})){for(var t=[],i=0;i<e.length;i++)null==e[i].value&&t.push({name:s[i].storageInfo.name,error:e[i].error});return a.reject(new n("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:t}))}for(var u=0,f=o;u<f.length;u++){for(var c=f[u],d={},i=0;i<e.length;i++)null!=e[i].value&&(d[s[i].storageInfo.name]=C(e[i].value,c));r.push(d)}return r})}function C(e,r){var t=e[r];return d.isInt16Array(e)?t===Q?null:t:d.isInt32Array(e)?t===Y?null:t:t!==t?null:t}function T(e,r){for(var t=e.length,n=Math.ceil(t/r),a=[],i=0;i<n;i++){var o=Math.floor(t*i/n),u=Math.floor(t*(i+1)/n);a.push(e.slice(o,u))}return a}function A(e){for(var r=[],t=0,n=e;t<n.length;t++){var a=n[t];r=r.concat(a)}return r}function M(e,r,t){void 0===t&&(t=2);for(var a=null!=r?r:e.length/t,i=new Uint32Array(a+1),o=0;o<a;o++){var u=e[o*t],l=3*u;i[o]=l;var s=(o-1)*t+1;if(s>=0&&u-1!==e[s])throw new n("Face ranges are not continuous")}var f=e[(a-1)*t+1],c=3*(f+1);return i[i.length-1]=c,i}function N(e){var r=new o(h(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function E(e){var r=new o(h(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function k(e,r){return r===c.SphericalECEFSpatialReference?"@ECEF":e.equals(r)?"":null!=r.wkid?"@"+r.wkid:null}function F(e,r,t){if(!u.canProject(e,r))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===t&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function G(e,r,t){var n=N(e),a=E(e);F(n,r,t),F(a,r,t)}function O(e){return(null==e.geometryType||"triangles"===e.geometryType)&&((null==e.topology||"PerAttributeArray"===e.topology)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position))}function _(e){if(null==e.store||null==e.store.defaultGeometrySchema||!O(e.store.defaultGeometrySchema))throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})}function j(e,r){G(e,r.spatialReference,r.viewingMode)}function D(e){return null!=e.geometryType&&"points"===e.geometryType&&((null==e.topology||"PerAttributeArray"===e.topology)&&((null==e.encoding||""===e.encoding||"lepcc-xyz"===e.encoding)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position)))}function L(e){if(null==e.store||null==e.store.defaultGeometrySchema||!D(e.store.defaultGeometrySchema))throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function P(e,r){F(e.spatialReference,r.spatialReference,r.viewingMode)}function U(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}function q(e){return"mesh-3d"===e.type}function V(e){if(null==e||!U(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var r=e.getSymbols();if(0===r.length)return!0;for(var t=0,n=r;t<n.length;t++){var a=n[t];if(!q(a)||0===a.symbolLayers.length)return!0;for(var i=0,o=a.symbolLayers.items;i<o.length;i++){var u=o[i];if("fill"!==u.type||null==u.material||"replace"!==u.material.colorMixMode)return!0}}return!1}function B(e){for(var r=new z,t=!1,n=!1,a=0,i=e.symbolLayers.items;a<i.length;a++){var o=i[a];if("fill"===o.type&&o.enabled){var u=o.material,l=o.edges;if(u&&!t){var s=u.color;r.material={color:s?[s.r/255,s.g/255,s.b/255]:null,alpha:s?s.a:null,colorMixMode:u.colorMixMode},t=!0}l&&!n&&(r.edges=o.edges,n=!0)}}return r}Object.defineProperty(r,"__esModule",{value:!0}),r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.extractWkid=h,r.getAppropriateTextureEncoding=p,r.findIntersectingNodes=v,r.buildTopNodeMap=g;var W=[0,0,0,0];r.intersectBoundingBoxWithMbs=y,r.findFieldsCaseInsensitive=m,r.whenGraphicAttributes=b;var Q=-Math.pow(2,15),Y=-Math.pow(2,31);r.getCachedAttributeValue=C,r.convertFlatRangesToOffsets=M,r.getIndexCrs=N,r.getVertexCrs=E,r.getCacheKeySuffix=k,r.checkSpatialReference=F,r.checkSpatialReferences=G,r.checkSceneLayerValid=_,r.checkSceneLayerCompatibleWithView=j,r.checkPointCloudLayerValid=L,r.checkPointCloudLayerCompatibleWithView=P,r.rendererNeedsTextures=V;var z=function(){function e(){this.edges=null,this.material=null}return e}();r.SymbolInfo=z,r.getSymbolInfo=B});