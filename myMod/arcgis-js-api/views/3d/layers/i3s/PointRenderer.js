// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../geometry/support/aaBoundingBox","../../lib/gl-matrix","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/lib/ProgramRepository","../../webgl-engine/lib/RenderPass","../../webgl-engine/materials/internal/MaterialUtil","../../webgl-engine/shaders/PointRendererPrograms","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],function(e,t,i,r,n,s,a,o,l,d,c,p){function u(e){return e?256:64}function h(e,t,i,r,n){if(i.drawScreenSpace)return i.fixedSize*t*r;var s=u(n)*t*r;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),s):Math.min(e/2,s)}function m(e,t,i,r,n){return i.drawScreenSpace?0:h(e,t,i,r,n)}function f(e,t,i){return null==i&&(i=r.vec3d.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}var g={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]},_=function(){function e(){this.didRender=!1,this.needsRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=i.create(i.POSITIVE_INFINITY),this._programRep=null,this._needsPrograms=!0,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=r.mat4.create(),this.tempVec3=r.vec3.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){var t=e.rctx;this._programRep=new a(t),this.needsRender=!0,this._needsPrograms=!0},e.prototype.uninitializeRenderContext=function(e){this._programRep.dispose(),this._programRep=null,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,a,o){var l=r.vec3d.create(),d=r.vec3d.create(),c=r.vec3d.create(),p=r.vec3d.create(),u=n.plane.create(),g=e.camera.perPixelRatio,_=e.camera.near,v=this._getSizeParams();r.vec3d.subtract(a,t,d);var S=1/r.vec3d.length(d);r.vec3d.scale(d,S,d),r.vec3d.negate(d,c),r.vec4d.set4(d[0],d[1],d[2],-r.vec3d.dot(d,t),u);var P={},b={},x=i.create(),y=i.create(this._clipBox);i.offset(y,-t[0],-t[1],-t[2],y);for(var z=0,R=this.nodes;z<R.length;z++){var M=R[z],I=M.splatSize*this._scaleFactor,w=s.minimumDistancePlane(M.obb,u),E=s.maximumDistancePlane(M.obb,u);w-=m(I,w+_,v,g,M.isLeaf),E-=m(I,E+_,v,g,M.isLeaf);var U=E<0,F=null!=P.dist&&null!=b.dist&&P.dist<w*S&&b.dist>E*S;if(!U&&!F){var V=h(I,E+_,v,g,M.isLeaf);if(s.intersectLine(M.obb,t,d,V)){var O=V*V;s.toAaBoundingBox(M.obb,x),i.offset(x,-t[0],-t[1],-t[2],x);var W=!i.contains(y,x);r.vec3d.subtract(M.origin,t,p);for(var q=M.coordinates.length/3,D=0;D<q;D++)if(l[0]=p[0]+M.coordinates[3*D],l[1]=p[1]+M.coordinates[3*D+1],l[2]=p[2]+M.coordinates[3*D+2],!W||i.containsPoint(y,l)){var j=r.vec3d.dot(l,d),B=j+_,T=m(I,B,v,g,M.isLeaf);if(!(j-T<0)){var A=r.vec3d.length2(l)-j*j;if(!(A>O)){B-=T;var N=h(I,B,v,g,M.isLeaf);if(!(A>N*N)){var L=this.layerUid+"/"+M.id+"/"+D,C=(j-T)*S;(null==P.dist||C<P.dist)&&(P.point=f(M,D,P.point),P.dist=C,P.normal=c,P.pointId=L,P.layerUid=this.layerUid),(null==b.dist||C>b.dist)&&(b.point=f(M,D,b.point),b.dist=C,b.normal=c,b.pointId=L,b.layerUid=this.layerUid)}}}}}}}if(null!=P.dist){var H=e.minResult;if(null==H.dist||P.dist<H.dist){var Y={type:"external",point:P.point,metadata:{pointId:P.pointId,layerUid:P.layerUid}};H.set(Y,P.pointId,P.dist,P.normal,void 0),H.setIntersector("PointRenderer")}}if(null!=b.dist){var k=e.maxResult;if(null==k.dist||b.dist>k.dist){var Y={type:"external",point:b.point,metadata:{pointId:b.pointId,layerUid:b.layerUid}};k.set(Y,b.pointId,b.dist,b.normal,void 0),k.setIntersector("PointRenderer")}}},e.prototype.render=function(e){if(e.pass!==o.MATERIAL&&e.pass!==o.MATERIAL_DEPTH)return!1;for(var t=e.pass===o.MATERIAL_DEPTH,n=e.rctx,s=0,a=this.nodes;s<a.length;s++){var d=a[s];null==d.vao&&this._initNode(e,d)}this._selectPrograms();var c=this._getSizeParams(),p=t?c.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:c.drawScreenSpace?this._programScreen:this._programWorld;if(null==p||0===this.nodes.length)return!0;var h=this._clipBox,m=!i.equals(h,i.POSITIVE_INFINITY,function(e,t){return e===t});m||(r.vec3.set3(-1/0,-1/0,-1/0,this.tempVec3),p.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set3(1/0,1/0,1/0,this.tempVec3),p.setUniform3fv("uClipMax",this.tempVec3)),n.setDepthTestEnabled(!0),n.bindProgram(p);var f=e.camera.projectionMatrix;p.setUniformMatrix4fv("uProjectionMatrix",f),t&&p.setUniform2f("nearFar",e.camera.near,e.camera.far),c.drawFixedSize&&p.setUniform2f("uPointScale",c.fixedSize,e.camera.fullHeight);for(var g=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,_=0,v=this.nodes;_<v.length;_++){var d=v[_];if(p.setUniform2f("uScreenMinMaxSize",c.screenMinSize,u(d.isLeaf)),!c.drawFixedSize){var S=d.splatSize*this._scaleFactor;p.setUniform2f("uPointScale",S,e.camera.fullHeight)}var P=d.origin;m&&(r.vec3.set3(h[0]-P[0],h[1]-P[1],h[2]-P[2],this.tempVec3),p.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set3(h[3]-P[0],h[4]-P[1],h[5]-P[2],this.tempVec3),p.setUniform3fv("uClipMax",this.tempVec3)),r.mat4.identity(this.tempMatrix4),r.mat4.translate(this.tempMatrix4,P,this.tempMatrix4),r.mat4.multiply(e.camera.viewMatrix,this.tempMatrix4,this.tempMatrix4),p.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),g&&l.bindSlicePlane(P,g,p),n.bindVAO(d.vao),n.drawArrays(0,0,d.coordinates.length/3)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){i.set(this._clipBox,e||i.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender(),this._needsPrograms=!0)},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._requestRender()},e.prototype.removeNode=function(e){var t=null;return this.nodes=this.nodes.filter(function(i){return i.id!==e||(t=i,i.vao&&(i.vao.dispose(!0),i.vao=null),!1)}),this._requestRender(),t},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new p(i,d.program.attributes,g,{positions:c.createVertex(i,35044,t.coordinates),colors:c.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this.didRender=!1,this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,r=this._minSizePx;return e&&(r=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:r}},e.prototype._selectPrograms=function(){this._needsPrograms&&(this._needsPrograms=!1,this._programWorld=this._programRep.getProgram(d.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(d.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(d.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(d.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}))},e}();return function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(_||(_={})),_});