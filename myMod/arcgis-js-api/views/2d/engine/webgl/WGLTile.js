// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix/mat2d","../../../../core/libs/gl-matrix/mat4","../../../../core/libs/gl-matrix/vec2","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./number","./TileData","./Utils","./WGLBuffers","./WGLDisplayList","../../tiling/enums","../../tiling/TileKey"],function(t,e,r,a,i,s,o,l,n,d,p,y,u,h,c,f,m,v){function _(t,e){return t.sortKey-e.sortKey}return function(t){function e(e,r){var o=t.call(this)||this;return o.status=m.TileStatus.INITIALIZED,o._data=null,o.hlDisplayList=null,o._displayList=null,o._wglBuffers=null,o._dirtyMap=new n.default,o.coords=[0,0],o.bounds=[0,0,0,0],o.tileTransform={transform:Float32Array[16],screenTransform:Float32Array[16],displayCoord:Float32Array[2],screenCoord:Float32Array[2]},o._labelIndex=null,o.tileTransform.screenTransform=a.create(),o.tileTransform.transform=i.create(),o.tileTransform.displayCoord=s.create(),o.tileTransform.screenCoord=s.create(),o.key=v.pool.acquire(e),o.coords[0]=r[0],o.coords[1]=r[3],o.bounds=r,o}return r(e,t),Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.FILL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LINE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.status===m.TileStatus.MODIFIED},set:function(t){this.hasData&&(t&&this.status===m.TileStatus.READY?this.setStatus(m.TileStatus.MODIFIED):t||this.status!==m.TileStatus.MODIFIED||this.setStatus(m.TileStatus.READY),this.requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},e.prototype.getDisplayList=function(t){switch(t){case p.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setData=function(t,e,r){var a=t.addOrUpdate&&u.decode(t.addOrUpdate),i=t.remove;if((t.clear||!this.hasData)&&!t.addOrUpdate)return this.clear(),void this.setStatus(m.TileStatus.NO_DATA);!t.clear&&this.hasData||!t.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:a,remove:i},e,r):(this._dirtyMap=new n.default,this._dispRecStore=d.default.fromTileData(a,this._dirtyMap),this._data=a,this._readyTileIfNoLabels(e,r),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=a.tileDisplayData.displayList.clone()))},e.prototype.commitChanges=function(t){this._data&&(this.status===m.TileStatus.READY||this.status===m.TileStatus.MODIFIED&&!this._wglBuffers)&&(this._wglBuffers||(this._wglBuffers=new c.default(t.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},e.prototype.resetVisibility=function(t){var e=this,r=new Array(0),a=new Array(1);t.forEach(function(t){a[0]=t,e.setVisibility(r,a)})},e.prototype.setVisibility=function(t,e){for(var r=this._data.tileBufferData.geometries.map(function(t){return{vertexFrom:void 0,vertexTo:void 0,geometry:t}}),a=0,i=t;a<i.length;a++){var s=i[a],o=this._data.tileDisplayData.displayObjectRegistry.get(s);if(o)for(var l=0,n=o.displayRecords;l<n.length;l++){var d=n[l],p=r[d.geometryType],y=p.geometry.vertexBuffer[h.C_VBO_VISIBILITY];if(y){p.vertexFrom=null==p.vertexFrom?d.vertexFrom:Math.min(p.vertexFrom,d.vertexFrom),p.vertexTo=null==p.vertexTo?d.vertexFrom+d.vertexCount:Math.max(p.vertexTo,d.vertexFrom+d.vertexCount);for(var u=d.vertexFrom,c=d.vertexCount,f=0;f<c;++f)y.data[u+f]=255}}}for(var m=0,v=e;m<v.length;m++){var _=v[m],o=this._data.tileDisplayData.displayObjectRegistry.get(_);if(o)for(var D=0,g=o.displayRecords;D<g.length;D++){var d=g[D],p=r[d.geometryType],y=p.geometry.vertexBuffer[h.C_VBO_VISIBILITY];if(y){p.vertexFrom=null==p.vertexFrom?d.vertexFrom:Math.min(p.vertexFrom,d.vertexFrom),p.vertexTo=null==p.vertexTo?d.vertexFrom+d.vertexCount:Math.max(p.vertexTo,d.vertexFrom+d.vertexCount);for(var u=d.vertexFrom,c=d.vertexCount,f=0;f<c;++f)y.data[u+f]=0}}}for(var b=!1,x=0;x<r.length;++x){var p=r[x];if(null!=p.vertexFrom&&null!=p.vertexTo){var L=p.vertexTo?p.vertexTo-p.vertexFrom:0;this._dirtyMap.markDirtyVertices(x,h.C_VBO_VISIBILITY,p.vertexFrom,L),b=!0}}b&&this.requestRender()},e.prototype.setVisibilityRange=function(t,e,r,a){for(var i=y.i8888to32(r,a,r,a),s=void 0,o=void 0,l=this._data.tileBufferData.geometries[p.WGLGeometryType.LABEL],n=l.vertexBuffer[h.C_VBO_VISIBILITY_RANGE],d=this._data.tileDisplayData.displayObjectRegistry.get(t),u=d.metrics[e],c=u.range.from,f=c+u.range.count,m=c;m<f;++m){var v=d.displayRecords[m];if(v.geometryType===p.WGLGeometryType.LABEL){s=null==s?v.vertexFrom:Math.min(s,v.vertexFrom),o=null==o?v.vertexFrom+v.vertexCount:Math.max(o,v.vertexFrom+v.vertexCount);for(var _=v.vertexFrom*n.stride/4,D=v.vertexCount*n.stride/4,g=0;g<D;++g)n.data[_+g]=i}}var b=o?o-s:0;this._dirtyMap.markDirtyVertices(p.WGLGeometryType.LABEL,h.C_VBO_VISIBILITY_RANGE,s,b)},e.prototype.setStatus=function(t){this.status=t,t!==m.TileStatus.READY&&t!==m.TileStatus.NO_DATA||(this.attached=!0)},e.prototype.clear=function(){this.attached=!1,this._data=null,this._displayList=null,this._dispRecStore=null,this.setStatus(m.TileStatus.INITIALIZED),this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},e.prototype.dispose=function(){this.clear()},e.prototype.attach=function(t){return this.canDisplay},e.prototype.detach=function(e){t.prototype.detach.call(this,e)},e.prototype.doRender=function(t){var e=this;if(this.attached&&this.hasData){this.commitChanges(t),t.context.setStencilFunction(514,this.stencilRef,255);t.painter.getBrushes(t.drawPhase).forEach(function(r){return r.draw(t,e)})}},e.prototype.buildHLList=function(t){var e=this;this.hlDisplayList=new f;var r=function(t){e._addToHLDisplayList(e.hlDisplayList,t)};t.forEach(r)},e.prototype._addToHLDisplayList=function(t,e){if(this._data){var r=this._data.tileDisplayData.displayObjectRegistry.get(e);if(r){for(var a=[],i=0,s=r.displayRecords;i<s.length;i++){var o=s[i],l=o.copy();l.meshData=null,l.symbolLevel=0,l.zOrder=0,a.push(l)}a.sort(_),t.addToList(a)}}},e.prototype._readyTileIfNoLabels=function(t,e){t?(this.setStatus(e?m.TileStatus.MODIFIED:m.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(m.TileStatus.READY)},e.prototype._doPatchData=function(t,e,r){this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=d.default.fromTileData(this._data,this._dirtyMap)),this._readyTileIfNoLabels(e,r),this.requestRender()},e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++){var r=e[t];this._insertIntoLabelIndex(r)}},e.prototype._insertIntoLabelIndex=function(t){var e=t.anchor;if(-1!==t.xBucket&&e){this.labelIndex[t.yBucket][t.xBucket].push(t)}},e.prototype._initLabelIndex=function(){for(var t=[],e=0;e<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var r=0;r<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;r++)t[e].push([])}return t},e.prototype._patchData=function(t){for(var e=!0,r=0,a=t.remove||[];r<a.length;r++){var i=a[r],s=this._data.tileDisplayData.displayObjectRegistry.get(i);if(s){this._data.tileDisplayData.displayList.removeFromList(s.displayRecords);for(var o=0,l=s.displayRecords;o<l.length;o++){var n=l[o];this._dispRecStore.delete(n)}this._data.tileDisplayData.displayObjectRegistry.delete(i);var d=this._data.tileDisplayData.displayObjects.indexOf(s);this._data.tileDisplayData.displayObjects.splice(d,1)}}for(var p=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],y=0,u=p;y<u.length;y++){var h=u[y],s=this._data.tileDisplayData.displayObjectRegistry.get(h.id);if(s){var c=s.displayRecords;s.set(h),s.displayRecords=c;for(var f=s.displayRecords.length,m=0;m<f;++m){var v=s.displayRecords[m],_=h.displayRecords[m];(m>=h.displayRecords.length||v.geometryType!==_.geometryType||v.symbolLevel!==_.symbolLevel||v.zOrder!==_.zOrder||v.materialInfo.materialKey!==_.materialInfo.materialKey)&&(this._dispRecStore.delete(s.displayRecords[m]),m<h.displayRecords.length&&(s.displayRecords[m]=void 0))}s.displayRecords.length=h.displayRecords.length,s.anchor=h.anchor,s.metrics=h.metrics}else s=h.copy(),s.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(h.id,s),this._data.tileDisplayData.displayObjects.push(s);for(var D=h.displayRecords.length,m=0;m<D;++m){var _=h.displayRecords[m],v=s.displayRecords[m];v?(v.meshData=_.meshData,v.materialInfo=_.materialInfo):(v=_.copy(),v.vertexFrom=void 0,v.indexFrom=void 0,s.displayRecords[m]=v);var g=_.geometryType,b=t.addOrUpdate.tileBufferData.geometries[g],x=b.vertexBuffer,L=b.indexBuffer;e=this._dispRecStore.setMeshData(v,_,x,L)&&e}}return e},e}(o)});