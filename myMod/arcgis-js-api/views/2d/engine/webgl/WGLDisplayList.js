// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/Logger","./enums","./MaterialInfo","./Utils","./util/serializationUtils"],function(e,t,r,n,i,o,l,s){function a(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];t<e.length?e.splice.apply(e,[t,r].concat(n)):e.push.apply(e,n)}var u=n.getLogger("esri.views.2d.engine.webgl.WGLDisplayList"),y=function(){function e(){this.symbolLevels=[]}return Object.defineProperty(e.prototype,"empty",{get:function(){return!this.symbolLevels||0===this.symbolLevels.length},enumerable:!0,configurable:!0}),e.prototype.addToList=function(e,t){if(!Array.isArray(e))return void this._addToList(e,t);for(var r=0,n=e;r<n.length;r++){var i=n[r];this._addToList(i,t)}},e.prototype.removeFromList=function(e){Array.isArray(e)||(e=[e]);for(var t=null,r=0,n=e;r<n.length;r++){var i=n[r];t=this._removeFromList(i)}return t},e.prototype.ofType=function(e){var t,n,i,o,l,s,a,u,y,m,f;return r(this,function(r){switch(r.label){case 0:t=0,n=this.symbolLevels,r.label=1;case 1:if(!(t<n.length))return[3,8];i=n[t],o=0,l=i.zLevels,r.label=2;case 2:if(!(o<l.length))return[3,7];if(s=l[o],a=s.geometryDPInfo,u=this._getDPInfoType(e),!a[u])return[3,6];y=0,m=a[u],r.label=3;case 3:return y<m.length?(f=m[y],[4,f]):[3,6];case 4:r.sent(),r.label=5;case 5:return y++,[3,3];case 6:return o++,[3,2];case 7:return t++,[3,1];case 8:return[2]}})},e.prototype.clone=function(){for(var t=new e,r=0,n=this.symbolLevels;r<n.length;r++){var i=n[r];t.symbolLevels.push(i.clone())}return t},e.prototype._addToList=function(e,t){var r=e.symbolLevel,n=e.zOrder,i=this._getDisplayList(r,n,e.geometryType),o=null!=t?t:i.length-1,s=o>=0&&o<i.length?i[o]:null;if(null!==s&&l.isSameMaterialInfo(s.materialInfo,e.materialInfo)&&s.indexFrom+s.indexCount===e.indexFrom)s.indexCount+=e.indexCount;else{var u=new m;u.indexFrom=e.indexFrom,u.indexCount=e.indexCount,u.materialInfo=e.materialInfo,u.geometryType=e.geometryType,a(i,o+1,0,u)}},e.prototype._removeFromList=function(e){for(var t=e.symbolLevel,r=e.zOrder,n=this._getDisplayList(t,r,e.geometryType),i=n.length,l=void 0,s=0;s<i;++s){var u=n[s];e.indexFrom+e.indexCount>u.indexFrom&&e.indexFrom<u.indexFrom+u.indexCount&&(l=s)}if(void 0!==l){var u=n[l];if(e.indexFrom===u.indexFrom)return u.indexCount-=e.indexCount,u.indexFrom+=e.indexCount,0===u.indexCount&&a(n,l,1),l-1;if(e.indexFrom+e.indexCount===u.indexFrom+u.indexCount)return u.indexCount-=e.indexCount,0===u.indexCount?(a(n,l,1),l-1):l;var y=u.indexFrom,f=e.indexFrom-u.indexFrom,p=e.indexCount,L=u.indexFrom+u.indexCount-(e.indexFrom+e.indexCount);u.indexCount=f;var d=new m;return d.geometryType=u.geometryType,d.materialInfo=new o.default,d.materialInfo.copy(u.materialInfo),d.indexFrom=y+f+p,d.indexCount=L,a(n,l+1,0,d),l}return null},e.prototype._getDisplayList=function(e,t,r){for(var n,o=this.symbolLevels.length,l=0;l<o;l++)if(this.symbolLevels[l].symbolLevel===e){n=this.symbolLevels[l];break}n||(n=new L,n.symbolLevel=e,this.symbolLevels.push(n));for(var s,a=n.zLevels.length,u=0;u<a;u++)if(n.zLevels[u].zLevel===t){s=n.zLevels[u];break}s||(s=new p,s.geometryDPInfo=new f,s.zLevel=t,n.zLevels.push(s));var y;switch(r){case i.WGLGeometryType.FILL:s.geometryDPInfo.fill||(s.geometryDPInfo.fill=[]),y=s.geometryDPInfo.fill;break;case i.WGLGeometryType.LINE:s.geometryDPInfo.line||(s.geometryDPInfo.line=[]),y=s.geometryDPInfo.line;break;case i.WGLGeometryType.MARKER:s.geometryDPInfo.marker||(s.geometryDPInfo.marker=[]),y=s.geometryDPInfo.marker;break;case i.WGLGeometryType.TEXT:s.geometryDPInfo.text||(s.geometryDPInfo.text=[]),y=s.geometryDPInfo.text;break;case i.WGLGeometryType.LABEL:s.geometryDPInfo.label||(s.geometryDPInfo.label=[]),y=s.geometryDPInfo.label;break;default:console.error("Trying to add a record with geometry type '"+r+"'.")}return y},e.prototype.serialize=function(e){return s.serializeList(e,this.symbolLevels),e},e.deserialize=function(t){var r=new e;return r.symbolLevels=s.deserializeList(t,L),r},e.prototype._getDPInfoType=function(e){switch(e){case i.WGLGeometryType.FILL:return"fill";case i.WGLGeometryType.LINE:return"line";case i.WGLGeometryType.MARKER:return"marker";case i.WGLGeometryType.TEXT:return"text";case i.WGLGeometryType.LABEL:return"label";default:u.error("DisplayList: Tried to convert unknown geometryType: "+e)}},e}(),m=function(){function e(){this.materialInfo=null,this.indexFrom=0,this.indexCount=0}return e.prototype.clone=function(){var t=new e;return t.geometryType=this.geometryType,t.materialInfo=new o.default,t.materialInfo.copy(this.materialInfo),t.indexFrom=this.indexFrom,t.indexCount=this.indexCount,t},e.prototype.serialize=function(e){return this.materialInfo.serialize(e),e.push(this.indexFrom),e.push(this.indexCount),e},e.deserialize=function(t,r){var n=new e;return n.geometryType=r.geometryType,n.materialInfo=o.default.deserialize(t),n.indexFrom=t.readInt32(),n.indexCount=t.readInt32(),n},e}(),f=function(){function e(){this.fill=null,this.line=null,this.marker=null,this.text=null,this.label=null}return e.prototype.clone=function(){var t=new e;return t.fill=this.fill&&this.fill.map(function(e){return e.clone()}),t.line=this.line&&this.line.map(function(e){return e.clone()}),t.marker=this.marker&&this.marker.map(function(e){return e.clone()}),t.text=this.text&&this.text.map(function(e){return e.clone()}),t.label=this.label&&this.label.map(function(e){return e.clone()}),t},e.prototype.serialize=function(e){return s.serializeList(e,this.fill),s.serializeList(e,this.line),s.serializeList(e,this.marker),s.serializeList(e,this.text),s.serializeList(e,this.label),e},e.deserialize=function(t){var r=new e,n={geometryType:i.WGLGeometryType.FILL},o=s.deserializeList(t,m,n);o.length&&(r.fill=o),n.geometryType=i.WGLGeometryType.LINE;var l=s.deserializeList(t,m,n);l.length&&(r.line=l),n.geometryType=i.WGLGeometryType.MARKER;var a=s.deserializeList(t,m,n);a.length&&(r.marker=a),n.geometryType=i.WGLGeometryType.TEXT;var u=s.deserializeList(t,m,n);u.length&&(r.text=u),n.geometryType=i.WGLGeometryType.LABEL;var y=s.deserializeList(t,m,n);return y.length&&(r.label=y),r},e}(),p=function(){function e(){this.geometryDPInfo=new f}return e.prototype.clone=function(){var t=new e;return t.zLevel=this.zLevel,t.geometryDPInfo=this.geometryDPInfo.clone(),t},e.prototype.serialize=function(e){return e.push(this.zLevel),this.geometryDPInfo.serialize(e),e},e.deserialize=function(t){var r=new e;return r.zLevel=t.readInt32(),r.geometryDPInfo=f.deserialize(t),r},e}(),L=function(){function e(){this.zLevels=[]}return e.prototype.clone=function(){var t=new e;t.symbolLevel=this.symbolLevel;for(var r=0,n=this.zLevels;r<n.length;r++){var i=n[r];t.zLevels.push(i.clone())}return t},e.prototype.serialize=function(e){return e.push(this.symbolLevel),s.serializeList(e,this.zLevels),e},e.deserialize=function(t){var r=new e;return r.symbolLevel=t.readInt32(),r.zLevels=s.deserializeList(t,p),r},e}();return y});