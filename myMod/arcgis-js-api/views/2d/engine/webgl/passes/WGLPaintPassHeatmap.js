// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../definitions","../shaders/HeatmapPrograms","../../../../webgl/BufferObject","../../../../webgl/FramebufferObject","../../../../webgl/programUtils","../../../../webgl/Texture","../../../../webgl/VertexArrayObject"],function(t,e,i,r,n,a,o,s,l){function h(t){for(var e=[],i=0;i<t.values.length;++i){var r=t.values[i],n=Math.floor(255*t.colors[4*i+0]),a=Math.floor(255*t.colors[4*i+1]),o=Math.floor(255*t.colors[4*i+2]),s=t.colors[4*i+3];e.push({ratio:r,color:"rgba("+n+", "+a+", "+o+", "+s+")"})}return e}Object.defineProperty(e,"__esModule",{value:!0});var d=i.TILE_SIZE,_=function(){function t(){this._initialized=!1,this._initWGLExtensions=!1}return t.prototype.dispose=function(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._gradientTex&&(this._gradientTex.dispose(),this._gradientTex=null),this._boundFBO=null},t.prototype.preRender=function(t,e){console.log("Heatmap: Running prerender");var i=t.context,r=i.getViewport(),n=r.width,a=r.height;this._bindHeatmapSurface(i,n,a)},t.prototype.postRender=function(t,e){console.log("Heatmap: Running postrender");var i=t.context,r=t.rendererInfo;this._drawHeatmap(i,r,1)},t.prototype._bindHeatmapSurface=function(t,e,i){if(!this._initWGLExtensions){var r=t.gl.getSupportedExtensions();if(-1===r.indexOf("OES_texture_float_linear")||-1===r.indexOf("WEBGL_color_buffer_float"))throw Error("Required WebGL extensions needed for the heatmap drawing are not available!");t.gl.getExtension("OES_texture_float_linear"),t.gl.getExtension("WEBGL_color_buffer_float"),this._initWGLExtensions=!0}var n=Math.round(e/4),o=Math.round(i/4);if(!this._intensityFBO||this._intensityFBO.width!==n||this._intensityFBO.height!==o){this._intensityFBO&&this._intensityFBO.dispose();var l=new s(t,{target:3553,internalFormat:34836,pixelFormat:6408,dataType:5126,samplingMode:9729,wrapMode:33071,width:n,height:o});this._intensityFBO=a.createWithAttachments(t,l,{colorTarget:0,depthStencilTarget:3,width:n,height:o,multisampled:!1})}this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._intensityFBO),this._prevVP=t.getViewport(),t.setViewport(0,0,n,o),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT)},t.prototype._drawHeatmap=function(t,e,i){t.bindFramebuffer(this._boundFBO),this._boundFBO=null,t.setViewport(this._prevVP.x,this._prevVP.y,this._prevVP.width,this._prevVP.height),this._initialized||(this._initialized=this._initialize(t)),t.setBlendFunctionSeparate(1,771,1,771),t.setBlendingEnabled(!0),t.bindVAO(this._vertexArrayObject),t.bindProgram(this._program),t.bindTexture(this._intensityFBO.colorTexture,2),this._program.setUniform1i("u_texture",2),this._program.setUniform1f("u_opacity",i);var r=e.heatmapParameters;this._updateGradient(t,r),this._program.setUniform2f("u_minmax",r.minPixelIntensity,r.maxPixelIntensity),t.setActiveTexture(5),t.bindTexture(this._gradientTex,5),this._program.setUniform1i("u_gradient",5),t.drawArrays(5,0,4),t.bindVAO()},t.prototype._initialize=function(t){if(this._initialized)return!0;var e={a_pos:0,a_tex:1},i=o.createProgram(t,r.heatmap);if(!i)return!1;var a={geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},s=new Int8Array(16);s[0]=-1,s[1]=-1,s[2]=0,s[3]=0,s[4]=1,s[5]=-1,s[6]=1,s[7]=0,s[8]=-1,s[9]=1,s[10]=0,s[11]=1,s[12]=1,s[13]=1,s[14]=1,s[15]=1;var h=new l(t,e,a,{geometry:n.createVertex(t,35044,s)});return this._program=i,this._vertexArrayObject=h,this._initialized=!0,!0},t.prototype._updateGradient=function(t,e){if(!this._gradientTex||e.color.refreshColorRamp){this._gradientTex&&(this._gradientTex.dispose(),this._gradientTex=null),this._gradientTex=new s(t,{target:3553,internalFormat:6408,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:1,height:d});var i=document.createElement("CANVAS");i.width=1,i.height=d;for(var r=i.getContext("2d"),n=h(e.color),a=r.createLinearGradient(0,0,0,d),o=0;o<n.length;o++){var l=n[o];a.addColorStop(l.ratio,l.color)}r.fillStyle=a,r.fillRect(0,0,1,d),this._gradientTex.setData(i),e.color.refreshColorRamp=!1}},t}();e.default=_});