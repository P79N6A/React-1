// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../arcade/Dictionary","../../../../arcade/Feature","../../../../core/Error","../../../../core/Logger","../../../../core/screenUtils","../../../../support/arcadeUtils","./color","./enums","./SymbolProperties"],function(e,r,t,n,i,a,s,_,o,u,E){function I(e){for(var r={},t=0,n=e;t<n.length;t++){var i=n[t];r[i.name]=i.strideInBytes}return r}function c(e,t,n){switch(void 0===n&&(n=!1),e){case u.WGLGeometryType.MARKER:return t?r.C_ICON_STRIDE_SPEC_VV:n?r.C_ICON_STRIDE_SPEC_HEATMAP:r.C_ICON_STRIDE_SPEC;case u.WGLGeometryType.FILL:return t?r.C_FILL_STRIDE_SPEC_VV:r.C_FILL_STRIDE_SPEC;case u.WGLGeometryType.LINE:return t?r.C_LINE_STRIDE_SPEC_VV:r.C_LINE_STRIDE_SPEC;case u.WGLGeometryType.TEXT:return t?r.C_TEXT_STRIDE_SPEC_VV:r.C_TEXT_STRIDE_SPEC;case u.WGLGeometryType.LABEL:return r.C_LABEL_STRIDE_SPEC}return null}function T(e){switch(e){case u.WGLGeometryType.MARKER:return z;case u.WGLGeometryType.FILL:return k;case u.WGLGeometryType.LINE:return K;case u.WGLGeometryType.TEXT:return H;case u.WGLGeometryType.LABEL:return J}return null}function l(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function C(e,r){switch(r%4){case 0:case 2:return new Uint32Array(Math.floor(e*r/4));case 1:case 3:return new Uint8Array(e*r)}}function V(e,r){switch(r%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function y(e){return f(e)?u.WGLGeometryType.MARKER:B(e)?u.WGLGeometryType.LINE:m(e)?u.WGLGeometryType.FILL:d(e)?u.WGLGeometryType.TEXT:u.WGLGeometryType.UNKNOWN}function p(e){switch(e){case"esriSMS":return"simple-marker";case"esriPMS":return"picture-marker";case"esriSLS":return"simple-line";case"esriPLS":return"picture-line";case"esriSFS":return"simple-fill";case"esriPFS":return"picture-fill";case"esriTS":return"text"}return e}function f(e){var r=p(e.type);if(r){switch(r){case"simple-marker":case"picture-marker":case"CIMPointSymbol":return!0}return!1}}function m(e){var r=p(e.type);if(r){switch(r){case"simple-fill":case"picture-fill":case"CIMPolygonSymbol":return!0}return!1}}function B(e){var r=p(e.type);if(r){switch(r){case"simple-line":case"picture-line":case"CIMLineSymbol":return!0}return!1}}function S(e){var r=p(e.type);if(r){switch(r){case"picture-marker":case"picture-line":case"picture-fill":return!0}return!1}return!1}function d(e){var r=p(e.type);if(r){switch(r){case"text":case"CIMTextSymbol":return!0}return!1}}function L(e){return E.TextProperties.pool.acquire(e.color?o.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?o.copyAndPremultiply(e.haloColor):[255,255,255,255],s.pt2px(e.haloSize),s.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)}function v(e,r){return!1}function O(e){return e&&e.length||0}function R(e,r){if(e.materialKey!==r.materialKey)return!1;if(O(e.texBindingInfo)!==O(r.texBindingInfo))return!1;if(O(e.materialParams)!==O(r.materialParams))return!1;for(var t=e.texBindingInfo.length,n=0;n<t;++n){var i=e.texBindingInfo[n],a=r.texBindingInfo[n];if(i.unit!==a.unit||i.pageId!==a.pageId||i.semantic!==a.semantic)return!1}for(var s=e.materialParams.length,n=0;n<s;++n){var _=e.materialParams[n],o=r.materialParams[n];if(_.name!==o.name||!v(_.value,o.value))return!1}return!0}function h(e,r,t){for(var n=0,i=e.length,a=0;a<i;++a)r&&(r[t+n]=e.charCodeAt(a)),++n;return r&&(r[t+n]=0),++n}function G(e,r,t){var n=0;e.s="";for(var i=!0;i;){var a=r[t+n];++n,0!==a?e.s+=String.fromCharCode(a):i=!1}return n}function g(e){return null!==e&&void 0!==e}function D(e){return"number"==typeof e}function M(e){return"string"==typeof e}function P(e){return null==e||M(e)}function N(e,r,t){return e+(r-e)*t}function F(e){switch(e){case"butt":return u.CapType.BUTT;case"round":return u.CapType.ROUND;case"square":return u.CapType.SQUARE;default:return U.error(new i("mapview-invalid-type","Cap type "+e+" is not a valid option. Defaulting to round")),u.CapType.ROUND}}function A(e){switch(e){case"miter":return u.JoinType.MITER;case"bevel":return u.JoinType.BEVEL;case"round":return u.JoinType.ROUND;default:return U.error(new i("mapview-invalid-type","Join type "+e+" is not a valid option. Defaulting to round")),u.JoinType.ROUND}}function Y(e){switch(e){case"opacity":return u.VVType.OPACITY;case"color":return u.VVType.COLOR;case"rotation":return u.VVType.ROTATION;case"size":return u.VVType.SIZE;default:return U.error("Cannot interpret unknown vv: "+e),null}}function w(e,r){var i=e.valueExpression,a=e.spatialReference,s=e.layer,o=_.createFunction(i),u=new n,E=new t({viewingMode:null,scale:null}),I={},c={vars:{$feature:u,$view:null},spatialReference:a};return function(e,t){u.repurposeFromGraphicLikeObject(e.geometry,e.attributes,s),t?(c.vars.$view=E,E.attributes.viewingMode=t.viewingMode,E.attributes.scale=t.scale):c.vars.$view=I;var n=_.executeFunction(o,c);return r?r(n):n}}function b(e,r,t,n,i,a,s){for(var _ in a)for(var o=a[_].stride,u=l(o),E=a[_].data,I=t[_].data,c=o*i.vertexCount/u,T=o*e/u,C=o*i.vertexFrom/u,V=0;V<c;++V)I[V+T]=E[V+C];for(var y=i.indexCount,V=0;V<y;++V)n[V+r]=s[V+i.indexFrom]-i.vertexFrom+e}function X(e,r){for(var t=[],n=0;n<5;++n){for(var i=T(n),a={},s=0,_=i;s<_.length;s++){var o=_[s];a[o]={data:r(n,o)}}t.push({data:e(n),buffers:a})}return t}function x(e,r,t,n,i,a,s){void 0===s&&(s=!0);for(var _=r/i,o=t/a,u=Math.ceil(_/2),E=Math.ceil(o/2),I=0;I<a;I++)for(var c=0;c<i;c++){for(var T=4*(c+(s?a-I-1:I)*i),l=0,C=0,V=0,y=0,p=0,f=0,m=0,B=(I+.5)*o,S=Math.floor(I*o);S<(I+1)*o;S++)for(var d=Math.abs(B-(S+.5))/E,L=(c+.5)*_,v=d*d,O=Math.floor(c*_);O<(c+1)*_;O++){var R=Math.abs(L-(O+.5))/u,h=Math.sqrt(v+R*R);h>=-1&&h<=1&&(l=2*h*h*h-3*h*h+1)>0&&(R=4*(O+S*r),m+=l*e[R+3],V+=l,e[R+3]<255&&(l=l*e[R+3]/250),y+=l*e[R],p+=l*e[R+1],f+=l*e[R+2],C+=l)}n[T]=y/C,n[T+1]=p/C,n[T+2]=f/C,n[T+3]=m/V}}Object.defineProperty(r,"__esModule",{value:!0});var W,U=a.getLogger("esri.views.2d.engine.webgl.Utils");r.C_HITTEST_SEARCH_SIZE=4,r.C_VBO_GEOMETRY="geometry",r.C_VBO_PERINSTANCE="per_instance",r.C_VBO_PERINSTANCE_VV="per_instance_vv",r.C_VBO_VISIBILITY="visibility",r.C_VBO_VISIBILITY_RANGE="visibilityRange",r.C_ICON_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_ICON_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_ICON_HEATMAP=[{name:r.C_VBO_GEOMETRY,strideInBytes:28,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_FILL_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_FILL_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_LINE_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_LINE_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:44,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_TEXT_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:20,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_TEXT_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:36,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_LABEL_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:20,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0},{name:r.C_VBO_VISIBILITY_RANGE,strideInBytes:2,divisor:0}],r.C_ICON_STRIDE_SPEC=I(r.C_ICON_VERTEX_DEF),r.C_ICON_STRIDE_SPEC_VV=I(r.C_ICON_VERTEX_DEF_VV),r.C_ICON_STRIDE_SPEC_HEATMAP=I(r.C_ICON_HEATMAP),r.C_FILL_STRIDE_SPEC=I(r.C_FILL_VERTEX_DEF),r.C_FILL_STRIDE_SPEC_VV=I(r.C_FILL_VERTEX_DEF_VV),r.C_LINE_STRIDE_SPEC=I(r.C_LINE_VERTEX_DEF),r.C_LINE_STRIDE_SPEC_VV=I(r.C_LINE_VERTEX_DEF_VV),r.C_TEXT_STRIDE_SPEC=I(r.C_TEXT_VERTEX_DEF),r.C_TEXT_STRIDE_SPEC_VV=I(r.C_TEXT_VERTEX_DEF_VV),r.C_LABEL_STRIDE_SPEC=I(r.C_LABEL_VERTEX_DEF),r.getStrides=c;var z=[r.C_VBO_GEOMETRY,r.C_VBO_VISIBILITY],k=[r.C_VBO_GEOMETRY,r.C_VBO_VISIBILITY],K=[r.C_VBO_GEOMETRY,r.C_VBO_VISIBILITY],H=[r.C_VBO_GEOMETRY,r.C_VBO_VISIBILITY],J=[r.C_VBO_GEOMETRY,r.C_VBO_VISIBILITY,r.C_VBO_VISIBILITY_RANGE];r.getNamedBuffers=T,r.strideToPackingFactor=l,r.allocateTypedArrayBuffer=C,r.allocateTypedArrayBufferwithData=V,r.getSymbolGeometryType=y,r.normalizeSymbolType=p,r.isMarkerSymbol=f,r.isFillSymbol=m,r.isLineSymbol=B,r.isPictureSymbol=S,r.isTextSymbol=d,r.getTextProperties=L,r.isSameUniformValue=v,r.isSameMaterialInfo=R,r.serializeString=h,r.deserializeString=G,r.isDefined=g,r.isNumber=D,r.isString=M,r.isStringOrNull=P,r.lerp=N;var q=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(r)},e.prototype.getKeys=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();r.KeysGetter=q;var $=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(e)},e.prototype.getValues=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();r.ValuesGetter=$,r.getCapType=F,r.getJoinType=A,r.getVVType=Y,r.createArcadeFunction=w,r.copyMeshData=b,r.C_VBO_INFO=(W={},W[r.C_VBO_GEOMETRY]=35044,W[r.C_VBO_VISIBILITY]=35044,W[r.C_VBO_VISIBILITY_RANGE]=35048,W),r.createGeometryData=X,r.resampleHermite=x});