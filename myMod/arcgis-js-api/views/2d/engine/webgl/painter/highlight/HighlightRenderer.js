// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../shaders/HighlightPrograms","../../../../../webgl/BufferObject","../../../../../webgl/programUtils","../../../../../webgl/Texture","../../../../../webgl/VertexArrayObject"],function(i,e,t,r,o,s,h){var n=[void 0,void 0,void 0,1],u=[3,4],a=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return function(){function i(){this._width=void 0,this._height=void 0,this._highlightOptions={fillColor:[.2,.6,.9,.75],outlineColor:[.2,.6,.9,.9],outlinePosition:0,outlineWidth:3.4,innerHaloWidth:2,outerHaloWidth:3.3},this._resources=null}return i.prototype.dispose=function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources.shadeTex.dispose(),this._resources=null)},i.prototype.preBlur=function(i,e){i.bindTexture(e,u[0]),i.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",a),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype.finalBlur=function(i,e){i.bindTexture(e,u[0]),i.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",l),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype.renderHighlight=function(i,e){i.bindTexture(e,u[0]),i.bindTexture(this._resources.shadeTex,u[1]),i.bindProgram(this._resources.highlightProgram),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype._initialize=function(i,e,a){this._width=e,this._height=a;var l=new r(i,34962,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),d=new h(i,{a_position:0,a_texcoord:1},{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:l}),g=o.createProgram(i,t.highlight),c=o.createProgram(i,t.blur);g.setUniform1i("u_texture",u[0]),g.setUniform1i("u_shade",u[1]),g.setUniform4fv("u_sigmas",n),c.setUniform1i("u_texture",u[0]),c.setUniform4fv("u_sigmas",n);var f=new s(i,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9728});this._resources={quadGeometry:l,quadVAO:d,highlightProgram:g,blurProgram:c,shadeTex:f}},i.prototype.setHighlightOptions=function(i){function e(i,e,t){g[0]=(1-t)*i[0]+t*e[0],g[1]=(1-t)*i[1]+t*e[1],g[2]=(1-t)*i[2]+t*e[2],g[3]=(1-t)*i[3]+t*e[3]}if(this._highlightOptions=i,this._resources){var t=i.outlinePosition-i.outlineWidth/2-i.outerHaloWidth,r=i.outlinePosition-i.outlineWidth/2,o=i.outlinePosition+i.outlineWidth/2,s=i.outlinePosition+i.outlineWidth/2+i.innerHaloWidth,h=Math.sqrt(Math.PI/2)*n[3],u=Math.abs(t)>h?Math.round(10*(Math.abs(t)-h))/10:0,a=Math.abs(s)>h?Math.round(10*(Math.abs(s)-h))/10:0;u&&!a?console.warn("The outer rim of the highlight is "+u+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!u&&a?console.warn("The inner rim of the highlight is "+a+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):u&&a&&console.warn("The highlight is "+Math.max(u,a)+"px away from the edge of the feature; consider reducing some width values.");for(var l,d=new Uint8Array(1024),g=[void 0,void 0,void 0,void 0],c=0;c<256;++c)l=t+c/255*(s-t),l<t?(d[4*c+0]=0,d[4*c+1]=0,d[4*c+2]=0,d[4*c+3]=0):l<r?e([0,0,0,0],i.outlineColor,(l-t)/(r-t)):l<o?(g[0]=i.outlineColor[0],g[1]=i.outlineColor[1],g[2]=i.outlineColor[2],g[3]=i.outlineColor[3]):l<s?e(i.outlineColor,i.fillColor,(l-o)/(s-o)):(d[4*c+0]=i.fillColor[0],d[4*c+1]=i.fillColor[1],d[4*c+2]=i.fillColor[2],d[4*c+3]=i.fillColor[3]),d[4*c+0]=255*g[0]*g[3],d[4*c+1]=255*g[1]*g[3],d[4*c+2]=255*g[2]*g[3],d[4*c+3]=255*g[3];this._resources.highlightProgram.setUniform2fv("u_minMaxDistance",[t,s]),this._resources.shadeTex.updateData(0,0,0,256,1,d)}},i.prototype.setup=function(i,e,t){this._resources?(this._width=e,this._height=t):(this._initialize(i,e,t),this.setHighlightOptions(this._highlightOptions))},i}()});