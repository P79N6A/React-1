// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../enums","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/BidiText","../../util/vvFlagUtils"],function(e,t,r,i,o,s,n,u,l,a,p,h){function c(e,t){return e.acquire().then(function(){return t()}).then(function(){return e.release()})}Object.defineProperty(t,"__esModule",{value:!0});var m=i.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),f=new Array,_=function(){function e(){this._promise=null,this._resolver=null}return e.prototype.isHeld=function(){return!!this._promise},e.prototype.acquire=function(){var e=this;return this._promise?this._promise.then(function(){return e.acquire()}):(this._promise=o.create(function(t){return e._resolver=t}),o.resolve())},e.prototype.release=function(){var e=this._resolver;this._resolver=null,this._promise=null,e()},e}(),d=function(){function e(e,t){this._idCounter=0,this._templateIdCounter=0,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._pixelRatio=1,this._lock=new _,this._fetchResource=e,this._pixelRatio=t}return e.prototype.createTemplateGroup=function(e,t,r,i){var o=this._hashSymbol(e);if(!this._symbolToTemplate.has(o)){var s=new Array;t&&this._createMeshTemplates(s,r,t,i,this._pixelRatio,!0),this._createMeshTemplates(s,r,e,i,this._pixelRatio,!1);var n=this._createGroupId();this._idToTemplateGroup.set(n,s),this._symbolToTemplate.set(o,n)}return this._symbolToTemplate.get(o)},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):f},e.prototype.finalize=function(){return this._fetchQueue.length||this._lock.isHeld()?c(this._lock,this._fetchAllQueuedResources.bind(this)):o.resolve()},e.prototype._fetchAllQueuedResources=function(){var e=this;if(!this._fetchQueue.length)return o.resolve();var t=this._fetchQueue;return this._fetchQueue=[],this._fetchResource(t).then(function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r],s=o.id,n=o.mosaicItem;e._idToResolver.get(s)(n),e._idToResolver.delete(s)}}).catch(function(i){"cancel"===i.dojoType?e._fetchQueue=e._fetchQueue.concat(t):m.error(new r("mapview-template-store","Unable to fetch requested texture resources",i))})},e.prototype._createGroupId=function(){return this._idCounter++},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._getCodepoints=function(e){for(var t=p.bidiText(e.text)[0],r=[],i=0;i<t.length;i++)r.push(t.charCodeAt(i));return r},e.prototype._getMosaicItem=function(e){var t=this,r=this._createTemplateId(),i="text"===e.type,s=i&&this._getCodepoints(e),n=o.create(function(e){return t._idToResolver.set(r,e)});return this._fetchQueue.push({symbol:e.toJSON(),id:r,glyphIds:s}),n},e.prototype._hashSymbol=function(e){return JSON.stringify(e)},e.prototype._createMeshTemplates=function(e,t,r,i,o,p){if(-1!==r.type.indexOf("3d"))return m.error("3D symbols are not supported with MapView"),e;var c=e.length;switch(e.push(null),r.type){case s.EsriSymbolTypeKebab.SIMPLE_MARKER:return this._getMosaicItem(r).then(function(s){e[c]=l.default.fromSimpleMarker(t,h.getMarkerVVFlags(i),r,s.spriteMosaicItem,o)}),e;case s.EsriSymbolTypeKebab.PICTURE_MARKER:return this._getMosaicItem(r).then(function(s){e[c]=l.default.fromPictureMarker(t,h.getMarkerVVFlags(i),r,s.spriteMosaicItem,o)}),e;case s.EsriSymbolTypeKebab.SIMPLE_FILL:var f=r;return this._getMosaicItem(r).then(function(r){e[c]=n.default.fromSimpleFill(t,h.getFillVVFlags(i),f,r.spriteMosaicItem,o,p)}),f.outline&&(e.push(null),this._getMosaicItem(f.outline).then(function(r){e[c+1]=u.default.fromSimpleLine(t,h.getLineVVFlags(i,!0),f.outline,r.spriteMosaicItem,o)})),e;case s.EsriSymbolTypeKebab.PICTURE_FILL:var _=r;return this._getMosaicItem(_).then(function(r){e[c]=n.default.fromPictureFill(t,h.getFillVVFlags(i),_,r.spriteMosaicItem,o,p)}),_.outline&&(e.push(null),this._getMosaicItem(_.outline).then(function(r){e[c+1]=u.default.fromSimpleLine(t,h.getLineVVFlags(i,!0),_.outline,r.spriteMosaicItem,o)})),e;case s.EsriSymbolTypeKebab.SIMPLE_LINE:return this._getMosaicItem(r).then(function(s){e[c]=u.default.fromSimpleLine(t,h.getLineVVFlags(i,!1),r,s.spriteMosaicItem,o)}),e;case s.EsriSymbolTypeKebab.TEXT:return this._getMosaicItem(r).then(function(s){e[c]=a.default.fromText(t,h.getTextVVFlags(i),r,o,s.glyphMosaicItems)}),e;default:return m.error("Unable to create mesh template for unknown symbol type: "+r.type),e}},e}();t.default=d});