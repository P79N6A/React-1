// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../color","../../definitions","../../enums","../../enums","../../LineTess","../../number","../../TileClipper","../../Utils","../../WGLDisplayRecord","./WGLMeshTemplate"],function(e,t,r,i,o,n,s,a,l,p,u,h,c,d){Object.defineProperty(t,"__esModule",{value:!0});var y=i.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate"),f=l.allocTriangles(20),v=l.allocTriangles(20),g=[l.allocExtrudeVectors(),l.allocExtrudeVectors()],x=l.allocExtrudeVectors(),m=n.TILE_SIZE+8,T=new l.Tessellator({distanceAlongCorrection:!0}),_=new u.TileClipper(0,0,0,1,8);_.setExtent(n.TILE_SIZE);var V=function(e){function t(t,r,i,o,n,a,l,p,u,h,c){var d=e.call(this)||this;d.capType=a,d.joinType=l,d.fillColor=p,d.tl=u,d.br=h,d.hasPattern=c,d.geometryType=s.WGLGeometryType.LINE;var y=1/n;return d.halfWidth=o>0?.5*(o+y):0,d._materialStore=t,d.vvFlags=r,d.materialId=d._materialStore.createSpriteMaterial(i,d.geometryType,r),d}return r(t,e),t.fromSimpleLine=function(e,r,i,n,s){var a=i.color,l=h.getCapType(i.cap||"round"),u=h.getJoinType(i.join||"round"),c=a&&"none"!==i.style&&o.premultiplyAlphaRGBA(a)||0;if("none"===i.style&&(c=0),!n)return new t(e,r,n,i.width,s,l,u,c,0,0,!1);var d=n.rect,y=n.width,f=n.height,v=d.x+1,g=d.y+1,x=d.x+1+y,m=d.y+1+f,T=p.i1616to32(v,g),_=p.i1616to32(x,m);return new t(e,r,n,i.width,s,l,u,c,T,_,!0)},t.fromPictureLineSymbol=function(e,t,r,i){return y.error("PictureLineSymbol support does not exist!"),null},t.prototype.writeMesh=function(e,t,r,i,o,n,s){if(this.vvFlags&a.WGLVVFlag.COLOR||0!==this.fillColor){var l=this._materialStore.get(this.materialId),p=t.indexVector,u=t.get("geometry"),h=t.get("visibility"),d=this.halfWidth,f=new c(i,this.geometryType,this.materialId),v=this._getOffset(u,l);switch(f.vertexFrom=v,f.indexFrom=p.length,e.push(f),r){case"esriGeometryPolyline":var g=o.geometry.paths,x=this._clipLines(g);return void this._write(f,p,u,h,v,i,d,x,l,s);case"esriGeometryPolygon":var m=o.geometry.rings,x=this._clipLines(m);return void this._write(f,p,u,h,v,i,d,x,l,s);default:y.error("Unable to handle geometryType: "+r)}}},t.prototype._clipLines=function(e){for(var t=[],r=!1,i=0;i<e.length;){var o=[],n=e[i];_.reset(2);var s=n[0],a=s[0],l=s[1];if(r)_.moveTo(a,l);else{if(a<-8||a>m||l<-8||l>m){r=!0;continue}o.push({x:a,y:l})}for(var p=!1,u=n.length,h=1;h<u;++h)if(a+=n[h][0],l+=n[h][1],r)_.lineTo(a,l);else{if(a<-8||a>m||l<-8||l>m){p=!0;break}o.push({x:a,y:l})}if(p)r=!0;else{if(r){var c=_.resultWithStarts();if(c)for(var d=0,y=c;d<y.length;d++){var f=y[d];t.push(f)}}else t.push({line:o,start:0});i++,r=!1}}return t},t.prototype._getOffset=function(e,t){var r=t.materialKeyInfo,i=r.hasVV()?11:8;return e.length/i},t.prototype._write=function(e,t,r,i,o,n,s,a,p,u){for(var h=0,c=0,d=a;c<d.length;c++){var y=d[c],v=y.line,m=y.start;if(!(v.length<2))for(var _=v[0],V=v[v.length-1],C=V.x-_.x,b=V.y-_.y,E=C*C+b*b<1e-6,w=m%65535,I=g[1],L=0;L<v.length;L++){var S=v[L],M=I===g[L%2]?g[(L+1)%2]:g[L%2],P=0===L,J=L===v.length-1;if(J&&E&&!this.hasPattern?l.copyExtrudeVectors(M,x):(this._computeExtrudeVectors(M,L,v,E),h+=this._writeVertices(r,i,n,s,S.x,S.y,M,w,h,p,u),!M.capCenter||E&&J||this._writePieIndices(e,t,o,M),E&&P&&!this.hasPattern&&l.copyExtrudeVectors(x,M)),P||this._writeBridgeIndices(e,t,o,I,M),!J){var R=v[L+1],O=[R.x-S.x,R.y-S.y],A=l.length(O),G=[O[0]/A,O[1]/A],W=w+A;if(W>65535){var B=(65535-w)/(W-w),U=S.x+(R.x-S.x)*B,j=S.y+(R.y-S.y)*B,z=I;T.buttCap(z,G,G),h+=this._writeVertices(r,i,n,s,U,j,z,65535,h,p,u),T.bridge(f,M,z),this._writeBridgeIndices(e,t,o,M,z),T.buttCap(z,G,G),w=W-65535}else w=W,I=M}}}e.vertexCount=h},t.prototype._writeVertices=function(e,t,r,i,o,n,s,a,l,u,h){for(var c=0,d=p.i1616to32(o,n),y=s.vectors,f=y.items,v=y.count;c<v;++c){var g=f[c].vector,x=g[0],m=g[1],T=f[c].texCoords,_=T[0],V=T[1],C=f[c].direction,b=C[0],E=C[1],w=p.i1616to32(a,31*i),I=p.i8888to32(Math.round(31*x),Math.round(31*m),Math.round(31*_),Math.round(31*V)),L=p.i8888to32(Math.round(31*b),Math.round(31*E),0,0);e.push(d),e.push(r),e.push(this.fillColor),e.push(I),e.push(w),e.push(this.tl),e.push(this.br),e.push(L),this._writeVV(e,h,u),t.push(255),f[c].base={index:l+c,point:[o,n]}}return c},t.prototype._writeVV=function(e,t,r){r.materialKeyInfo.hasVV()&&(e.push(t[s.VVType.SIZE]),e.push(t[s.VVType.COLOR]),e.push(t[s.VVType.OPACITY]))},t.prototype._writeBridgeIndices=function(e,t,r,i,o){T.bridge(f,i,o);for(var n=0;n<f.count;++n){var s=f.items[n];t.push(r+s.v1.base.index),t.push(r+s.v2.base.index),t.push(r+s.v3.base.index),e.indexCount+=3}},t.prototype._writePieIndices=function(e,t,r,i){T.pie(v,i);for(var o=0;o<v.count;++o){var n=v.items[o];t.push(r+n.v1.base.index),t.push(r+n.v2.base.index),t.push(r+n.v3.base.index),e.indexCount+=3}},t.prototype._computeExtrudeVectors=function(e,t,r,i){var o=r[t],n=[void 0,void 0],s=[void 0,void 0];if(t>0&&t<r.length-1){var a=r[(t+r.length-1)%r.length],p=r[(t+1)%r.length];l.normalize(n,[o.x-a.x,o.y-a.y]),l.normalize(s,[p.x-o.x,p.y-o.y])}else if(0===t){var p=r[(t+1)%r.length];if(l.normalize(s,[p.x-o.x,p.y-o.y]),i){var u=r[r.length-2];l.normalize(n,[o.x-u.x,o.y-u.y])}else n=s}else{if(t!==r.length-1)return void console.error("Vertex index 'i' out of range.");var a=r[(t+r.length-1)%r.length];if(l.normalize(n,[o.x-a.x,o.y-a.y]),i){var h=r[1];l.normalize(s,[h.x-o.x,h.y-o.y])}else s=n}i||0!==t?i||t!==r.length-1?this._computeJoinExtrudeVectors(e,n,s):this._computeCapExtrudeVectors(e,n,s,l.CapPosition.END):this._computeCapExtrudeVectors(e,n,s,l.CapPosition.START)},t.prototype._computeCapExtrudeVectors=function(e,t,r,i){switch(this.capType){case s.CapType.BUTT:return void T.buttCap(e,t,r);case s.CapType.ROUND:var o=l.getNumberOfSlices(Math.PI),n=i===l.CapPosition.START?-1:1;return void T.roundCap(e,t,r,i,o,n);case s.CapType.SQUARE:return void T.squareCap(e,t,r,i);default:return y.error("Encountered unknown cap type: "+this.capType+", defaulting to BUTT"),void T.buttCap(e,t,r)}},t.prototype._computeJoinExtrudeVectors=function(e,t,r){var i=l.getRads(t,r);if(i>Math.PI-.05)T.rectJoin(e,t,r);else if(this.joinType===s.JoinType.MITER||i<.1)i<.05?T.fastMiterJoin(e,t,r):i<l.MITER_SAFE_RADS?T.miterJoin(e,t,r):T.bevelJoin(e,t,r,l.SYSTEM_MAG_LIMIT);else if(this.joinType===s.JoinType.BEVEL)T.bevelJoin(e,t,r,1);else if(this.joinType===s.JoinType.ROUND){var o=l.getNumberOfSlices(i),n=i<2.3;n?o<2||i<.5?T.bevelJoin(e,t,r,1):T.roundJoin(e,t,r,o):T.unitRoundJoin(e,t,r,o)}},t}(d.default);t.default=V});