// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix/mat2d","../../../../../../core/libs/gl-matrix/vec2","../../color","../../definitions","../../enums","../../number","../../WGLDisplayRecord","./WGLMeshTemplate"],function(t,e,r,i,o,s,h,n,p,u,a,l,f){Object.defineProperty(e,"__esModule",{value:!0});var d=i.getLogger("esri.views.2d.engine.webgl.WGLMeshTemplate"),_=128,c=function(t){function e(e,r,i,o,n,p,l,f,d,c,y){var m=t.call(this)||this;m.geometryType=u.WGLGeometryType.MARKER;var g=h.create(),x=s.create(),w=y.sdf?.5:1;if(s.translate(x,x,new Float32Array([w*i,w*-o])),n){s.rotate(x,x,3.14159265359/180*n)}m._materialStore=e,m.vvFlags=r,m._materialId=e.createSpriteMaterial(y,m.geometryType,r),m._fillColor=p,m._outlineColor=d,m._sizeOutlineWidth=a.i8888to32(l,f,c,0);var v=Math.round(y.rect.x/4)-_,M=Math.round(y.rect.y/4)-_,V=v+Math.round(y.rect.width/4),T=M+Math.round(y.rect.height/4);return g.set([-.5*l,-.5*f]),h.transformMat2d(g,g,x),m._offsetAndTexUpperLeft=a.i8888to32(g[0],g[1],v,M),g.set([.5*l,-.5*f]),h.transformMat2d(g,g,x),m._offsetAndTexUpperRight=a.i8888to32(g[0],g[1],V,M),g.set([-.5*l,.5*f]),h.transformMat2d(g,g,x),m._offsetAndTexBottomLeft=a.i8888to32(g[0],g[1],v,T),g.set([.5*l,.5*f]),h.transformMat2d(g,g,x),m._offsetAndTexBottomRight=a.i8888to32(g[0],g[1],V,T),m.height=f,m.width=l,m.xOffset=i,m.yOffset=o,m}return r(e,t),e.fromPictureMarker=function(t,r,i,s,h){var n=Math.round(o.pt2px(i.width)),u=Math.round(o.pt2px(i.height)),a=p.PICTURE_FILL_COLOR;return new e(t,r,Math.round(o.pt2px(i.xoffset||0)),Math.round(o.pt2px(i.yoffset||0)),i.angle,a,n,u,0,0,s)},e.fromSimpleMarker=function(t,r,i,s,h){var p=n.premultiplyAlphaRGBA(i.color),u=Math.round(o.pt2px(i.size)),a=u,l=Math.round(o.pt2px(i.xoffset||0)),f=Math.round(o.pt2px(i.yoffset||0)),d=i.outline,_=0|(d&&d.color&&n.premultiplyAlphaRGBA(d.color)),c=0|(d&&d.width&&Math.round(o.pt2px(d.width)));return new e(t,r,l,f,i.angle,p,u,a,_,c,s)},e.prototype.writeMesh=function(t,e,r,i,o,s,h){var n=this._materialStore.get(this._materialId),p=e.indexVector,u=e.get("geometry"),a=e.get("visibility"),f=new l(i,this.geometryType,this._materialId),_=this._getOffset(u,n);switch(t.push(f),f.vertexFrom=_,f.indexFrom=p.length,r){case"esriGeometryPoint":var c=o.geometry,y=c.x,m=c.y;return this._writeVertices(f,u,a,i,this._getPos(y,m),n,h),void this._writeIndices(f,p,_);case"esriGeometryPolyline":var g=o.geometry.paths;return void this._writeMany(f,p,u,a,_,i,g[0],n,h);case"esriGeometryPolygon":var x=o.centroid;if(x){var y=x.x,m=x.y;this._writeVertices(f,u,a,i,this._getPos(y,m),n,h),this._writeIndices(f,p,_)}else d.error("Tried to render polygon geometries as markers, but found no centroid!");return;case"esriGeometryMultipoint":var w=o.geometry.points;return void this._writeMany(f,p,u,a,_,i,w,n,h);case"esriGeometryEnvelope":default:d.error("Unable to handle geometryType: "+r)}},e.prototype._getPos=function(t,e){return a.i1616to32(t,e)},e.prototype._writeMany=function(t,e,r,i,o,s,h,n,p){for(var u=0,a=0,l=0,f=0,d=h;f<d.length;f++){var _=d[f],c=_[0],y=_[1];this._writeVertices(t,r,i,s,this._getPos(c+u,y+a),n,p),this._writeIndices(t,e,o+l),u+=c,a+=y,l+=4}},e.prototype._getOffset=function(t,e){var r=e.materialKeyInfo,i=r.hasVV()?10:6;return t.length/i},e.prototype._writeVertices=function(t,e,r,i,o,s,h){e.push(o),e.push(this._offsetAndTexUpperLeft),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(255),e.push(o),e.push(this._offsetAndTexUpperRight),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(255),e.push(o),e.push(this._offsetAndTexBottomLeft),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(255),e.push(o),e.push(this._offsetAndTexBottomRight),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(255),t.vertexCount+=4},e.prototype._writeVV=function(t,e,r){r.materialKeyInfo.hasVV()&&(t.push(e[u.VVType.SIZE]),t.push(e[u.VVType.COLOR]),t.push(e[u.VVType.OPACITY]),t.push(e[u.VVType.ROTATION]))},e.prototype._writeIndices=function(t,e,r){var i=r;e.push(i+0),e.push(i+1),e.push(i+2),e.push(i+1),e.push(i+3),e.push(i+2),t.indexCount+=6},e}(f.default);e.default=c});