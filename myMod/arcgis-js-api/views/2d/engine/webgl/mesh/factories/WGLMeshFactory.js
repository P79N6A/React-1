// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../symbols/SimpleLineSymbol","../../definitions","../../enums","../../WGLDisplayObject","../MeshData","../VertexVector","./VVFactory","../templates/WGLLabelTemplate","../templates/WGLLineTemplate","../templates/WGLMarkerTemplate","../../util/vvFlagUtils"],function(e,t,r,a,l,i,o,n,s,p,h,u,y,m,g,c){Object.defineProperty(t,"__esModule",{value:!0});var f=l.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),b={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:null,esriGeometryMultipoint:null,esriGeometryEnvelope:null},_=function(){function e(e,t,r,l,i,o,n,s,p){var h=this;this._labelsDebugTemplate=null,this._materials=n,this._geometryType=e,this._idField=t,this._pixelRatio=i,this._vvFlags=c.getVVFlags(l),this._vvFactory=new u.default(l,r,o),this._vvBuf=new ArrayBuffer(16),this._vvBufU32=new Uint32Array(this._vvBuf),this._vvBufF32=new Float32Array(this._vvBuf),this._templateStore=s,p&&(this._validateLabelingInfo(p)?this._labelTemplates=p.map(function(e){return y.default.fromText(h._materials,0,e.symbol,i,e.labelPlacement)}):f.error(new a("mapview-labeling:unsupported-geometry","LabelingInfo failed validation - unable to create labels for layer.")))}return Object.defineProperty(e.prototype,"materials",{get:function(){return this._materials},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0}),e.prototype.createMeshData=function(e){var t=new Array(5),r=new Array,a=!!c.getMarkerVVFlags(this._vvFlags),l=!!c.getFillVVFlags(this._vvFlags),i=!!c.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),o=!!c.getTextVVFlags(this._vvFlags);return t[n.WGLGeometryType.MARKER]=new h.VertexVectors(n.WGLGeometryType.MARKER,a,e),t[n.WGLGeometryType.FILL]=new h.VertexVectors(n.WGLGeometryType.FILL,l,e),t[n.WGLGeometryType.LINE]=new h.VertexVectors(n.WGLGeometryType.LINE,i,e),t[n.WGLGeometryType.TEXT]=new h.VertexVectors(n.WGLGeometryType.TEXT,o,e),t[n.WGLGeometryType.LABEL]=new h.VertexVectors(n.WGLGeometryType.LABEL,!1,this._labelTemplates&&this._labelTemplates.length>0?e:0),new p.default(r,t,this._materials)},e.prototype.analyze=function(e,t,r){for(var a=e,l=0,i=a;l<i.length;l++){var o=i[l],n=-1;t&&(n=t.match(o,r)),o.groupId=n}return this._templateStore.finalize().then(function(){return a})},e.prototype.write=function(e,t,r,a,l){var i=this._templateStore.getTemplateGroup(t.groupId),o=e,n=t.attributes[this._idField],p=new s(n),h=!!a&&!!this._labelTemplates&&a.has(n);if(i&&(t.geometry||t.centroid)){this._vvFactory.computeVV(this._vvBufF32,t,r);for(var u=p.displayRecords,y=0,m=i;y<m.length;y++){var g=m[y],c=o.get(g.geometryType);g.writeMesh(u,c,this._geometryType,n,t,this._pixelRatio,this._vvBufU32)}if(h){var f=this._getLabelReference(i);this._writeLabelMesh(p,o,n,t,l,a.get(n),f)}o.pushDisplayObject(p)}},e.prototype._hasBadLabelClass=function(e,t){var r=e.labelPlacement,l=b[t];if(!l)return f.error(new a("mapview-labeling:unsupported-geometry-type","Unable to create labels for WebGL Feature Layer, "+t+" is not supported")),!0;if(!l.some(function(e){return e===r})){var i=l[0];r&&f.warn("Found invalid label placement type "+r+" for "+t+". Defaulting to "+i),e.labelPlacement=i}return!1},e.prototype._validateLabelingInfo=function(e){var t=this;return!e.some(function(e){return t._hasBadLabelClass(e,t._geometryType)})},e.prototype._getLabelReference=function(e){for(var t=0,r=e;t<r.length;t++){var a=r[t];if(a instanceof g.default)return a}return null},e.prototype._writeLabelMesh=function(e,t,r,a,l,i,n){for(var s=e.displayRecords,p=0,h=0,u=-1,y=-1,m=0;m<i.labelingInfo.length;m++){var g=i.labelingInfo[m],c=i.text[m],f=this._labelTemplates[g],b=t.get(f.geometryType),_=l.get(f.symbolId).glyphMosaicItems,v=s.length;f.bindReferenceTemplate(n);var L=f.computeAnchor(this._geometryType,a);0===m&&(u=Math.floor(L[0]/o.COLLISION_BUCKET_SIZE),y=Math.floor(L[1]/o.COLLISION_BUCKET_SIZE));if(!f.computeGlyphs(_,c)){var T=f.bounds;f.writeMesh(s,b,this._geometryType,r,a,this._pixelRatio,this._vvBufU32),e.anchor=L,e.addMetric(T,v,s.length-v,g);var d=T.center;p=Math.max(T.halfWidth+Math.abs(d[0]),p),h=Math.max(T.halfHeight+Math.abs(d[1]),h)}}if(e.metrics.length){var w=2.5*Math.max(p,h),G=e.anchor[0]%o.COLLISION_BUCKET_SIZE,I=e.anchor[1]%o.COLLISION_BUCKET_SIZE,M=w-G,V=w-I,F=Math.ceil(Math.abs(M/o.COLLISION_BUCKET_SIZE)),E=Math.ceil(Math.abs(V/o.COLLISION_BUCKET_SIZE));e.xBucket=u,e.yBucket=y,e.xOverflow=F,e.yOverflow=E}},e.prototype._debugLabels=function(e,t,r,a,l){var i=a[0]+l.center[0],o=a[1]+l.center[1],n=[i-l.width/2,o+l.height/2],s=[0,-l.height],p=[l.width,0],h=[0,l.height],u=[-l.width,0],y={geometry:{paths:[[n,s,p,h,u]]},attributes:{}},m=this._getLabelDebugTemplate(),g=t.get(m.geometryType);m.writeMesh(e,g,"esriGeometryPolyline",r,y,this._pixelRatio,null)},e.prototype._getLabelDebugTemplate=function(){return this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate()),this._labelsDebugTemplate},e.prototype._createLabelsDebugTemplate=function(){var e=new i({style:"solid",width:1,color:[255,0,0,1]});return m.default.fromSimpleLine(this._materials,0,e,null,this._pixelRatio)},e}();t.default=_});