// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","@dojo/framework/shim/array","@dojo/framework/shim/Map","../../../../Color","../../../../request","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../geometry/Polygon","../../../../symbols/SimpleMarkerSymbol","../../../../symbols/support/gfxUtils","../../libs/gl-matrix/mat2d","../../libs/gl-matrix/mat2dExtras"],function(e,t,r,n,o,a,i,l,s,c,u,p,f,h,g){function v(e){return"simple-marker"===e.type}function y(e){return"picture-marker"===e.type}function d(e){return"simple-line"===e.type}function S(e){return"picture-fill"===e.type}function m(e){return"text"===e.type}function x(e){return"extent"===e.type}function b(e){return"polygon"===e.type}function k(e){return"polyline"===e.type}function T(e,t){return t?(t.toRgba?(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e):null}function w(e,t,r){return null!=r&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r),e}function M(e,t,r){var n=t[0]/t[1];return e[0]=e[1]=1,isNaN(r)||(n>1?(e[0]=r/t[0],e[1]=r/n/t[1]):(e[1]=r/t[1],e[0]=r*n/t[0])),e}function A(e,t,r,n,o,a,u){var d,S,x=o.symbol,b=e.toScreenPoint(D,r,u[0]),k=[b.x,b.y],T=b.x,w=b.y,A=o.heading,E=o.size&&o.size[0];h.identity(G),"number"==typeof E&&(d=isFinite(E)&&E);var L=d&&isFinite(d)&&!isNaN(d);d=L?s.pt2px(d):NaN,a&&g.rotategAt(G,G,a,k),A&&g.rotategAt(G,G,A,k);var N,Y=s.pt2px(x.xoffset),F=s.pt2px(x.yoffset);0===Y&&0===F||(N=[Y,-F]);var O=null;0!==x.angle&&(O=h.create(),g.rotategAt(O,O,x.angle,k));var C;if(v(x)){var z=x.style,I=Math.round;d=L?d:s.pt2px(x.size);var V=void 0,q=void 0;switch(z){case p.STYLE_SQUARE:case p.STYLE_CROSS:case p.STYLE_X:case p.STYLE_DIAMOND:V=isNaN(d)?16:.5*d,q=U(t,n,j(z,T,w,I(T-V),I(T+V),I(w-V),I(w+V)));break;case p.STYLE_PATH:var X=U(t,n,x.path);q=X;var H=X.getBoundingBox(),Q=M(h.create(),[H.width,H.height],d);1===Q[0]&&1===Q[3]||g.scaleAt(G,G,Q,k),C=[-(H.x+.5*H.width)+T,-(H.y+.5*H.height)+w];break;default:V=isNaN(d)?16:.5*d,q=P(t,n,{cx:T,cy:w,r:V})}S=l.resolve(q)}else if(y(x)){var Z=null,W=null,J=s.pt2px(x.width),K=s.pt2px(x.height);L?(W=d,Z=W*(J/K)):(Z=J,W=K),N&&(null!=N[0]&&(N[0]=Z*(N[0]/J)),null!=N[1]&&(N[1]=W*(N[1]/K)));var $=x.url,ee=void 0;ee=c.isDataProtocol($)?l.resolve($):c.isBlobProtocol($)?l.resolve(URL.createObjectURL($)):B.has($)?l.resolve(B.get($)):i($,{responseType:"blob"}).then(function(e){if(B.has($))return B.get($);var t=URL.createObjectURL(e.data);return B.set($,t),t}).catch(function(e){if("cancel"!==e.dojoType)return $;l.reject(e)}),S=ee.then(function(e){var r=R(t,n,{x:T-.5*Z,y:w-.5*W,width:Z,height:W,src:e}),a=r.getNode();return a&&(null!=o.opacity?a.setAttribute("opacity",o.opacity.toString()):a.setAttribute("opacity","1")),r})}else if(m(x)){var te=x.font&&x.font.clone();te&&(te.size=L?d:s.pt2px(te.size));var q=_(t,n,{type:"text",text:x.text,x:T,y:w,align:f.getSVGAlign(x),decoration:x.decoration||te&&te.decoration,rotated:x.rotated,kerning:x.kerning});te&&q.setFont(te);var re=q.getNode(),ne=f.getSVGBaseline(x),oe=f.getSVGBaselineShift(x);re&&(re.setAttribute("dominant-baseline",ne),oe&&re.setAttribute("baseline-shift",oe)),S=l.resolve(q)}return S.then(function(e){return N&&h.translate(G,G,N),O&&h.multiply(G,G,O),C&&h.translate(G,G,C),e.setTransform(G),e})}function E(e,t,r,n,o,a,i,s){var c=o.symbol,u=r.points,p=n||t.createGroup(),f=[0];p.children[0]&&Y(c,p.children[0])&&p.clear();for(var h=0,g=[],v=u.length,y=0;y<v;y++)for(var d=u[y],S=i.length,m=0;m<S;m++)f[0]=i[m],g.push(A(e,p,{x:d[0],y:d[1]},p.children[h++],o,a,f));return l.all(g).then(function(e){e.forEach(function(e){e.getNode().gfxObject=s,p.add(e)});var t=p.children.length;if(u.length*i.length<t)for(var r=u.length*i.length,n=t-1;n>=r;n--)p.children[n].removeShape();return p})}function L(e,t,r,n,o){var a=[];if(x(r)&&(r=u.fromExtent(r)),k(r)||b(r)){for(var i=o.length,s=0;s<i;s++)a=a.concat(e.toScreenPath(r,o[s]));n=U(t,n,a)}return l.resolve(n)}function N(e,t,r){return t?t.setShape(r):e.createRect(r)}function R(e,t,r){return t?t.setShape(r):e.createImage(r)}function P(e,t,r){return t?t.setShape(r):e.createCircle(r)}function U(e,t,r){var n=Array.isArray(r)?r.join(" "):r;return t?t.setShape(n):e.createPath(n)}function _(e,t,r){return t?t.setShape(r):e.createText(r)}function Y(e,t){var r=t&&t.shape&&t.shape.type,n=e&&e.type,o=e&&e.style;return n&&(o=I[n]||o),V[o]&&(o="path"),!(!r||!o||r===o)}function j(e,t,r,n,o,a,i,l){switch(e){case p.STYLE_SQUARE:return["M",n+","+a,o+","+a,o+","+i,n+","+i,"Z"];case p.STYLE_CROSS:return["M",t+","+a,t+","+i,"M",n+","+r,o+","+r];case p.STYLE_X:return["M",n+","+a,o+","+i,"M",n+","+i,o+","+a];case p.STYLE_DIAMOND:return["M",t+","+a,o+","+r,t+","+i,n+","+r,"Z"];case p.STYLE_TARGET:return["M",n+","+a,o+","+a,o+","+i,n+","+i,n+","+a,"M",n-l+","+r,n+","+r,"M",t+","+(a-l),t+","+a,"M",o+l+","+r,o+","+r,"M",t+","+(i+l),t+","+i]}}function F(e,t){var n=t.symbol;if(!y(n)){var o=f.getFill(n);if(v(n)){var a=n.style,i=f.getStroke(n),l=i&&i.color,s=a===p.STYLE_X||a===p.STYLE_CROSS,c=t.opacity,u=t.color||T([0,0,0,0],s?l:o);u&&null!=c&&(u=w([0,0,0,0],u,c)),u&&(s?u!==l&&(i=r({},i),i.color=u):u!==o&&(o=u)),e.setFill(o).setStroke(i)}else if(m(n)){var c=t.opacity,u=t.color||T([0,0,0,0],o);u&&null!=c&&(u=w([0,0,0,0],u,c)),u&&u!==o&&(o=u),e.setFill(o)}}}function O(e,t){for(var r=e.children,n=r.length,o=0;o<n;o++)F(e.children[o],t)}function C(e,t){var n,o=t.symbol,i=t.size,l=t.color,c=t.opacity,u=t.outlineSize,p=f.getStroke(o),h=f.getFill(o),g=!1;d(o)?(g=!0,n="none"!==o.style):n=o.outline&&"none"!==o.outline.style;var v,y,m;if(null!=i||null!=u){var x=i&&isFinite(i[0])&&i[0],b=g?null:u;null==x&&null==b||(m=s.pt2px(b||x))}var k=S(o);!l&&null==c||k||(g?(v=l||p&&p.color&&T([0,0,0,0],p.color))&&null!=c&&(v=w(v,v,c)):h&&(y=l||T([0,0,0,0],h))&&null!=c&&(y=w(y,y,c))),!n||null==m&&!v?e.setStroke(p):e.setStroke(r({},p,null!=m?{width:m}:null,v&&{color:v}));var M=h,A=l&&new a(l)||o.color;M&&"pattern"===M.type&&A&&!k?f.getPatternUrlWithColor(M.src,A.toCss(!0)).then(function(t){M.src=t,e.setFill(M)}):e.setFill(y||h),e.rawNode.setAttribute("vector-effect","non-scaling-stroke")}function z(e){if(e&&c.isBlobProtocol(e)){for(var t=0,r=n.from(B);t<r.length;t++){var o=r[t],a=o[0];if(o[1]===e){B.delete(a);break}}URL.revokeObjectURL(e)}}Object.defineProperty(t,"__esModule",{value:!0});var B=new o.default;t.getScalingVector=M;var D={x:0,y:0},G=h.create();t.drawPoint=A,t.drawMarkers=E,t.drawShape=L,t.drawRect=N,t.drawImage=R,t.drawCircle=P,t.drawPath=U,t.drawText=_;var I={"picture-marker":"image","picture-fill":"path","simple-fill":"path","simple-line":"path",text:"text"},V={square:1,cross:1,x:1,diamond:1,target:1};t.isShapeInvalid=Y,t.smsToPath=j,t.stylePoint=F,t.styleMarkers=O,t.styleShape=C,t.revokeBlobUrl=z});