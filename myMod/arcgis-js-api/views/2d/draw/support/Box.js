// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../geometry","../../../../Graphic","../../../../core/Accessor","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/geometryEngine","../../../../geometry/support/boundsUtils","../../../../geometry/support/coordsUtils","../../../../symbols/SimpleFillSymbol","../../../../symbols/SimpleLineSymbol","../../../../symbols/SimpleMarkerSymbol","./drawUtils","./GraphicMover"],function(t,e,i,r,a,h,o,s,n,c,p,l,y,u,G,d,g,_){var v=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.dx=i,this.dy=r,this.type="move-start"}return t}(),m=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.dx=i,this.dy=r,this.type="move"}return t}(),f=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.dx=i,this.dy=r,this.type="move-stop"}return t}(),b=function(){function t(t,e,i){this.graphic=t,this.targetGraphic=e,this.angle=i,this.type="rotate-start"}return t}(),w=function(){function t(t,e,i){this.graphic=t,this.targetGraphic=e,this.angle=i,this.type="rotate"}return t}(),S=function(){function t(t,e,i){this.graphic=t,this.targetGraphic=e,this.angle=i,this.type="rotate-stop"}return t}(),x=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.xScale=i,this.yScale=r,this.type="scale-start"}return t}(),k=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.xScale=i,this.yScale=r,this.type="scale"}return t}(),R=function(){function t(t,e,i,r){this.graphic=t,this.targetGraphic=e,this.xScale=i,this.yScale=r,this.type="scale-stop"}return t}();return function(t){function e(e){var i=t.call(this,e)||this;return i._centerGraphicSymbol=new d({type:"simple-marker",style:"circle",size:4,color:[255,255,255,1],outline:{color:[0,12,207],width:1}}),i._defaultFillSymbol=new u({type:"simple-fill",color:[12,207,255,.075],outline:{join:"round",color:[0,12,207],width:2}}),i._dashedFillSymbol=new u({type:"simple-fill",color:[0,0,0,0],outline:{style:"dash",color:[150,150,150,.5],width:2}}),i._defaultGraphicSymbol=new d({type:"simple-marker",style:"square",size:8,color:[255,255,255,1],outline:{color:[0,12,207],width:1}}),i._handles=new s,i._initialGeometry=null,i._initialBoxGeometry=null,i._initialRotateGeometry=null,i._mover=null,i._activeHandleGraphic=null,i._rotateGraphicOffset=20,i._rotateGraphicHoverSymbol=new d({type:"simple-marker",style:"circle",size:10,color:[255,255,255,1],outline:{color:[0,12,207],width:1}}),i._rotateGraphicSymbol=new d({type:"simple-marker",style:"circle",size:8,color:[255,255,255,1],outline:{color:[0,12,207],width:1}}),i._rotationAngle=0,i._rotateLineGraphic=null,i._rotateLineGraphicSymbol=new G({color:[0,12,207],width:2}),i._startBox=null,i._totalDx=0,i._totalDy=0,i._xScale=1,i._yScale=1,i.callbacks={onMoveStart:function(t){},onMove:function(t){},onMoveStop:function(t){},onScaleStart:function(t){},onScale:function(t){},onScaleStop:function(t){},onRotateStart:function(t){},onRotate:function(t){},onRotateStop:function(t){}},i.centerGraphic=null,i.backgroundGraphic=null,i.enableMovement=!0,i.enableRotation=!0,i.enableScaling=!0,i.graphic=null,i.handleGraphics=[],i.layer=null,i.rotateGraphic=null,i.showCenterGraphic=!0,i.uniformScaling=!1,i.view=null,i}return i(e,t),e.prototype.initialize=function(){var t=this;this.graphic&&this.layer&&(this._setUpGraphics(),this._setUpMover(),this._updateGraphics()),this._handles.add([n.whenOnce(this,"view.ready",function(){t.view&&t.view.map&&t.view.map.add(t.layer)}),n.pausable(this,"uniformScaling",function(){t._activeHandleGraphic&&(t._scaleGraphic(t._activeHandleGraphic),t._updateGraphics())}),n.pausable(this,"view.scale",function(){t._updateRotateGraphic(),t._updateRotateLineGraphic()}),n.pausable(this,"graphic",function(){t.refresh()}),n.pausable(this,"layer",function(e,i){i&&t._cleanUpGraphics(i),t.refresh()})])},e.prototype.destroy=function(){this._reset(),this._handles.removeAll(),this._handles=null},Object.defineProperty(e.prototype,"graphics",{get:function(){var t=[];return this.handleGraphics.length&&(t=t.concat(this.handleGraphics)),this.graphic&&t.push(this.graphic),this.backgroundGraphic&&t.push(this.backgroundGraphic),this.centerGraphic&&t.push(this.centerGraphic),this.rotateGraphic&&t.push(this.rotateGraphic),this._rotateLineGraphic&&t.push(this._rotateLineGraphic),t},enumerable:!0,configurable:!0}),e.prototype.move=function(t,e){if(this._mover&&this.graphic){var i=this.graphic.geometry,r=g.move(i,t,e,this.view);this.graphic.geometry=r,this.refresh()}},e.prototype.scale=function(t,e){if(this._mover&&this.graphic){var i=this.graphic.geometry,r=g.scale(i,t,e,this.view);this.graphic.geometry=r,this.refresh()}},e.prototype.rotate=function(t,e){if(this._mover&&this.graphic){if(!e){var i=this.handleGraphics[1].geometry.x,r=this.handleGraphics[3].geometry.y;e=new a.Point(i,r,this.view.spatialReference)}var h=this.graphic.geometry,o=p.rotate(h,t,e);this.graphic.geometry=o,this.refresh()}},e.prototype.refresh=function(){this._reset(),this.graphic&&this.layer&&(this._setUpGraphics(),this._setUpMover(),this._updateGraphics())},e.prototype._reset=function(){this._resetGraphicStateVars(),this._cleanUpGraphics(),this._mover&&this._mover.destroy(),this._mover=null,this.view.container.style.cursor="default"},e.prototype._resetGraphicStateVars=function(){this._startBox=null,this._activeHandleGraphic=null,this._initialGeometry=null,this._initialBoxGeometry=null,this._initialRotateGeometry=null,this._totalDx=0,this._totalDy=0,this._xScale=1,this._yScale=1,this._rotationAngle=0},e.prototype._cleanUpGraphics=function(t){var e=t||this.layer;e&&e.removeMany(this.handleGraphics),e&&e.remove(this.backgroundGraphic),e&&e.remove(this.centerGraphic),e&&e.remove(this.rotateGraphic),e&&e.remove(this._rotateLineGraphic),this.handleGraphics.forEach(function(t){return t.destroy()}),this._set("handleGraphics",[]),this.backgroundGraphic&&(this.backgroundGraphic.destroy(),this._set("backgroundGraphic",null)),this.centerGraphic&&(this.centerGraphic.destroy(),this._set("centerGraphic",null)),this.rotateGraphic&&(this.rotateGraphic.destroy(),this._set("rotateGraphic",null)),this._rotateLineGraphic&&(this._rotateLineGraphic.destroy(),this._rotateLineGraphic=null)},e.prototype._setUpMover=function(){var t=this,e=this.handleGraphics;this.enableMovement&&(e=e.concat(this.graphic,this.backgroundGraphic)),this.enableRotation&&(e=e.concat(this.rotateGraphic)),this.showCenterGraphic&&e.push(this.centerGraphic),this._mover=new _({view:this.view,graphics:e,callbacks:{onGraphicMoveStart:function(e){return t._onGraphicMoveStartCallback(e)},onGraphicMove:function(e){return t._onGraphicMoveCallback(e)},onGraphicMoveStop:function(e){return t._onGraphicMoveStopCallback(e)},onGraphicPointerOver:function(e){return t._onGraphicPointerOverCallback(e)},onGraphicPointerOut:function(e){return t._onGraphicPointerOutCallback(e)}}})},e.prototype._onGraphicMoveStartCallback=function(t){var e=t.graphic,i=this.graphic.geometry,r=this.backgroundGraphic.geometry;this._resetGraphicStateVars(),this.rotateGraphic.visible=!1,this._rotateLineGraphic.visible=!1,this.handleGraphics.forEach(function(t){t.visible=!1});var a=e.geometry,h=l.getRingsOrPathsBounds(r.rings),o=h[0],s=h[1],n=h[2],c=h[3],p=Math.abs(n-o),y=Math.abs(c-s),u=(n+o)/2,G=(c+s)/2,d=t.dx,g=t.dy;this._startBox={width:p,height:y,centerX:u,centerY:G,startX:a.x,startY:a.y},this._initialGeometry=i,this._initialBoxGeometry=r,this._initialRotateGeometry=this.rotateGraphic.geometry,e===this.rotateGraphic?(this.backgroundGraphic.symbol=this._dashedFillSymbol,this.rotateGraphic.symbol=this._rotateGraphicHoverSymbol,this.callbacks.onRotateStart(new b(this.graphic,e,0))):this.handleGraphics.indexOf(e)>-1?(this._activeHandleGraphic=e,this.callbacks.onScaleStart(new x(this.graphic,e,1,1))):(this.centerGraphic.visible=!1,this.callbacks.onMoveStart(new v(this.graphic,e,d,g)))},e.prototype._onGraphicMoveCallback=function(t){var e=t.graphic;if(this.handleGraphics.indexOf(e)>-1)this._scaleGraphic(e),this._updateBackgroundGraphic(),this._updateCenterGraphic(),this.callbacks.onScale(new k(this.graphic,e,this._xScale,this._yScale));else if(e===this.rotateGraphic){var i=new a.Point(this._startBox.startX,this._startBox.startY,this.view.spatialReference),r=new a.Point(this._startBox.centerX,this._startBox.centerY,this.view.spatialReference),h=this._getAngle(r,i,e.geometry),o=p.rotate(this._initialGeometry,h,r),s=p.rotate(this._initialBoxGeometry,h,r),n=p.rotate(this._initialRotateGeometry,h,r);this.graphic.geometry=o,this.backgroundGraphic.geometry=s,this.rotateGraphic.geometry=n,this._rotationAngle=h,this.callbacks.onRotate(new w(this.graphic,e,h))}else{var c=t.dx,l=t.dy;if(this._totalDx+=c,this._totalDy+=l,e===this.graphic||e===this.centerGraphic){var y=this.backgroundGraphic.geometry;this.backgroundGraphic.geometry=g.move(y,c,l,this.view)}if(e===this.backgroundGraphic||e===this.centerGraphic){var u=this.graphic.geometry;this.graphic.geometry=g.move(u,c,l,this.view)}this.callbacks.onMove(new m(this.graphic,e,c,l))}},e.prototype._onGraphicMoveStopCallback=function(t){var e=t.graphic;this._updateGraphics(),this.enableRotation&&(this._rotateLineGraphic.visible=!0,this.rotateGraphic.visible=!0),this.showCenterGraphic&&(this.centerGraphic.visible=!0),this.enableScaling&&this.handleGraphics.forEach(function(t){t.visible=!0}),e===this.rotateGraphic?(this.rotateGraphic.symbol=this._rotateGraphicSymbol,this.backgroundGraphic.symbol=this._defaultFillSymbol,this.callbacks.onRotateStop(new S(this.graphic,e,this._rotationAngle))):this.handleGraphics.indexOf(e)>-1?this.callbacks.onScaleStop(new R(this.graphic,e,this._xScale,this._yScale)):this.callbacks.onMoveStop(new f(this.graphic,e,this._totalDx,this._totalDy)),this._resetGraphicStateVars()},e.prototype._onGraphicPointerOverCallback=function(t){var e,i=this.view.rotation,r=t.index;switch(t.graphic===this.rotateGraphic&&(this.rotateGraphic.symbol=this._rotateGraphicHoverSymbol),r<8&&(i>=0&&i<45?r%=8:r=i>=45&&i<90?(r+1)%8:i>=90&&i<135?(r+2)%8:i>=135&&i<180?(r+3)%8:i>=180&&i<225?(r+4)%8:i>=225&&i<270?(r+5)%8:i>=270&&i<315?(r+6)%8:(r+7)%8),r){case 0:e="nwse-resize";break;case 1:e="ns-resize";break;case 2:e="nesw-resize";break;case 3:e="ew-resize";break;case 4:e="nwse-resize";break;case 5:e="ns-resize";break;case 6:e="nesw-resize";break;case 7:e="ew-resize";break;default:e="pointer"}this.view.container.style.cursor=e},e.prototype._onGraphicPointerOutCallback=function(t){t.graphic===this.rotateGraphic&&(this.rotateGraphic.symbol=this._rotateGraphicSymbol),"default"!==this.view.container.style.cursor&&(this.view.container.style.cursor="default")},e.prototype._getBoxCoordinates=function(t){var e=new a.Point(t.xmin,t.ymax,this.view.spatialReference),i=new a.Point(t.xmax,t.ymin,this.view.spatialReference),r=(e.x+i.x)/2,h=(e.y+i.y)/2;return[[e.x,e.y],[r,e.y],[i.x,e.y],[i.x,h],[i.x,i.y],[r,i.y],[e.x,i.y],[e.x,h]]},e.prototype._scaleGraphic=function(t){var e=this.handleGraphics.indexOf(t),i=this._startBox,r=i.centerX,a=i.centerY,h=i.startX,o=i.startY;1!==e&&5!==e||this._updateX(t,r),3!==e&&7!==e||this._updateY(t,a);var s=t.geometry,n=this.view.toScreen(s),c=n.x,p=n.y;if(this.uniformScaling){var l=this.view.toScreen(r,a),y=l.x,u=l.y,G=this.view.toScreen(h,o),d=G.x,_=G.y;this._xScale=this._yScale=this._getScaleRatio(y,u,c,p,d,_),this.graphic.geometry=g.scale(this._initialGeometry,this._xScale,this._yScale,this.view)}else{var v=this._startBox,m=v.width,f=v.height,b=h>r,w=o<a,S=s.x-h,x=o-s.y;if(1===e||5===e?S=0:3!==e&&7!==e||(x=0),0===S&&0===x)return;var k=b?S:-1*S,R=w?x:-1*x,M=m+k,P=f+R,B=r+S/2,C=a+x/2;this._xScale=M/m||1,this._yScale=P/f||1,1===e||5===e?this._xScale=1:3!==e&&7!==e||(this._yScale=1);var O=g.scale(this._initialGeometry,this._xScale,this._yScale,this.view),L=(B-r)/this.view.state.resolution,z=(C-a)/this.view.state.resolution;this.graphic.geometry=g.move(O,L,z,this.view,!0)}},e.prototype._setUpGraphics=function(){this._set("centerGraphic",new h(null,this._centerGraphicSymbol)),this.showCenterGraphic&&this.layer.add(this.centerGraphic),this._set("backgroundGraphic",new h(null,this._defaultFillSymbol)),this.layer.add(this.backgroundGraphic),this._rotateLineGraphic=new h(null,this._rotateLineGraphicSymbol),this.enableRotation&&this.layer.add(this._rotateLineGraphic),this._set("rotateGraphic",new h(null,this._rotateGraphicSymbol)),this.enableRotation&&this.layer.add(this.rotateGraphic);for(var t=0;t<8;t++)this.handleGraphics.push(new h(null,this._defaultGraphicSymbol));this.enableScaling&&this.layer.addMany(this.handleGraphics)},e.prototype._updateGraphics=function(){this._updateBackgroundGraphic(),this._updateHandleGraphics(),this._updateCenterGraphic(),this._updateRotateGraphic(),this._updateRotateLineGraphic()},e.prototype._updateHandleGraphics=function(){var t=this;if(this.graphic&&this.graphic.geometry){var e=y.geometryToCoordinates(this.graphic.geometry),i=l.getRingsOrPathsBounds(e),r=i[0],a=i[1],h=i[2],o=i[3],s=this._getBoxCoordinates({xmin:r,ymin:a,xmax:h,ymax:o});this.handleGraphics.forEach(function(e,i){var r=s[i],a=r[0],h=r[1];t._updateXY(e,a,h)})}},e.prototype._updateBackgroundGraphic=function(){if(this.graphic&&this.graphic.geometry){var t=y.geometryToCoordinates(this.graphic.geometry),e=l.getRingsOrPathsBounds(t),i=e[0],r=e[1],h=e[2],o=e[3],s=this._getBoxCoordinates({xmin:i,ymin:r,xmax:h,ymax:o});this.backgroundGraphic.geometry=new a.Polygon({rings:s,spatialReference:this.view.spatialReference})}},e.prototype._updateCenterGraphic=function(){if(this.graphic&&this.graphic.geometry){var t=y.geometryToCoordinates(this.graphic.geometry),e=l.getRingsOrPathsBounds(t),i=e[0],r=e[1],h=e[2],o=e[3],s=(h+i)/2,n=(o+r)/2;this.centerGraphic.geometry=new a.Point(s,n,this.view.spatialReference)}},e.prototype._updateRotateGraphic=function(){if(this.handleGraphics.length){var t=this.handleGraphics[1].geometry,e=t.x,i=t.y,r=i+this.view.state.resolution*this._rotateGraphicOffset;this.rotateGraphic.geometry=new a.Point(e,r,this.view.spatialReference)}},e.prototype._updateRotateLineGraphic=function(){if(this.handleGraphics.length&&this.rotateGraphic&&this.rotateGraphic.geometry){var t=this.handleGraphics[1].geometry,e=this.rotateGraphic.geometry;this._rotateLineGraphic.geometry=new a.Polyline({paths:[[t.x,t.y],[e.x,e.y]],spatialReference:this.view.spatialReference})}},e.prototype._updateXY=function(t,e,i){t.geometry=new a.Point(e,i,this.view.spatialReference)},e.prototype._updateX=function(t,e){var i=t.geometry.y;t.geometry=new a.Point(e,i,this.view.spatialReference)},e.prototype._updateY=function(t,e){var i=t.geometry.x;t.geometry=new a.Point(i,e,this.view.spatialReference)},e.prototype._getScaleRatio=function(t,e,i,r,a,h){var o=Math.sqrt((a-t)*(a-t)+(h-e)*(h-e));return Math.sqrt((i-t)*(i-t)+(r-e)*(r-e))/o},e.prototype._getAngle=function(t,e,i){var r=180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI;return 180*Math.atan2(t.y-i.y,t.x-i.x)/Math.PI-r},r([c.property()],e.prototype,"_rotateLineGraphic",void 0),r([c.property()],e.prototype,"callbacks",void 0),r([c.property({readOnly:!0})],e.prototype,"centerGraphic",void 0),r([c.property({readOnly:!0})],e.prototype,"backgroundGraphic",void 0),r([c.property()],e.prototype,"enableMovement",void 0),r([c.property()],e.prototype,"enableRotation",void 0),r([c.property()],e.prototype,"enableScaling",void 0),r([c.property()],e.prototype,"graphic",void 0),r([c.property({dependsOn:["graphic","backgroundGraphic","centerGraphic","handleGraphics","rotateGraphic","_rotateLineGraphic"],readOnly:!0})],e.prototype,"graphics",null),r([c.property({readOnly:!0})],e.prototype,"handleGraphics",void 0),r([c.property()],e.prototype,"layer",void 0),r([c.property({readOnly:!0})],e.prototype,"rotateGraphic",void 0),r([c.property()],e.prototype,"showCenterGraphic",void 0),r([c.property()],e.prototype,"uniformScaling",void 0),r([c.property()],e.prototype,"view",void 0),e=r([c.subclass("esri.views.2d.draw.support.Box")],e)}(c.declared(o))});