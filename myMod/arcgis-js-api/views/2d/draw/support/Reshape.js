// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../geometry","../../../../Graphic","../../../../core/Accessor","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/coordsUtils","../../../../symbols/SimpleMarkerSymbol","./drawUtils","./GraphicMover"],function(e,t,i,r,o,n,a,s,h,c,p,l,d,y){var v=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape-start"}return e}(),u=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape"}return e}(),f=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape-stop"}return e}(),g=function(){function e(e,t,i){this.graphic=e,this.dx=t,this.dy=i,this.type="move-start"}return e}(),m=function(){function e(e,t,i){this.graphic=e,this.dx=t,this.dy=i,this.type="move"}return e}(),G=function(){function e(e,t,i){this.graphic=e,this.dx=t,this.dy=i,this.type="move-stop"}return e}(),b=function(){function e(e){this.graphics=e,this.type="select"}return e}(),_=function(){function e(e){this.graphics=e,this.type="deselect"}return e}(),x=function(){function e(e,t,i){this.added=e,this.graphic=t,this.oldGraphic=i,this.type="vertex-add"}return e}(),w=function(){function e(e,t,i){this.removed=e,this.graphic=t,this.oldGraphic=i,this.type="vertex-remove"}return e}();return function(e){function t(t){var i=e.call(this,t)||this;return i._handles=new s,i._mover=null,i._viewHandles=new s,i.callbacks={onReshapeStart:function(e){},onReshape:function(e){},onReshapeStop:function(e){},onMoveStart:function(e){},onMove:function(e){},onMoveStop:function(e){}},i.graphic=null,i.handleGraphics=[],i.handleHoverSymbol=new l({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.handleSelectionSymbol=new l({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),i.handleSymbol=new l({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.layer=null,i.midpointGraphics=[],i.midpointSymbol=new l({type:"simple-marker",style:"circle",size:6,color:[200,200,200],outline:{color:[100,100,100],width:1}}),i.midpointsEnabled=!0,i.selectedGraphics=[],i.view=null,i}return i(t,e),t.prototype.initialize=function(){var e=this;this.graphic&&this.layer&&(this._setUpGraphics(),this._setUpMover()),this._handles.add([h.whenOnce(this,"view.ready",function(){e.view&&e.view.map&&e.view.map.add(e.layer),e._viewHandles.add([e.view.on("key-down",function(t){return e._keyDownHandler(t)})])}),h.pausable(this,"graphic",function(){e.refresh()}),h.pausable(this,"layer",function(t,i){i&&(e._clearSelection(),e._resetGraphics(i)),e.refresh()}),h.pausable(this,"midpointsEnabled",function(){e.refresh()})])},t.prototype.destroy=function(){this._reset(),this._mover&&this._mover.destroy(),this._mover=null,this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null},Object.defineProperty(t.prototype,"graphics",{get:function(){return[].concat(this.graphic,this.handleGraphics,this.midpointGraphics)},enumerable:!0,configurable:!0}),t.prototype.refresh=function(){this._reset(),this.graphic&&this.layer&&(this._setUpGraphics(),this._setUpMover())},t.prototype.clearSelection=function(){this._clearSelection()},t.prototype._reset=function(){this._clearSelection(),this._resetGraphics(),this._mover&&this._mover.destroy(),this._mover=null,this.view.container.style.cursor="default"},t.prototype._resetGraphics=function(e){var t=e||this.layer;t&&t.removeMany(this.handleGraphics),t&&t.removeMany(this.midpointGraphics),this.handleGraphics.forEach(function(e){return e.destroy()}),this.midpointGraphics.forEach(function(e){return e.destroy()}),this._set("handleGraphics",[]),this._set("midpointGraphics",[]),this._set("selectedGraphics",[])},t.prototype._setUpGraphics=function(){var e=this.graphic.geometry,t=p.geometryToCoordinates(e.clone());if("polygon"===e.type)for(var i=0,r=t;i<r.length;i++){var o=r[i],n=o[o.length-1];o[0][0]===n[0]&&o[0][1]===n[1]&&o.length>2&&o.pop()}this._set("handleGraphics",this._createHandleGraphics(t)),this.midpointsEnabled&&this._set("midpointGraphics",this._createMidpointGraphics(t)),this._saveRelatedIndices(this.handleGraphics),this.layer.addMany(this.midpointGraphics),this.layer.addMany(this.handleGraphics)},t.prototype._createHandleGraphics=function(e){for(var t=[],i=0,r=e;i<r.length;i++)for(var a=r[i],s=e.indexOf(a),h=0,c=a;h<c.length;h++){var p=c[h],l=a.indexOf(p),d=p[0],y=p[1];t.push(new n({geometry:new o.Point({x:d,y:y,spatialReference:this.view.spatialReference}),symbol:this.handleSymbol,attributes:{pathIndex:s,pointIndex:l}}))}return t},t.prototype._createMidpointGraphics=function(e){for(var t=[],i=0,r=e;i<r.length;i++)for(var a=r[i],s=e.indexOf(a),h=0,c=a;h<c.length;h++){var l=c[h],d=a.indexOf(l),y=l[0],v=l[1],u=a[d+1]?d+1:0;if("polyline"!==this.graphic.geometry.type||0!==u){var f=a[u],g=f[0],m=f[1],G=p.getMidpoint([y,v],[g,m]),b=G[0],_=G[1];t.push(new n({geometry:new o.Point({x:b,y:_,spatialReference:this.view.spatialReference}),symbol:this.midpointSymbol,attributes:{pathIndex:s,pointIndexStart:d,pointIndexEnd:u}}))}}return t},t.prototype._saveRelatedIndices=function(e){for(var t=0,i=e;t<i.length;t++){for(var r=i[t],o=e.indexOf(r),n=[],a=r.geometry,s=a.x,h=a.y,c=0,p=e;c<p.length;c++){var l=p[c],d=e.indexOf(l);if(o!==d){var y=l.geometry,v=y.x,u=y.y;s===v&&h===u&&n.push(d)}}r.attributes.relatedGraphicIndices=n}},t.prototype._setUpMover=function(){var e=this;this._mover=new y({graphics:[].concat(this.handleGraphics,this.graphic,this.midpointGraphics),view:this.view,callbacks:{onGraphicClick:function(t){return e._onGraphicClickCallback(t)},onGraphicMoveStart:function(t){return e._onGraphicMoveStartCallback(t)},onGraphicMove:function(t){return e._onGraphicMoveCallback(t)},onGraphicMoveStop:function(t){return e._onGraphicMoveStopCallback(t)},onGraphicPointerOver:function(t){return e._onGraphicPointerOverCallback(t)},onGraphicPointerOut:function(t){return e._onGraphicPointerOutCallback(t)}}})},t.prototype._onGraphicClickCallback=function(e){var t=e.graphic;if(t===this.graphic)return void this.clearSelection();if(this.midpointGraphics.indexOf(t)>-1){if(e.viewEvent.stopPropagation(),2===e.viewEvent.button)return;var i=this.graphic.clone();this._createHandleFromMidpoint(t),this.refresh(),this.callbacks.onVertexAdd&&this.callbacks.onVertexAdd(new x([t],this.graphic,i))}else this.handleGraphics.indexOf(t)>-1&&(e.viewEvent.stopPropagation(),2===e.viewEvent.button?this._removeVertex(t):(e.viewEvent.native.ctrlKey||this._clearSelection(),-1===this.selectedGraphics.indexOf(t)?this._addToSelection(t):this._removeFromSelection(t,!0)))},t.prototype._onGraphicMoveStartCallback=function(e){var t=e.graphic;if(t===this.graphic){var i=e.dx,r=e.dy;return this._clearSelection(),void(this.callbacks.onMoveStart&&this.callbacks.onMoveStart(new g(this.graphic,i,r)))}this.midpointGraphics.indexOf(t)>-1?(this._clearSelection(),this._createHandleFromMidpoint(t),this._addToSelection(t)):-1===this.selectedGraphics.indexOf(t)&&(this._clearSelection(),this._addToSelection(t)),this.callbacks.onReshapeStart&&this.callbacks.onReshapeStart(new v(this.graphic,t))},t.prototype._onGraphicMoveCallback=function(e){var t=e.graphic,i=e.dx,r=e.dy;t===this.graphic?(this._syncGraphicsWithGeometry(),this.callbacks.onMove&&this.callbacks.onMove(new m(this.graphic,i,r))):(this._syncGeometryAfterHandleMove(t,i,r),this.callbacks.onReshape&&this.callbacks.onReshape(new u(this.graphic,t)))},t.prototype._onGraphicMoveStopCallback=function(e){var t=e.graphic,i=e.dx,r=e.dy;t===this.graphic?(this._syncGraphicsWithGeometry(),this.callbacks.onMoveStop&&this.callbacks.onMoveStop(new G(this.graphic,i,r))):(this._syncGeometryAfterHandleMove(t,i,r),this.midpointGraphics.indexOf(t)>-1&&this.refresh(),this.callbacks.onReshapeStop&&this.callbacks.onReshapeStop(new f(this.graphic,t)))},t.prototype._syncGraphicsWithGeometry=function(){var e=this.graphic.geometry,t="polyline"===e.type?e.paths:e.rings;this._updateHandleGraphicLocations(t),this._updateMidpointGraphicLocations(t)},t.prototype._updateHandleGraphicLocations=function(e){for(var t=0,i=this.handleGraphics;t<i.length;t++){var r=i[t],n=r.attributes,a=n.pathIndex,s=n.pointIndex,h=e[a][s],c=h[0],p=h[1];r.set("geometry",new o.Point(c,p,this.view.spatialReference))}},t.prototype._updateMidpointGraphicLocations=function(e){for(var t=0,i=this.midpointGraphics;t<i.length;t++){var r=i[t],n=r.attributes,a=n.pathIndex,s=n.pointIndexStart,h=n.pointIndexEnd,c=e[a][s],l=c[0],d=c[1],y=e[a][h],v=y[0],u=y[1],f=p.getMidpoint([l,d],[v,u]),g=f[0],m=f[1];r.geometry=new o.Point({x:g,y:m,spatialReference:this.view.spatialReference})}},t.prototype._syncGeometryAfterHandleMove=function(e,t,i){var r=this.graphic.geometry.clone(),o="polyline"===r.type?r.paths:r.rings,n=e.attributes,a=n.pathIndex,s=n.pointIndex,h=e.geometry,c=h.x,p=h.y;if(o[a][s]=[c,p],"polygon"===r.type&&0===s&&(o[a][o[a].length-1]=[c,p]),this.handleGraphics.indexOf(e)>-1){for(var l=e.attributes.relatedGraphicIndices,y=0,v=l;y<v.length;y++){var u=v[y],f=this.handleGraphics[u],g=f.attributes,m=g.pathIndex,G=g.pointIndex;o[m][G]=[c,p],f.geometry=e.geometry}for(var b=0,_=this.selectedGraphics;b<_.length;b++){var x=_[b];if(x!==e){var w=x.attributes,S=w.pathIndex,k=w.pointIndex,M=w.relatedGraphicIndices,O=d.move(x.geometry,t,i,this.view);o[S][k]=[O.x,O.y],x.geometry=O;for(var I=0,H=M;I<H.length;I++){var u=H[I],f=this.handleGraphics[u],R=f.attributes,C=R.pathIndex,E=R.pointIndex;o[C][E]=[O.x,O.y],f.geometry=O}}}this._updateMidpointGraphicLocations(o)}this.graphic.geometry=r},t.prototype._onGraphicPointerOverCallback=function(e){var t=e.graphic;this.handleGraphics.indexOf(t)>-1&&-1===this.selectedGraphics.indexOf(t)&&(t.symbol=this.handleHoverSymbol),"pointer"!==this.view.container.style.cursor&&(this.view.container.style.cursor="pointer")},t.prototype._onGraphicPointerOutCallback=function(e){var t=e.graphic;this.handleGraphics.indexOf(t)>-1&&-1===this.selectedGraphics.indexOf(t)&&(t.symbol=this.handleSymbol),"default"!==this.view.container.style.cursor&&(this.view.container.style.cursor="default")},t.prototype._createHandleFromMidpoint=function(e){var t=this.graphic.geometry.clone(),i=e.attributes,r=i.pathIndex,o=i.pointIndexStart,n=i.pointIndexEnd,a=e.geometry,s=a.x,h=a.y,c=0===n?o+1:n;("polyline"===t.type?t.paths:t.rings)[r].splice(c,0,[s,h]),e.attributes={pathIndex:r,pointIndex:c,relatedGraphicIndices:[]},this.graphic.geometry=t},t.prototype._removeHandles=function(e){var t=this.graphic.geometry.clone(),i="polygon"===t.type?t.rings:t.paths;e instanceof n&&(e=[e]);for(var r=0,o=e;r<o.length;r++){var a=o[r],s=a.geometry,h=s.x,c=s.y;for(var p in i){var l=i[p];for(var d in l){var y=l[d],v=y[0],u=y[1];h===v&&c===u&&i[p].splice(Number(d),1)}}}if("polygon"===t.type)for(var f=0,g=i;f<g.length;f++){var m=g[f],G=m[0],h=G[0],c=G[1],b=m[m.length-1],_=b[0],x=b[1];(1===m.length||m.length<3&&h===_&&c===x)&&i.splice(i.indexOf(m),1),m.length>2&&(h!==_||c!==x)&&m.push(m[0])}else for(var w=0,S=i;w<S.length;w++){var k=S[w];1===k.length&&i.splice(i.indexOf(k),1)}this.graphic.geometry=t},t.prototype._addToSelection=function(e){e instanceof n&&(e=[e]);for(var t=0,i=e;t<i.length;t++){i[t].symbol=this.handleSelectionSymbol}this._set("selectedGraphics",this.selectedGraphics.concat(e)),this.callbacks.onSelect&&this.callbacks.onSelect(new b(e))},t.prototype._removeFromSelection=function(e,t){var i=t?this.handleHoverSymbol:this.handleSymbol;e instanceof n&&(e=[e]);for(var r=0,o=e;r<o.length;r++){var a=o[r];this.selectedGraphics.splice(this.selectedGraphics.indexOf(a),1),a.symbol=i}this.callbacks.onDeselect&&this.callbacks.onDeselect(new _(e))},t.prototype._clearSelection=function(){if(this.selectedGraphics.length){for(var e=this.selectedGraphics,t=0,i=this.selectedGraphics;t<i.length;t++){i[t].symbol=this.handleSymbol}this._set("selectedGraphics",[]),this.callbacks.onDeselect&&this.callbacks.onDeselect(new _(e))}},t.prototype._keyDownHandler=function(e){"Backspace"===e.key&&!e.repeat&&this.selectedGraphics.length&&this._removeVertex(this.selectedGraphics)},t.prototype._removeVertex=function(e){if(!("polygon"===this.graphic.geometry.type&&this.handleGraphics.length<4||this.handleGraphics.length<3)){var t=this.graphic.clone();e instanceof n&&(e=[e]),this._removeHandles(e),this.refresh(),this.callbacks.onVertexRemove&&this.callbacks.onVertexRemove(new w(e,this.graphic,t))}},r([c.property()],t.prototype,"callbacks",void 0),r([c.property()],t.prototype,"graphic",void 0),r([c.property({dependsOn:["graphic","handleGraphics","midpointGraphics"],readOnly:!0})],t.prototype,"graphics",null),r([c.property({readOnly:!0})],t.prototype,"handleGraphics",void 0),r([c.property()],t.prototype,"handleHoverSymbol",void 0),r([c.property()],t.prototype,"handleSelectionSymbol",void 0),r([c.property()],t.prototype,"handleSymbol",void 0),r([c.property()],t.prototype,"layer",void 0),r([c.property({readOnly:!0})],t.prototype,"midpointGraphics",void 0),r([c.property()],t.prototype,"midpointSymbol",void 0),r([c.property()],t.prototype,"midpointsEnabled",void 0),r([c.property({readOnly:!0})],t.prototype,"selectedGraphics",void 0),r([c.property()],t.prototype,"view",void 0),t=r([c.subclass("esri.views.2d.draw.support.Reshape")],t)}(c.declared(a))});