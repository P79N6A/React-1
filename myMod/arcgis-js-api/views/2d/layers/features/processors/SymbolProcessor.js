// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/Error","../../../../../core/Logger","../../../../../core/MapPool","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../renderers/support/jsonUtils","../../../engine/webgl/definitions","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/Utils","../../../engine/webgl/collisions/CollisionGrid","../../../engine/webgl/mesh/factories/matcherUtils","../../../engine/webgl/mesh/factories/MaterialStore","../../../engine/webgl/mesh/factories/WGLMeshFactory","../../../engine/webgl/mesh/templates/WGLTemplateStore","../../../engine/webgl/util/BidiText","./BaseProcessor"],function(e,t,r,n,i,o,s,l,a,u,c,p,f,d,y,g,h,m,b,v,I,_){function C(e){return e&&("unique-value"===e.type||"class-breaks"===e.type)&&null!==e.backgroundFillSymbol}function S(e){var t=e&&e.getSymbols();return C(e)||t.some(function(e){return"simple-fill"===e.type||"picture-fill"===e.type})}function P(e,t){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryMultipoint":return!0;case"esriGeometryPolygon":return S(t);default:return w.error(new i("mapview-invalid-type",e+" is not supported")),!1}}function O(e,t,r){r.has(e)||r.set(e,new Set);for(var n=r.get(e),i=t.length,o=0;o<i;o++){var s=t.charCodeAt(o);n.add(s)}}Object.defineProperty(t,"__esModule",{value:!0});var w=o.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor"),M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._symbolToMosaicItemMap=new Map,t._visualSetPromises=new Map,t.type="symbol",t}return r(t,e),t.prototype.destroy=function(){this._visualSetPromises.forEach(function(e,t){e.cancel()}),this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(t.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelingInfo",{get:function(){return this.configuration&&this.configuration.labelingInfo?this.configuration.labelingInfo.map(function(e){return c.fromJSON(e)}):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelClassInfos",{get:function(){var e=this;return this.labelingInfo?this.labelingInfo.map(function(t){return{labelOptions:t.getOptions(e.spatialReference),labelExpression:t.getLabelExpression(),labelClass:t}}):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"matcher",{get:function(){return h.createMatcher(this.renderer,this.factory.materials,this.factory.templates,u.fromJSON(this.spatialReference),this.service.fields)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"factory",{get:function(){var e=this;if(!this.configuration)return null;var t=function(t){return e.remoteClient.invoke("tileRenderer.getMaterialItems",t)},r=new m.default,n=new v.default(t,this.configuration.devicePixelRatio);return new b.default(this.service.geometryType,this.service.objectIdField,this.service.fields,this.renderer.visualVariables,this.configuration.devicePixelRatio,u.fromJSON(this.spatialReference),r,n,this.labelingInfo)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"queryInfo",{get:function(){var e=this.configuration,t=e.renderer,r=e.definitionExpression,n=e.outFields,i=e.gdbVersion,o=e.historicMoment,s=this.service.geometryType,l=this._getReturnCentroid(this.rendererInfo.renderer),a=P(s,this.rendererInfo.renderer),u="esriGeometryPoint"===s||"esriGeometryMultipoint"===s||l,c=u?20:0,p=null,f=t.visualVariables;return f&&f.some(function(e){if("size"===e.type&&e.field&&!e.normalizationField)return p=[e.field+" DESC"],!0}),{definitionExpression:r,orderByFields:p,outFields:n,pixelBuffer:c,returnCentroid:l,returnGeometry:a,gdbVersion:i,historicMoment:o}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.configuration?p.fromJSON(this.configuration.renderer):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendererInfo",{get:function(){return this.configuration?d.createRendererInfo(p.fromJSON(this.configuration.renderer),this.tileStore.spatialReference,{fields:this.service.fields}):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fields",{get:function(){return this.service.fields},enumerable:!0,configurable:!0}),t.prototype.onTileData=function(e,t){var r,n=this,i=t.addOrUpdate,o=t.remove,s=t.clear;r=i&&i.length?this._processFeatures(e,i):l.resolve();var a=r.then(function(t){var r=t&&t.message||null,i=t&&t.transferList||null;return n.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{addOrUpdate:r,remove:o,clear:s}},i)}).catch(function(t){return n._handleError(e,t)});return this._visualSetPromises.set(e,a),a.then(function(){return n._cleanPromise(e)},function(){return n._cleanPromise(e)}),this.notifyChange("updating"),a},t.prototype.onTileError=function(e,t){var r=this,n=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t});return this._visualSetPromises.set(e,n),n.then(function(){return r._cleanPromise(e)},function(){return r._cleanPromise(e)}),this.notifyChange("updating"),n},t.prototype.onTileUpdate=function(e){for(var t=0,r=e.removed;t<r.length;t++){var n=r[t],i=this._visualSetPromises;if(!i.has(n))return;i.get(n).cancel(),i.delete(n),this.notifyChange("updating")}},t.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},t.prototype._processFeatures=function(e,t){var r=this;if(!t||!t.length)return l.resolve(null);var n=this.factory;return n.analyze(t,this.matcher,{viewingMode:"",scale:e.scale}).then(function(t){return r._getLabelMosaicItems(e,t).then(function(i){return r._writeFeatures(e,t,i,n)})})},t.prototype._writeFeatures=function(e,t,r,n){for(var i=n.createMeshData(t.length),o={viewingMode:"",scale:e.scale},s=0,l=t;s<l.length;s++){var a=l[s];n.write(i,a,o,r,this._symbolToMosaicItemMap)}return this._encodeDisplayData(i)},t.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),{message:t,transferList:r}},t.prototype._handleError=function(e,t){if(t&&"cancel"!==t.dojoType)return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t.message})},t.prototype._getReturnCentroid=function(e){function t(e){if(!e)return!1;var t=e.type;return"simple-marker"===t||"picture-marker"===t||"text"===t}if("esriGeometryPolygon"===this.service.geometryType&&this.labelingInfo)return!0;if("esriGeometryPolygon"!==this.service.geometryType)return!1;switch(e.type){case"simple":return t(e.symbol);case"unique-value":return t(e.defaultSymbol)||e.uniqueValueInfos.some(function(e){return t(e.symbol)});case"class-breaks":return t(e.defaultSymbol)||e.classBreakInfos.some(function(e){return t(e.symbol)});default:return!0}},t.prototype._getLabelMosaicItems=function(e,t){var r=s.acquire(),n=this._createLabelFeatures(e.scale,t,r),i=this._symbolToMosaicItemMap,o=s.acquire(),a=[],u=0;return r.forEach(function(e,t){if(i.has(t.id)){var r=i.get(t.id),n=r.glyphMosaicItems,s=[];e.forEach(function(e){(n&&n.length<e||!n[e])&&(s[e]=e)}),s.length>0&&(o.set(u,t),a.push({symbol:t.toJSON(),id:u,glyphIds:s}),u++)}else{o.set(u,t);var l=[];e.forEach(function(e){return l.push(e)}),a.push({symbol:t.toJSON(),id:u,glyphIds:l}),u++}}),a.length>0?this.remoteClient.invoke("tileRenderer.getMaterialItems",a).then(function(e){for(var t=0,r=e;t<r.length;t++){var l=r[t],a=o.get(l.id);if(a)if(y.isTextSymbol(a))if(i.has(a.id)){var u=i.get(a.id),c=u.glyphMosaicItems,p=l.mosaicItem.glyphMosaicItems;if(p)for(var f=0;f<p.length;f++)null!=p[f]&&(c[f]=p[f])}else i.set(a.id,l.mosaicItem);else i.set(a.id,l.mosaicItem)}return s.release(o),n}):(s.release(r),l.resolve(n))},t.prototype._getLabelClassInfos=function(e){return this.labelClassInfos.map(function(e,t){return{id:t,labelClassInfo:e}}).filter(function(t){var r=t.labelClassInfo;return(!r.labelClass.minScale||r.labelClass.minScale>=e||0===r.labelClass.minScale)&&(!r.labelClass.maxScale||r.labelClass.maxScale<=e||0===r.labelClass.maxScale)})},t.prototype._createLabelFeatures=function(e,t,r){if(!this.labelingInfo||!t||0===t.length)return null;var n=this._getLabelClassInfos(e);if(0===n.length)return null;for(var i=s.acquire(),o=n.map(function(e){return e.id}),l=new g.default(f.COLLISION_EARLY_REJECT_BUCKET_SIZE),a=0,u=t;a<u.length;a++){var c=u[a],p=this.service.geometryType,d=0,y=0;if("esriGeometryPoint"===p){var h=c.geometry;d=h.x,y=h.y}else{if("esriGeometryPolygon"!==p)return null;d=c.centroid.x,y=c.centroid.y}var m=c.attributes[this.service.objectIdField];if(!l.checkOverlap(d,y)){for(var b=new Array(n.length),v=0;v<n.length;v++){var _=n[v].labelClassInfo,C=I.bidiText(this._evaluateLabelExpression(c,_)),S=C[0],P=C[1];O(_.labelClass.symbol,S,r),b[v]={text:S,rtl:P}}i.set(m,{text:b,labelingInfo:o})}}return i},t.prototype._evaluateLabelExpression=function(e,t){return t.labelClass.symbol&&c.evaluateWhere(t.labelClass.where,e.attributes)&&t.labelExpression.expression?c.buildLabelText(t.labelExpression.expression,e,this.fields,t.labelOptions):""},n([a.property({readOnly:!0})],t.prototype,"supportsTileUpdates",null),n([a.property()],t.prototype,"configuration",void 0),n([a.property({dependsOn:["configuration"]})],t.prototype,"labelingInfo",null),n([a.property({dependsOn:["labelingInfo"]})],t.prototype,"labelClassInfos",null),n([a.property({dependsOn:["factory"]})],t.prototype,"matcher",null),n([a.property({dependsOn:["configuration","service","fields"]})],t.prototype,"factory",null),n([a.property({constructOnly:!0})],t.prototype,"queryInfo",null),n([a.property({dependsOn:["configuration"]})],t.prototype,"renderer",null),n([a.property({dependsOn:["configuration"]})],t.prototype,"rendererInfo",null),n([a.property({readOnly:!0})],t.prototype,"updating",null),n([a.property({dependsOn:["service"]})],t.prototype,"fields",null),t=n([a.subclass()],t)}(a.declared(_.default));t.default=M});