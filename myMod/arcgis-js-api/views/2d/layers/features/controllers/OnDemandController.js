// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","@dojo/framework/shim/Set","../../../../../geometry","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/QueueProcessor","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/DefaultSpatialIndex","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FeatureProcessing","../../../../../tasks/operations/query","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","./BaseController","../support/DataTile","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileInfoView","../../../tiling/TileQueue"],function(e,t,r,i,n,o,s,a,u,l,d,c,p,h,f,y,g,_,m,v,x,T,Q,I,b,F,E){Object.defineProperty(t,"__esModule",{value:!0});var q=l.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),w=u("esri-featurelayer-webgl"),O=u("esri-mobile"),P={maxDrillLevel:w&&"object"==typeof w&&null!=w.maxDrillLevel?w.maxDrillLevel:O?1:4,maxRecordCountFactor:w&&"object"==typeof w&&null!=w.maxRecordCountFactor?w.maxRecordCountFactor:O?1:3,enablePBFQuery:!w||"object"!=typeof w||null==w.enablePBFQuery||w.enablePBFQuery},S=new o.default,j=[],C=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._processingInMainThread=!1,t._dataTileIndex=new Q.default,t._editsQueue=new c({concurrency:1,ordered:!0,process:function(e){return t._processEditsEvent(e)}}),t}return r(t,e),t.prototype.initialize=function(){var e=this;this._fetchQueue=new E({concurrency:10,strategy:"center-first",tileInfoView:new F(this.tileStore.tileInfo),process:function(t){return e._fetchTile(t)}}),this._updateQueue=new b.default({tileInfoView:new F(this.tileStore.tileInfo),process:function(t,r){return e._updateTile(t,r)}}),this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))},t.prototype.destroy=function(){this._fetchQueue.clear(),this._updateQueue.clear(),this.queryEngine&&(this.queryEngine.destroy(),this._set("queryEngine",null))},Object.defineProperty(t.prototype,"processing",{get:function(){return g.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._fetchQueue.updating||this._updateQueue.updating},enumerable:!0,configurable:!0}),t.prototype.onEdits=function(e){var t=this;this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then(function(){0===t._editsQueue.length&&t._fetchQueue.resume()})},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(v.fromJSON(e))},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(v.fromJSON(e))},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(v.fromJSON(e))},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(v.fromJSON(e))},t.prototype.redraw=function(){this._updateQueue.pause(),this._manageTiles(this.tileStore.tiles),this._updateQueue.resume()},t.prototype.refresh=function(){},t.prototype.setViewState=function(e){this._fetchQueue.state=e,this._updateQueue.state=e},t.prototype.onTileUpdate=function(e){this.queryEngine&&this._manageTiles(e.added,e.removed)},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,n=this._updateQueue,o="esriGeometryPoint"===this.service.geometryType,s=this,a=0,u=e;a<u.length;a++){var l=u[a];!function(e){var t=r.get(e.id);t?(t.displayTile=e,o?r.forEach(function(r){I.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):(t=new T.default,t.tile=e.clone(),t.displayTile=e,r.add(t)),s._processDataTile(t)}(l)}if(t)for(var d=0,c=t;d<c.length;d++){var l=c[d];S.add(l),n.cancel(l.id)}r.forEach(function(e){S.has(e.displayTile)&&j.push(e)});for(var p=0,h=j;p<h.length;p++){var f=h[p];i.has(f.id)&&i.getPromise(f.id).cancel(),r.delete(f)}j.length=0,S.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,n=this._dataTileIndex,o=this._fetchQueue,s=i.id,u=this._queryInfoHash,l=i.level-r.key.level>=P.maxDrillLevel;if(n.add(e),e.done||o.has(s)){if(e.queryInfoHash!==u||e.returnExceeded!==l)if(e.done)e.done=!1;else{if(!o.isOngoing(s))return e.queryInfoHash=u,void(e.returnExceeded=l);o.getPromise(s).cancel()}}else e.queryInfoHash=u,e.returnExceeded=l;if(e.done)return void this._invalidateTile(e.displayTile);o.has(s)||o.push(e).then(function(r){return t._handleResponse(e,r)}).catch(function(t){"cancel"!==t.dojoType&&q.error(new a("mapview-controller","Encountered an error when handling tile response",t)),e.done=!0})},t.prototype._handleResponse=function(e,t){if(e.done=!0,h.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else for(var r=e.tile.createChildTiles(),i=0,n=r;i<n.length;i++){var o=n[i],s=new T.default;s.tile=o,s.displayTile=e.displayTile,this._processDataTile(s)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile)},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach(function(t){I.isChildOf(t,e)&&j.push(t)});for(var t=0,r=j;t<r.length;t++){var i=r[t];this._fetchQueue.has(i.id)&&this._fetchQueue.getPromise(i.id).cancel(),this._dataTileIndex.delete(i)}j.length=0},t.prototype._fetchTile=function(e){var t=this,r=this._createQuery(e.displayTile,e.tile,e.returnExceeded),i=this.service.source;return P.enablePBFQuery&&this.service.capabilities.query.supportsFormatPBF?_.executeQueryPBF(i,r).then(function(e){return e.data}):_.executeQuery(i,r).then(function(e){return h.convertFromFeatureSet(e.data,t.service.objectIdField)})},t.prototype._invalidateTile=function(e){for(var t=this._updateQueue,r=this.tileStore.intersections(e,this.processor.queryInfo.pixelBuffer),i=0,n=r;i<n.length;i++){var o=n[i].tile;t.push(o.id,o.updateTimestamp)}},t.prototype._updateTile=function(e,t){var r=this,i=this.tileStore.get(e),n=this.processor.queryInfo,o=n.returnCentroid,s=n.returnGeometry,a=n.pixelBuffer,u=this.queryEngine.executeTileQuery(i,{pixelBuffer:a,returnGeometry:s,returnCentroid:o}),l=u.features,d=u.objectIds,c={features:l,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:{originPosition:"upperLeft",scale:[i.resolution,i.resolution],translate:[i.bounds[0],i.bounds[3]]}};return this._applyProcessing(c).catch(function(e){return e&&"cancel"!==e.dojoType&&q.error("updating-tile",e),c}).then(function(e){var n=[],o=!0;return r._dataTileIndex.forEach(function(e){i.id!==e.id&&I.isChildOf(e,i)&&o&&!e.done&&(o=!1)}),o&&i&&i.objectIds.forEach(function(e){d.has(e)||n.push(e)}),d.forEach(function(e){i.objectIds.add(e)}),i.updateTimestamp=t,r.processor.onTileData(i,{addOrUpdate:e.features,remove:n}).catch(function(e){e&&"cancel"!==e.dojoType&&q.error("updating-tile",e)})})},t.prototype._processEditsEvent=function(e){var t=this;return d.create(function(r,i){var n=function(e){return e.objectId},o=e.deletedFeatures.map(n),s=t._dataTileIndex.deleteFeaturesById(o),a=e.addedFeatures.concat(e.updatedFeatures).map(n);if(a.length){var u=t.service.source,l=t._createObjectIdsQuery(a);_.executeQuery(u,l).then(function(e){var r=e.data;if(r&&r.features&&r.features.length){var i=h.convertFromFeatureSet(r,t.service.objectIdField).features;s.push.apply(s,t._dataTileIndex.addOrUpdateFeatures(i));for(var n=0,o=s;n<o.length;n++){var a=o[n];t._invalidateTile(a.tile)}}}).then(r,r)}else{for(var d=0,c=s;d<c.length;d++){var p=c[d];t._invalidateTile(p.tile)}r()}})},t.prototype._switchProcessor=function(e,t){var r=e.queryInfo,i=r.definitionExpression,n=r.gdbVersion,o=r.historicMoment,s=this._createQueryInfoHash(e);this._queryInfoHash!==s&&(this._queryInfoHash=s,this.queryEngine&&this.queryEngine.destroy(),this.spatialIndex&&this.spatialIndex.clear(),this._set("spatialIndex",new f.default({geometryType:this.service.geometryType,hasM:!1,hasZ:!1})),this._set("queryEngine",new y.default({definitionExpression:i,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference,cacheSpatialQueries:!0,gdbVersion:n,historicMoment:null!=o&&new Date(o),spatialIndex:this.spatialIndex})),this._dataTileIndex.spatialIndex=this.spatialIndex,this._dataTileIndex.forEach(function(e){e.done=!1})),this._editsQueue.pause(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.reset(),this._updateQueue.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._editsQueue.resume(),this._updateQueue.resume()},t.prototype._createQuery=function(e,t,r){void 0===r&&(r=!0);var i=this.service.geometryType,n=this._createDefaultQuery(),o="esriGeometryPoint"===this.service.geometryType?t:e;return n.maxRecordCountFactor=P.maxRecordCountFactor,n.resultType="tile",n.returnExceededLimitFeatures=r,n.geometry=s.Extent.fromJSON({xmin:t.bounds[0],ymin:t.bounds[1],xmax:t.bounds[2],ymax:t.bounds[3],spatialReference:this.spatialReference}),this.service.capabilities.query.supportsQuantization?(n.quantizationParameters=m.default.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:o.resolution,extent:{xmin:o.bounds[0],ymin:o.bounds[1],xmax:o.bounds[2],ymax:o.bounds[3],spatialReference:this.spatialReference}}),"esriGeometryPolyline"===i&&(n.maxAllowableOffset=o.resolution)):"esriGeometryPolyline"!==i&&"esriGeometryPolygon"!==i||(n.maxAllowableOffset=o.resolution),n},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery();return t.objectIds=e,t},t.prototype._createDefaultQuery=function(){var e=this,t=this.processor.queryInfo,r=new v;r.outSpatialReference=s.SpatialReference.fromJSON(this.spatialReference);var i=t.outFields,n=t.orderByFields;return this.processing&&(i=i&&i.filter(function(t){return!e.processing.getField(t)}),n=n&&n.filter(function(t){return!e.processing.getField(t)})),i=i.length/this.service.fields.length>=.75?["*"]:i,r.gdbVersion=t.gdbVersion,r.historicMoment=null!=t.historicMoment?new Date(t.historicMoment):null,r.outFields=i,r.where=t.definitionExpression||"1=1",r.returnGeometry=!0,r.returnCentroid=t.returnCentroid,r.orderByFields=n,r},t.prototype._applyProcessing=function(e){var t=this.processing;if(!t)return d.resolve(e);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:e});try{var r=t.process(e,t.options);return r?"then"in r?r:d.resolve(r):d.reject(new a("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(t){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:e})}},t.prototype._createQueryInfoHash=function(e){var t=this,r=e.queryInfo,i=r.orderByFields,n=r.outFields,o=e.queryInfo,s=o.definitionExpression,a=o.gdbVersion,u=o.historicMoment;return this.processing&&(n=n&&n.filter(function(e){return!t.processing.getField(e)}),i=i&&i.filter(function(e){return!t.processing.getField(e)})),n&&n.sort(),i&&i.sort(),JSON.stringify({definitionExpression:s,outFields:n.length/this.service.fields.length>=.75?["*"]:n,orderByFields:i,gdbVersion:a,historicMoment:u})},i([p.property()],t.prototype,"_fetchQueue",void 0),i([p.property()],t.prototype,"_updateQueue",void 0),i([p.property()],t.prototype,"configuration",void 0),i([p.property({readOnly:!0,dependsOn:["configuration"]})],t.prototype,"processing",null),i([p.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([p.property({readOnly:!0})],t.prototype,"spatialIndex",void 0),i([p.property({dependsOn:["_fetchQueue.updating","_updateQueue.updating"]})],t.prototype,"updating",null),t=i([p.subclass()],t)}(p.declared(x.default));t.default=C});