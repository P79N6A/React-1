// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../../geometry/support/spatialReferenceUtils","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],function(e,t,o,r,n,i,l){var s=new i("0/0/0/0"),a=function(){function e(e,t,o,r,n,i,l,s){this.x=e,this.ymin=t,this.ymax=o,this.invM=r,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=l,this.rightBound=s}return e.create=function(t,o){var r;t[1]>o[1]&&(r=[o,t],t=r[0],o=r[1]);var n=t[0],i=t[1],l=o[0],s=o[1],a=l-n,u=s-i,f=0!==u?a/u:0,h=(Math.ceil(i)-i)*f,c=(Math.floor(i)-i)*f;return new e(n,Math.floor(i),Math.ceil(s),f,a<0?h:c,a<0?c:h,a<0?l:n,a<0?n:l)},e.prototype.incrRow=function(){this.x+=this.invM},e.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},e.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},e}(),u=[[0,0],[0,0],[0,0],[0,0]];return function(){function e(e,t){var o=this;this.tileInfo=e,this.fullExtent=t,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=e.lods.slice();n.sort(function(e,t){return t.scale-e.scale});var i=this._lodInfos=n.map(function(o){return r.create(e,o,t)});n.forEach(function(e,t){o._infoByLevel[e.level]=i[t],o._infoByScale[e.scale]=i[t],o.scales[t]=e.scale},this),this._wrap=e.isWrappable}return e.prototype.getLODInfoAt=function(e){return this._infoByLevel[e.level]},e.prototype.getTileBounds=function(e,t,o){void 0===o&&(o=!1),s.set(t);var r=this._infoByLevel[s.level];return r?r.getTileBounds(e,s,o):e},e.prototype.getTileCoords=function(e,t,o){void 0===o&&(o=!1),s.set(t);var r=this._infoByLevel[s.level];return r?r.getTileCoords(e,s,o):e},e.prototype.getTileCoverage=function(e,t){void 0===t&&(t=192);var o,r,i,s=this.getClosestInfoForScale(e.scale),f=n.pool.acquire(s),h=this._wrap,c=1/0,v=-1/0,p=f.spans;u[0][0]=u[0][1]=u[1][1]=u[3][0]=-t,u[1][0]=u[2][0]=e.size[0]+t,u[2][1]=u[3][1]=e.size[1]+t;for(var d=0,g=u;d<g.length;d++){var y=g[d];e.toMap(y,y),y[0]=s.getColumnForX(y[0]),y[1]=s.getRowForY(y[1])}for(var m=[],w=3,M=0;M<4;M++)if(u[M][1]!==u[w][1]){var B=a.create(u[M],u[w]);c=Math.min(B.ymin,c),v=Math.max(B.ymax,v),void 0===m[B.ymin]&&(m[B.ymin]=[]),m[B.ymin].push(B),w=M}else w=M;if(null==c||null==v||v-c>100)return null;var _=[];for(o=c;o<v;){null!=m[o]&&(_=_.concat(m[o])),r=1/0,i=-1/0;for(var M=_.length-1;M>=0;M--){var B=_[M];r=Math.min(r,B.getLeftCol()),i=Math.max(i,B.getRightCol())}if(r=Math.floor(r),i=Math.floor(i),o>=s.first[1]&&o<=s.last[1])if(h)if(s.size[0]<s.worldSize[0])for(var C=Math.floor(i/s.worldSize[0]),M=Math.floor(r/s.worldSize[0]);M<=C;M++)p.push(new l(o,Math.max(s.getFirstColumnForWorld(M),r),Math.min(s.getLastColumnForWorld(M),i)));else p.push(new l(o,r,i));else r>s.last[0]||i<s.first[0]||(r=Math.max(r,s.first[0]),i=Math.min(i,s.last[0]),p.push(new l(o,r,i)));o+=1;for(var M=_.length-1;M>=0;M--){var B=_[M];B.ymax>=o?B.incrRow():_.splice(M,1)}}return f},e.prototype.getTileIdAtParent=function(e,t){var o=i.pool.acquire(t),r=this._infoByLevel[o.level];if(e.resolution<r.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+e.resolution+" is not a parent resolution of "+r.resolution);if(e.resolution===r.resolution)return o.id;var n=Math.floor(o.col*r.resolution/e.resolution+.01),l=Math.floor(o.row*r.resolution/e.resolution+.01);return i.getId(e.level,l,n,o.world)},e.prototype.getTileParentId=function(e){var t=i.pool.acquire(e),o=this._infoByLevel[t.level],r=this._lodInfos.indexOf(o)-1;if(r<0)return i.pool.release(t),null;var n=this._lodInfos[r],l=this.getTileIdAtParent(n,t);return i.pool.release(t),l},e.prototype.getTileResolution=function(e){var t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1},e.prototype.getTileScale=function(e){var t=this._infoByLevel[e.level];return t?t.scale:-1},e.prototype.intersects=function(e,t){var o=i.pool.acquire(t),r=this._infoByLevel[o.level],n=e.lodInfo;if(n.resolution>r.resolution){var l=i.pool.acquire(this.getTileIdAtParent(n,o)),s=n.denormalizeCol(l.col,l.world),a=e.spans.some(function(e){return e.row===l.row&&e.colFrom<=s&&e.colTo>=s});return i.pool.release(o),i.pool.release(l),a}if(n.resolution<r.resolution){var u=e.spans.reduce(function(e,t){return e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e},[1/0,-1/0,1/0,-1/0]),f=u[0],h=u[1],c=u[2],v=u[3],p=r.denormalizeCol(o.col,o.world),d=n.getColumnForX(r.getXForColumn(p)),g=n.getRowForY(r.getYForRow(o.row)),y=n.getColumnForX(r.getXForColumn(p+1))-1,m=n.getRowForY(r.getYForRow(o.row+1))-1;return i.pool.release(o),!(d>v||y<c||g>h||m<f)}var w=n.denormalizeCol(o.col,o.world),M=e.spans.some(function(e){return e.row===o.row&&e.colFrom<=w&&e.colTo>=w});return i.pool.release(o),M},e.prototype.normalizeBounds=function(e,t,r){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){var n=o.getInfo(this.tileInfo.spatialReference),i=-r*(n.valid[1]-n.valid[0]);e[0]+=i,e[2]+=i}return e},e.prototype.getClosestInfoForScale=function(e){var t=this.scales;return this._infoByScale[e]?this._infoByScale[e]:(e=t.reduce(function(t,o,r,n){return Math.abs(o-e)<Math.abs(t-e)?o:t},t[0]),this._infoByScale[e])},e.prototype.scaleToLevel=function(e){var t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(var o=t.length-1;o>=0;o--)if(e<t[o]){if(o===t.length-1)return this._infoByScale[t[t.length-1]].level;var r=this._infoByScale[t[o]].level;return r+(t[o]-e)/(t[o]-t[o+1])}return this._infoByScale[t[0]].level},e}()});