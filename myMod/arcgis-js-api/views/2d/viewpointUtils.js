// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../../Viewpoint","../../core/Error","../../core/promiseUtils","../../core/wgs84Constants","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils","./libs/gl-matrix/common","./libs/gl-matrix/mat2d","./libs/gl-matrix/vec2"],function(e,t,r,n,a,o,c,i,u,s,l,f,g,y,m,p,v){function d(e,t,r){var n=m.toDegree(t[0]/_);return v.set(e,r?n:n-360*Math.floor((n+180)/360),m.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/_))))}function x(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(m.toRadian(r)),v.set(e,m.toRadian(t[0])*_,.5*_*Math.log((1+r)/(1-r)))}function h(e,t,r,n){return n&&r&&!n.equals(r)&&g.canProject(n,r)&&n.isWebMercator?n.isWebMercator?x(e,t):d(e,t):v.copy(e,t)}function b(e){return e.wkid?e:e.spatialReference||s.WGS84}function R(e,t){return t.type?v.set(e,t.x,t.y):v.copy(e,t)}function M(e){return l.getMetersPerUnitForSR(e)}function w(e,t){return Math.max(e.width/t[0],e.height/t[1])*W(e.spatialReference)}function G(e,t,r){var n;if(!e)return null;if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])return new u(e);if(e.reduce)return e.reduce(function(e,r){return G(r,t,e)},r);if(e instanceof i?n=e:e.geometry&&(n=e.geometry),!n)return null;var a;if(!(a="point"===n.type?new c({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return null;var o=g.canProject(a,t);if(!a.spatialReference.equals(t)&&o)a=g.project(a,t);else if(!o)return null;return r=r?r.union(a):a.clone()}function P(e,t){if(!e)return new r({targetGeometry:new u,scale:0,rotation:0});var n=t.spatialReference,a=t.size,o=t.viewpoint,i=t.constraints,s=null;"esri.Viewpoint"===e.declaredClass?s=e:e.viewpoint?s=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(s=e.target);var l=null;s&&s.targetGeometry?l=s.targetGeometry:e instanceof c?l=e:(e||e&&(e.hasOwnProperty("center")||e.hasOwnProperty("extent")||e.hasOwnProperty("target")))&&(l=G(e.center,n)||G(e.extent,n)||G(e.target,n)||G(e,n)),!l&&o&&o.targetGeometry?l=o.targetGeometry:!l&&t.extent&&(l=t.extent);var f=b(l);if(n||(n=b(t.spatialReference||t.extent||l)),!y.canProject(l,n)&&f&&!f.equals(n))return null;var m=R(v.create(),l.center?l.center:l),p=new u(h(m,m,f,n),n),d=null;d=s&&s.targetGeometry&&"point"===s.targetGeometry.type?s.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&i&&i.effectiveLODs?i.zoomToScale(e.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?t.extent&&g.canProject(t.extent,n)?w(g.project(t.extent,n),a):t.extent?w(t.extent,a):o.scale:g.canProject(l.extent,n)?w(g.project(l.extent,n),a):w(l.extent,a);var x=0;s?x=s.rotation:e.hasOwnProperty("rotation")?x=e.rotation:o&&(x=o.rotation);var M=new r({targetGeometry:p,scale:d,rotation:x});return i&&(M=i.fit(M),i.rotationEnabled||(M.rotation=x)),M}function S(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function A(e,t,r){return r?v.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):v.scale(e,t,.5)}function T(e,r,n,a,o){return t.centerAt(e,r,n.center),e.scale=w(n,a),o&&o.constraints&&o.constraints.constrain(e),e}function j(e,r,n,a){return t.getTransform(e,r,n,a),p.invert(e,e)}function B(e,t,r){var n=k(t),a=Math.abs(Math.cos(n)),o=Math.abs(Math.sin(n));return v.set(e,Math.round(r[1]*o+r[0]*a),Math.round(r[1]*a+r[0]*o))}function z(e){return e.scale*O(e.targetGeometry.spatialReference)}function O(e){return 1/(M(e)*F*96)}function k(e){return m.toRadian(e.rotation)||0}function W(e){return M(e)*F*96}function E(e,t){return v.scale(e,t,.5)}function N(e){if(e.isWrappable){var t=f.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function U(e,t){return Math.round(N(e)/t)}function q(e,t){var r=P(e,t);if(r)return a.resolve(r);var o=new n("viewpointUtils-createAsync:different-spatialReference","Target spatialReference cannot be projected and is different from out spatialReference");return a.reject(o)}function C(e,t,r){return z(t)}function V(e,t,r){return S(e,t),e.rotation+=r,e}function D(e,t,r){return S(e,t),e.rotation=r,e}function I(e,t,r){return S(e,t),e.scale=r,e}Object.defineProperty(t,"__esModule",{value:!0});var F=39.37,_=o.wgs84Radius,L=180/Math.PI;t.extentToScale=w,t.create=P,t.copy=S,t.getAnchor=A,t.getExtent=function(){var e=v.create();return function(t,r,n){var a=r.targetGeometry;R(e,a);var o=.5*z(r);return t.xmin=e[0]-o*n[0],t.ymin=e[1]-o*n[1],t.xmax=e[0]+o*n[0],t.ymax=e[1]+o*n[1],t.spatialReference=a.spatialReference,t}}(),t.setExtent=T,t.getOuterExtent=function(){var e=v.create(),t=v.create();return function(r,n,a){R(e,n.targetGeometry),B(t,n,a);var o=.5*z(n),c=e[0]-o*t[0],i=e[1]-o*t[1],u=e[0]+o*t[0],s=e[1]+o*t[1],l=n.targetGeometry.spatialReference;return r.set({xmin:c,ymin:i,xmax:u,ymax:s,spatialReference:l}),r}}(),t.getClippedExtent=function(){var e=v.create(),t=v.create();return function(r,n,a){var o=z(n),c=n.targetGeometry.spatialReference,i=U(c,o);R(e,n.targetGeometry),B(t,n,a),c.isWrappable&&t[0]>i&&(t[0]=i);var u=.5*o,s=e[0]-u*t[0],l=e[1]-u*t[1],f=e[0]+u*t[0],g=e[1]+u*t[1];return r.set({xmin:s,ymin:l,xmax:f,ymax:g,spatialReference:c}),r}}(),t.getOuterSize=B,t.getPaddingScreenTranslation=function(){var e=v.create();return function(t,r,n){return v.sub(t,E(t,r),A(e,r,n))}}();var H=function(){var e=p.create(),r=v.create();return function(n,a,o,c){var i=z(a),u=k(a);return v.set(r,i,i),p.fromScaling(e,r),p.rotate(e,e,u),p.translate(e,e,t.getPaddingScreenTranslation(r,o,c)),p.translate(e,e,[0,c.top-c.bottom]),v.set(n,e[4],e[5])}}();t.getResolution=z,t.getResolutionToScaleFactor=W,t.getMatrix=function(){var e=v.create(),t=v.create(),r=v.create();return function(n,a,o,c,i,u){return v.negate(e,a),v.scale(t,o,.5*u),v.set(r,1/c*u,-1/c*u),p.identity(n),p.translate(n,n,t),i&&p.rotate(n,n,i),p.scale(n,n,r),p.translate(n,n,e),n}}(),t.getTransform=function(){var e=v.create();return function(r,n,a,o){var c=z(n),i=k(n);return R(e,n.targetGeometry),t.getMatrix(r,e,a,c,i,o)}}(),t.getTransformNoRotation=function(){var e=v.create();return function(r,n,a,o){var c=z(n);return R(e,n.targetGeometry),t.getMatrix(r,e,a,c,0,o)}}(),t.getWorldWidth=N,t.getWorldScreenWidth=U,t.createAsync=q,t.angleBetween=function(){var e=v.create(),t=v.create(),r=v.create();return function(n,a,o){v.subtract(e,n,a),v.normalize(e,e),v.subtract(t,n,o),v.normalize(t,t),v.cross(r,e,t);var c=Math.acos(v.dot(e,t)/(v.length(e)*v.length(t)))*L;return r[2]<0&&(c=-c),isNaN(c)&&(c=0),c}}(),t.addPadding=function(){var e=v.create();return function(t,r,n,a){var o=t.targetGeometry;return S(t,r),H(e,r,n,a),o.x+=e[0],o.y+=e[1],t}}(),t.removePadding=function(){var e=v.create();return function(t,r,n,a){var o=t.targetGeometry;return S(t,r),H(e,r,n,a),o.x-=e[0],o.y-=e[1],t}}(),t.centerAt=function(){var e=v.create();return function(t,r,n){S(t,r);var a=t.targetGeometry,o=b(n),c=b(a);return R(e,n),h(e,e,o,c),a.x=e[0],a.y=e[1],t}}(),t.pixelSizeAt=C,t.resize=function(){var e=v.create();return function(r,n,a,o,c){c||(c="center"),v.sub(e,a,o),v.scale(e,e,.5);var i=e[0],u=e[1];switch(c){case"center":v.set(e,0,0);break;case"left":v.set(e,-i,0);break;case"top":v.set(e,0,u);break;case"right":v.set(e,i,0);break;case"bottom":v.set(e,0,-u);break;case"top-left":v.set(e,-i,u);break;case"bottom-left":v.set(e,-i,-u);break;case"top-right":v.set(e,i,u);break;case"bottom-right":v.set(e,i,-u)}return t.translateBy(r,n,e),r}}(),t.rotateBy=V,t.rotateTo=D,t.scaleBy=function(){var e=v.create();return function(r,n,a,o,c){return S(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,c),r.scale=n.scale*a,t.toScreen(e,e,r,c),t.translateBy(r,r,v.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.scaleTo=I,t.scaleAndRotateBy=function(){var e=v.create();return function(r,n,a,o,c,i){return S(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,i),r.scale=n.scale*a,r.rotation+=o,t.toScreen(e,e,r,i),t.translateBy(r,r,v.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=function(){var e=v.create(),r=v.create();return function(n,a,o,c,i,u,s){return t.getPaddingScreenTranslation(r,u,s),v.add(e,i,r),c?t.scaleAndRotateBy(n,a,o,c,e,u):t.scaleBy(n,a,o,e,u)}}(),t.toMap=function(){var e=p.create();return function(t,r,n,a){return v.transformMat2d(t,r,j(e,n,a,1))}}(),t.toScreen=function(){var e=p.create();return function(r,n,a,o){return v.transformMat2d(r,n,t.getTransform(e,a,o,1))}}(),t.translateBy=function(){var e=v.create(),t=p.create();return function(r,n,a){S(r,n);var o=z(n),c=r.targetGeometry;return p.fromRotation(t,k(n)),p.scale(t,t,v.fromValues(o,o)),v.transformMat2d(e,a,t),c.x+=e[0],c.y+=e[1],r}}()});