// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["../core/kebabDictionary","../core/urlUtils","../core/promiseUtils","../core/screenUtils","../geometry/Polygon","../kernel","../request","../core/lang","dojo/dom-construct","dojox/gfx/canvas","./Geoprocessor","./support/fileFormat","./support/layoutTemplate","./support/PrintTemplate","./support/printTaskUtils","./Task"],function(e,t,r,i,a,n,s,l,o,u,y,c,d,p,f,m){function h(e){return e&&(e.path||"image/svg+xml"===e.contentType)}var g={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},b=e({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),v=e({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"});return m.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},_gpServerUrl:null,_cimVersion:null,_is11xService:!1,_data:null,properties:{mode:{readonly:!0,value:"sync"},_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new y(this.url,{updateDelay:this.updateDelay})}},url:{value:null,type:String},updateDelay:{value:1e3,type:Number}},execute:function(e,t){var i=this.url,a=i.lastIndexOf("/GPServer/");return a>0&&(i=i.slice(0,a+9)),r.resolve().then(function(){return this._gpServerUrl===i?{data:this._data}:(this._gpServerUrl=i,s(i,{query:{f:"json"}}))}.bind(this)).then(function(r){this._data=r.data,this._cimVersion=this._data.cimVersion,this._is11xService=!!this._cimVersion;var i=this._setPrintParams(e);this._data.executionType&&(this.mode=v.fromJSON(this._data.executionType));var a="async"===this.mode?"submitJob":"execute";return this._geoprocessor[a](i,t).then(this._handleExecuteResponse)}.bind(this))},_createOperationalLayers:function(e,r){var i,a,s,o,u=e.map,y=[],c=u.allLayers.filter(function(e){return!(e.parent&&"group"===e.parent.type&&!e.parent.visible)}).items;for(i=0;i<c.length;i++)if(a=c[i],a.loaded&&a.visible)switch(o={id:a.id,title:this._legendLayerNameMap[a.id]||a.title,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,url:a.url&&t.normalize(a.url),token:a.token},s=a.declaredClass){case"esri.layers.ImageryLayer":var d={bandIds:a.bandIds,compressionQuality:a.compressionQuality,format:a.format,interpolation:a.interpolation};a.mosaicRule&&(d.mosaicRule=a.mosaicRule.toJSON()),a.renderingRule&&(d.renderingRule=a.renderingRule.toJSON()),y.push(l.mixin(o,d)),this._legendLayers&&this._legendLayers.push({id:a.id});break;case"esri.layers.OpenStreetMapLayer":l.mixin(o,{type:"OpenStreetMap"}),y.push(o);break;case"esri.layers.GraphicsLayer":l.mixin(o,this._createFeatureCollectionJSON(a,null,r)),y.push(o),this._legendLayers&&this._legendLayers.push({id:a.id});break;case"esri.layers.VectorTileLayer":if(delete o.url,delete o.token,this._is11xService&&a.serviceUrl&&a.styleUrl){var p=n.id&&n.id.findCredential(a.styleUrl),f=n.id&&n.id.findCredential(a.serviceUrl);if(!p&&!f||"2.1.0"!==this._cimVersion){l.mixin(o,{type:"VectorTileLayer",styleUrl:t.normalize(a.styleUrl)}),p&&(o.token=p.token),f&&f.token!==o.token&&(o.additionalTokens=[{url:a.serviceUrl,token:f.token}]),y.push(o);break}}o.type="image";var m=r.exportOptions&&r.exportOptions.dpi||96,h=r.exportOptions&&r.exportOptions.width%2==e.width%2,g=r.exportOptions&&r.exportOptions.height%2==e.height%2,b={format:"png",rotation:0},v=this._vtlExtent||e.extent.clone();if("MAP_ONLY"===r.layout&&r.preserveScale&&(!r.outScale||r.outScale===e.scale)&&96===m&&(!h||!g)&&(b.area={x:0,y:0,width:e.width,height:e.height},h||(b.area.width-=1),g||(b.area.height-=1),!this._vtlExtent)){var S=e.toMap({x:b.area.width,y:b.area.height});v.ymin=S.y,v.xmax=S.x,this._vtlExtent=v}o.extent=v.clone()._normalize(!0).toJSON();var x=e.whenLayerView(a);x.isResolved()&&x.then(function(r){var i=r.takeScreenshot(b,e);i.isResolved()?i.then(function(e){var r=t.dataComponents(e.dataUrl);o.imageData=r.data}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise"),o.imageData&&y.push(o)});break;case"esri.layers.MapImageLayer":var _={id:a.id,subLayerIds:[]},L=[],w=e.scale,D=function(e){var t=0===w,r=0===e.minScale||w<=e.minScale,i=0===e.maxScale||w>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(D);else{var a=e.toExportImageJSON().drawingInfo,n=e.toJSON();n.layerDefinition.drawingInfo=a,L.unshift(n),_.subLayerIds.push(e.id)}};a.sublayers&&a.sublayers.forEach(D),L.length&&(l.mixin(o,{layers:L,visibleLayers:_.subLayerIds}),y.push(o),this._legendLayers.push(_));break;case"esri.layers.KMLLayer":if(this._is11xService){var o={};a.write(o,{origin:"web-map"}),o.showLabels=r.showLabels,y.push(o)}else e.whenLayerView(a).then(function(e){e.allVisibleMapImages.forEach(function(e,t){var r={id:a.id+"_image"+t,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity,extent:e.extent.toJSON()};"data:image/png;base64,"===e.href.substr(0,22)?r.imageData=e.href.substr(22):r.url=e.href,y.push(r)});var t=e.allVisiblePoints.concat(e.allVisiblePolylines).concat(e.allVisiblePolygons),i={id:a.id};l.mixin(i,this._createFeatureCollectionJSON(null,t,r)),y.push(i)}.bind(this));break;case"esri.layers.WMSLayer":var L=[],D=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(D):e.name&&L.unshift(e.name))};a.sublayers&&a.sublayers.forEach(D),l.mixin(o,{type:"wms",transparentBackground:a.imageTransparency,visibleLayers:L,version:a.version}),y.push(o);break;case"esri.layers.WMTSLayer":var O=a.activeLayer;l.mixin(o,{type:"wmts",layer:O.id,style:O.styleId,format:O.imageFormat,tileMatrixSet:O.tileMatrixSetId}),y.push(o);break;case"esri.layers.WebTileLayer":var T=a.urlTemplate.replace(/\$\{/g,"{");l.mixin(o,{type:"WebTiledLayer",urlTemplate:T,credits:a.copyright}),a.subDomains&&a.subDomains.length>0&&(o.subDomains=a.subDomains),y.push(o);break;case"esri.layers.CSVLayer":if(this._is11xService){var o={};a.write(o,{origin:"web-map"}),y.push(o);break}case"esri.layers.StreamLayer":case"esri.layers.FeatureLayer":var I=a.renderer,F=I&&!I.hasVisualVariables()&&!a.featureReduction&&!I.valueExpression&&"esri.layers.CSVLayer"!==s,k="esri.layers.FeatureLayer"===s&&a.source&&a.source.length||"esri.layers.StreamLayer"===s;if((this._is11xService||F)&&!k&&I&&("esri.renderer.SimpleRenderer"===I.declaredClass||null==I.field||"string"==typeof I.field&&a.getField(I.field))){if(a.write(o,{origin:"web-map"}),delete o.layerType,delete o.popupInfo,delete o.visibility,o.layerDefinition&&o.layerDefinition.drawingInfo&&o.layerDefinition.drawingInfo.renderer&&(this._convertSvgRenderer(o.layerDefinition.drawingInfo.renderer),I.visualVariables&&I.visualVariables[0]&&I.visualVariables[0].maxSize&&"number"!=typeof I.visualVariables[0].maxSize&&I.visualVariables[0].minSize&&"number"!=typeof I.visualVariables[0].minSize)){var M=I.getSizeRangeAtScale(I.visualVariables[0],e.scale);o.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=M.minSize,o.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=M.maxSize}}else{var V=this._getGraphics(e,a);l.mixin(o,this._createFeatureCollectionJSON(a,V,r))}y.push(o),this._legendLayers&&this._legendLayers.push({id:a.id});break;case"esri.layers.MapNotesLayer":var E=[];a.featureCollections.map(function(e){var t=e.source.toArray(),i=this._createFeatureCollectionJSON(e,t,r).featureCollection;E=E.concat(i.layers)}.bind(this)),l.mixin(o,{featureCollection:{layers:E}}),y.push(o);break;default:y.push(o)}if(e.graphics&&e.graphics.length){var o=this._createFeatureCollectionJSON({},e.graphics,r);o&&y.push(o)}return y},_createFeatureCollectionJSON:function(e,t,r){var i=e,n=f.createPolygonLayer(),s=f.createPolylineLayer(),l=f.createPointLayer(),o=f.createMultipointLayer(),u=f.createPointLayer();u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,i&&("esri.layers.FeatureLayer"===i.declaredClass||"esri.layers.StreamLayer"===i.declaredClass?n.layerDefinition.name=s.layerDefinition.name=l.layerDefinition.name=o.layerDefinition.name=this._legendLayerNameMap[i.id]||i.get("arcgisProps.title")||i.title:"esri.layers.GraphicsLayer"===i.declaredClass&&(t=i.graphics.items));var y=i.renderer&&"esri.renderer.SimpleRenderer"===i.renderer.declaredClass;if(i&&i.renderer&&"function"!=typeof i.get("renderer.field")){var c=i.renderer.toJSON();n.layerDefinition.drawingInfo.renderer=c,s.layerDefinition.drawingInfo.renderer=c,l.layerDefinition.drawingInfo.renderer=c,o.layerDefinition.drawingInfo.renderer=c}else delete n.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo;var d=i&&i.fields,p=i&&i.renderer,m=[];p&&"function"!=typeof i.get("renderer.field")&&("class-breaks"===p.type?(d||(d=[{name:p.field,type:"esriFieldTypeDouble"}],p.normalizationField&&d.push({name:p.normalizationField,type:"esriFieldTypeDouble"})),p.field&&m.push(p.field),p.normalizationField&&m.push(p.normalizationField)):"unique-value"===p.type&&(d||(d=[{name:p.field,type:"esriFieldTypeString"}],p.field2&&d.push({name:p.field2,type:"esriFieldTypeString"}),p.field3&&d.push({name:p.field3,type:"esriFieldTypeString"})),p.field&&m.push(p.field),p.field2&&m.push(p.field2),p.field3&&m.push(p.field3))),d&&(n.layerDefinition.fields=d,s.layerDefinition.fields=d,l.layerDefinition.fields=d,o.layerDefinition.fields=d);for(var g,b=t&&t.length,v=0;v<b;v++){var S=t[v]||t.getItemAt(v);if(!1!==S.visible&&S.geometry&&(g=S.toJSON(),g.hasOwnProperty("popupTemplate")&&delete g.popupTemplate,g.geometry&&g.geometry.z&&delete g.geometry.z,!g.symbol||!g.symbol.outline||"esriCLS"!==g.symbol.outline.type||this._is11xService)){if(g.symbol&&g.symbol.outline&&g.symbol.outline.color&&g.symbol.outline.color[3]&&!this._is11xService&&(g.symbol.outline.color[3]=255),i&&i.renderer&&!g.symbol&&("function"==typeof i.renderer.field||i.renderer.compiledFunc||i.renderer.hasVisualVariables()||i.renderer)){var p=i.renderer,x=p.getSymbol(S);if(!x)continue;g.symbol=x.toJSON(),p.hasVisualVariables()&&f.applyVisualVariables(g.symbol,{renderer:p,graphic:S,symbol:x})}if(g.symbol&&(g.symbol.angle||delete g.symbol.angle,h(g.symbol)?g.symbol=this._convertSvgToPictureMarkerSymbolJson(g.symbol):g.symbol.text&&delete g.attributes),!r||!r.forceFeatureAttributes)if(i&&i.renderer&&"simple"===i.renderer.type)delete g.attributes;else if(m.length){var _={};m.forEach(function(e){g.attributes&&g.attributes.hasOwnProperty(e)&&(_[e]=g.attributes[e])}),g.attributes=_}"polygon"===S.geometry.type?n.featureSet.features.push(g):"polyline"===S.geometry.type?s.featureSet.features.push(g):"point"===S.geometry.type?g.symbol&&g.symbol.text?u.featureSet.features.push(g):l.featureSet.features.push(g):"multipoint"===S.geometry.type?o.featureSet.features.push(g):"extent"===S.geometry.type&&(g.geometry=a.fromExtent(S.geometry).toJSON(),n.featureSet.features.push(g))}}var L=[n,s,o,l,u].filter(function(e){return e.featureSet.features.length>0});return L.forEach(function(e){var t=e.featureSet.features.every(function(e){return e.symbol});!t&&!y||r&&r.forceFeatureAttributes||e.featureSet.features.forEach(function(e){delete e.attributes}),t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this),L.length?{featureCollection:{layers:L}}:null},_convertSvgToPictureMarkerSymbolJson:function(e){this._canvasParent||(this._canvasParent=o.create("div"),this._canvasSurface=u.createSurface(this._canvasParent,200,200));var t;t="image/svg+xml"===e.contentType?this._canvasSurface.createObject(u.Image,{src:"data:image/svg+xml;base64,"+e.imageData,width:i.pt2px(e.width),height:i.pt2px(e.height),x:0,y:0}):this._canvasSurface.createObject(u.Path,e.path).setFill(e.color).setStroke(e.outline),"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var r=this._canvasSurface.rawNode.getContext("2d"),a=t.getBoundingBox(),n=Math.ceil(a.width+a.x),s=Math.ceil(a.height+a.y),l=r.getImageData(a.x,a.y,n,s);r.canvas.width=n,r.canvas.height=s,r.putImageData(l,0,0);return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:e.size?e.size:s-a.y,width:e.size?e.size:n-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},_convertSvgRenderer:function(e){var t=e.type;if("simple"===t&&h(e.symbol))e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol);else if("unique-value"===t||"class-breaks"===t){h(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol));var r="unique-value"===t?"uniqueValueInfos":"classBreakInfos",i=e[r];i&&i.forEach(function(e){h(e.symbol)&&(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol))},this)}},_getGraphics:function(e,t){var r;return e.whenLayerView(t).then(function(e){return e.queryGraphics&&e.queryGraphics()||e.featuresView.graphics}).then(function(e){r=e&&e.features||e}),r},_getPrintDefinition:function(e,t){var r=e.view,i=r.map,a=r.spatialReference,n={operationalLayers:this._createOperationalLayers(r,t)},s=this._vtlExtent||e.extent||r.extent;return a&&a.isWrappable&&(s=s.clone()._normalize(!0),a=s.spatialReference),n.mapOptions={extent:s&&s.toJSON(),spatialReference:a&&a.toJSON(),showAttribution:t.attributionVisible},this._vtlExtent=null,r.rotation&&(n.mapOptions.rotation=-r.rotation),t.preserveScale&&(n.mapOptions.scale=t.outScale||r.scale),i.timeExtent&&(n.mapOptions.time=[i.timeExtent.startTime.getTime(),i.timeExtent.endTime.getTime()]),n},_handleExecuteResponse:function(e){return"sync"===this.mode?e.results&&e.results[0]&&e.results[0].value:this._geoprocessor.getResultData(e.jobId,"Output_File").then(function(e){return e.value})},_setPrintParams:function(e){var t=e.template||new p;null==t.showLabels&&(t.showLabels=!0);var r,i=t.exportOptions;if(i){r={dpi:i.dpi};var a=d.toJSON(t.layout);if("map_only"===a.toLowerCase()||""===a){var n=i.width,s=i.height;r.outputSize=[n,s]}}var o,u=t.layoutOptions;if(u){var y,f;"Miles"===u.scalebarUnit||"Kilometers"===u.scalebarUnit?(y="Kilometers",f="Miles"):"Meters"!==u.scalebarUnit&&"Feet"!==u.scalebarUnit||(y="Meters",f="Feet"),o={titleText:u.titleText,authorText:u.authorText,copyrightText:u.copyrightText,customTextElements:u.customTextElements,scaleBarOptions:{metricUnit:b.toJSON(y),metricLabel:g[y],nonMetricUnit:b.toJSON(f),nonMetricLabel:g[f]}}}var m=null;u&&u.legendLayers&&(m=u.legendLayers.map(function(e){this._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t},this));var h=this._getPrintDefinition(e,t);if(h.operationalLayers){var v,S=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),x=/[\u0600-\u06FF]/,_=function(e){var t=e.text,r=e.font,i=r&&r.family&&r.family.toLowerCase();t&&r&&("arial"===i||"arial unicode ms"===i)&&(r.family=S.test(t)?"Arial Unicode MS":"Arial","normal"!==r.style&&x.test(t)&&(r.family="Arial Unicode MS"))};h.operationalLayers.forEach(function(e){e.featureCollection&&e.featureCollection.layers&&e.featureCollection.layers.forEach(function(e){e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&e.layerDefinition.drawingInfo.renderer.symbol&&(v=e.layerDefinition.drawingInfo.renderer,"esriTS"===v.symbol.type&&_(v.symbol)),e.featureSet&&e.featureSet.features&&e.featureSet.features.forEach(function(e){e.symbol&&"esriTS"===e.symbol.type&&_(e.symbol)})})})}e.outSpatialReference&&(h.mapOptions.spatialReference=e.outSpatialReference.toJSON()),l.mixin(h,{exportOptions:r,layoutOptions:o}),l.mixin(h.layoutOptions,{legendOptions:{operationalLayers:null!=m?m:this._legendLayers}}),this._legendLayers.length=0;var L=JSON.stringify(h),w={Web_Map_as_JSON:L,Format:c.toJSON(t.format),Layout_Template:a};return e.extraParameters&&l.mixin(w,e.extraParameters),w}})});