// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","./tsSupport/assignHelper","dojo/io-query","dojo/_base/url","../config","./Error","./global","./lang","./Logger"],function(r,e,t,n,a,i,u,o,l,s){function f(r){var e={path:null,query:null},t=new a(r),i=r.indexOf("?");return null===t.query?e.path=r:(e.path=r.substring(0,i),e.query=n.queryToObject(t.query)),t.fragment&&(e.hash=t.fragment,null===t.query&&(e.path=e.path.substring(0,e.path.length-(t.fragment.length+1)))),e}function c(r){void 0===r&&(r=!1);var e,t=fr.proxyUrl;if("string"==typeof r){e=A(r);var n=g(r);n&&(t=n.proxyUrl)}else e=!!r;if(!t)throw sr.warn(cr),new u("urlutils:proxy-not-set",cr);return e&&W()&&(t=K(t)),f(t)}function p(r){var e,a,i=g(r);if(i){var u=h(i.proxyUrl);e=u.path,a=u.query?n.queryToObject(u.query):null}if(e){var o=f(r);r=e+"?"+o.path;var l=n.objectToQuery(t({},a,o.query));l&&(r=r+"?"+l)}return r}function h(r){var e=r.indexOf("?");return-1!==e?(mr.path=r.slice(0,e),mr.query=r.slice(e+1)):(mr.path=r,mr.query=null),mr}function v(r){return r=h(r).path,r=F(r),r=_(r,!0),r=r.toLowerCase()}function d(r){for(var e={proxyUrl:r.proxyUrl,urlPrefix:v(r.urlPrefix)},t=fr.proxyRules,n=e.urlPrefix,a=t.length,i=0;i<t.length;i++){var u=t[i].urlPrefix;if(0===n.indexOf(u)){if(n.length===u.length)return-1;a=i;break}0===u.indexOf(n)&&(a=i+1)}return t.splice(a,0,e),a}function g(r){for(var e=fr.proxyRules,t=v(r),n=0;n<e.length;n++)if(0===t.indexOf(e[n].urlPrefix))return e[n]}function y(r,e){return r=m(r),e=m(e),_(r)===_(e)}function m(r){r=q(r);var e=r.indexOf("/sharing");return e>0?r.substring(0,e):r.replace(/\/+$/,"")}function U(r){var e=function(e){return null==e||e instanceof RegExp&&e.test(r)||"string"==typeof e&&l.startsWith(r,e)},t=fr.interceptors;if(t)for(var n=0,a=t;n<a.length;n++){var i=a[n];if(Array.isArray(i.urls)){var u=i.urls.some(e);if(u)return i}else if(e(i.urls))return i}return null}function x(r,e,t){void 0===t&&(t=!1);var n=Y(r),a=Y(e);return!(!t&&n.scheme!==a.scheme)&&(n.host.toLowerCase()===a.host.toLowerCase()&&n.port===a.port)}function O(r){if("string"==typeof r){if(!R(r))return!0;r=Y(r)}for(var e=fr.trustedServers||[],t=0;t<e.length;t++)for(var n=e[t],a=b(n),i=0;i<a.length;i++)if(x(r,a[i]))return!0;return!1}function b(r){return e.trustedServersUrlCache[r]||(k(r)||Q(r)?e.trustedServersUrlCache[r]=[new a(w(r))]:e.trustedServersUrlCache[r]=[new a("http://"+r),new a("https://"+r)]),e.trustedServersUrlCache[r]}function w(r,t,n){return void 0===t&&(t=e.appBaseUrl),Q(r)?n&&n.preserveProtocolRelative?r:"http"===e.appUrl.scheme&&e.appUrl.authority===T(r).slice(2)?"http:"+r:"https:"+r:k(r)?r:C("/"===r[0]?E(t):t,r)}function P(r,t,n){if(void 0===t&&(t=e.appBaseUrl),!R(r))return r;var a=q(r),i=a.toLowerCase(),u=q(t).toLowerCase().replace(/\/+$/,""),o=n?q(n).toLowerCase().replace(/\/+$/,""):null;if(o&&0!==u.indexOf(o))return r;for(var l=function(r,e,t){return t=r.indexOf(e,t),-1===t?r.length:t},s=l(i,"/",i.indexOf("//")+2),f=-1;i.slice(0,s+1)===u.slice(0,s)+"/"&&(f=s+1,s!==i.length);)s=l(i,"/",s+1);if(-1===f)return r;if(o&&f<o.length)return r;r=a.slice(f);var c=u.slice(f-1).replace(/[^\/]+/g,"").length;if(c>0)for(var p=0;p<c;p++)r="../"+r;else r="./"+r;return r}function q(r){return r=r.trim(),r=w(r),r=V(r),r=J(r),r=N(r)}function C(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(r&&r.length){var t=[];if(R(r[0])){var n=r[0],a=n.indexOf("//");t.push(n.slice(0,a+1)),H(r[0])&&(t[0]+="/"),r[0]=n.slice(a+2)}else"/"===r[0][0]&&t.push("");for(var i=r.reduce(function(r,e){return e?r.concat(e.split("/")):r},[]),u=0;u<i.length;u++){var o=i[u];".."===o&&t.length>0?t.pop():!o||"."===o&&0!==t.length||t.push(o)}return t.join("/")}}function T(r){if(j(r)||S(r))return null;var e=r.indexOf("://");if(-1===e&&Q(r))e=2;else{if(-1===e)return null;e+=3}var t=r.indexOf("/",e);return-1===t?r:r.slice(0,t)}function R(r){return Q(r)||k(r)}function j(r){return"blob:"===r.slice(0,5)}function S(r){return"data:"===r.slice(0,5)}function B(r){var e=L(r);if(!e||!e.isBase64)return null;for(var t=atob(e.data),n=new Uint8Array(t.length),a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return n.buffer}function L(r){var e=r.match(Ur);return e?{mediaType:e[1],isBase64:!!e[2],data:e[3]}:null}function $(r){return r.isBase64?"data:"+r.mediaType+";base64,"+r.data:"data:"+r.mediaType+","+r.data}function Q(r){return r&&"/"===r[0]&&"/"===r[1]}function k(r){return pr.test(r)}function A(r){return vr.test(r)||"https"===e.appUrl.scheme&&Q(r)}function I(r){return hr.test(r)||"http"===e.appUrl.scheme&&Q(r)}function H(r){return dr.test(r)}function D(r){return Q(r)?"http:"+r:r.replace(vr,"http:")}function K(r){return Q(r)?"https:"+r:r.replace(hr,"https:")}function z(){return"http"===e.appUrl.scheme}function W(){return"https"===e.appUrl.scheme}function _(r,e){return void 0===e&&(e=!1),Q(r)?r.slice(2):(r=r.replace(pr,""),e&&r.length>1&&"/"===r[0]&&"/"===r[1]&&(r=r.slice(2)),r)}function E(r){var e=r.indexOf("//"),t=r.indexOf("/",e+2);return-1===t?r:r.slice(0,t)}function M(r){var e=0;if(R(r)){var t=r.indexOf("//");-1!==t&&(e=t+2)}var n=r.lastIndexOf("/");return n<e?r:r.slice(0,n+1)}function F(r){return r&&"/"===r[r.length-1]?r:r+"/"}function G(r){return r.replace(/\/+$/,"")}function V(r){if(/^https?:\/\//i.test(r)){var e=h(r);r=e.path.replace(/\/{2,}/g,"/"),r=r.replace("/","//"),e.query&&(r+="?"+e.query)}return r}function J(r){return r.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function N(r){var t=fr.httpsDomains;if(!I(r))return r;var n,a=r.indexOf("/",7);if(n=-1===a?r:r.slice(0,a),n=n.toLowerCase().slice(7),gr.test(n)){if(!l.endsWith(n,":80"))return r;n=n.slice(0,-3),r=r.replace(":80","")}return z()&&n===e.appUrl.authority&&!yr.test(r)?r:((W()&&n===e.appUrl.authority||t&&t.some(function(r){return n===r||l.endsWith(n,"."+r)})||W()&&!g(r))&&(r=K(r)),r)}function X(r,e,t){if(!(e&&t&&r&&R(r)))return r;var n=r.indexOf("//"),a=r.indexOf("/",n+2),i=r.indexOf(":",n+2),u=Math.min(a<0?r.length:a,i<0?r.length:i);return r.slice(n+2,u).toLowerCase()!==e.toLowerCase()?r:""+r.slice(0,n+2)+t+r.slice(u)}function Y(r){return"string"==typeof r?new a(w(r)):(r.scheme||(r.scheme=e.appUrl.scheme),r)}function Z(r,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?X(r,e.urlKey+"."+e.customBaseUrl,e.portalHostname):r}function rr(r,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return r;var n=t.urlKey+"."+t.customBaseUrl;return x(e.appUrl,e.appUrl.scheme+"://"+n)?X(r,t.portalHostname,n):X(r,n,t.portalHostname)}function er(r,e){var t=e&&e.url&&e.url.path;return r&&t&&(r=w(r,t,{preserveProtocolRelative:!0})),rr(r,e&&e.portal)}function tr(r,e){if(!r)return r;!R(r)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(r);var t=w(r);if(e){var n=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;n&&(t=P(t,n,n))!==r&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(t)}return t=Z(t,e&&e.portal)}function nr(r,e){r&&Q(r)&&(r="https:"+r),e.url=r?q(r):r}function ar(r){return xr.test(r)}function ir(r,e){var t=f(r),n=Object.keys(t.query||{});return n.length>0&&e&&e.warn("removeQueryParameters()","Url query parameters are not supported, the following parameters have been removed: "+n.join(", ")+"."),t.path}function ur(r,e,t){var a=f(r),i=a.query||{};return i[e]=t,a.path+"?"+n.objectToQuery(i)}function or(r,e){var t=f(r),a=t.query||{};for(var i in e)a[i]=e[i];var u=n.objectToQuery(a);return u?t.path+"?"+u:t.path}function lr(r,e){var t=f(r),a=t.path,i=t.query;if(!i)return r;delete i[e];var u=n.objectToQuery(i);return u?a+"?"+u:a}Object.defineProperty(e,"__esModule",{value:!0});var sr=s.getLogger("esri.core.urlUtils"),fr=i.request,cr="esri/config: esriConfig.request.proxyUrl is not set.",pr=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,hr=/^\s*http:/i,vr=/^\s*https:/i,dr=/^\s*file:/i,gr=/:\d+$/,yr=/^https?:\/\/[^\/]+\.arcgis.com\/sharing(\/|$)/i;e.appUrl=new a(o.location),e.trustedServersUrlCache={},e.appBaseUrl=function(){var r=e.appUrl.path,t=r.substring(0,r.lastIndexOf(r.split("/")[r.split("/").length-1]));return e.appUrl.scheme+"://"+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:"")+t}(),e.urlToObject=f,e.getProxyUrl=c,e.addProxy=p;var mr={path:"",query:""};e.addProxyRule=d,e.getProxyRule=g,e.hasSamePortal=y,e.getInterceptor=U,e.hasSameOrigin=x,e.isTrustedServer=O,e.makeAbsolute=w,e.makeRelative=P,e.normalize=q,e.join=C,e.getOrigin=T,e.isAbsolute=R,e.isBlobProtocol=j,e.isDataProtocol=S,e.dataToArrayBuffer=B;var Ur=/^data:(.*?)(;base64)?,(.*)$/;e.dataComponents=L,e.makeData=$,e.isProtocolRelative=Q,e.hasProtocol=k,e.toHTTP=D,e.toHTTPS=K,e.removeFile=M,e.removeTrailingSlash=G,e.changeDomain=X,e.read=er,e.write=tr,e.writeOperationalLayerUrl=nr,e.isSVG=ar,e.removeQueryParameters=ir,e.addQueryParameter=ur,e.addQueryParameters=or,e.removeQueryParameter=lr;var xr=/(^data:image\/svg|\.svg$)/i});