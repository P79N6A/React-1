// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","dojo/Deferred","dojo/has!host-webworker?./core/workers/request","dojo/io-query","dojo/_base/url","dojo/errors/CancelError","dojo/request/xhr","./config","./core/deferredUtils","./core/Error","./core/global","./core/has","./core/lang","./core/promiseUtils","./core/urlUtils"],function(e,r,t,n,o,s,a,i,l,u,d,c,p,f,h,v,g){function m(e,r){void 0===r&&(r=!1),g.isBlobProtocol(e.url)||g.isDataProtocol(e.url)||!e.content||(e.preventCache&&(e.content["request.preventCache"]=Date.now()),e.url=g.addQueryParameters(e.url,e.content));var t=new Image;e.withCredentials?t.crossOrigin="use-credentials":t.crossOrigin="anonymous";var o=!1,s=new n(function(){o=!0,t.onload=t.onerror=t.onabort=null,t.src=""}),a=function(){t.onload=t.onerror=t.onabort=null,r&&URL.revokeObjectURL(this.src),o||s.reject(new Error("Unable to load the resource"))};return t.onload=function(){t.onload=t.onerror=t.onabort=null,r&&URL.revokeObjectURL(this.src),o||s.resolve(this)},t.onerror=a,t.onabort=a,t.alt="",t.src=e.url,s.promise}function y(e){var r=new a(e);return(r.host+(r.port?":"+r.port:"")).toLowerCase()}function b(){return D||(D=v.create(function(r){e(["./identity/IdentityManager"],r)}).then(function(e){j=e}))}function O(e,r){var o=!!e.useProxy,a=e.method||"auto";e=t({},e),e.content=e.content||{},e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var i=e.url,u=g.isBlobProtocol(i)||g.isDataProtocol(i);e._token&&(e.content.token=e._token);var d,c=0;u||(d=s.objectToQuery(e.content),c=d.length+i.length+1,f("esri-url-encodes-apostrophe")&&(c=d.replace(/'/g,"%27").length+i.length+1)),e.timeout=null!=e.timeout?e.timeout:U.timeout,e.handleAs=e.handleAs||"json";try{var p=void 0,h=void 0,v=!u&&("post"===a||!!e.body||c>U.maxUrlLength),y=!u&&(o||!!g.getProxyRule(e.url));if(y||"image"!==e.handleAs||!U.proxyUrl||u||C(e.url)||(e.handleAs="blob"),y&&(f("host-browser")||f("host-webworker"))&&(p=g.getProxyUrl(i),h=p.path,!v&&h.length+1+c>U.maxUrlLength&&(v=!0),p.query&&(e.content=t({},p.query,e.content)),v||(e.preventCache&&(e.content["request.preventCache"]=Date.now(),e.preventCache=!1),e.url=g.addQueryParameters(e.url,e.content),e.content=null),e.url=h+"?"+e.url),!u){var b=e.headers;if(!f("host-browser")&&!f("host-webworker")||b&&b.hasOwnProperty("X-Requested-With")||(b=e.headers=b||{},b["X-Requested-With"]=null),f("host-browser")&&r){var O=e.content&&e.content.token;O&&(r.set?r.set("token",O):r.append("token",O)),e.contentType=!1}if(!e.hasOwnProperty("withCredentials")){var q=y?h:i;if(g.isTrustedServer(q))e.withCredentials=!0;else if(j){var w=j.findServerInfo(q);w&&w.webTierAuth&&(e.withCredentials=!0)}}}return v?("image"===e.handleAs&&(e.handleAs="blob"),e.body?(e.data=r||e.body,e.query=e.content):e.data=e.content,delete e.body,delete e.content,!y&&f("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+S++),l.post(e.url,e)):"image"===e.handleAs?m(e):(e.query=e.content,delete e.content,l.get(e.url,e))}catch(e){var _=new n;return _.reject(e),_.promise}}function q(e,r,o,s){function a(e){e._pendingDfd=O(o,d);var r=!!e._pendingDfd.response;(e._pendingDfd.response||e._pendingDfd).then(function(e){if(!r||!e.data)return e;U.proxyUrl&&!h.startsWith(e.url,U.proxyUrl)&&x(e.url);var o=e.getHeader("Content-Type");if(o&&(o=o.toLowerCase(),-1===o.indexOf("text/plain")&&-1===o.indexOf("application/json")))return e;var s,a=e.data;if(a instanceof ArrayBuffer&&a.byteLength<=750)s=new Blob([a]);else{if(!(a instanceof Blob&&a.size<=750))return e;s=a}var i=new n,l=new FileReader;return l.readAsText(s),l.onloadend=function(){if(!l.error)try{var r=JSON.parse(l.result);r.error&&(Object.isExtensible(e)||(e=t({},e)),e._jsonData=r)}catch(e){}i.resolve(e)},i.promise}).then(function(e){return r&&!e._jsonData&&"image"===s.requestOptions.responseType&&e.data instanceof Blob?(r=!1,o.url=URL.createObjectURL(e.data),m(o,!0)):e}).then(function(t){var n=r?t.data:t,o=r?t.getHeader.bind(t):L;if(n){var a=r&&t._jsonData||n;if(a.error||"error"===a.status){var i=h.mixin(new Error,a.error||a);throw i.getHeader=o,i}}e.resolve({data:n,url:s.url,requestOptions:s.requestOptions,getHeader:o}),e._pendingDfd=null}).catch(function(r){var t,n,a,i;if(r&&(t=Number(r.code),n=r.hasOwnProperty("subcode")?Number(r.subcode):null,a=r.messageCode,a=a&&a.toUpperCase(),i=r.response),i&&0===i.status&&U.proxyUrl&&!l&&"post"!==o.method&&i.url&&!h.startsWith(i.url,U.proxyUrl))return g.addProxyRule({proxyUrl:U.proxyUrl,urlPrefix:g.removeFile(g.urlToObject(o.url).path)}),void q(e,!0,o,s);if(403===t&&(4===n||r.message&&r.message.toLowerCase().indexOf("ssl")>-1&&-1===r.message.toLowerCase().indexOf("permission"))){if(!o._ssl)return o._ssl=o._sslFromServer=!0,void q(e,!0,o,s)}else if(u&&"no-prompt"!==o.authMode&&j._errorCodes&&-1!==j._errorCodes.indexOf(t)&&!j._isPublic(o.url)&&(403!==t||P&&-1===P.indexOf(a)&&(null==n||2===n&&o._token)))return void w(e,o,s,_("request:server",r,s));i&&i.status>0&&i.url&&U.proxyUrl&&!h.startsWith(i.url,U.proxyUrl)&&x(i.url),e.reject(_("request:server",r,s)),e._pendingDfd=null})}var i,l=o.body,u=o.useIdentity,d=null,p=l instanceof FormData;(p||l&&l.elements)&&(d=p?l:new FormData(l));var f=!!(-1!==o.url.toLowerCase().indexOf("token=")||o.content&&o.content.token||d&&d.get&&d.get("token")||l&&l.elements&&l.elements.token);if(!r){if(u&&!f&&!o._token&&!j._isPublic(o.url)){var v=function(e){e&&(o._token=e.token,o._ssl=e.ssl)};"immediate"===o.authMode?i=j.getCredential(o.url).then(v):"no-prompt"===o.authMode?i=j.checkSignInStatus(o.url).then(v).catch(function(){}):v(j.findCredential(o.url))}e.then(function(e){(/\/sharing\/rest\/accounts\/self/i.test(o.url)||/\/sharing\/rest\/portals\/self/i.test(o.url))&&!f&&!o._token&&e.user&&e.user.username&&(g.isTrustedServer(o.url)||U.trustedServers.push(y(o.url)));var r=o._credential;if(r){var t=j.findServerInfo(r.server),n=t&&t.owningSystemUrl,s=void 0;n&&(n=n.replace(/\/?$/,"/sharing"),(s=j.findCredential(n,r.userId))&&-1===j._getIdenticalSvcIdx(n,s)&&s.resources.splice(0,0,n))}return e}).always(function(e){if(delete o._credential,e){var r=!!o._ssl;e instanceof c?e.details.ssl=r:e.ssl=r}})}return i?i.then(function(){e.isCanceled()||a(e)}).catch(function(r){e.reject(r)}):a(e),e.promise}function w(e,r,t,n){e._pendingDfd=j.getCredential(r.url,{error:n,token:r._token}),e._pendingDfd.then(function(n){r._token=n.token,r._credential=n,r._ssl=r._sslFromServer||n.ssl,q(e,!0,r,t)}).catch(function(r){e.reject(r),e._pendingDfd=null})}function _(e,r,t){var n="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:L};if(r instanceof c)return r.details?(r.details=h.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var s=r.response,a=s&&s.getHeader,i=s&&s.status,l=r.message,u=r.getHeader||a;l&&(n=l),u&&(o.getHeader=u),o.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||i,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var d=new c(e,n,o);return r&&"cancel"===r.dojoType&&(d.name="AbortError",d.dojoType="cancel"),d}function C(e){var r=g.getOrigin(e);return!r||h.endsWith(r,".arcgis.com")||g.hasSameOrigin(r,g.appUrl)||-1!==k._corsServers.indexOf(r)||g.isTrustedServer(r)}function x(e){if(!g.isBlobProtocol(e)&&!g.isDataProtocol(e)){var r=g.getOrigin(e);r&&-1===k._corsServers.indexOf(r)&&k._corsServers.push(r)}}function k(e,r){if(o&&p.invokeStaticMessage)return o.execute(e,r);g.isBlobProtocol(e)||g.isDataProtocol(e)||(e=g.normalize(e));var n={url:e,requestOptions:t({},r)},s=g.getInterceptor(e);if(s){if(null!=s.responseData)return v.resolve({data:s.responseData,requestOptions:n.requestOptions,getHeader:L,url:e});if(s.headers&&(n.requestOptions.headers=t({},n.requestOptions.headers,s.headers)),s.query&&(n.requestOptions.query=t({},n.requestOptions.query,s.query)),s.before){var l=s.before(n);if(null!=l)return l instanceof Error||l instanceof c?v.reject(_("request:interceptor",l,n)):v.resolve({data:l,requestOptions:n.requestOptions,getHeader:L,url:n.url})}}var u=t({url:n.url},n.requestOptions);if(u.content=u.query,delete u.query,u.preventCache=!!u.cacheBust,delete u.cacheBust,u.handleAs=u.responseType,delete u.responseType,"array-buffer"===u.handleAs&&(u.handleAs="arraybuffer"),"image"===u.handleAs){if(f("host-webworker")||f("host-node"))return v.reject(_("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n))}else if(g.isDataProtocol(e))return v.reject(_("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+u.handleAs),n));var h=U.useIdentity;"anonymous"===u.authMode&&(h=!1),u.useIdentity=h,u.urlObj=new a(u.url);var m,y=d.makeDeferredCancellingPending();if(n.requestOptions.signal){var O=n.requestOptions.signal;m=function(){y.cancel(_("AbortError",new i("Request canceled"),n))},O.aborted?m():O.addEventListener("abort",m)}return v.resolve().then(function(){if(h&&!j)return b()}).always(function(){y.isCanceled()||q(y,!1,u,n)}),y.then(function(e){return n.requestOptions.signal&&n.requestOptions.signal.removeEventListener("abort",m),s&&s.after&&s.after(e),e}).catch(function(e){throw n.requestOptions.signal&&n.requestOptions.signal.removeEventListener("abort",m),e})}var j,D,U=u.request,P=["COM_0056","COM_0057"],S=0,L=function(){return null};return function(e){e._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"]}(k||(k={})),k});